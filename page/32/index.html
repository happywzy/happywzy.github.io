<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"happywzy.top","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="日常学习笔记,共同进步">
<meta property="og:type" content="website">
<meta property="og:title" content="Happywzy">
<meta property="og:url" content="https://happywzy.top/page/32/index.html">
<meta property="og:site_name" content="Happywzy">
<meta property="og:description" content="日常学习笔记,共同进步">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="wuzhiyong">
<meta property="article:tag" content="spring boot">
<meta property="article:tag" content="java">
<meta property="article:tag" content="flink">
<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="hadoop">
<meta property="article:tag" content="分布式">
<meta property="article:tag" content="微服务">
<meta property="article:tag" content="容器">
<meta property="article:tag" content="常用工具">
<meta property="article:tag" content="linux">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://happywzy.top/page/32/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Happywzy</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Happywzy" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Happywzy</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">enjoy coding...</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://happywzy.top/fu-wu-wang-ge/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="wuzhiyong">
      <meta itemprop="description" content="日常学习笔记,共同进步">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Happywzy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/fu-wu-wang-ge/" class="post-title-link" itemprop="url">Service Mesh简介</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-15 10:28:05" itemprop="dateCreated datePublished" datetime="2020-01-15T10:28:05+08:00">2020-01-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-15 13:37:46" itemprop="dateModified" datetime="2020-04-15T13:37:46+08:00">2020-04-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/istio/" itemprop="url" rel="index"><span itemprop="name">istio</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><strong>服务网格（<code>Service mesh</code>）是服务间通信的基础设施层</strong>。它对全局流量和通信进行监控和管理，提供包括可观察性、流量转移（用于灰度发布）、弹性能力（例如断路和重试/超时）等一系列功能，并为服务之间的通信提供双向 TLS 认证能力，让网格能够对请求和响应进行自动加密和解密。<br><img src="/images/sm1.jpg" alt="Service Mesh"></p>
<h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h4><ul>
<li>治理能力独立（Sidecar）</li>
<li>应用程序无感知</li>
<li>服务通信的基础设施层</li>
</ul>
<h4 id="关注的方面"><a href="#关注的方面" class="headerlink" title="关注的方面"></a>关注的方面</h4><ul>
<li>可观察性</li>
<li>安全性</li>
<li>可运维性</li>
<li>可拓展性</li>
</ul>
<h3 id="为什么需要？"><a href="#为什么需要？" class="headerlink" title="为什么需要？"></a>为什么需要？</h3><p><img src="/images/sm4.png" alt="Service Mesh"><br><code>Kubernetes</code> 提供平台基础设施层强大的容器编排与调度能力</p>
<ul>
<li>服务部署与弹性伸缩：<code>Deployment</code></li>
<li>服务拆分与服务发现：<code>Service</code></li>
</ul>
<p><code>Kubernetes</code> 提供简单的负载均衡</p>
<ul>
<li>负载均衡：基于<code>IPVS</code>或<code>Iptables</code>的简单均衡机制</li>
</ul>
<p>但是<code>Kubernetes</code>在服务治理方面并不完备，缺少了动态路由、熔断、灰度发布等等功能，需要由服务网格互补。</p>
<h3 id="什么时候用Service-Mesh？"><a href="#什么时候用Service-Mesh？" class="headerlink" title="什么时候用Service Mesh？"></a>什么时候用Service Mesh？</h3><p><img src="/images/sm2.jpg" alt="Service Mesh"></p>
<p>随着我们的微服务越来越细分，我们所要管理的服务正在成倍的增长着，<code>Kubernetes</code> 提供了丰富的功能，使得我们可以快速的部署和调度这些服务，同时也提供了我们熟悉的方式来实现那些复杂的功能，但是随着部署的应该越来越多，复杂度越来越高，当临界点到来时，可能就是我们真正要去考虑使用 <code>Service Mesh</code> 的时候了。</p>
<h3 id="Istio问世"><a href="#Istio问世" class="headerlink" title="Istio问世"></a>Istio问世</h3><p><img src="/images/sm3.jpg" alt="Service Mesh"><br><code>Istio</code>是一个开放服务网格，是<code>Service Mesh</code>标准实现，也是当下最流行的，提供了一种连接，管理和保护微服务的统一方法。它支持管理服务之间的流量，执行访问策略以及汇总遥测数据，所有这些都无需更改微服务代码。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://happywzy.top/ri-zhi-ju-he-gong-ju-loki-shi-yong-logql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="wuzhiyong">
      <meta itemprop="description" content="日常学习笔记,共同进步">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Happywzy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/ri-zhi-ju-he-gong-ju-loki-shi-yong-logql/" class="post-title-link" itemprop="url">日志聚合工具Loki使用【LogQL】</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-13 11:14:18" itemprop="dateCreated datePublished" datetime="2020-01-13T11:14:18+08:00">2020-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-15 13:38:48" itemprop="dateModified" datetime="2020-04-15T13:38:48+08:00">2020-04-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="https://github.com/grafana/loki/blob/master/docs/logql.md" target="_blank" rel="noopener">LogQL github</a></p>
<h3 id="LogQL简介"><a href="#LogQL简介" class="headerlink" title="LogQL简介"></a>LogQL简介</h3><p>LogQL: Log Query Language<br>Loki comes with its very own language for querying logs called LogQL. LogQL can be considered a distributed grep with labels for filtering.</p>
<p>A basic LogQL query consists of two parts: the log stream selector and a filter expression. Due to Loki’s design, all LogQL queries are required to contain a log stream selector.</p>
<p>The log stream selector will reduce the number of log streams to a manageable volume. Depending how many labels you use to filter down the log streams will affect the relative performance of the query’s execution. The filter expression is then used to do a distributed grep over the retrieved log streams.</p>
<h3 id="Loki选择器"><a href="#Loki选择器" class="headerlink" title="Loki选择器"></a>Loki选择器</h3><p>对于查询表达式的标签部分，将其包装在花括号中<code>{}</code>，然后使用键值对的语法来选择标签，多个标签表达式用逗号分隔，比如：</p>
<pre><code>{app="mysql",name="mysql-backup"}</code></pre><p>目前支持以下标签匹配运算符：</p>
<ul>
<li>=等于</li>
<li>!=不相等</li>
<li>=~正则表达式匹配</li>
<li>!~不匹配正则表达式</li>
<li>比如：<pre><code>{name=~"mysql.+"}
{name!~"mysql.+"}</code></pre></li>
</ul>
<h3 id="日志过滤器"><a href="#日志过滤器" class="headerlink" title="日志过滤器"></a>日志过滤器</h3><p>编写日志流选择器后，您可以通过编写搜索表达式来进一步过滤结果。搜索表达式可以只是文本或正则表达式。<br>查询示例：</p>
<pre><code>{job="mysql"} |= "error"
{name="kafka"} |~ "tsdb-ops.*io:2003"
{instance=~"kafka-[23]",name="kafka"} != kafka.server:type=ReplicaManager</code></pre><p>过滤器运算符可以被链接，并将顺序过滤表达式-结果日志行将满足每个过滤器。例如：</p>
<pre><code>{job="mysql"} |= "error" != "timeout"</code></pre><p>已实现以下过滤器类型：</p>
<ul>
<li>|= 行包含字符串。</li>
<li>!= 行不包含字符串。</li>
<li>|~ 行匹配正则表达式。</li>
<li>!~ 行与正则表达式不匹配。<br><code>regex</code>表达式接受<code>RE2</code>语法。默认情况下，匹配项区分大小写，并且可以将<code>regex</code>切换为不区分大小写的前缀<code>(?i)</code>。</li>
</ul>
<h3 id="日志统计"><a href="#日志统计" class="headerlink" title="日志统计"></a>日志统计</h3><ul>
<li>rate: calculate the number of entries per second</li>
</ul>
<pre><code>rate( ( {job="mysql"} |= "error" != "timeout)[10s] ) )</code></pre><ul>
<li>count_over_time: counts the entries for each log stream within the given range.</li>
</ul>
<pre><code>count_over_time({job="mysql"}[5m])</code></pre><h3 id="聚合运算"><a href="#聚合运算" class="headerlink" title="聚合运算"></a>聚合运算</h3><ul>
<li>sum: Calculate sum over labels</li>
<li>min: Select minimum over labels</li>
<li>max: Select maximum over labels</li>
<li>avg: Calculate the average over labels</li>
<li>stddev: Calculate the population standard deviation over labels</li>
<li>stdvar: Calculate the population standard variance over labels</li>
<li>count: Count number of elements in the vector</li>
<li>bottomk: Select smallest k elements by sample value</li>
<li>topk: Select largest k elements by sample value</li>
</ul>
<p>示例：<br>Get the top 10 applications by the highest log throughput:</p>
<pre><code>topk(10,sum(rate({region="us-east1"}[5m])) by (name))</code></pre><p>Get the count of logs during the last five minutes, grouping by level:</p>
<pre><code>sum(count_over_time({job="mysql"}[5m])) by (level)</code></pre><p>Get the rate of HTTP GET requests from NGINX logs:</p>
<pre><code>avg(rate(({job="nginx"} |= "GET")[10s])) by (region)</code></pre><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://happywzy.top/linux-xi-tong-ci-pan-shi-yong-qing-kuang-xiang-guan-ming-ling/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="wuzhiyong">
      <meta itemprop="description" content="日常学习笔记,共同进步">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Happywzy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/linux-xi-tong-ci-pan-shi-yong-qing-kuang-xiang-guan-ming-ling/" class="post-title-link" itemprop="url">Linux系统磁盘使用情况相关命令</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-08 11:16:42" itemprop="dateCreated datePublished" datetime="2020-01-08T11:16:42+08:00">2020-01-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-16 10:02:09" itemprop="dateModified" datetime="2020-04-16T10:02:09+08:00">2020-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="df命令"><a href="#df命令" class="headerlink" title="df命令"></a>df命令</h3><p>Linux df命令用于显示目前在Linux系统上的文件系统的磁盘使用情况统计。</p>
<pre><code>df -h</code></pre><pre><code>df -h /home</code></pre><pre><code>df --total</code></pre><h3 id="du命令"><a href="#du命令" class="headerlink" title="du命令"></a>du命令</h3><p>Linux du命令用于显示目录或文件的大小。<br>du会显示指定的目录或文件所占用的磁盘空间。</p>
<ul>
<li>查看当前目录下文件夹所占磁盘大小<pre><code>du</code></pre></li>
<li>查看当前目录下文件夹所占磁盘大小，并格式单位<pre><code>du -h</code></pre></li>
<li>查看当前目录下文件夹所占磁盘大小，并显示时间<pre><code>du --time</code></pre></li>
<li>查看文件占用空间<pre><code>du test.log</code></pre></li>
<li>查看文件占用空间<pre><code>du test</code></pre></li>
<li>以M为单位<pre><code>du -m</code></pre></li>
<li>以K为单位<pre><code>du -k</code></pre></li>
<li>只显示总计，不显示子目录<pre><code>du -s</code></pre></li>
<li>设置目录层数<pre><code>du --max-depth=1</code></pre></li>
</ul>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://happywzy.top/docker-la-ji-shou-ji/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="wuzhiyong">
      <meta itemprop="description" content="日常学习笔记,共同进步">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Happywzy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/docker-la-ji-shou-ji/" class="post-title-link" itemprop="url">docker垃圾收集</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-01-08 10:54:25 / 修改时间：11:46:41" itemprop="dateCreated datePublished" datetime="2020-01-08T10:54:25+08:00">2020-01-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="查看tag为none的镜像"><a href="#查看tag为none的镜像" class="headerlink" title="查看tag为none的镜像"></a>查看tag为none的镜像</h3><pre class="line-numbers language-bash"><code class="language-bash">docker images -f <span class="token string">"dangling=true"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="删除tag为none的镜像"><a href="#删除tag为none的镜像" class="headerlink" title="删除tag为none的镜像"></a>删除tag为none的镜像</h3><pre class="line-numbers language-bash"><code class="language-bash">docker rmi <span class="token punctuation">$(</span>docker images -f <span class="token string">"dangling=true"</span> -q<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="查看docker占用的磁盘空间"><a href="#查看docker占用的磁盘空间" class="headerlink" title="查看docker占用的磁盘空间"></a>查看docker占用的磁盘空间</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># docker system df</span>
TYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE
Images              35                  3                   5.039GB             4.603GB <span class="token punctuation">(</span>91%<span class="token punctuation">)</span>
Containers          3                   2                   19.69kB             19.5kB <span class="token punctuation">(</span>99%<span class="token punctuation">)</span>
Local Volumes       28                  0                   3.782MB             3.782MB <span class="token punctuation">(</span>100%<span class="token punctuation">)</span>
Build Cache         0                   0                   0B                  0B<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="查找所有无用的volume"><a href="#查找所有无用的volume" class="headerlink" title="查找所有无用的volume"></a>查找所有无用的volume</h3><pre class="line-numbers language-bash"><code class="language-bash">docker volume <span class="token function">ls</span> -qf dangling<span class="token operator">=</span>true<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="删除所有无用的volume"><a href="#删除所有无用的volume" class="headerlink" title="删除所有无用的volume"></a>删除所有无用的volume</h3><pre class="line-numbers language-bash"><code class="language-bash">docker volume <span class="token function">rm</span> <span class="token variable"><span class="token variable">$(</span>docker volume <span class="token function">ls</span> -qf dangling<span class="token operator">=</span>true<span class="token variable">)</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="查看所有docker文件夹"><a href="#查看所有docker文件夹" class="headerlink" title="查看所有docker文件夹"></a>查看所有docker文件夹</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">find</span> / -name docker<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p>可以使用<code>df</code>或者<code>du</code>命令查看文件夹具体使用情况，参考<a href="https://haolin.club/2020/01/08/linux-xi-tong-ci-pan-shi-yong-qing-kuang-xiang-guan-ming-ling/" target="_blank" rel="noopener">Linux系统磁盘使用情况相关命令</a>.<br>如:  </p>
<pre><code>du -hs /var/lib/docker/</code></pre></blockquote>
<h3 id="查找所有未运行的容器"><a href="#查找所有未运行的容器" class="headerlink" title="查找所有未运行的容器"></a>查找所有未运行的容器</h3><pre class="line-numbers language-bash"><code class="language-bash">docker <span class="token function">ps</span> -a<span class="token operator">|</span><span class="token function">grep</span> Exited<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-bash"><code class="language-bash">docker <span class="token function">ps</span> -qf status<span class="token operator">=</span>exited<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="删除所有未运行的容器"><a href="#删除所有未运行的容器" class="headerlink" title="删除所有未运行的容器"></a>删除所有未运行的容器</h3><pre class="line-numbers language-bash"><code class="language-bash">docker <span class="token function">rm</span> <span class="token punctuation">$(</span>docker <span class="token function">ps</span> -a<span class="token operator">|</span><span class="token function">grep</span> Exited <span class="token operator">|</span><span class="token function">awk</span> <span class="token string">'{print <span class="token variable">$1</span>}'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="prune命令"><a href="#prune命令" class="headerlink" title="prune命令"></a><font color="red"><strong>prune命令</strong></font></h3><ul>
<li>删除所有无用的容器</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">docker container prune<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>删除所有无用的镜像</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">docker image prune<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>删除所有无用的volume</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">docker volume prune<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>删除所有无用的network</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">docker network prune<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>删除docker系统中所有无用的，包括容器、镜像、volume、网络等</li>
</ul>
<pre class="line-numbers language-bash"><code class="language-bash">docker system prune<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p><strong>注意</strong><code>docker system prune</code>和<code>docker system prune -a</code>两者的区别：  </p>
<hr>
<p>[root@node1 ~]# <code>docker system prune</code><br>WARNING! This will remove:</p>
<ul>
<li>all stopped containers</li>
<li>all networks not used by at least one container</li>
<li>all dangling images</li>
<li>all dangling build cache<br>Are you sure you want to continue? [y/N]</li>
</ul>
<hr>
<p>[root@node1 ~]# <code>docker system prune -a</code><br>WARNING! This will remove:</p>
<ul>
<li>all stopped containers</li>
<li>all networks not used by at least one container</li>
<li>all images without at least one container associated to them</li>
<li>all build cache<br>Are you sure you want to continue? [y/N]</li>
</ul>
</blockquote>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://happywzy.top/k8s-zheng-shu-guan-li-cert-manager-zi-dong-qian-fa-geng-xin-zheng-shu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="wuzhiyong">
      <meta itemprop="description" content="日常学习笔记,共同进步">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Happywzy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/k8s-zheng-shu-guan-li-cert-manager-zi-dong-qian-fa-geng-xin-zheng-shu/" class="post-title-link" itemprop="url">k8s证书管理【Cert-manager自动签发/更新证书】</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-07 15:03:34" itemprop="dateCreated datePublished" datetime="2020-01-07T15:03:34+08:00">2020-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-07-14 10:02:12" itemprop="dateModified" datetime="2020-07-14T10:02:12+08:00">2020-07-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>Cert-manager 是一个云原生证书管理开源项目，用于在 Kubernetes 集群中提供 HTTPS 证书并自动续期，支持 Let’s Encrypt, HashiCorp Vault 这些免费证书的签发。在Kubernetes集群中，我们可以通过 Kubernetes Ingress 和 Let’s Encrypt 实现外部服务的自动化 HTTPS。<br>本文 Cert manager使用版本：<font color="red"><strong>v0.12.0</strong></font><br><img src="/images/cert-manager.png" alt="cert-manager"><br>强烈建议参考官方文档：<a href="https://cert-manager.io/docs" target="_blank" rel="noopener">https://cert-manager.io/docs</a></p>
</blockquote>
<h3 id="添加helm源"><a href="#添加helm源" class="headerlink" title="添加helm源"></a>添加helm源</h3><blockquote>
<p>注意<a href="https://github.com/helm/charts/tree/master/stable/cert-manager" target="_blank" rel="noopener">stable/cert-manager</a>已经过时不再维护了，转到<a href="https://github.com/jetstack/cert-manager/tree/master/deploy/charts/cert-manager" target="_blank" rel="noopener">jetstack/cert-manager</a>。</p>
</blockquote>
<pre class="line-numbers language-bash"><code class="language-bash">helm repo add jetstack https://charts.jetstack.io<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="更新源"><a href="#更新源" class="headerlink" title="更新源"></a>更新源</h3><pre class="line-numbers language-bash"><code class="language-bash">helm repo update<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="创建CRDs"><a href="#创建CRDs" class="headerlink" title="创建CRDs"></a>创建CRDs</h3><pre class="line-numbers language-bash"><code class="language-bash">kubectl apply --validate<span class="token operator">=</span>false -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.12/deploy/manifests/00-crds.yaml
或
kubectl create -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.12/deploy/manifests/00-crds.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><blockquote>
<p>这里设置了两个默认值<br>–set ingressShim.defaultIssuerName=<font color="red"><strong>letsencrypt-prod</strong></font><br>–set ingressShim.defaultIssuerKind=ClusterIssuer<br>–set ingressShim.defaultIssuerGroup=cert-manager.io<br>用于在后续创建Ingress时，配合annotations<br>kubernetes.io/tls-acme: “true”<br>kubernetes.io/ingress.class: “nginx”<br>实现<strong>自动创建</strong>证书。</p>
</blockquote>
<pre class="line-numbers language-bash"><code class="language-bash">helm <span class="token function">install</span> --name cert-manager --namespace cert-manager --set ingressShim.defaultIssuerName<span class="token operator">=</span>letsencrypt-prod --set ingressShim.defaultIssuerKind<span class="token operator">=</span>ClusterIssuer --set ingressShim.defaultIssuerGroup<span class="token operator">=</span>cert-manager.io jetstack/cert-manager<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="查看安装是否完成"><a href="#查看安装是否完成" class="headerlink" title="查看安装是否完成"></a>查看安装是否完成</h3><blockquote>
<p>注意事项：下面的<code>pod</code>需要部署在可以访问外网的机器上.</p>
</blockquote>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master cert<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get pod -n cert-manager</span>
NAME                                      READY   STATUS    RESTARTS   AGE
cert-manager-5cd477f7bb-fxpvf             1/1     Running   0          22m
cert-manager-cainjector-df4dc78cd-l527b   1/1     Running   0          22m
cert-manager-webhook-5f78ff89bc-ggvqt     1/1     Running   0          22m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master cert<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get crd | grep cert-manager</span>
certificaterequests.cert-manager.io         2020-01-07T01:38:32Z
certificates.cert-manager.io                2020-01-07T01:38:32Z
challenges.acme.cert-manager.io             2020-01-07T01:38:32Z
clusterissuers.cert-manager.io              2020-01-07T01:38:32Z
issuers.cert-manager.io                     2020-01-07T01:38:32Z
orders.acme.cert-manager.io                 2020-01-07T01:38:32Z<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="创建默认签发机构"><a href="#创建默认签发机构" class="headerlink" title="创建默认签发机构"></a>创建默认签发机构</h3><p>刚刚安装时已经指定了默认签发类型是<code>ClusterIssuer</code> ，签发机构名称是<code>letsencrypt-prod</code> ，但是我们还没有创建，现在需要创建<code>cluster-issuer.yaml</code>。 </p>
<blockquote>
<p>cert-manager 给我们提供了 <code>Issuer</code> 和 <code>ClusterIssuer</code> 这两种用于创建签发机构的自定义资源对象，<code>Issuer</code> 只能用来签发自己所在 namespace 下的证书，<code>ClusterIssuer</code> 可以签发任意 namespace 下的证书.</p>
</blockquote>
<pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> cert<span class="token punctuation">-</span>manager.io/v1alpha2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterIssuer
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> letsencrypt<span class="token punctuation">-</span>prod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">acme</span><span class="token punctuation">:</span>
    <span class="token key atrule">server</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//acme<span class="token punctuation">-</span>v02.api.letsencrypt.org/directory
    <span class="token key atrule">email</span><span class="token punctuation">:</span> 1154365135@qq.com
    <span class="token key atrule">privateKeySecretRef</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> letsencrypt<span class="token punctuation">-</span>prod
    <span class="token key atrule">solvers</span><span class="token punctuation">:</span>    
    <span class="token punctuation">-</span> <span class="token key atrule">http01</span><span class="token punctuation">:</span>
        <span class="token key atrule">ingress</span><span class="token punctuation">:</span>
          <span class="token key atrule">class</span><span class="token punctuation">:</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>上述配置，更多配置参考<a href="https://cert-manager.io/docs/reference/api-docs/#cert-manager.io/v1alpha2.ClusterIssuer" target="_blank" rel="noopener">ClusterIssuer</a></p>
<ul>
<li><code>metadata.name</code> 是我们创建的签发机构的名称，后面我们创建证书的时候会引用它</li>
<li><code>spec.acme.email</code> 是你自己的邮箱，证书快过期的时候会有邮件提醒，不过 cert-manager 会利用 acme 协议自动给我们重新颁发证书来续期</li>
<li><code>spec.acme.server</code> 是 acme 协议的服务端，我们这里用 Let’s Encrypt，这个地址就写死成这样就行</li>
<li><code>spec.acme.privateKeySecretRef</code> 指示此签发机构的私钥将要存储到哪个 Secret 对象中，名称不重要</li>
<li><code>spec.acme.solvers.http01</code> 这里指示签发机构使用 HTTP-01 的方式进行 acme 协议 (还可以用 DNS 方式，acme 协议的目的是证明这台机器和域名都是属于你的，然后才准许给你颁发证书)</li>
</ul>
</blockquote>
<pre class="line-numbers language-bash"><code class="language-bash">kubectl create -f cluster-issuer.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-bash"><code class="language-bash">kubectl get clusterissuer<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="配置ingress"><a href="#配置ingress" class="headerlink" title="配置ingress"></a>配置ingress</h3><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">kubernetes.io/ingress.class</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">kubernetes.io/tls-acme</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/backend-protocol</span><span class="token punctuation">:</span> HTTPS
    <span class="token key atrule">nginx.ingress.kubernetes.io/ssl-redirect</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
    <span class="token key atrule">chart</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>1.10.0
    <span class="token key atrule">heritage</span><span class="token punctuation">:</span> Tiller
    <span class="token key atrule">release</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> k8s.deri.com
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">443</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> k8s.deri.com
    <span class="token key atrule">secretName</span><span class="token punctuation">:</span> deri<span class="token punctuation">-</span>com<span class="token punctuation">-</span>tls<span class="token punctuation">-</span>secret<span class="token punctuation">-</span>cc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于添加了<code>annotations kubernetes.io/tls-acme: "true"</code>，tls这个secret会自动创建。</p>
<blockquote>
<p>创建完成后隔一会儿我们可以看到会多出现一个随机名称的 Ingress 对象<code>cm-acme-http-solver-hl5sx</code>，这个 Ingress 对象就是用来专门验证证书的：</p>
<pre class="line-numbers language-bash"><code class="language-bash">$ kubectl get ingress -n gateway
NAME                        HOSTS                   ADDRESS   PORTS     AGE
cm-acme-http-solver-hl5sx   cs.deri.com             80        37s
kube-ui                     cs.deri.com             80, 443   41s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</blockquote>
<p>验证成功后，这个 Ingress 对象会自动删除.</p>
<h3 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h3><pre class="line-numbers language-bash"><code class="language-bash">helm delete --purge cert-manager<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-bash"><code class="language-bash">kubectl delete -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.12/deploy/manifests/00-crds.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="Check"><a href="#Check" class="headerlink" title="Check"></a>Check</h3><p>检查服务是否正常</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get certificate -n gateway </span>
NAME              READY   SECRET            AGE
consul-tls-test   True    consul-tls-test   19m

<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get clusterissuer</span>
NAME               READY   AGE
letsencrypt-prod   True    157m

<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get certificate -n gateway </span>
NAME              READY   SECRET            AGE
consul-tls-test   True    consul-tls-test   19m

<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get Order -n gateway</span>
NAME                                    STATE   AGE
consul-tls-test-3546184973-1845474898   valid   20m

<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get  CertificateRequest -n gateway</span>
NAME                         READY   AGE
consul-tls-test-3546184973   True    27m

<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get secret -ngateway</span>
NAME                      TYPE                                  DATA   AGE
consul-tls-test           kubernetes.io/tls                     3      29m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="用到的镜像"><a href="#用到的镜像" class="headerlink" title="用到的镜像"></a>用到的镜像</h3><pre><code>quay.io/jetstack/cert-manager-cainjector:v0.12.0
quay.io/jetstack/cert-manager-webhook:v0.12.0
quay.io/jetstack/cert-manager-controller:v0.12.0
#这里由于上面配置solve是acme所以用到这个镜像，如果你配置别的，可能不一致
quay.io/jetstack/cert-manager-acmesolver:v0.12.0</code></pre><script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://happywzy.top/docker-la-qu-guo-wai-jing-xiang-shi-bai-quay-io-he-gcr-io-jie-jue-ban-fa/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="wuzhiyong">
      <meta itemprop="description" content="日常学习笔记,共同进步">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Happywzy">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/docker-la-qu-guo-wai-jing-xiang-shi-bai-quay-io-he-gcr-io-jie-jue-ban-fa/" class="post-title-link" itemprop="url">docker拉取国外镜像失败【quay.io和gcr.io解决办法】</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-01-07 14:53:44 / 修改时间：14:56:25" itemprop="dateCreated datePublished" datetime="2020-01-07T14:53:44+08:00">2020-01-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>使用国内镜像源。</p>
</blockquote>
<h3 id="quay-io"><a href="#quay-io" class="headerlink" title="quay.io"></a>quay.io</h3><p>例如下面拉取比较慢</p>
<pre class="line-numbers language-bash"><code class="language-bash">docker pull quay.io/jetstack/cert-manager-cainjector:v0.12.0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>可以换成</p>
<pre class="line-numbers language-bash"><code class="language-bash">docker pull quay-mirror.qiniu.com/jetstack/cert-manager-cainjector:v0.12.0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="gcr-io"><a href="#gcr-io" class="headerlink" title="gcr.io"></a>gcr.io</h3><p>例如下面拉取比较慢</p>
<pre class="line-numbers language-bash"><code class="language-bash">docker pull gcr.io/google_containers/kube-proxy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>可以换成阿里云的</p>
<pre class="line-numbers language-bash"><code class="language-bash">docker pull registry.aliyuncs.com/google_containers/kube-proxy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="下载完成"><a href="#下载完成" class="headerlink" title="下载完成"></a>下载完成</h3><p>可以使用tag命令改回去</p>
<pre class="line-numbers language-bash"><code class="language-bash">docker tag <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/31/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/31/">31</a><span class="page-number current">32</span><a class="page-number" href="/page/33/">33</a><span class="space">&hellip;</span><a class="page-number" href="/page/43/">43</a><a class="extend next" rel="next" href="/page/33/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="wuzhiyong"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">wuzhiyong</p>
  <div class="site-description" itemprop="description">日常学习笔记,共同进步</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">258</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">183</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/happywzy" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;happywzy" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1154365135@qq.com" title="E-Mail → mailto:1154365135@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://blog.csdn.net/wzy_168" title="https:&#x2F;&#x2F;blog.csdn.net&#x2F;wzy_168" rel="noopener" target="_blank">CSDN</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://gitee.com/happywzy" title="https:&#x2F;&#x2F;gitee.com&#x2F;happywzy" rel="noopener" target="_blank">Gitee</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wuzhiyong</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


  
  <script type="text/javascript" color="0,0,0" opacity='0.7' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
  
</body>
</html>
