<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>hadoop单机版部署测试</title>
      <link href="/2020/05/07/hadoop-dan-ji-ban-bu-shu-ce-shi/"/>
      <url>/2020/05/07/hadoop-dan-ji-ban-bu-shu-ce-shi/</url>
      
        <content type="html"><![CDATA[<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><ul><li><a href="https://mirrors.tuna.tsinghua.edu.cn/apache/hadoop/common/" target="_blank" rel="noopener">hadoop-2.7.7.tar.gz</a></li></ul><h3 id="配置ssh无密码登录"><a href="#配置ssh无密码登录" class="headerlink" title="配置ssh无密码登录"></a>配置ssh无密码登录</h3><pre class="line-numbers language-sh"><code class="language-sh"># 测试ssh localhost, 默认需要密码[root@node1 hadoop]# ssh localhostThe authenticity of host 'localhost (::1)' can't be established.ECDSA key fingerprint is SHA256:Ii9RadytomW4X2LEvMQwRxoOTeGgxfNbOgwXrc/wwZI.ECDSA key fingerprint is MD5:bc:b5:ef:93:e6:fd:7c:cd:a3:4f:a7:f6:4c:24:c7:a7.Are you sure you want to continue connecting (yes/no)? yesWarning: Permanently added 'localhost' (ECDSA) to the list of known hosts.root@localhost's password: <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-sh"><code class="language-sh">ssh-keygen -t dsa -P '' -f ~/.ssh/id_dsacat ~/.ssh/id_dsa.pub &gt;&gt; ~/.ssh/authorized_keys<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre class="line-numbers language-sh"><code class="language-sh"># 测试免密登录,无需密码即可登录成功[root@node1 hadoop]# ssh localhostLast failed login: Thu May  7 11:44:07 CST 2020 from localhost on ssh:nottyThere was 1 failed login attempt since the last successful login.Last login: Thu May  7 11:43:04 2020 from 192.168.41.1[root@node1 ~]# <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="配置java环境"><a href="#配置java环境" class="headerlink" title="配置java环境"></a>配置java环境</h3><pre class="line-numbers language-sh"><code class="language-sh">#已经部署过了[root@node1 hadoop]# echo $JAVA_HOME/usr/local/bin/jdk1.8.0_112<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="安装hadoop"><a href="#安装hadoop" class="headerlink" title="安装hadoop"></a>安装hadoop</h3><p>将<code>hadoop-2.7.7.tar.gz</code>拷贝到<code>/root/hadoop</code>目录下并解压.</p><pre class="line-numbers language-sh"><code class="language-sh">[root@node1 hadoop]# pwd/root/hadoop[root@node1 hadoop]# tar -zxvf hadoop-2.7.7.tar.gz <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>在<code>/etc/profile</code>或者<code>~/.bash_profile</code>配置环境变量<code>HADOOP_HOME</code>.</p><pre class="line-numbers language-sh"><code class="language-sh">export HADOOP_HOME=/root/hadoop/hadoop-2.7.7export PATH=$PATH:$HADOOP_HOME/bin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>使配置生效</p><pre class="line-numbers language-sh"><code class="language-sh">source /etc/profile<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="配置hadoop"><a href="#配置hadoop" class="headerlink" title="配置hadoop"></a>配置hadoop</h3><p>进入<code>$HADOOP_HOME/etc/hadoop</code>目录，配置<code>hadoop-env.sh</code>等。涉及的配置文件如下：</p><pre><code>hadoop-2.9.2/etc/hadoop/hadoop-env.shhadoop-2.9.2/etc/hadoop/yarn-env.shhadoop-2.9.2/etc/hadoop/core-site.xmlhadoop-2.9.2/etc/hadoop/hdfs-site.xmlhadoop-2.9.2/etc/hadoop/mapred-site.xmlhadoop-2.9.2/etc/hadoop/yarn-site.xml</code></pre><ol><li><p>配置<code>hadoop-env.sh</code></p><pre class="line-numbers language-sh"><code class="language-sh"># The java implementation to use.export JAVA_HOME=${JAVA_HOME}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>配置<code>yarn-env.sh</code></p><pre class="line-numbers language-sh"><code class="language-sh">#export JAVA_HOME=/home/y/libexec/jdk1.6.0/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>配置<code>core-site.xml</code></p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>　　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>fs.default.name<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>　　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>hdfs://192.168.41.128:9000<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>　　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>HDFS的URI，文件系统://namenode标识:端口号<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><property>　　<name>hadoop.tmp.dir</name>　　<value>/root/hadoop/tmp</value>　　<description>namenode上本地的hadoop临时文件夹</description></property>```<ol start="4"><li>配置<code>hdfs-site.xml</code><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>　　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>dfs.name.dir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>　　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>/root/hadoop/name<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>　　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>namenode上存储hdfs名字空间元数据 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><property>　　<name>dfs.data.dir</name>　　<value>/root/hadoop/data</value>　　<description>datanode上数据块的物理存储位置</description></property><property>　　<name>dfs.replication</name>　　<value>1</value>　　<description>副本个数，配置默认是3,应小于datanode机器数量</description>　　</property>```<ol start="5"><li><p>配置<code>mapred-site.xml</code></p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>　　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>mapreduce.framework.name<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>　　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>yarn<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>　　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>配置<code>yarn-site.xml</code></p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>　　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.nodemanager.aux-services<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>　　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>mapreduce_shuffle<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>　　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>yarn.resourcemanager.webapp.address<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>　　<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>${yarn.resourcemanager.hostname}:8099<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h3 id="启动hadoop"><a href="#启动hadoop" class="headerlink" title="启动hadoop"></a>启动hadoop</h3><ol><li><p>格式化hdfs文件系统</p><pre class="line-numbers language-sh"><code class="language-sh">bin/hadoop namenode -format<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>启动namenode</p><pre><code>sbin/hadoop-daemon.sh start namenode</code></pre></li><li><p>启动datanode</p><pre><code>sbin/hadoop-daemon.sh start datanode</code></pre></li><li><p>启动yarn</p><pre><code>sbin/start-yarn.sh</code></pre></li><li><p>验证<br>查看<code>logs/</code>目录下是否有错误日志,通过<code>jps</code>命令查看后台进程.</p><pre class="line-numbers language-sh"><code class="language-sh">[root@node1 hadoop-2.7.7]# jps17152 NodeManager17920 Jps16721 DataNode #数据节点16866 ResourceManager62190 HMaster # Hbase16623 NameNode #名称节点<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>查看<code>UI</code></p></li></ol><ul><li>Nodes of the cluster: <a href="http://192.168.41.128:8099/cluster/nodes" target="_blank" rel="noopener">http://192.168.41.128:8099/cluster/nodes</a></li><li>Applications running on this node: <a href="http://192.168.41.128:8042/node/allApplications" target="_blank" rel="noopener">http://192.168.41.128:8042/node/allApplications</a></li><li>Browse Hdfs: <a href="http://192.168.41.128:50070/" target="_blank" rel="noopener">http://192.168.41.128:50070/</a></li><li>DataNode overview: <a href="http://192.168.41.128:50075/" target="_blank" rel="noopener">http://192.168.41.128:50075/</a></li></ul><h3 id="提交MapReduce作业"><a href="#提交MapReduce作业" class="headerlink" title="提交MapReduce作业"></a>提交<code>MapReduce</code>作业</h3><pre class="line-numbers language-sh"><code class="language-sh">bin/hadoop jar share/hadoop/mapreduce/hadoop-mapreduce-examples-2.7.7.jar pi 2 100<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="hdfs使用"><a href="#hdfs使用" class="headerlink" title="hdfs使用"></a>hdfs使用</h3><ol><li><p>创建一个目录</p><pre><code>hadoop fs -mkdir /test</code></pre></li><li><p>上传一个文件到指定目录</p><pre><code>hadoop fs -put README.txt /test</code></pre><p>或者</p><pre><code>hadoop fs -moveFromLocal README.txt /test</code></pre></li><li><p>查看目录下文件<br>```sh<br>[root@node1 hadoop-2.7.7]# hadoop fs -ls /test<br>Found 2 items</p></li></ol><p>-rw-r–r–   1 root supergroup      14978 2020-05-07 14:15 /test/NOTICE.txt<br>-rw-r–r–   1 root supergroup       1366 2020-05-07 14:18 /test/README.txt</p><p>```</p><blockquote><p>更多命令<a href="/2020/05/06/hdfs-chang-yong-ming-ling/">参考</a></p></blockquote><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hdfs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hadoop与hbase支持矩阵</title>
      <link href="/2020/05/07/hadoop-yu-hbase-zhi-chi-ju-zhen/"/>
      <url>/2020/05/07/hadoop-yu-hbase-zhi-chi-ju-zhen/</url>
      
        <content type="html"><![CDATA[<p>Hadoop版本支持矩阵：</p><ul><li><code>S</code>=支持</li><li><code>X</code>=不支持</li><li><code>NT</code>=未测试</li></ul><table><thead><tr><th>HBase的-1.1.x中</th><th>HBase的-1.2.x的</th><th>HBase的-1.3.x的</th><th>HBase的-2.0.x版本</th><th></th></tr></thead><tbody><tr><td>Hadoop-2.0.x-alpha</td><td>X</td><td>X</td><td>X</td><td>X</td></tr><tr><td>Hadoop-2.1.0-beta</td><td>X</td><td>X</td><td>X</td><td>X</td></tr><tr><td>Hadoop-2.2.0</td><td>NT</td><td>X</td><td>X</td><td>X</td></tr><tr><td>Hadoop-2.3.x</td><td>NT</td><td>X</td><td>X</td><td>X</td></tr><tr><td>Hadoop-2.4.x</td><td>S</td><td>S</td><td>S</td><td>X</td></tr><tr><td>Hadoop-2.5.x</td><td>S</td><td>S</td><td>S</td><td>X</td></tr><tr><td>Hadoop-2.6.0</td><td>X</td><td>X</td><td>X</td><td>X</td></tr><tr><td>Hadoop-2.6.1+</td><td>NT</td><td>S</td><td>S</td><td>S</td></tr><tr><td>Hadoop-2.7.0</td><td>X</td><td>X</td><td>X</td><td>X</td></tr><tr><td>Hadoop-2.7.1+</td><td>NT</td><td>S</td><td>S</td><td>S</td></tr><tr><td>Hadoop-2.8.0</td><td>X</td><td>X</td><td>X</td><td>X</td></tr><tr><td>Hadoop-2.8.1</td><td>X</td><td>X</td><td>X</td><td>X</td></tr><tr><td>Hadoop-3.0.0</td><td>NT</td><td>NT</td><td>NT</td><td>NT</td></tr></tbody></table><blockquote><p>建议使用 Hadoop 2.x：Hadoop 2.x 速度更快，包括短路读取功能，这将有助于提高您的 HBase 随机读取配置文件；Hadoop 2.x 还包括重要的 bug 修复，可以改善您的整体 HBase 体验；HBase 不支持使用早期版本的 Hadoop 运行；有关特定于不同 HBase 版本的要求，请参见下表；Hadoop 3.x 仍处于早期访问版本中，尚未被 HBase 社区对生产用例进行充分测试。</p></blockquote><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hbase </tag>
            
            <tag> hadoop </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hdfs常用命令</title>
      <link href="/2020/05/06/hdfs-chang-yong-ming-ling/"/>
      <url>/2020/05/06/hdfs-chang-yong-ming-ling/</url>
      
        <content type="html"><![CDATA[<table><thead><tr><th>命令</th><th>使用方法</th><th>说明</th></tr></thead><tbody><tr><td><code>ls</code></td><td><code>hadoop fs -ls</code></td><td>返回文件详细信息或者目录列表</td></tr><tr><td><code>lsr</code></td><td><code>hadoop fs -lsr</code></td><td>递归返回文件详细信息或者目录列表,类似<code>ls -R</code></td></tr><tr><td><code>cat</code></td><td><code>hadoop fs -cat URI</code></td><td>返回文件内容</td></tr><tr><td><code>chgrp</code></td><td><code>hadoop fs -chgrp [-R] GROUP URI</code></td><td>改变文件所属组</td></tr><tr><td><code>chmod</code></td><td><code>hadoop fs -chmod [-R]</code></td><td>改变文件的权限</td></tr><tr><td><code>chown</code></td><td><code>hadoop fs -chown [-R]</code></td><td>改变文件拥有者</td></tr><tr><td><code>put</code></td><td><code>hadoop fs -put</code></td><td>上传文件</td></tr><tr><td><code>copyFromLocal</code></td><td><code>hadoop fs -copyFromLocal URI</code></td><td>上传文件</td></tr><tr><td><code>moveFromLocal</code></td><td><code>hadoop fs -moveFromLocal</code></td><td>上传文件</td></tr><tr><td><code>get</code></td><td><code>hadoop fs -get [-ignorecrc] [-crc]</code></td><td>下载文件</td></tr><tr><td><code>copyToLocal</code></td><td><code>hadoop fs -copyToLocal [-ignorecrc] [-crc]</code></td><td>下载文件</td></tr><tr><td><code>cp</code></td><td><code>hadoop fs -cp URI</code></td><td>复制文件</td></tr><tr><td><code>du</code></td><td><code>hadoop fs -du URI</code></td><td>显示所有文件大小</td></tr><tr><td><code>dus</code></td><td><code>hadoop fs -dus</code></td><td>显示文件大小</td></tr><tr><td><code>expunge</code></td><td><code>hadoop fs -expunge</code></td><td>清空回收站</td></tr><tr><td><code>getmerge</code></td><td><code>hadoop fs -getmerge [addnl]</code></td><td></td></tr><tr><td><code>mkdir</code></td><td><code>hadoop fs -mkdir</code></td><td>创建目录</td></tr><tr><td><code>mv</code></td><td><code>hadoop fs -mv URI</code></td><td>移动</td></tr><tr><td><code>rm</code></td><td><code>hadoop fs -rm URI</code></td><td>删除非空目录和文件</td></tr><tr><td><code>rmr</code></td><td><code>hadoop fs -rmr</code></td><td>递归删除</td></tr><tr><td><code>setrep</code></td><td><code>hadoop fs -setrep [-R]</code></td><td>改变文件副本数</td></tr><tr><td><code>stat</code></td><td><code>hadoop fs -stat URI</code></td><td>返回统计信息</td></tr><tr><td><code>tail</code></td><td><code>hadoop fs -tail [-f] URI</code></td><td>返回文件尾部<code>1K</code>字节内容</td></tr><tr><td><code>test</code></td><td><code>hadoop fs -test -[ezd] URI</code></td><td><code>-e</code>检查文件是否存在,<code>-z</code>检查文件是否为空,<code>-d</code>检查文件是否是目录</td></tr><tr><td><code>text</code></td><td><code>hadoop fs -text</code></td><td>将文件输出和为文本格式,允许的格式<code>zip</code> <code>TextRecordInputStream</code></td></tr><tr><td><code>touchz</code></td><td><code>hadoop fs -touchz</code></td><td>创建一个空文件</td></tr></tbody></table><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hdfs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springboot返回的时间时区不对</title>
      <link href="/2020/04/29/springboot-fan-hui-de-shi-jian-shi-qu-bu-dui/"/>
      <url>/2020/04/29/springboot-fan-hui-de-shi-jian-shi-qu-bu-dui/</url>
      
        <content type="html"><![CDATA[<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">import</span> java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>Timestamp<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//对象中属性为</span><span class="token keyword">private</span> Timestamp startTime<span class="token punctuation">;</span><span class="token keyword">private</span> Timestamp endTime<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>通过<code>spring boot restful</code>接口返回到前端，时区自动转换不对，晚八个小时:</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token property">"startTime"</span><span class="token operator">:</span> <span class="token string">"2020-04-29T06:15:00.000+0000"</span><span class="token punctuation">,</span>    <span class="token property">"endTime"</span><span class="token operator">:</span> <span class="token string">"2020-04-29T06:15:00.000+0000"</span><span class="token punctuation">,</span>    <span class="token property">"taskResult"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p><code>application.yml</code>中指定日期格式和时区</p><pre class="line-numbers language-yml"><code class="language-yml">spring:  jackson:    date-format: yyyy-MM-dd HH:mm:ss    time-zone: Asia/Shanghai<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>再次测试:</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token property">"startTime"</span><span class="token operator">:</span> <span class="token string">"2020-04-29 14:15:00"</span><span class="token punctuation">,</span>    <span class="token property">"endTime"</span><span class="token operator">:</span> <span class="token string">"2020-04-29 14:15:00"</span><span class="token punctuation">,</span>    <span class="token property">"taskResult"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> spring boot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring boot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dataway集成springboot在线开发restful接口</title>
      <link href="/2020/04/28/dataway-ji-cheng-springboot-zai-xian-kai-fa-restful-jie-kou/"/>
      <url>/2020/04/28/dataway-ji-cheng-springboot-zai-xian-kai-fa-restful-jie-kou/</url>
      
        <content type="html"><![CDATA[<h3 id="创建一个spring-boot-web基本项目"><a href="#创建一个spring-boot-web基本项目" class="headerlink" title="创建一个spring boot web基本项目"></a>创建一个spring boot web基本项目</h3><h3 id="引入dataway相关依赖"><a href="#引入dataway相关依赖" class="headerlink" title="引入dataway相关依赖"></a>引入dataway相关依赖</h3><pre class="line-numbers language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!-- hasor-spring 负责 Spring 和 Hasor 框架之间的整合。 --&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>net.hasor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hasor-spring<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.1.3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token comment" spellcheck="true">&lt;!-- hasor-dataway 是工作在 Hasor 之上，利用 hasor-spring 我们就可以使用 dataway了。 --&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>net.hasor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hasor-dataway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.1.3-fix20200414<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span><span class="token comment" spellcheck="true">&lt;!-- 4.1.3 包存在UI资源缺失问题 --&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token comment" spellcheck="true">&lt;!-- 数据库相关依赖 --&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.30<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>druid<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.1.21<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>druid-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.1.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="mysql数据库中创建表"><a href="#mysql数据库中创建表" class="headerlink" title="mysql数据库中创建表"></a>mysql数据库中创建表</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>interface_info<span class="token punctuation">`</span> <span class="token punctuation">(</span>    <span class="token punctuation">`</span>api_id<span class="token punctuation">`</span>          <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>      <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span>   <span class="token keyword">COMMENT</span> <span class="token string">'ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>api_method<span class="token punctuation">`</span>      <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>  <span class="token operator">NOT</span> <span class="token boolean">NULL</span>                  <span class="token keyword">COMMENT</span> <span class="token string">'HttpMethod：GET、PUT、POST'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>api_path<span class="token punctuation">`</span>        <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>                  <span class="token keyword">COMMENT</span> <span class="token string">'拦截路径'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>api_status<span class="token punctuation">`</span>      <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>       <span class="token operator">NOT</span> <span class="token boolean">NULL</span>                  <span class="token keyword">COMMENT</span> <span class="token string">'状态：0草稿，1发布，2有变更，3禁用'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>api_comment<span class="token punctuation">`</span>     <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>     <span class="token boolean">NULL</span>                  <span class="token keyword">COMMENT</span> <span class="token string">'注释'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>api_type<span class="token punctuation">`</span>        <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span>  <span class="token operator">NOT</span> <span class="token boolean">NULL</span>                  <span class="token keyword">COMMENT</span> <span class="token string">'脚本类型：SQL、DataQL'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>api_script<span class="token punctuation">`</span>      <span class="token keyword">mediumtext</span>   <span class="token operator">NOT</span> <span class="token boolean">NULL</span>                  <span class="token keyword">COMMENT</span> <span class="token string">'查询脚本：xxxxxxx'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>api_schema<span class="token punctuation">`</span>      <span class="token keyword">mediumtext</span>       <span class="token boolean">NULL</span>                  <span class="token keyword">COMMENT</span> <span class="token string">'接口的请求/响应数据结构'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>api_sample<span class="token punctuation">`</span>      <span class="token keyword">mediumtext</span>       <span class="token boolean">NULL</span>                  <span class="token keyword">COMMENT</span> <span class="token string">'请求/响应/请求头样本数据'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>api_create_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span>     <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>api_gmt_time<span class="token punctuation">`</span>    <span class="token keyword">datetime</span>     <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'修改时间'</span><span class="token punctuation">,</span>    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>api_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'Dataway 中的API'</span><span class="token punctuation">;</span><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>interface_release<span class="token punctuation">`</span> <span class="token punctuation">(</span>    <span class="token punctuation">`</span>pub_id<span class="token punctuation">`</span>          <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>      <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span>   <span class="token keyword">COMMENT</span> <span class="token string">'Publish ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>pub_api_id<span class="token punctuation">`</span>      <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>      <span class="token operator">NOT</span> <span class="token boolean">NULL</span>                  <span class="token keyword">COMMENT</span> <span class="token string">'所属API ID'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>pub_method<span class="token punctuation">`</span>      <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>  <span class="token operator">NOT</span> <span class="token boolean">NULL</span>                  <span class="token keyword">COMMENT</span> <span class="token string">'HttpMethod：GET、PUT、POST'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>pub_path<span class="token punctuation">`</span>        <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>                  <span class="token keyword">COMMENT</span> <span class="token string">'拦截路径'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>pub_status<span class="token punctuation">`</span>      <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>       <span class="token operator">NOT</span> <span class="token boolean">NULL</span>                  <span class="token keyword">COMMENT</span> <span class="token string">'状态：0有效，1无效（可能被下线）'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>pub_type<span class="token punctuation">`</span>        <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span>  <span class="token operator">NOT</span> <span class="token boolean">NULL</span>                  <span class="token keyword">COMMENT</span> <span class="token string">'脚本类型：SQL、DataQL'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>pub_script<span class="token punctuation">`</span>      <span class="token keyword">mediumtext</span>   <span class="token operator">NOT</span> <span class="token boolean">NULL</span>                  <span class="token keyword">COMMENT</span> <span class="token string">'查询脚本：xxxxxxx'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>pub_script_ori<span class="token punctuation">`</span>  <span class="token keyword">mediumtext</span>   <span class="token operator">NOT</span> <span class="token boolean">NULL</span>                  <span class="token keyword">COMMENT</span> <span class="token string">'原始查询脚本，仅当类型为SQL时不同'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>pub_schema<span class="token punctuation">`</span>      <span class="token keyword">mediumtext</span>       <span class="token boolean">NULL</span>                  <span class="token keyword">COMMENT</span> <span class="token string">'接口的请求/响应数据结构'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>pub_sample<span class="token punctuation">`</span>      <span class="token keyword">mediumtext</span>       <span class="token boolean">NULL</span>                  <span class="token keyword">COMMENT</span> <span class="token string">'请求/响应/请求头样本数据'</span><span class="token punctuation">,</span>    <span class="token punctuation">`</span>pub_release_time<span class="token punctuation">`</span><span class="token keyword">datetime</span>     <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">COMMENT</span> <span class="token string">'发布时间（下线不更新）'</span><span class="token punctuation">,</span>    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>pub_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">0</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'Dataway API 发布历史。'</span><span class="token punctuation">;</span><span class="token keyword">create</span> <span class="token keyword">index</span> idx_interface_release <span class="token keyword">on</span> interface_release <span class="token punctuation">(</span>pub_api_id<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="在application-properties中配置hasor-dataway和数据源"><a href="#在application-properties中配置hasor-dataway和数据源" class="headerlink" title="在application.properties中配置hasor-dataway和数据源"></a>在<code>application.properties</code>中配置<code>hasor-dataway</code>和数据源</h3><pre class="line-numbers language-sh"><code class="language-sh"># 是否启用 Dataway 功能（必选：默认false）HASOR_DATAQL_DATAWAY=true# 是否开启 Dataway 后台管理界面（必选：默认false）HASOR_DATAQL_DATAWAY_ADMIN=true# dataway  API工作路径（可选，默认：/api/）HASOR_DATAQL_DATAWAY_API_URL=/api/# dataway-ui 的工作路径（可选，默认：/interface-ui/）HASOR_DATAQL_DATAWAY_UI_URL=/ui/# SQL执行器方言设置（可选，建议设置）HASOR_DATAQL_FX_PAGE_DIALECT=mysql# dbspring.datasource.url=jdbc:mysql://192.168.41.128:3306/compare?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=falsespring.datasource.username=rootspring.datasource.password=123456spring.datasource.driver-class-name=com.mysql.jdbc.Driverspring.datasource.type:com.alibaba.druid.pool.DruidDataSource# druidspring.datasource.druid.initial-size=3spring.datasource.druid.min-idle=3spring.datasource.druid.max-active=10spring.datasource.druid.max-wait=60000spring.datasource.druid.stat-view-servlet.login-username=adminspring.datasource.druid.stat-view-servlet.login-password=adminspring.datasource.druid.filter.stat.log-slow-sql=truespring.datasource.druid.filter.stat.slow-sql-millis=1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="把数据源设置到-Hasor-容器中"><a href="#把数据源设置到-Hasor-容器中" class="headerlink" title="把数据源设置到 Hasor 容器中"></a>把数据源设置到 Hasor 容器中</h3><p>首先新建一个 Hasor 的 模块，并且将其交给 Spring 管理。然后把数据源通过 Spring 注入进来。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@DimModule</span><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExampleModule</span>  <span class="token keyword">implements</span> <span class="token class-name">SpringModule</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Autowired</span>    <span class="token keyword">private</span> DataSource dataSource <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">loadModule</span><span class="token punctuation">(</span>ApiBinder apiBinder<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// .DataSource form Spring boot into Hasor</span>        apiBinder<span class="token punctuation">.</span><span class="token function">installModule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JdbcModule</span><span class="token punctuation">(</span>Level<span class="token punctuation">.</span>Full<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Hasor 启动的时候会调用 loadModule 方法，在这里再把 DataSource 设置到 Hasor 中。</p><h3 id="在SprintBoot-中启用-Hasor"><a href="#在SprintBoot-中启用-Hasor" class="headerlink" title="在SprintBoot 中启用 Hasor"></a>在SprintBoot 中启用 Hasor</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@EnableHasor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token annotation punctuation">@EnableHasorWeb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>scanBasePackages <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string">"com.deri.dataway.component"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DatawayApplication</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        SpringApplication<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>DatawayApplication<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="启动应用"><a href="#启动应用" class="headerlink" title="启动应用"></a>启动应用</h3><p>相关日志</p><pre class="line-numbers language-log"><code class="language-log"> _    _                        ____              _| |  | |                      |  _ \            | || |__| | __ _ ___  ___  _ __  | |_) | ___   ___ | |_|  __  |/ _` / __|/ _ \| '__| |  _ &lt; / _ \ / _ \| __|| |  | | (_| \__ \ (_) | |    | |_) | (_) | (_) | |_|_|  |_|\__,_|___/\___/|_|    |____/ \___/ \___/ \__|<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-log"><code class="language-log">2020-04-29 09:29:11.899  INFO 43336 --- [           main] net.hasor.dataway.config.DatawayModule   : dataway api workAt /api/2020-04-29 09:29:11.899  INFO 43336 --- [           main] n.h.c.environment.AbstractEnvironment    : var -&gt; HASOR_DATAQL_DATAWAY_API_URL = /api/.2020-04-29 09:29:11.903  INFO 43336 --- [           main] net.hasor.dataway.config.DatawayModule   : dataway admin workAt /ui/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="访问接口管理页面进行在线接口开发"><a href="#访问接口管理页面进行在线接口开发" class="headerlink" title="访问接口管理页面进行在线接口开发"></a>访问接口管理页面进行在线接口开发</h3><ul><li><code>http://localhost:8080/ui/</code><blockquote><p>注意：地址最后的<code>/</code>不能不写.</p></blockquote></li></ul><h3 id="DataQL"><a href="#DataQL" class="headerlink" title="DataQL"></a>DataQL</h3><p>新建一个restful接口，其中<code>var query = @@sql()&lt;% ... %&gt;</code>是用来定义<code>SQL</code>外部代码块，并将这个定义存入 <code>query</code>变量名中。<code>&lt;% %&gt;</code> 中间的就是<code>SQL</code>语句。</p><pre class="line-numbers language-sql"><code class="language-sql">var query <span class="token operator">=</span> @<span class="token variable">@sql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">%</span>    <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> interface_info<span class="token operator">%</span><span class="token operator">&gt;</span><span class="token keyword">return</span> query<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>运行测试没有问题，就可以保存-发布了.</p><blockquote><p>方便测试，请求方式可以写<code>GET</code>，<code>/api/</code>后面写上接口的路径.如<code>/api/test</code></p></blockquote><p>发布成功后，就可以访问刚刚发布的接口了<br><code>http://localhost:8080/api/test</code>.</p><p>结果示例：</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"success"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"OK"</span><span class="token punctuation">,</span>  <span class="token property">"code"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token property">"lifeCycleTime"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>  <span class="token property">"executionTime"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token property">"value"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>    <span class="token property">"task_id"</span><span class="token operator">:</span> <span class="token string">"m-20200904-3"</span><span class="token punctuation">,</span>    <span class="token property">"task_type"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>    <span class="token property">"task_data_type"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>    <span class="token property">"start_time"</span><span class="token operator">:</span> <span class="token number">1586491785000</span><span class="token punctuation">,</span>    <span class="token property">"end_time"</span><span class="token operator">:</span> <span class="token number">1586491785000</span><span class="token punctuation">,</span>    <span class="token property">"task_result"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>    <span class="token property">"remark"</span><span class="token operator">:</span> <span class="token string">"存在不一样"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul><li><a href="https://mp.weixin.qq.com/s?__biz=MzIwMTY0NDU3Nw==&amp;mid=2651942058&amp;idx=1&amp;sn=a92439d6bd966f4f0d7c35474789c033&amp;chksm=8d0f03e4ba788af200fdfaf759f0b0576828a6b93d1c49baf363d50848d0adba82e209e9ef4d&amp;scene=126&amp;sessionid=1588065339&amp;key=adf3334aef273b731f98a9ed5e4e29f2acaae3964a7a6a111ce90e47d0a63a9e5d9c61b510d7e947bb064a982eb2784fc777cecd75258a7515a3b4188b46ddfb3115ba6f05b7a1de42c4b56f0953949e&amp;ascene=1&amp;uin=MjI2NzI5NTQ4MQ%3D%3D&amp;devicetype=Windows+10+x64&amp;version=62090070&amp;lang=zh_CN&amp;exportkey=Ae8OdkEZFh3ST3QYp1brGd8%3D&amp;pass_ticket=fYzu4Or%2BWtaHwY7xWJJCcIY0FS%2B%2Fw%2FpjuohZY460VCqP32cvtxR3LUyWKVF50HCF" target="_blank" rel="noopener">绝了！Dataway让SpringBoot不在需要Controller、Service、DAO、Mapper了</a></li><li><a href="https://www.hasor.net/web/dataway/for_boot.html#" target="_blank" rel="noopener">hasor官方文档</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring boot </tag>
            
            <tag> dataway </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>分布式存储</title>
      <link href="/2020/04/26/fen-bu-shi-cun-chu/"/>
      <url>/2020/04/26/fen-bu-shi-cun-chu/</url>
      
        <content type="html"><![CDATA[<h3 id="CephFS"><a href="#CephFS" class="headerlink" title="CephFS"></a>CephFS</h3><h3 id="glusterfs"><a href="#glusterfs" class="headerlink" title="glusterfs"></a>glusterfs</h3><h3 id="rook"><a href="#rook" class="headerlink" title="rook"></a><a href="https://github.com/rook/rook" target="_blank" rel="noopener">rook</a></h3><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 分布式存储 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>rowkey字典排序</title>
      <link href="/2020/04/24/rowkey-zi-dian-pai-xu/"/>
      <url>/2020/04/24/rowkey-zi-dian-pai-xu/</url>
      
        <content type="html"><![CDATA[<h3 id="排序规则"><a href="#排序规则" class="headerlink" title="排序规则"></a>排序规则</h3><ul><li><code>rowkey</code>从高位到低位依照<code>ASCII</code>码表排序;如<code>A</code>排在<code>a</code>前面,<code>a</code>排在<code>aa</code> <code>ab</code>前面;</li><li>如果<code>rowkey</code>一样,按照<code>column family:qualifier</code>排序;</li><li>如果<code>column family:qualifier</code>一样,按照<code>时间戳</code>排序;</li></ul><h3 id="充分利用rowkey会排序特性"><a href="#充分利用rowkey会排序特性" class="headerlink" title="充分利用rowkey会排序特性"></a>充分利用<code>rowkey</code>会排序特性</h3><ol><li>如果热点数据的<code>rowkey</code>前缀一样，则很容易被存储在同一<code>RegionServer</code>上，这样就会造成访问的性能瓶颈;</li><li><code>rowkey</code>前缀提供一个随机字符串,可以更好的分布在集群中，但是失去了排序特性;</li><li><code>rowkey</code>应该设计的精简，过长会加长硬盘和网络IO的开销.</li></ol><h3 id="rowkey排序"><a href="#rowkey排序" class="headerlink" title="rowkey排序"></a><code>rowkey</code>排序</h3><ol><li><code>scan</code>返回的数据是按照<code>rowkey</code>排序;</li><li><code>API</code>可以设置<code>StartRow</code>、<code>StopRow</code>查询范围内数据;</li></ol><p>如<code>rowkey</code>是时间日期格式,以下可以查询<code>2020</code>年的数据:</p><pre class="line-numbers language-java"><code class="language-java">Scan scan <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>scan<span class="token punctuation">.</span><span class="token function">setStartRow</span><span class="token punctuation">(</span>Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token string">"20200101"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>scan<span class="token punctuation">.</span><span class="token function">setStopRow</span><span class="token punctuation">(</span>Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token string">"20210101"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>注意[<code>StartRow</code>,<code>StopRow</code>)左闭右开.</p></blockquote><h3 id="ASCII编码"><a href="#ASCII编码" class="headerlink" title="ASCII编码"></a><code>ASCII</code>编码</h3><p><img src="/images/asc.png" alt="ASCII"></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> hbase </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hbase </tag>
            
            <tag> rowkey </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hbase-client java API 操作</title>
      <link href="/2020/04/23/hbase-client-cao-zuo/"/>
      <url>/2020/04/23/hbase-client-cao-zuo/</url>
      
        <content type="html"><![CDATA[<h3 id="spring-boot集成hbase-client"><a href="#spring-boot集成hbase-client" class="headerlink" title="spring boot集成hbase-client"></a>spring boot集成hbase-client</h3><blockquote><p>参考上文使用<code>spring-boot-starter-hbase</code>和<code>RowMapper</code>.</p></blockquote><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span><span class="token keyword">private</span> HbaseTemplate hbaseTemplate<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*** 创建表* @return* @throws IOException*/</span><span class="token keyword">public</span> String <span class="token function">createTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>    Admin admin <span class="token operator">=</span> hbaseTemplate<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAdmin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    HTableDescriptor hTableDescriptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HTableDescriptor</span><span class="token punctuation">(</span>TableName<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>table_name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    hTableDescriptor<span class="token punctuation">.</span><span class="token function">addFamily</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HColumnDescriptor</span><span class="token punctuation">(</span>column_family<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>admin<span class="token punctuation">.</span><span class="token function">tableExists</span><span class="token punctuation">(</span>TableName<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>table_name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"tableExists"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        admin<span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span>hTableDescriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token string">"ok"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="批量插入数据"><a href="#批量插入数据" class="headerlink" title="批量插入数据"></a>批量插入数据</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*** 批量插入数据* @param i*/</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">puts</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>    List<span class="token operator">&lt;</span>Mutation<span class="token operator">&gt;</span> puts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 设值</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Put put <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Put</span><span class="token punctuation">(</span>Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span>Long<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>18752038428L <span class="token operator">-</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        put<span class="token punctuation">.</span><span class="token function">addColumn</span><span class="token punctuation">(</span>Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span>column_family<span class="token punctuation">)</span><span class="token punctuation">,</span> Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token string">"JThink"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        put<span class="token punctuation">.</span><span class="token function">addColumn</span><span class="token punctuation">(</span>Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span>column_family<span class="token punctuation">)</span><span class="token punctuation">,</span> Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token string">"age"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        puts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>put<span class="token punctuation">)</span><span class="token punctuation">;</span>        i<span class="token operator">--</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hbaseTemplate<span class="token punctuation">.</span><span class="token function">saveOrUpdates</span><span class="token punctuation">(</span>table_name<span class="token punctuation">,</span> puts<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="根据rowkey查询数据"><a href="#根据rowkey查询数据" class="headerlink" title="根据rowkey查询数据"></a>根据rowkey查询数据</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*** 根据rowkey查询数据* @param row* @return*/</span><span class="token keyword">public</span> PeopleDto <span class="token function">get</span><span class="token punctuation">(</span>String row<span class="token punctuation">)</span> <span class="token punctuation">{</span>    PeopleDto dto <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hbaseTemplate<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>table_name<span class="token punctuation">,</span> row<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PeopleRowMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> dto<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="根据rowkey删除数据"><a href="#根据rowkey删除数据" class="headerlink" title="根据rowkey删除数据"></a>根据rowkey删除数据</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*** 根据rowkey删除数据*/</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span>String rk<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Mutation delete <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Delete</span><span class="token punctuation">(</span>Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span>rk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>hbaseTemplate<span class="token punctuation">.</span><span class="token function">saveOrUpdate</span><span class="token punctuation">(</span>table_name<span class="token punctuation">,</span> delete<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="批量查询数据"><a href="#批量查询数据" class="headerlink" title="批量查询数据"></a>批量查询数据</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*** 区间查找 [startRow, stopRow)* @param startRow* @param stopRow* @return*/</span><span class="token keyword">public</span> List<span class="token operator">&lt;</span>PeopleDto<span class="token operator">&gt;</span> <span class="token function">query</span><span class="token punctuation">(</span>String startRow<span class="token punctuation">,</span> String stopRow<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Scan scan <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scan</span><span class="token punctuation">(</span>Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span>startRow<span class="token punctuation">)</span><span class="token punctuation">,</span> Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span>stopRow<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    scan<span class="token punctuation">.</span><span class="token function">setCaching</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    List<span class="token operator">&lt;</span>PeopleDto<span class="token operator">&gt;</span> dtos <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hbaseTemplate<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>table_name<span class="token punctuation">,</span> scan<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PeopleRowMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> dtos<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>注意查找的结果遵循<code>左闭右开</code>原则.</p></blockquote><h3 id="过滤"><a href="#过滤" class="headerlink" title="过滤"></a>过滤</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 要查询的表</span>HTable table <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HTable</span><span class="token punctuation">(</span>conf<span class="token punctuation">,</span> <span class="token string">"table1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 要查询的字段</span>Scan scan <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>scan<span class="token punctuation">.</span><span class="token function">addColumn</span><span class="token punctuation">(</span>Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token string">"cf"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>scan<span class="token punctuation">.</span><span class="token function">addColumn</span><span class="token punctuation">(</span>Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token string">"cf"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// where条件</span><span class="token comment" spellcheck="true">// a = 1</span>SingleColumnValueFilter a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SingleColumnValueFilter</span><span class="token punctuation">(</span>Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token string">"cf"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CompareOp<span class="token punctuation">.</span>EQUAL<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BinaryComparator</span><span class="token punctuation">(</span>Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>filterList<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// b = 2</span>SingleColumnValueFilter b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SingleColumnValueFilter</span><span class="token punctuation">(</span>Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token string">"cf"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CompareOp<span class="token punctuation">.</span>EQUAL<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BinaryComparator</span><span class="token punctuation">(</span>Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// and</span>FilterList filterList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterList</span><span class="token punctuation">(</span>Operator<span class="token punctuation">.</span>MUST_PASS_ALL<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>scan<span class="token punctuation">.</span><span class="token function">setFilter</span><span class="token punctuation">(</span>filterList<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul><li><a href="https://github.com/SpringForAll/spring-boot-starter-hbase" target="_blank" rel="noopener">https://github.com/SpringForAll/spring-boot-starter-hbase</a></li><li><a href="https://www.yiibai.com/hbase/hbase_client_api.html" target="_blank" rel="noopener">https://www.yiibai.com/hbase/hbase_client_api.html</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hbase </tag>
            
            <tag> hbase-client </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hbase之namespace</title>
      <link href="/2020/04/23/hbase-zhi-namespace/"/>
      <url>/2020/04/23/hbase-zhi-namespace/</url>
      
        <content type="html"><![CDATA[<h3 id="查看namespace"><a href="#查看namespace" class="headerlink" title="查看namespace"></a>查看namespace</h3><pre class="line-numbers language-sh"><code class="language-sh">hbase(main):008:0&gt; list_namespaceNAMESPACE            default                hbase                 test3 row(s)Took 0.0327 seconds <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><code>default</code>：创建表时未指定命名空间的话默认挂在<code>default</code>下。</p></blockquote><h3 id="查看namespace所有表"><a href="#查看namespace所有表" class="headerlink" title="查看namespace所有表"></a>查看namespace所有表</h3><pre class="line-numbers language-sh"><code class="language-sh">hbase(main):009:0&gt; list_namespace_tables "test"TABLEtestuser_table2 row(s)Took 0.0300 seconds=&gt; ["test", "user_table"]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="创建namespace"><a href="#创建namespace" class="headerlink" title="创建namespace"></a>创建namespace</h3><pre class="line-numbers language-sh"><code class="language-sh">hbase(main):010:0&gt; create_namespace "test"Took 0.2781 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre class="line-numbers language-sh"><code class="language-sh">hbase(main):018:0&gt; create_namespace "test", {"author"=&gt;"test", "create_time"=&gt;"2020-01-4 17:51:53"}Took 0.2262 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="查看namespace信息"><a href="#查看namespace信息" class="headerlink" title="查看namespace信息"></a>查看namespace信息</h3><pre class="line-numbers language-sh"><code class="language-sh">describe_namespace "test"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="修改namespace"><a href="#修改namespace" class="headerlink" title="修改namespace"></a>修改namespace</h3><pre class="line-numbers language-sh"><code class="language-sh">alter_namespace "test", {METHOD=&gt;"set", "author"=&gt;"wuzhiyong"}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-sh"><code class="language-sh">alter_namespace "test", {METHOD=&gt;"set", "email"=&gt;"1154365135@qq.com"}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-sh"><code class="language-sh">alter_namespace "test", {METHOD=&gt;"unset", NAME=&gt;"email"}<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="删除namespace"><a href="#删除namespace" class="headerlink" title="删除namespace"></a>删除namespace</h3><pre class="line-numbers language-sh"><code class="language-sh">drop_namespace "test"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>注意要删除的<code>namespace</code>必须是<strong>空</strong>的，其下没有表，否则会删除失败.</p></blockquote><h3 id="创建表时指定namespace"><a href="#创建表时指定namespace" class="headerlink" title="创建表时指定namespace"></a>创建表时指定namespace</h3><pre class="line-numbers language-sh"><code class="language-sh">create "test:user", "f"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul><li><a href="https://www.cnblogs.com/cc11001100/p/9911730.html" target="_blank" rel="noopener">https://www.cnblogs.com/cc11001100/p/9911730.html</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hbase </tag>
            
            <tag> namespace </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JdbcTemplate中RowMapper用法</title>
      <link href="/2020/04/23/jdbctemplate-zhong-rowmapper-yong-fa/"/>
      <url>/2020/04/23/jdbctemplate-zhong-rowmapper-yong-fa/</url>
      
        <content type="html"><![CDATA[<blockquote><p><code>查询结果</code>和<code>java对象</code>之间的映射.</p></blockquote><h3 id="RowMapper映射Bean容器的用法"><a href="#RowMapper映射Bean容器的用法" class="headerlink" title="RowMapper映射Bean容器的用法"></a>RowMapper映射Bean容器的用法</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">UserRowMapper</span> <span class="token keyword">implements</span> <span class="token class-name">RowMapper</span><span class="token operator">&lt;</span>User<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> User <span class="token function">mapRow</span><span class="token punctuation">(</span>ResultSet rs<span class="token punctuation">,</span> <span class="token keyword">int</span> rowNum<span class="token punctuation">)</span> <span class="token keyword">throws</span> SQLException <span class="token punctuation">{</span>        User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        user<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        user<span class="token punctuation">.</span><span class="token function">setGender</span><span class="token punctuation">(</span>rs<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"gender"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> user<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如此，完成了一个对<code>User</code>类的<code>RowMapper</code>映射。直接<code>jdbcTemplate.query(sql,new UserRowMapper)</code>即可将查询的信息存入<code>java Bean</code>中，靠的是<code>bean</code>中的<code>get/set</code>方法。</p><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul><li><a href="https://blog.csdn.net/chenyezhou1/article/details/71122570" target="_blank" rel="noopener">https://blog.csdn.net/chenyezhou1/article/details/71122570</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RowMapper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springboot集成hbase-client,解决包冲突问题</title>
      <link href="/2020/04/23/springboot-yin-ru-hbase-client-ri-zhi-bao-chong-tu/"/>
      <url>/2020/04/23/springboot-yin-ru-hbase-client-ri-zhi-bao-chong-tu/</url>
      
        <content type="html"><![CDATA[<h3 id="spring-boot集成hbase"><a href="#spring-boot集成hbase" class="headerlink" title="spring boot集成hbase"></a>spring boot集成hbase</h3><ul><li><a href="https://github.com/SpringForAll/spring-boot-starter-hbase" target="_blank" rel="noopener">https://github.com/SpringForAll/spring-boot-starter-hbase</a></li><li><a href="https://juejin.im/post/5cf643186fb9a07eaa226908" target="_blank" rel="noopener">https://juejin.im/post/5cf643186fb9a07eaa226908</a></li></ul><h4 id="关键配置"><a href="#关键配置" class="headerlink" title="关键配置"></a>关键配置</h4><p>参考源码：<code>HbaseProperties</code>,<code>HbaseAutoConfiguration</code>,缺少配置启动报错.</p><pre class="line-numbers language-yml"><code class="language-yml">spring:  data:    hbase:      quorum: 192.168.41.128:2181      rootDir: file:///root/hbase/rootdir      nodeParent: /hbase<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span><span class="token keyword">private</span> HbaseTemplate hbaseTemplate<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>默认pom配置会存在<code>日志</code>包和<code>servlet</code>包冲突问题：</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.spring4all<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-hbase<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0.0.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.hbase<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>hbase-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.junit.vintage<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>junit-vintage-engine<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h4><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.spring4all<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-hbase<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0.0.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.hbase<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>hbase-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>javax.servlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>servlet-api<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>log4j-over-slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>slf4j-log4j12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">></span></span>            <span class="token comment" spellcheck="true">&lt;!--&lt;exclusion>--></span>                <span class="token comment" spellcheck="true">&lt;!--&lt;groupId>com.google.guava&lt;/groupId>--></span>                <span class="token comment" spellcheck="true">&lt;!--&lt;artifactId>guava&lt;/artifactId>--></span>            <span class="token comment" spellcheck="true">&lt;!--&lt;/exclusion>--></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.junit.vintage<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>junit-vintage-engine<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring boot </tag>
            
            <tag> hbase-client </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xpath中*、text()和node()区别</title>
      <link href="/2020/04/22/xpath-zhong-text-he-node-qu-bie/"/>
      <url>/2020/04/22/xpath-zhong-text-he-node-qu-bie/</url>
      
        <content type="html"><![CDATA[<p>假设有这么一段html：</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post-content<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Subtitle<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>a.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>example.html<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Goto<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>    Bare text    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!-- this is html comment --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Bottom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="child"><a href="#child" class="headerlink" title="child::*"></a>child::*</h3><p>节点的所有子元素，如<code>//div[@class="post-content"]/*</code>，结果：</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Subtitle<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>a.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>example.html<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Goto<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Bottom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到，这里只选择了有标签名的节点，不在标签内的Bare text和注释都被过滤了。</p><h3 id="child-text"><a href="#child-text" class="headerlink" title="child::text()"></a>child::text()</h3><p>节点的所有文本，如<code>//div[@class="post-content"]/text()</code>，结果：</p><pre><code>Bare text</code></pre><h3 id="child-node"><a href="#child-node" class="headerlink" title="child::node()"></a>child::node()</h3><p>节点下的所有内容，不论是标签还是文本还是其他，<code>//div[@class="post-content"]/node()</code>，结果：</p><pre class="line-numbers language-XML"><code class="language-XML"><h1>Title</h1><p>Subtitle</p><img src="a.jpg"><div>    <a href="example.html">Goto</a></div>Bare text<br><!-- this is html comment --><p>Bottom</p> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>原样输出了其下的所有内容。</p><h3 id="原文链接"><a href="#原文链接" class="headerlink" title="原文链接"></a>原文链接</h3><ul><li><a href="https://www.awaimai.com/2726.html" target="_blank" rel="noopener">https://www.awaimai.com/2726.html</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xpath </tag>
            
            <tag> xml </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>B树、平衡二叉树、B+树</title>
      <link href="/2020/04/21/b-shu-ping-heng-er-cha-shu-b-shu/"/>
      <url>/2020/04/21/b-shu-ping-heng-er-cha-shu-b-shu/</url>
      
        <content type="html"><![CDATA[<h3 id="B树"><a href="#B树" class="headerlink" title="B树"></a>B树</h3><h3 id="平衡二叉树"><a href="#平衡二叉树" class="headerlink" title="平衡二叉树"></a>平衡二叉树</h3><h3 id="B-树"><a href="#B-树" class="headerlink" title="B+树"></a>B+树</h3><h3 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h3><ul><li><a href="https://juejin.im/entry/5b0cb64e518825157476b4a9" target="_blank" rel="noopener">https://juejin.im/entry/5b0cb64e518825157476b4a9</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> B树 </tag>
            
            <tag> 平衡二叉树 </tag>
            
            <tag> B+树 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysql索引</title>
      <link href="/2020/04/21/mysql-suo-yin/"/>
      <url>/2020/04/21/mysql-suo-yin/</url>
      
        <content type="html"><![CDATA[<h3 id="回表查询"><a href="#回表查询" class="headerlink" title="回表查询"></a>回表查询</h3><p>InnoDB 引擎中使用的是聚簇索引，其主索引的实现树中的叶子结点存储的是完整的数据记录，而辅助索引中存储的则只是辅助键和主键的值。</p><h3 id="索引覆盖"><a href="#索引覆盖" class="headerlink" title="索引覆盖"></a>索引覆盖</h3><p>如果索引已经包含了所有满足查询需要的数据，这时我们称之为覆盖索引（Covering Index），这时就不再需要回表操作。</p><h3 id="最左匹配"><a href="#最左匹配" class="headerlink" title="最左匹配"></a>最左匹配</h3><p>一个查询可以只使用索引中的一部分，更准确地说是最左侧部分（最左优先），这就是传说中的最左匹配原则。</p><p>即最左优先，如：</p><ul><li>如果有一个 2 列的索引 (col1,col2)，则相当于已经对 (col1)、(col1,col2) 上建立了索引；</li><li>如果有一个 3 列索引 (col1,col2,col3)，则相当于已经对 (col1)、(col1,col2)、(col1,col2,col3) 上建立了索引；但是 (col2,col3) 上并没有。</li></ul><h3 id="索引下推"><a href="#索引下推" class="headerlink" title="索引下推"></a>索引下推</h3><p>对索引中包含的字段先做判断，过滤掉不符合条件的记录，减少回表字数。</p><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul><li><a href="https://www.jianshu.com/p/d0d3de6832b9" target="_blank" rel="noopener">https://www.jianshu.com/p/d0d3de6832b9</a></li><li><a href="https://hoxis.github.io/mysql-zhuanlan-05-high-performance-index.html" target="_blank" rel="noopener">https://hoxis.github.io/mysql-zhuanlan-05-high-performance-index.html</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> 索引 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dom4j获取xml所有节点</title>
      <link href="/2020/04/21/dom4j-huo-qu-xml-suo-you-jie-dian/"/>
      <url>/2020/04/21/dom4j-huo-qu-xml-suo-you-jie-dian/</url>
      
        <content type="html"><![CDATA[<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Dom4jTest</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> DocumentException <span class="token punctuation">{</span>        String svgURI <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"user.dir"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/test.svg"</span><span class="token punctuation">;</span>        SAXReader reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SAXReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        File file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>svgURI<span class="token punctuation">)</span><span class="token punctuation">;</span>        Document document <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>        Element root <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getRootElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        List<span class="token operator">&lt;</span>Element<span class="token operator">></span> childElements <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">elements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>Element child <span class="token operator">:</span> childElements<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"g"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getQName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                List<span class="token operator">&lt;</span>Element<span class="token operator">></span> gElements <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">elements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span>Element gEle <span class="token operator">:</span> gElements<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"g"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>gEle<span class="token punctuation">.</span><span class="token function">getQName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        List<span class="token operator">&lt;</span>Element<span class="token operator">></span> elements <span class="token operator">=</span> gEle<span class="token punctuation">.</span><span class="token function">elements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">for</span> <span class="token punctuation">(</span>Element e <span class="token operator">:</span> elements<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"dfg:desc"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getQName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> dom4j </tag>
            
            <tag> xml </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>batik配合XPath解析svg文件</title>
      <link href="/2020/04/21/svg-jie-xi/"/>
      <url>/2020/04/21/svg-jie-xi/</url>
      
        <content type="html"><![CDATA[<pre class="line-numbers language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!-- SVG解析包 --></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.xmlgraphics<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>batik-all<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">></span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>svg</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rect</span> <span class="token attr-name">x</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">y</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1198<span class="token punctuation">"</span></span> <span class="token attr-name">height</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>598<span class="token punctuation">"</span></span>        <span class="token attr-name">fill</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>none<span class="token punctuation">"</span></span> <span class="token attr-name">stroke</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>blue<span class="token punctuation">"</span></span> <span class="token attr-name">stroke-width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>path</span> <span class="token attr-name">d</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>M200,300 Q400,50 600,300 T1000,300<span class="token punctuation">"</span></span>        <span class="token attr-name">fill</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>none<span class="token punctuation">"</span></span> <span class="token attr-name">stroke</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>red<span class="token punctuation">"</span></span> <span class="token attr-name">stroke-width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span>  <span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>g</span> <span class="token attr-name">fill</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>black<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>circle</span> <span class="token attr-name">cx</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>200<span class="token punctuation">"</span></span> <span class="token attr-name">cy</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span> <span class="token attr-name">r</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>circle</span> <span class="token attr-name">cx</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>600<span class="token punctuation">"</span></span> <span class="token attr-name">cy</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span> <span class="token attr-name">r</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>circle</span> <span class="token attr-name">cx</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1000<span class="token punctuation">"</span></span> <span class="token attr-name">cy</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>300<span class="token punctuation">"</span></span> <span class="token attr-name">r</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>g</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>g</span> <span class="token attr-name">fill</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#888888<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>circle</span> <span class="token attr-name">cx</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>400<span class="token punctuation">"</span></span> <span class="token attr-name">cy</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>50<span class="token punctuation">"</span></span> <span class="token attr-name">r</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>circle</span> <span class="token attr-name">cx</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>800<span class="token punctuation">"</span></span> <span class="token attr-name">cy</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>550<span class="token punctuation">"</span></span> <span class="token attr-name">r</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>g</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>path</span> <span class="token attr-name">d</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>M200,300 L400,50 L600,300 L800,550 L1000,300<span class="token punctuation">"</span></span>        <span class="token attr-name">fill</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>none<span class="token punctuation">"</span></span> <span class="token attr-name">stroke</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#888888<span class="token punctuation">"</span></span> <span class="token attr-name">stroke-width</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>svg</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">//You first load the XML as a Document:</span>DocumentBuilderFactory factory <span class="token operator">=</span> DocumentBuilderFactory<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>DocumentBuilder builder <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">newDocumentBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Document document <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"image.svg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//Then you use XPath to select the desired nodes. The expression below selects the contents of the d attributes of all the path elements inside the file:</span>String xpathExpression <span class="token operator">=</span> <span class="token string">"//path/@d"</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//Now we can instantiate the XPath processor and compile the expression:</span>XPathFactory xpf <span class="token operator">=</span> XPathFactory<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>XPath xpath <span class="token operator">=</span> xpf<span class="token punctuation">.</span><span class="token function">newXPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>XPathExpression expression <span class="token operator">=</span> xpath<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>xpathExpression<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//Since the expected result is a node-set (two strings), we evaluate the expression on the SVG document using XPathConstants.NODESET as the second parameter:</span>NodeList svgPaths <span class="token operator">=</span> <span class="token punctuation">(</span>NodeList<span class="token punctuation">)</span>expression<span class="token punctuation">.</span><span class="token function">evaluate</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> XPathConstants<span class="token punctuation">.</span>NODESET<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//From there you can extract the first set of path data using:</span>svgPaths<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNodeValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xpath </tag>
            
            <tag> svg </tag>
            
            <tag> batik </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Xpath元素定位</title>
      <link href="/2020/04/21/xpath-yuan-su-ding-wei/"/>
      <url>/2020/04/21/xpath-yuan-su-ding-wei/</url>
      
        <content type="html"><![CDATA[<h2 id="Xpath简介"><a href="#Xpath简介" class="headerlink" title="Xpath简介"></a>Xpath简介</h2><p><code>XPath</code>是<code>XML Path</code>的简称，它是一种用来确定<code>XML</code>（可扩展标记语言）文档中某部分位置的语言。<code>Xpath</code>也是一种表达式语言，它基于<code>XML</code>的树状结构，可以用来在整个树中来寻找指定的节点，因此它的返回值可能是节点，节点集合，原子值，以及节点和原子值的混合等。</p><h2 id="Xpath定位方法"><a href="#Xpath定位方法" class="headerlink" title="Xpath定位方法"></a>Xpath定位方法</h2><h3 id="Xpath选取节点"><a href="#Xpath选取节点" class="headerlink" title="Xpath选取节点"></a>Xpath选取节点</h3><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td><code>/</code></td><td>表示从根节点开始选取</td></tr><tr><td><code>//</code></td><td>表示选择任意位置的某个节点，而不考虑它们的位置</td></tr><tr><td><code>nodename</code></td><td>选取此节点的所有子节点。</td></tr><tr><td><code>.</code></td><td>选取当前节点。</td></tr><tr><td><code>..</code></td><td>选取当前节点的父节点。</td></tr><tr><td><code>@</code></td><td>选取属性。</td></tr></tbody></table><pre class="line-numbers language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="ISO-8859-1"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bookstore</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>book</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>eng<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Harry Potter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>price</span><span class="token punctuation">></span></span>29.99<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>price</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>book</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>book</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>eng<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Learning XML<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>price</span><span class="token punctuation">></span></span>39.95<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>price</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>book</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bookstore</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th>路径表达式</th><th>结果</th></tr></thead><tbody><tr><td>bookstore</td><td>选取 bookstore 元素的所有子节点。</td></tr><tr><td>/bookstore</td><td>选取根元素 bookstore。注释：假如路径起始于正斜杠( / )，则此路径始终代表到某元素的绝对路径！</td></tr><tr><td>bookstore/book</td><td>选取属于 bookstore 的子元素的所有 book 元素。</td></tr><tr><td>//book</td><td>选取所有 book 子元素，而不管它们在文档中的位置。</td></tr><tr><td>bookstore//book</td><td>选择属于 bookstore 元素的后代的所有 book 元素，而不管它们位于 bookstore 之下的什么位置。</td></tr><tr><td>//@lang</td><td>选取名为 lang 的所有属性。</td></tr></tbody></table><h3 id="以html选择节点为例"><a href="#以html选择节点为例" class="headerlink" title="以html选择节点为例"></a>以html选择节点为例</h3><blockquote><p>由于<code>HTML</code>文档本身就是一个标准的XML页面，因此我们可以使用XPath的语法来定位页面元素。</p></blockquote><h4 id="定位节点"><a href="#定位节点" class="headerlink" title="定位节点"></a>定位节点</h4><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td><code>/html/body/form/input</code></td><td>查找<code>form</code>下所有<code>input</code>节点元素</td></tr><tr><td><code>//input</code></td><td>查找<code>html</code>中所有<code>input</code>节点元素</td></tr></tbody></table><h4 id="使用通配符-选择未知的元素"><a href="#使用通配符-选择未知的元素" class="headerlink" title="使用通配符(*)选择未知的元素"></a>使用通配符(<code>*</code>)选择未知的元素</h4><blockquote><p>XPath 通配符可用来选取未知的 XML 元素。</p></blockquote><table><thead><tr><th>通配符</th><th>描述</th></tr></thead><tbody><tr><td><code>*</code></td><td>匹配任何元素节点。</td></tr><tr><td><code>@*</code></td><td>匹配任何属性节点。</td></tr><tr><td><code>node()</code></td><td>匹配任何类型的节点。</td></tr></tbody></table><hr><hr><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td><code>//form/*</code></td><td>查找<code>form</code>下所有节点元素</td></tr><tr><td><code>//*</code></td><td>查找<code>html</code>中所有节点元素</td></tr><tr><td><code>//*/input</code></td><td>查找所有<code>input</code>节点元素</td></tr><tr><td><code>//title[@*]</code></td><td>选取所有带有属性的 title 元素。</td></tr></tbody></table><h4 id="选择分支"><a href="#选择分支" class="headerlink" title="选择分支"></a>选择分支</h4><blockquote><p>对于存在多个元素时想唯一定位，可以使用<code>[]</code>中括号来选择分支，下标从<code>1</code>开始</p></blockquote><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td><code>//*/td[7]/a[1]</code></td><td>定位到第<code>7</code>个<code>td</code>元素中第<code>1</code>个<code>a</code>元素</td></tr><tr><td><code>//*/td[7]/span[2]</code></td><td>定位到第<code>7</code>个<code>td</code>元素中第<code>2</code>个<code>span</code>元素</td></tr><tr><td><code>//*/td[last()]/a[last()]</code></td><td>定位到最后一个<code>td</code>元素中最后一个<code>a</code>元素</td></tr><tr><td><code>//*/td[a]</code></td><td>定位包含<code>a</code>元素的所有<code>td</code>元素</td></tr></tbody></table><blockquote><p>选择最后一个元素可以用<code>last()</code>函数，但是选择第一个元素没有<code>first()</code>函数。</p></blockquote><h4 id="选择属性"><a href="#选择属性" class="headerlink" title="选择属性"></a>选择属性</h4><blockquote><p>还可以利用标签内的属性来加以区分定位，在&lt;&gt;开始标记内除标签外，其他都可以看做是属性.</p></blockquote><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td><code>//input[@name]</code></td><td>定位所有含<code>name</code>属性的<code>input</code>元素</td></tr><tr><td><code>//input[@*]</code></td><td>定位所有含属性的<code>input</code>元素</td></tr><tr><td><code>//input[@value='2']</code></td><td>定位出<code>value</code>属性值为<code>2</code>的<code>input</code>元素</td></tr><tr><td><code>//input[@type='vedio'][@value='1']</code>或<code>//input[@type='vedio' and @value='1']</code></td><td>多个属性定位</td></tr><tr><td><code>//input/@id</code></td><td>返回所有<code>input</code>元素的<code>id</code>属性</td></tr></tbody></table><h4 id="选取若干路径"><a href="#选取若干路径" class="headerlink" title="选取若干路径"></a>选取若干路径</h4><blockquote><p>过在路径表达式中使用<code>|</code>运算符，您可以选取若干个路径。</p></blockquote><table><thead><tr><th>路径表达式</th><th>结果</th></tr></thead><tbody><tr><td>`//book/title</td><td>//book/price`</td></tr><tr><td>`//title</td><td>//price`</td></tr><tr><td>`/bookstore/book/title</td><td>//price`</td></tr></tbody></table><h4 id="常用函数"><a href="#常用函数" class="headerlink" title="常用函数"></a>常用函数</h4><ul><li>字符串查找函数： <code>contains()</code><blockquote><p><code>contains(string1,string2)</code>，表示如果 <code>string1</code> 包含 <code>string2</code>，则返回 <code>true</code>，否则返回 <code>false</code>。</p></blockquote></li><li>获取元素的文本内容： <code>text()</code></li><li>从起始位置匹配字符串：<code>starts-with()</code></li></ul><blockquote><p>更多函数可参考：<code>http://www.w3school.com.cn/xpath/xpath_functions.asp</code></p></blockquote><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td><code>//a[contains(@href,'baidu')]</code></td><td>定位<code>href</code>属性中包含<code>baidu</code>的所有<code>a</code>元素</td></tr><tr><td><code>//a[text()='推广']</code></td><td>链接文本信息是<code>推广</code>的所有<code>a</code>元素</td></tr><tr><td><code>//a[starts-with(@href,'/ads')]</code></td><td>链接<code>href</code>属性以<code>/ads</code>开始的所有<code>a</code>元素</td></tr><tr><td><code>//a[contains(text(),'推广')]</code></td><td>链接文本信息包含<code>推广</code>的所有<code>a</code>元素</td></tr></tbody></table><h4 id="Xpath轴"><a href="#Xpath轴" class="headerlink" title="Xpath轴"></a>Xpath轴</h4><p>上面这些方法都不能定位时，这时候就得考虑依据元素的父辈、兄弟或者子辈节点来定位了，这就需要用到Xpath轴，利用轴可定位某个相对于当前节点的节点集。</p><p>语法：</p><pre><code>轴名称::标签名</code></pre><table><thead><tr><th>轴名称</th><th>描述</th></tr></thead><tbody><tr><td><code>ancestor</code></td><td>选取当前节点的所有先辈（父、祖父等）。</td></tr><tr><td><code>ancestor-or-self</code></td><td>选取当前节点的所有先辈（父、祖父等）以及当前节点本身。</td></tr><tr><td><code>attribute</code></td><td>选取当前节点的所有属性。</td></tr><tr><td><code>child</code></td><td>选取当前节点的所有子元素。</td></tr><tr><td><code>descendant</code></td><td>选取当前节点的所有后代元素（子、孙等）。</td></tr><tr><td><code>descendant-or-self</code></td><td>选取当前节点的所有后代元素（子、孙等）以及当前节点本身。</td></tr><tr><td><code>following</code></td><td>选取文档中当前节点的结束标签之后的所有节点。</td></tr><tr><td><code>namespace</code></td><td>选取当前节点的所有命名空间节点。</td></tr><tr><td><code>parent</code></td><td>选取当前节点的父节点。</td></tr><tr><td><code>preceding</code></td><td>选取文档中当前节点的开始标签之前的所有节点。</td></tr><tr><td><code>preceding-sibling</code></td><td>选取当前节点之前的所有同级节点。</td></tr><tr><td><code>self</code></td><td>选取当前节点。</td></tr></tbody></table><hr><hr><table><thead><tr><th>例子</th><th>结果</th></tr></thead><tbody><tr><td><code>child::book</code></td><td>选取所有属于当前节点的子元素的 book 节点。</td></tr><tr><td><code>attribute::lang</code></td><td>选取当前节点的 lang 属性。</td></tr><tr><td><code>child::*</code></td><td>选取当前节点的所有子元素。</td></tr><tr><td><code>attribute::*</code></td><td>选取当前节点的所有属性。</td></tr><tr><td><code>child::text()</code></td><td>选取当前节点的所有文本子节点。</td></tr><tr><td><code>child::node()</code></td><td>选取当前节点的所有子节点。</td></tr><tr><td><code>descendant::book</code></td><td>选取当前节点的所有 book 后代。</td></tr><tr><td><code>ancestor::book</code></td><td>选择当前节点的所有 book 先辈。</td></tr><tr><td><code>ancestor-or-self::book</code></td><td>选取当前节点的所有 book 先辈以及当前节点（如果此节点是 book 节点）</td></tr><tr><td><code>child::*/child::price</code></td><td>选取当前节点的所有 price 孙节点。</td></tr></tbody></table><h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><h2 id="XPath教程"><a href="#XPath教程" class="headerlink" title="XPath教程"></a>XPath教程</h2><ul><li><a href="https://www.w3school.com.cn/xpath/index.asp" target="_blank" rel="noopener">https://www.w3school.com.cn/xpath/index.asp</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xpath </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hbase的rowkey设计</title>
      <link href="/2020/04/16/hbase-de-rowkey-she-ji/"/>
      <url>/2020/04/16/hbase-de-rowkey-she-ji/</url>
      
        <content type="html"><![CDATA[<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>HBase是一个<code>K/V</code>存储型NoSQL数据库，与一般k/v数据库不同的是，Hbase的<code>value</code>由<code>rowkey</code>、<code>column family</code>:<code>qualifier</code>和<code>TimeStamp</code>这个三个维度快速定位。</p><p>HBase中rowkey可以唯一标识一行记录，在HBase查询的时候，有两种方式：</p><ul><li>通过get方式，指定rowkey获取唯一一条记录</li><li>通过scan方式，设置startRow和stopRow参数进行范围匹配</li><li>全表扫描，即直接扫描整张表中所有行记录</li></ul><h3 id="rowkey长度原则"><a href="#rowkey长度原则" class="headerlink" title="rowkey长度原则"></a>rowkey长度原则</h3><p>rowkey是一个二进制码流，可以是任意字符串，最大长度64kb，实际应用中一般为10-100bytes，以byte[]形式保存，一般设计成定长。</p><blockquote><p>建议越短越好，不要超过16个字节</p></blockquote><h3 id="rowkey散列原则"><a href="#rowkey散列原则" class="headerlink" title="rowkey散列原则"></a>rowkey散列原则</h3><ul><li>尽量不要将rowkey设计成连续的值，如时间戳;</li><li>为rowkey增加随机散列字段，使数据均衡分布在每个RegionServer;</li><li>如果没有散列字段，所有的数据都会集中在一个RegionServer上，这样在数据检索的时候负载会集中在个别的RegionServer上，造成热点问题，会降低查询效率。</li></ul><blockquote><p><strong>什么是热点?</strong><br>热点发生在大量的client直接访问集群的一个或极少数个节点（访问可能是读，写或者其他操作）。大量访问会使热点region所在的单个机器超出自身承受能力，引起性能下降甚至region不可用.</p></blockquote><h3 id="rowkey唯一原则"><a href="#rowkey唯一原则" class="headerlink" title="rowkey唯一原则"></a>rowkey唯一原则</h3><p>必须在设计上保证其唯一性，rowkey是按照字典顺序排序存储的.</p><h3 id="设计方法"><a href="#设计方法" class="headerlink" title="设计方法"></a>设计方法</h3><ul><li>Salting: 指将随机数据添加到行键的开头。</li><li>Hashing: 哈希会使同一行永远用一个前缀加盐。</li><li>反转: 以手机号为rowkey，可以将手机号反转后的字符串作为rowkey</li><li>时间戳反转: <code>Long.Max_Value - timestamp</code></li><li>尽量保持 ColumnFamily 名称尽可能小，最好是一个字符</li><li>虽然详细的属性名称更易于阅读，但更喜欢使用较短的属性名称来存储在<code>HBase</code>中。</li></ul><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul><li><a href="https://zhuanlan.zhihu.com/p/64748254" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/64748254</a></li><li><a href="https://wiki.imooc.com/hbase/rowkey.html" target="_blank" rel="noopener">https://wiki.imooc.com/hbase/rowkey.html</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hbase </tag>
            
            <tag> rowkey </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hbase数据版本</title>
      <link href="/2020/04/14/hbase-shu-ju-ban-ben/"/>
      <url>/2020/04/14/hbase-shu-ju-ban-ben/</url>
      
        <content type="html"><![CDATA[<h3 id="Hbase版本数量"><a href="#Hbase版本数量" class="headerlink" title="Hbase版本数量"></a>Hbase版本数量</h3><p>Hbase版本数量分为<code>最大版本数量</code>和<code>最小版本数量</code>：</p><ul><li><strong>HBase最大版本数量</strong>:HBase 通过 HColumnDescriptor 为每个列族配置要存储的最大行数版本。最大版本的默认值为1。最大版本的数量可能需要根据应用程序需求增加或减少。不建议将最高版本数设置为极高的级别（例如，数百个或更多）。</li><li><strong>HBase最小版本数量</strong>：与最大行版本数一样，HBase 通过 HColumnDescriptor 为每个列族配置要保留的最小行数版本。最小版本的默认值为0，这意味着该功能被禁用。行版本参数的最小数目与<code>生存时间</code>参数一起使用，并且可以与行版本参数的数目组合在一起，以允许诸如“保留最多T分钟值的数据，最多N个版本，但是至少保留 M 个版本 “（其中M 是最小行版本数的值，<code>M &lt; N</code> ）。仅当对列族启用了生存时间并且必须小于行版本的数量时，才应设置此参数。</li></ul><h3 id="HBase-生存时间（TTL）"><a href="#HBase-生存时间（TTL）" class="headerlink" title="HBase 生存时间（TTL）"></a>HBase 生存时间（TTL）</h3><ul><li>ColumnFamilies 可以以<code>秒</code>为单位来设置 TTL（<code>Time To Live</code>）长度，一旦达到到期时间，HBase 将自动删除行。</li><li>也支持设置时间以每个单元为基础生存。</li><li>单元 TTL 以毫秒为单位而不是秒。</li><li>单元 TTL 不能将一个单元的有效生命周期延长超过 ColumnFamily 级 TTL 设置。</li></ul><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>默认<code>Hbase</code>列族最多保存一个版本的数据，可以通过下面命令修改,也可以使用<code>HColumnDescriptor</code>：</p><pre class="line-numbers language-sh"><code class="language-sh">alter 'test', NAME =&gt; 'cf', VERSIONS =&gt; 3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>创建表的时候指定版本数量:</p><pre class="line-numbers language-sh"><code class="language-sh">hbase(main):018:0&gt; create 'test',{NAME=&gt;'base_info',VERSIONS=&gt;3 },{NAME=&gt;'extra_info',VERSIONS=&gt;1 } 0 row(s) in 4.2670 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>更多详细的用法可以参考<code>help 'create'</code>:</p><pre class="line-numbers language-sh"><code class="language-sh">hbase(main):016:0&gt; help 'create'Creates a table. Pass a table name, and a set of column familyspecifications (at least one), and, optionally, table configuration.Column specification can be a simple string (name), or a dictionary(dictionaries are described below in main help output), necessarilyincluding NAME attribute.Examples:Create a table with namespace=ns1 and table qualifier=t1  hbase&gt; create 'ns1:t1', {NAME =&gt; 'f1', VERSIONS =&gt; 5}Create a table with namespace=default and table qualifier=t1  hbase&gt; create 't1', {NAME =&gt; 'f1'}, {NAME =&gt; 'f2'}, {NAME =&gt; 'f3'}  hbase&gt; # The above in shorthand would be the following:  hbase&gt; create 't1', 'f1', 'f2', 'f3'  hbase&gt; create 't1', {NAME =&gt; 'f1', VERSIONS =&gt; 1, TTL =&gt; 2592000, BLOCKCACHE =&gt; true}  hbase&gt; create 't1', {NAME =&gt; 'f1', CONFIGURATION =&gt; {'hbase.hstore.blockingStoreFiles' =&gt; '10'}}  hbase&gt; create 't1', {NAME =&gt; 'f1', IS_MOB =&gt; true, MOB_THRESHOLD =&gt; 1000000, MOB_COMPACT_PARTITION_POLICY =&gt; 'weekly'}Table configuration options can be put at the end.Examples:  hbase&gt; create 'ns1:t1', 'f1', SPLITS =&gt; ['10', '20', '30', '40']  hbase&gt; create 't1', 'f1', SPLITS =&gt; ['10', '20', '30', '40']  hbase&gt; create 't1', 'f1', SPLITS_FILE =&gt; 'splits.txt', OWNER =&gt; 'johndoe'  hbase&gt; create 't1', {NAME =&gt; 'f1', VERSIONS =&gt; 5}, METADATA =&gt; { 'mykey' =&gt; 'myvalue' }  hbase&gt; # Optionally pre-split the table into NUMREGIONS, using  hbase&gt; # SPLITALGO ("HexStringSplit", "UniformSplit" or classname)  hbase&gt; create 't1', 'f1', {NUMREGIONS =&gt; 15, SPLITALGO =&gt; 'HexStringSplit'}  hbase&gt; create 't1', 'f1', {NUMREGIONS =&gt; 15, SPLITALGO =&gt; 'HexStringSplit', REGION_REPLICATION =&gt; 2, CONFIGURATION =&gt; {'hbase.hregion.scan.loadColumnFamiliesOnDemand' =&gt; 'true'}}  hbase&gt; create 't1', 'f1', {SPLIT_ENABLED =&gt; false, MERGE_ENABLED =&gt; false}  hbase&gt; create 't1', {NAME =&gt; 'f1', DFS_REPLICATION =&gt; 1}You can also keep around a reference to the created table:  hbase&gt; t1 = create 't1', 'f1'Which gives you a reference to the table named 't1', on which you can thencall methods.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hbase </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hbase默认端口说明</title>
      <link href="/2020/04/13/hbase-mo-ren-duan-kou-shuo-ming/"/>
      <url>/2020/04/13/hbase-mo-ren-duan-kou-shuo-ming/</url>
      
        <content type="html"><![CDATA[<table>   <tbody><tr>      <td>节点</td>      <td>端口号</td>      <td>协议</td>      <td>使用</td>      <td>说明</td>   </tr>   <tr>      <td rowspan="3">zookeeper</td>      <td>2181</td>      <td></td>      <td>zkCli.sh -server zookeeper1:2181</td>      <td>客户端接入</td>   </tr>   <tr>      <td>2888</td>      <td></td>      <td>N/A</td>      <td>集群内部通讯</td>   </tr>      <tr>      <td>3888</td>      <td></td>      <td>N/A</td>      <td>集群内部通讯</td>   </tr>   <tr>      <td rowspan="2">HDFS Namenode</td>      <td>9000</td>      <td>HDFS</td>      <td>hdfs dfs -ls hdfs://namenode1:9000/</td>      <td>客户端接入</td>   </tr>   <tr>      <td>50070</td>      <td>HTTP</td>      <td>http://namenode1:50070/</td>      <td>集群监控</td>   </tr>   <tr>      <td>HDFS SecondaryNamenode</td>      <td>50090</td>      <td>HTTP</td>      <td>http://namenode1:50090/</td>      <td>secondary监控</td>   </tr>   <tr>      <td rowspan="3">HDFS Datanode</td>      <td>50010</td>      <td></td>      <td>N/A</td>      <td>客户端接入/其他节点接入</td>   </tr>   <tr>      <td>50020</td>      <td></td>      <td>N/A</td>      <td></td>   </tr>   <tr>      <td>50075</td>      <td>HTTP</td>      <td>http://datanode1:50075/</td>      <td>节点监控</td>   </tr>   <tr>      <td rowspan="2">HBase Master</td>      <td>16000</td>      <td></td>      <td>hbase-client-1.x.x.jar</td>      <td>RegionServer接入</td>   </tr>   <tr>      <td>16010</td>      <td>HTTP</td>      <td>http://namenode1:16010/</td>      <td>集群监控</td>   </tr>   <tr>      <td rowspan="2">HBase RegionServer</td>      <td>16020</td>      <td></td>      <td>N/A</td>      <td>客户端接入</td>   </tr>   <tr>      <td>16030</td>      <td>HTTP</td>      <td>http://datanode1:16030/</td>      <td>节点监控</td>   </tr></tbody></table><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hbase </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HBase默认配置</title>
      <link href="/2020/04/13/hbase-mo-ren-pei-zhi/"/>
      <url>/2020/04/13/hbase-mo-ren-pei-zhi/</url>
      
        <content type="html"><![CDATA[<p><code>hbase-default.xml</code>默认配置中<strong>常用的</strong>的配置项：</p><table><thead><tr><th>配置项</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td><code>hbase.tmp.dir</code></td><td>本地文件系统上的临时目录。将此设置更改为指向比“/tmp”更持久的位置，因为在重新启动计算机时清除了“/tmp”目录。</td><td><code>${java.io.tmpdir}/hbase-${user.name}</code></td></tr><tr><td><code>hbase.rootdir</code></td><td>这个目录是region servers共享的目录。</td><td><code>${hbase.tmp.dir}/hbase</code></td></tr><tr><td><code>hbase.cluster.distributed</code></td><td>群集所处的模式。对于独立模式，可能的值为false，对于分布式模式，可能的值为true。</td><td><code>false</code></td></tr><tr><td><code>hbase.zookeeper.quorum</code></td><td>使用逗号分隔的ZooKeeper集合中的服务器列表</td><td><code>localhost</code></td></tr><tr><td><code>zookeeper.recovery.retry.maxsleeptime</code></td><td>在重试 zookeeper操作之前的最大睡眠时间（以毫秒为单位）</td><td><code>60000</code></td></tr><tr><td><code>hbase.local.dir</code></td><td>将本地文件系统上的目录用作本地存储。</td><td><code>${hbase.tmp.dir}/local/</code></td></tr><tr><td><code>hbase.master.port</code></td><td>HBase Master应该绑定的端口。</td><td><code>16000</code></td></tr><tr><td><code>hbase.master.info.port</code></td><td>HBase Master Web UI的端口。如果您不想运行UI实例，请将其设置为-1。</td><td><code>16010</code></td></tr><tr><td><code>hbase.master.info.bindAddress</code></td><td>HBase Master Web UI的绑定地址</td><td><code>0.0.0.0</code></td></tr><tr><td><code>hbase.master.logcleaner.ttl</code></td><td>WAL在归档（{hbase.rootdir} / oldWALs）目录中保留多久，之后将由主线程清除。该值以毫秒为单位。</td><td><code>600000</code></td></tr><tr><td><code>hbase.master.procedurewalcleaner.ttl</code></td><td>程序WAL将在归档目录中保留多久，之后将由主线程清除。该值以毫秒为单位。</td><td><code>604800000</code></td></tr><tr><td><code>hbase.master.fileSplitTimeout</code></td><td>分割一个区域，在放弃尝试之前等待文件分割步骤需要多长时间。</td><td><code>600000</code></td></tr><tr><td><code>hbase.regionserver.port</code></td><td>HBase RegionServer绑定的端口。</td><td><code>16020</code></td></tr><tr><td><code>hbase.regionserver.info.port</code></td><td>HBase RegionServer Web UI的端口如果您不希望RegionServer UI运行，请将其设置为-1。</td><td><code>16030</code></td></tr><tr><td><code>hbase.regionserver.info.bindAddress</code></td><td>HBase RegionServer Web UI的地址</td><td><code>0.0.0.0</code></td></tr><tr><td><code>hbase.regionserver.msginterval</code></td><td>从RegionServer到Master的消息间隔（以毫秒为单位）。</td><td><code>3000</code></td></tr><tr><td><code>hbase.regionserver.regionSplitLimit</code></td><td>限制区域数量，之后不再发生区域分割。这并不是硬性限制区域数量，而是作为区域服务商在一定限度之后停止分裂的指导方针。默认设置为1000。</td><td><code>1000</code></td></tr><tr><td><code>zookeeper.session.timeout</code></td><td>ZooKeeper会话超时（以毫秒为单位）。它使用两种不同的方式。首先，这个值用于HBase用来连接到集合的ZK客户端。当它启动一个ZK服务器时它也被HBase使用</td><td><code>90000</code></td></tr><tr><td><code>zookeeper.znode.parent</code></td><td>ZooKeeper中用于HBase的Root ZNode。所有配置了相对路径的HBase的ZooKeeper文件都会在这个节点下。</td><td><code>/hbase</code></td></tr><tr><td><code>zookeeper.znode.acl.parent</code></td><td>Root ZNode用于访问控制列表。</td><td><code>acl</code></td></tr><tr><td><code>hbase.zookeeper.dns.interface</code></td><td>ZooKeeper服务器应从中报告其IP地址的网络接口的名称。</td><td><code>default</code></td></tr><tr><td><code>hbase.zookeeper.peerport</code></td><td>ZooKeeper同伴使用的端口进行彼此会话。</td><td><code>2888</code></td></tr><tr><td><code>hbase.zookeeper.leaderport</code></td><td>ZooKeeper用于leader选举的端口。</td><td><code>3888</code></td></tr><tr><td><code>hbase.zookeeper.property.dataDir</code></td><td>来自ZooKeeper的配置zoo.cfg的属性。快照存储的目录。</td><td><code>${hbase.tmp.dir}/zookeeper</code></td></tr><tr><td><code>hbase.zookeeper.property.clientPort</code></td><td>来自ZooKeeper的配置zoo.cfg的属性。客户端将连接的端口。</td><td><code>2181</code></td></tr><tr><td><code>hbase.zookeeper.property.maxClientCnxns</code></td><td>来自ZooKeeper的配置zoo.cfg的属性。限制由IP地址标识的单个客户端的并发连接数量</td><td><code>300</code></td></tr><tr><td><code>hbase.column.max.version</code></td><td>新的列族描述符将使用此值作为要保留的默认版本数。</td><td><code>1</code></td></tr></tbody></table><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul><li><a href="http://hbase.apache.org/book.html#config.files" target="_blank" rel="noopener">官网</a></li><li><a href="http://hbase.apache.org/book.html#example_config" target="_blank" rel="noopener">官网示例</a></li><li><a href="https://wiki.imooc.com/hbase/defaultconfiguration.html" target="_blank" rel="noopener">慕课网中文翻译</a></li><li><a href="https://wiki.imooc.com/hbase/configurationexample.html" target="_blank" rel="noopener">慕课网中文翻译示例</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hbase </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hbase shell常用命令</title>
      <link href="/2020/04/13/hbase-chang-yong-ming-ling/"/>
      <url>/2020/04/13/hbase-chang-yong-ming-ling/</url>
      
        <content type="html"><![CDATA[<h3 id="通用命令"><a href="#通用命令" class="headerlink" title="通用命令"></a>通用命令</h3><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>status</td><td>提供HBase的状态，例如，服务器的数量。</td></tr><tr><td>version</td><td>提供正在使用HBase版本。</td></tr><tr><td>table_help</td><td>表引用命令提供帮助。</td></tr><tr><td>whoami</td><td>提供有关用户的信息。</td></tr></tbody></table><h3 id="数据定义"><a href="#数据定义" class="headerlink" title="数据定义"></a>数据定义</h3><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>create</td><td>用于创建一个表。</td></tr><tr><td>list</td><td>用于列出HBase的所有表。</td></tr><tr><td>disable</td><td>用于禁用表。</td></tr><tr><td>is_disabled</td><td>用于验证表是否被禁用。</td></tr><tr><td>enable</td><td>用于启用一个表。</td></tr><tr><td>is_enabled</td><td>用于验证表是否已启用。</td></tr><tr><td>describe</td><td>用于提供了一个表的描述。</td></tr><tr><td>alter</td><td>用于改变一个表。</td></tr><tr><td>exists</td><td>用于验证表是否存在。</td></tr><tr><td>drop</td><td>用于从HBase中删除表。</td></tr><tr><td>drop_all</td><td>用于丢弃在命令中给出匹配“regex”的表。</td></tr></tbody></table><h3 id="数据操作语言"><a href="#数据操作语言" class="headerlink" title="数据操作语言"></a>数据操作语言</h3><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>put</td><td>用于把指定列在指定的行中单元格的值在一个特定的表。</td></tr><tr><td>get</td><td>用于取行或单元格的内容。</td></tr><tr><td>delete</td><td>用于删除表中的单元格值。</td></tr><tr><td>deleteall</td><td>用于删除给定行的所有单元格。</td></tr><tr><td>scan</td><td>用于扫描并返回表数据。</td></tr><tr><td>count</td><td>用于计数并返回表中的行的数目。</td></tr><tr><td>truncate</td><td>用于禁用、删除和重新创建一个指定的表。清空表。</td></tr></tbody></table><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hbase </tag>
            
            <tag> shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hbase单机版部署及简单测试</title>
      <link href="/2020/04/10/hbase-dan-ji-ban-bu-shu-ji-jian-dan-ce-shi/"/>
      <url>/2020/04/10/hbase-dan-ji-ban-bu-shu-ji-jian-dan-ce-shi/</url>
      
        <content type="html"><![CDATA[<p>在<code>Centos7</code>上部署单机版<code>hbase</code></p><h3 id="下载安装包"><a href="#下载安装包" class="headerlink" title="下载安装包"></a>下载安装包</h3><p><a href="https://www.apache.org/dyn/closer.lua/hbase/" target="_blank" rel="noopener">hbase</a></p><p><a href="http://hbase.apache.org/book.html#quickstart" target="_blank" rel="noopener">hbase官网</a></p><h3 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h3><pre><code>tar -zxvf hbase-2.2.4.bin.tar.gz</code></pre><h3 id="配置hbase-env-sh"><a href="#配置hbase-env-sh" class="headerlink" title="配置hbase-env.sh"></a>配置<code>hbase-env.sh</code></h3><p>部署<code>JDK</code>，查看<code>JAVA_HOME</code>路径。</p><pre class="line-numbers language-sh"><code class="language-sh">[root@node1 hbase]# echo $JAVA_HOME/usr/local/bin/jdk1.8.0_112<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>配置<code>conf/hbase-env.sh</code></p><pre class="line-numbers language-sh"><code class="language-sh">...# 配置java路径export JAVA_HOME=/usr/local/bin/jdk1.8.0_112# 配置是否使用自身Zookeeperexport HBASE_MANAGES_ZK=true...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>编辑<code>conf/hbase-site.xml</code></p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>hbase.rootdir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>file:///root/hbase/rootdir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>The directory shared byregion servers.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>fs.defaultFS<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>file:///root/hbase/dfs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>    <span class="token comment" spellcheck="true">&lt;!-- hbase的端口 --&gt;</span>    <span class="token comment" spellcheck="true">&lt;!-- &lt;property&gt;        &lt;name&gt;hbase.zookeeper.property.clientPort&lt;/name&gt;        &lt;value&gt;2181&lt;/value&gt;        &lt;description&gt;Property from ZooKeeper'sconfig zoo.cfg. The port at which the clients will connect.        &lt;/description&gt;    &lt;/property&gt; --&gt;</span>    <span class="token comment" spellcheck="true">&lt;!--  超时时间 --&gt;</span>    <span class="token comment" spellcheck="true">&lt;!-- &lt;property&gt;        &lt;name&gt;zookeeper.session.timeout&lt;/name&gt;        &lt;value&gt;120000&lt;/value&gt;    &lt;/property&gt; --&gt;</span>    <span class="token comment" spellcheck="true">&lt;!--  zookeeper 集群配置。如果是集群，则添加其它的主机地址 --&gt;</span>    <span class="token comment" spellcheck="true">&lt;!-- &lt;property&gt;        &lt;name&gt;hbase.zookeeper.quorum&lt;/name&gt;        &lt;value&gt;localhost:2181&lt;/value&gt;    &lt;/property&gt; --&gt;</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>hbase.tmp.dir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>/root/hbase/tmp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>    <span class="token comment" spellcheck="true">&lt;!-- &lt;property&gt;        &lt;name&gt;hbase.cluster.distributed&lt;/name&gt;        &lt;value&gt;false&lt;/value&gt;    &lt;/property&gt; --&gt;</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>hbase.zookeeper.property.dataDir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>/root/hbase/datadir<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>zookeeper.znode.parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>/hbase<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><pre><code>./bin/start-hbase.sh</code></pre><h3 id="Web-UI"><a href="#Web-UI" class="headerlink" title="Web UI"></a>Web UI</h3><p><code>http://192.168.41.128:16010</code></p><h3 id="进入shell命令行"><a href="#进入shell命令行" class="headerlink" title="进入shell命令行"></a>进入shell命令行</h3><pre><code>./bin/hbase shell</code></pre><h3 id="简单测试"><a href="#简单测试" class="headerlink" title="简单测试"></a>简单测试</h3><h4 id="创建一个表，需要指明table-name和ColumnFamily-name"><a href="#创建一个表，需要指明table-name和ColumnFamily-name" class="headerlink" title="创建一个表，需要指明table name和ColumnFamily name"></a>创建一个表，需要指明<code>table name</code>和<code>ColumnFamily name</code></h4><pre class="line-numbers language-sh"><code class="language-sh">hbase(main):002:0&gt; create 'test', 'cf'Created table testTook 0.8251 seconds=&gt; Hbase::Table - test<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="确认"><a href="#确认" class="headerlink" title="确认"></a>确认</h4><pre class="line-numbers language-sh"><code class="language-sh">hbase(main):004:0&gt; list 'test'TABLEtest1 row(s)Took 0.0077 seconds=&gt; ["test"]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="describe-‘test’"><a href="#describe-‘test’" class="headerlink" title="describe ‘test’"></a>describe ‘test’</h4><pre class="line-numbers language-sh"><code class="language-sh">hbase(main):005:0&gt; describe 'test'Table test is ENABLEDtestCOLUMN FAMILIES DESCRIPTION{NAME =&gt; 'cf', VERSIONS =&gt; '1', EVICT_BLOCKS_ON_CLOSE =&gt; 'false', NEW_VERSION_BEHAVIOR =&gt; 'false', KEEP_DELETED_CELLS =&gt; 'FALSE', CACHE_DATA_ON_WRITE =&gt; 'false', DATA_BLOCK_ENCODING =&gt; 'NONE', TTL =&gt; 'FOREVER', MIN_VERSIONS =&gt; '0', REPLICATION_SCOPE =&gt; '0', BLOOMFILTER =&gt; 'ROW', CACHE_INDEX_ON_WRITE =&gt; 'false', IN_MEMORY =&gt; 'false', CACHE_BLOOMS_ON_WRITE =&gt; 'false', PREFETCH_BLOCKS_ON_OPEN =&gt; 'false', COMPRESSION =&gt; 'NONE', BLOCKCACHE =&gt; 'true', BLOCKSIZE =&gt; '65536'} 1 row(s)QUOTAS                                                                                                                                                                  0 row(s)Took 0.2132 seconds <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="写入数据"><a href="#写入数据" class="headerlink" title="写入数据"></a>写入数据</h4><pre class="line-numbers language-sh"><code class="language-sh">hbase(main):003:0&gt; put 'test', 'row1', 'cf:a', 'value1'0 row(s) in 0.0850 secondshbase(main):004:0&gt; put 'test', 'row2', 'cf:b', 'value2'0 row(s) in 0.0110 secondshbase(main):005:0&gt; put 'test', 'row3', 'cf:c', 'value3'0 row(s) in 0.0100 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="查看写入的数据"><a href="#查看写入的数据" class="headerlink" title="查看写入的数据"></a>查看写入的数据</h4><pre class="line-numbers language-sh"><code class="language-sh">hbase(main):006:0&gt; scan 'test'ROW                                      COLUMN+CELL row1                                    column=cf:a, timestamp=1586504678931, value=value1 row2                                    column=cf:b, timestamp=1586504712029, value=value2 row3                                    column=cf:c, timestamp=1586504717104, value=value33 row(s) in 0.0230 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="获取一行数据"><a href="#获取一行数据" class="headerlink" title="获取一行数据"></a>获取一行数据</h4><pre class="line-numbers language-sh"><code class="language-sh">hbase(main):007:0&gt; get 'test', 'row1'COLUMN                                   CELL cf:a                                    timestamp=1586504678931, value=value11 row(s) in 0.0350 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="获取一个字段"><a href="#获取一个字段" class="headerlink" title="获取一个字段"></a>获取一个字段</h4><pre class="line-numbers language-sh"><code class="language-sh">hbase(main):007:0&gt; get 'test', 'row1','cf:a'COLUMN                                   CELL cf:a                                    timestamp=1586504678931, value=value11 row(s) in 0.0350 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="返回一个字段的多个版本值"><a href="#返回一个字段的多个版本值" class="headerlink" title="返回一个字段的多个版本值"></a>返回一个字段的多个版本值</h4><p>默认<code>Hbase</code>列族最多保存一个版本的数据，可以通过下面命令修改,也可以使用<code>HColumnDescriptor</code>：</p><pre class="line-numbers language-sh"><code class="language-sh">alter 'test', NAME =&gt; 'cf', VERSIONS =&gt; 3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>从<code>HBase 0.98.2</code>开始，您可以通过在<code>hbase-site.xml</code>中设置<code>hbase.column.max.version</code>为所有新创建列保留的最大版本数指定一个全局默认值。</p><pre><code>get 'test', 'row1', {COLUMN=&gt;'cf:a',VERSIONS=&gt;3}</code></pre><h4 id="禁用或者恢复表"><a href="#禁用或者恢复表" class="headerlink" title="禁用或者恢复表"></a>禁用或者恢复表</h4><pre class="line-numbers language-sh"><code class="language-sh">hbase(main):008:0&gt; disable 'test'0 row(s) in 1.1820 secondshbase(main):009:0&gt; enable 'test'0 row(s) in 0.1770 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="添加一个列族"><a href="#添加一个列族" class="headerlink" title="添加一个列族"></a>添加一个列族</h4><pre class="line-numbers language-sh"><code class="language-sh">hbase(main):012:0&gt; alter 'test',{NAME=&gt;'haha'}Updating all regions with the new schema...1/1 regions updated.Done.Took 2.0149 seconds <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-sh"><code class="language-sh">hbase(main):014:0&gt; alter 'test',NAME=&gt;'hehe'Updating all regions with the new schema...1/1 regions updated.Done.Took 1.9555 seconds <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="删除一个列族"><a href="#删除一个列族" class="headerlink" title="删除一个列族"></a>删除一个列族</h4><pre class="line-numbers language-sh"><code class="language-sh">hbase(main):009:0&gt; alter 'test',{NAME=&gt;'haha',METHOD=&gt;'delete'}Updating all regions with the new schema...1/1 regions updated.Done.Took 1.9296 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-sh"><code class="language-sh">hbase(main):013:0&gt; alter 'test','delete'=&gt;'haha'Updating all regions with the new schema...1/1 regions updated.Done.Took 1.8706 seconds <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-sh"><code class="language-sh"># 添加一个列族，同时删除一个列族hbase(main):011:0&gt; alter 'test', {NAME =&gt; 'hehe'}, {NAME =&gt; 'myInfo', METHOD =&gt; 'delete'}Updating all regions with the new schema...1/1 regions updated.Done.Updating all regions with the new schema...1/1 regions updated.Done.0 row(s) in 3.8260 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="清空表"><a href="#清空表" class="headerlink" title="清空表"></a>清空表</h4><pre class="line-numbers language-sh"><code class="language-sh">hbase(main):013:0&gt; truncate 'test'Truncating 'test' table (it may take a while): - Disabling table... - Truncating table...0 row(s) in 3.6760 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="删除表"><a href="#删除表" class="headerlink" title="删除表"></a>删除表</h4><p>删除表或者修改表的配置前，需要禁用表</p><pre class="line-numbers language-sh"><code class="language-sh">hbase(main):011:0&gt; drop 'test'0 row(s) in 0.1370 seconds<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="退出Shell"><a href="#退出Shell" class="headerlink" title="退出Shell"></a>退出Shell</h3><p><code>quit</code> 或者 <code>Ctrl+D</code></p><h3 id="停止Hbase"><a href="#停止Hbase" class="headerlink" title="停止Hbase"></a>停止Hbase</h3><pre class="line-numbers language-sh"><code class="language-sh">./bin/stop-hbase.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hbase </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springboot定时任务从配置文件中获取cron表达式</title>
      <link href="/2020/04/07/spring-boot-ding-shi-ren-wu-cong-pei-zhi-wen-jian-zhong-huo-qu-cron-biao-da-shi/"/>
      <url>/2020/04/07/spring-boot-ding-shi-ren-wu-cong-pei-zhi-wen-jian-zhong-huo-qu-cron-biao-da-shi/</url>
      
        <content type="html"><![CDATA[<h3 id="Scheduled"><a href="#Scheduled" class="headerlink" title="@Scheduled"></a>@Scheduled</h3><p>实现cron表达式从application.yml文件中获取</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">dbc</span><span class="token punctuation">:</span>  <span class="token key atrule">cron</span><span class="token punctuation">:</span> 0/5 * * * * <span class="token punctuation">?</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Component</span><span class="token annotation punctuation">@EnableScheduling</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CompareSchedule</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">"${dbc.cron}"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="cron表达式含义"><a href="#cron表达式含义" class="headerlink" title="cron表达式含义"></a>cron表达式含义</h3><p>cron一共有7位，但是最后一位是年，可以留空，所以我们可以写6位：</p><ul><li>第一位，表示秒，取值0-59</li><li>第二位，表示分，取值0-59 </li><li>第三位，表示小时，取值0-23 </li><li>第四位，日期天/日，取值1-31</li><li>第五位，日期月份，取值1-12 </li><li>第六位，星期，取值1-7，星期一，星期二…，注：不是第1周，第二周的意思 另外：1表示星期天，2表示星期一。</li><li>第七位，年份，可以留空，取值1970-2099 </li></ul><p>cron中，还有一些特殊的符号，含义如下：</p><ul><li>(*)星号：可以理解为每的意思，每秒，每分，每天，每月，每年… </li><li>(?)问号：问号只能出现在日期和星期这两个位置，表示这个位置的值不确定，每天3点执行，所以第六位星期的位置，我们是不需要关注的，就是不确定的值。同时：日期和星期是两个相互排斥的元素，通过问号来表明不指定值。比如，1月10日，比如是星期1，如果在星期的位置是另指定星期二，就前后冲突矛盾了。</li><li>(-)减号：表达一个范围，如在小时字段中使用“10-12”，则表示从10到12点，即10,11,12 </li><li>(,)逗号：表达一个列表值，如在星期字段中使用“1,2,4”，则表示星期一，星期二，星期四 </li><li>(/)斜杠：如：x/y，x是开始值，y是步长，比如在第一位（秒） 0/15就是，从0秒开始，每15秒，最后就是0，15，30，45，60 另：*/y，等同于0/y </li></ul><p>下面列举几个例子供大家来验证：</p><ul><li>0 0 3 * * ? 每天3点执行 </li><li>0 5 3 * * ? 每天3点5分执行 </li><li>0 5 3 ? * * 每天3点5分执行，与上面作用相同</li><li>0 5/10 3 * * ? 每天3点的 5分，15分，25分，35分，45分，55分这几个时间点执行 </li><li>0 10 3 ? * 1 每周星期天，3点10分 执行，注：1表示星期天 </li><li>0 10 3 ? * 1 #3 每个月的第三个星期，星期天 执行，#号只能出现在星期的位置 </li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> spring boot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring boot </tag>
            
            <tag> schedule </tag>
            
            <tag> cron </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>测试文章加密，密码123456</title>
      <link href="/2020/04/07/ce-shi-wen-zhang-jia-mi/"/>
      <url>/2020/04/07/ce-shi-wen-zhang-jia-mi/</url>
      
        <content type="html"><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <div class="hbe-input-container">  <input type="password" id="hbePass" placeholder="" />    <label for="hbePass">您好, 这里需要密码.</label>    <div class="bottom-line"></div>  </div>  <script id="hbeData" type="hbeData" data-hmacdigest="618d6daba212d3c84c9a6f0ae9baf87a0e78b74a1cb3861903995d4ac49c4cfb">77bc0d5eedda4cd565f284783dc4897a94c94d1c642f116651c186c648af73a360ff74eb83b8db683365e4190c48b8a5c1b35723823f55115c96fd6246ca639d7c69c9afd6a757ca5fe1e5326dd4238a52c419cc56c2ff52a9eef7931d735a950c78f4c51460d566541c251a1038df47b20616e65349907a106daf41809d87340b5d7fa122d6db01df2f51b798c2846335dfff34db77b88341151e42ab342e45c5d1e15b41b635972e7d887ecac29a0b46966e689fb2c25b061ece8390de3dc26314e692c2c268436bcd2c39b8e95714800f5c96f7ca46bab9cae616006f964388b8af6fd044e3a9030c06b985c63330a11eb7133664379c078f30e5988bbac11a8d955aa92b9acd0d994bdc98cfb10f4ec7652726b59ac4b4da51ccca543d22593c2b6fb808384a7b8a37a09374a7c8c6ae590804f42ba52a2573d1c24f29861ee823afea9015ccf5e753031773a8a1dac393d2e3ec0f123b373a26fc80ea811714bf68915f66c22f29d1d4f23a2b7a8db7dbefaba5d58184ac62ccca49469f510988b1eede523feb5355961b1875584d63e984ebc628cfbbd9107f7d025a940caa89f97480097e7159cdc94246d58cff3fbc4ed6fabcb916c9b607bfbd687247295195ad99995c5bf9c9095270b7598319466fa95bf3b7eae831c2b1fc67fdd646c59ce48a1877d622be9c96382090c7e0ed00fec3a703a8777d5b51f49403c34ff43a94595dbd963e4774319eb4fa7e566b0a18bb37b8b0959d1aecef0ab03d0447f0753450d770a2b385263813714012fc37b29ae9a01833a5b453e453670e0eb92802bf0f817eaf51fa0337a5a25d52b4be72608daa28b66db5b3f79896df47c1581caf93559c6481de8a9712a74ece2c7b39fe6e94e20c19779329d6211d91d2415a2fa9e16c791da0d648e60e18027b364f28f5e51cc63a79391e6b60bd63bbae933f6dbb3866ef3ee140c92c23155f6216ddfaf3136726da1af0813c9215474bdc38b474e7759e2fa87219a60cb2313cb92ce6072667042910f94cd644c28a5d57558fa59b918f9bd4a563332054a21beac6c53bb5cbeff5afc49bd73ee6b13432ab70a6bb82430e5047d9791830f71f01d62b8e4adf7b1f253a19e5c07ef1f40795c84f235b6d273da32f70a2351f0aaddbc7bb9e562f81b6e123479694b183a92ddbad7445662daf4b7ea06f8bc3c43ae316d79de93f4526245338666273c653d44ba306ce0fc1cb097d6e66a57e9f0af0aa0b1ecf2107a0bc0ed0a6e8788baf786ce7ed66c91b97a2aa87db37fc90f612ba42d88e5900789af9f7a1b31189d3c13d5265e186d49726366a50901a6badea93aaa3b8011b2bd82bfe0f886ac15d49f18503e0c73f579ce48bca7dd4c521eab48eb91a9427eabfb712316a5a672495ee43fadb674c8cbaae8f09ba3dc01411f740fb1685e722450cbe56fcf0a6596e1af1fdd9ed9c6c757eb638dd07097560f1ad76270104177e4192b77a867ef4daf0bf4be8ae0896673c437250d8c22df523c2ede0741f152f7535294eb95286e814db32f14b29369cda84e8071f0e67005805849ac5e242b9aa2ca3a01f26cce1fe1bbf467f54685604f0f119a2a9889255cf14b2b63650728e3e6ce3f2f928c506a317be09df389c5781b0e70948f5165608e71bbc052ec10e02c4d6ca0eb8aec32a5416d17dcaf529cdff8d740733d9bc98fa7f9b37dc78895af5418e9b872abd2a7d48cb23e3ebd8f0be04303bd5e32ab703e8c1e5cf8b2e5bd92c94c12f7a303a29fb97598cf7ba6a5993509c092fec3c9f6a9b9daab1bff3c852b07f765dc016804d0ac130b4dff91c35ca00cb355ea4f725a6f9e01e54c6daece57cde88be686d79abae5fadd73ffcbb03a965744e035fce7095b59af296f1024bd9bd0f0ec9e68a9b8f58d664c64a8a99eec851ff1e1bd32b1a3114724aaba45cba880dfc5ff0daf580aa4b71e60b8b771b23363a332dc05b43f8b9eaf4bd021011856eacd40a84b4f1e145bd140ac404eaad1131aba5a293282b9a8947e7333e89069d4f0926bd4620ad55ce978f18002ed1e76f75de4ef7026966912fdb447447f85ca086f4dea57219fbddabd628d96e014e6a954a4de75698e51fead3b4986508e3406d660f7af87fca0a92098b137101805cbbc6d7589c14fd5ae23dc62b3fd40b7e299137ddcb3ac870cf61b73aaa949fc1888ba182d388b3cd70ed9f52d124c9b08c986c7dead70a75cb9dc55f962a32c4ce9240bfefe305b8856a09c54c907d5d124bdf36f9f55611169c122432f5ee399a0c114bececfcf6b1bffbc7c4897a8912d86a67e9dc943f8d1cfaf22c80a090da2c7eee6a844d088593a726ba466c7f98ed03392257971bd5e04220655bebb974a9d69ed2fdc39c0b1bb23b8ce743d2d83352394e737a307ca16e152c925fa68f0a25db5c09f78d4f49c22e21664881be724bce0b94fb2d680c43e9bc2f389ee7bf533ae86401660fd25621a4ce11583b9ba52a09d9e726c8de908cfada45d01c04fb334bb7a679f8814031f159bafa573cbcd26dd1ba759c2443b5cbf71dc527e5950fec45418ae7ae800db9fc05189e19c12752b208574ffb9988c2efee4bf1ba982be3c6c0f2d6f9e742e26c59927e51b0004239c2dfa8acfd9420da168ce92968b026924d50635e7a17185caf65061cc68694f19f3c9f2400593c95d9cb71f335d57350285c23ef98d9fd4a92d16d4d7918f20c051d7690edb8ac3f0935af18af023d21c9a0a91b3da3ed33a0b52d6aa4c891d9054d681946909ea2ad8d3079e05015400ba64904737e1c5e2c32cd337a458a401374d387ed082ebb6cdd9abde6c16c7450e5b604d289246ec03604b336d67882326b3e10cf7de8ed37b5f03ee020a22e01de8415d37bff15c4c38c6c329e0d2a56e1132b33f496be0b6d17a39315be3f1d1da2b6591be9fbd9a08e8d9f3d1ef7ca335446e1fab30c96a864874f87fe4b80c180a867c40478b452b758cbf2b5bc27581eea387cbd908bfe461009ec73f8bafc1a2085bc5235c365976be7ca43446f393e9f7e1f86e487aa2ced8a0c7f754b659eb18f3ca760158f89a14120d00529dbc8905f7262d8737df0fce509d4982de4fd0aee4d8c34ca5e24d07fc11b462eca3d2a8213b9668f063aa25717173a95c5bfcff8f2fb1e8f36fd6c31cb15d02863f8bc6952d64f4c722ee7258e0a6cab04b5225f6e93828ceab08e41850fd756d7b5def616822e1fd44e8863b9008c28b37a5c613dfd418979d3ab6c4300b8fb3af51f0fb7b555e588f231eb2223018eba34</script></div><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      
      
      <categories>
          
          <category> test </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SHA256 </tag>
            
            <tag> hexo-blog-encrypt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysql表结构查询</title>
      <link href="/2020/04/02/mysql-biao-jie-gou-cha-xun/"/>
      <url>/2020/04/02/mysql-biao-jie-gou-cha-xun/</url>
      
        <content type="html"><![CDATA[<h3 id="方法1"><a href="#方法1" class="headerlink" title="方法1"></a>方法1</h3><p>这种方法能够查询到一些表信息，但是不够详细</p><pre class="line-numbers language-java"><code class="language-java">PreparedStatement pst <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token string">"select * from t_gateway_logs where 1=2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ResultSet rs <span class="token operator">=</span> pst<span class="token punctuation">.</span><span class="token function">executeQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ResultSetMetaData rsd <span class="token operator">=</span> rs<span class="token punctuation">.</span><span class="token function">getMetaData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rsd<span class="token punctuation">.</span><span class="token function">getColumnCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"java类型："</span><span class="token operator">+</span>rsd<span class="token punctuation">.</span><span class="token function">getColumnClassName</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  数据库类型:"</span><span class="token operator">+</span>rsd<span class="token punctuation">.</span><span class="token function">getColumnTypeName</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  字段名称:"</span><span class="token operator">+</span>rsd<span class="token punctuation">.</span><span class="token function">getColumnName</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  字段长度:"</span><span class="token operator">+</span>rsd<span class="token punctuation">.</span><span class="token function">getColumnDisplaySize</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  是否为空:"</span><span class="token operator">+</span>rsd<span class="token punctuation">.</span><span class="token function">isNullable</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"  是否自增:"</span><span class="token operator">+</span>rsd<span class="token punctuation">.</span><span class="token function">isAutoIncrement</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><p>查询出来的内容非常多。</p><h4 id="查询出库中所有表"><a href="#查询出库中所有表" class="headerlink" title="查询出库中所有表"></a>查询出库中所有表</h4><pre class="line-numbers language-java"><code class="language-java">ResultSet tableRet <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getMetaData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTables</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"%"</span><span class="token punctuation">,</span><span class="token string">"%"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"TABLE"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span><span class="token punctuation">(</span>tableRet<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>tableRet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"TABLE_NAME"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="查询某个表的主键信息"><a href="#查询某个表的主键信息" class="headerlink" title="查询某个表的主键信息"></a>查询某个表的主键信息</h4><pre class="line-numbers language-java"><code class="language-java">ResultSet pkInfo <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getMetaData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPrimaryKeys</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"%"</span><span class="token punctuation">,</span> <span class="token string">"test_table"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>pkInfo<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"TABLE_CAT:"</span> <span class="token operator">+</span> pkInfo<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"TABLE_CAT"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"TABLE_NAME:"</span> <span class="token operator">+</span> pkInfo<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"TABLE_NAME"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"COLUMN_NAME:"</span> <span class="token operator">+</span> pkInfo<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"COLUMN_NAME"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"PK_NAME:"</span> <span class="token operator">+</span> pkInfo<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"PK_NAME"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"TABLE_SCHEM:"</span> <span class="token operator">+</span> pkInfo<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"TABLE_SCHEM"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"KEY_SEQ:"</span> <span class="token operator">+</span> pkInfo<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"KEY_SEQ"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="查询某个表的详细信息"><a href="#查询某个表的详细信息" class="headerlink" title="查询某个表的详细信息"></a>查询某个表的详细信息</h4><pre class="line-numbers language-java"><code class="language-java">ResultSet colRet <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getMetaData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getColumns</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token string">"%"</span><span class="token punctuation">,</span> <span class="token string">"test_table"</span><span class="token punctuation">,</span> <span class="token string">"%"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">while</span> <span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"TABLE_CAT"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"TABLE_SCHEM"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"TABLE_NAME"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"COLUMN_NAME"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"DATA_TYPE"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"TYPE_NAME"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"COLUMN_SIZE"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"BUFFER_LENGTH"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"DECIMAL_DIGITS"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"NUM_PREC_RADIX"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"NULLABLE"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"REMARKS"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"COLUMN_DEF"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"SQL_DATA_TYPE"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"SQL_DATETIME_SUB"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"CHAR_OCTET_LENGTH"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"ORDINAL_POSITION"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">"IS_NULLABLE"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"SCOPE_CATALOG"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"SCOPE_SCHEMA"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"SCOPE_TABLE"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string">"SOURCE_DATA_TYPE"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">"IS_AUTOINCREMENT"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>colRet<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">"IS_GENERATEDCOLUMN"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> schema </tag>
            
            <tag> jdbc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>maven打包插件指定main函数及依赖包</title>
      <link href="/2020/04/02/maven-da-bao-cha-jian-zhi-ding-main-han-shu-ji-yi-lai-bao/"/>
      <url>/2020/04/02/maven-da-bao-cha-jian-zhi-ding-main-han-shu-ji-yi-lai-bao/</url>
      
        <content type="html"><![CDATA[<h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p><code>Maven</code>打包<code>jar</code>用的默认插件是<code>maven-jar-plugin</code>，默认<code>Maven</code>生成的<code>JAR</code>包只包含了编译生成的<code>.class</code>文件和项目资源文件。有两个问题：</p><ul><li>运行时提示没有主清单属性;</li><li>依赖的jar包也没有打包进去.</li></ul><h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p><code>maven</code>打包插件有很多种：</p><ul><li><code>maven-shade-plugin</code></li><li><code>maven-assembly-plugin</code></li><li><code>maven-jar-plugin</code></li></ul><p>我们直接重新定义<code>maven-jar-plugin</code>,详细配置如下：</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-shade-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.2.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">></span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>shade<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transformers</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transformer</span>                                    <span class="token attr-name">implementation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.apache.maven.plugins.shade.resource.ManifestResourceTransformer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                                <span class="token comment" spellcheck="true">&lt;!-- 这里指定main函数 --></span>                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mainClass</span><span class="token punctuation">></span></span>com.deri.App<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mainClass</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>transformer</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>transformers</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> maven </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>logback关闭启动时自身调试信息打印</title>
      <link href="/2020/04/01/logback-guan-bi-qi-dong-shi-zi-shen-diao-shi-xin-xi-da-yin/"/>
      <url>/2020/04/01/logback-guan-bi-qi-dong-shi-zi-shen-diao-shi-xin-xi-da-yin/</url>
      
        <content type="html"><![CDATA[<h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>使用logback打印日志，启动服务时logback会打印一些自身的调试信息如下，会打印它检查了哪些配置、看见了哪些配置：</p><pre class="line-numbers language-log"><code class="language-log">18:00:22,729 |-INFO in ch.qos.logback.classic.LoggerContext[default] - Could NOT find resource [logback-test.xml]18:00:22,729 |-INFO in ch.qos.logback.classic.LoggerContext[default] - Could NOT find resource [logback.groovy]18:00:22,729 |-INFO in ch.qos.logback.classic.LoggerContext[default] - Found resource [logback.xml] at [file:/D:/DeriGateway/DBCompare/target/classes/logback.xml]18:00:22,770 |-INFO in ch.qos.logback.classic.joran.action.ConfigurationAction - debug attribute not set18:00:22,775 |-INFO in ch.qos.logback.core.joran.action.TimestampAction - Using current interpretation time, i.e. now, as time reference.18:00:22,788 |-INFO in ch.qos.logback.core.joran.action.TimestampAction - Adding property to the context with key="DATETIME" and value="2020-04-01 18:00:22" to the LOCAL scope18:00:22,788 |-INFO in ch.qos.logback.core.joran.action.AppenderAction - About to instantiate appender of type [ch.qos.logback.core.ConsoleAppender]18:00:22,793 |-INFO in ch.qos.logback.core.joran.action.AppenderAction - Naming appender as [STDOUT]18:00:22,796 |-INFO in ch.qos.logback.core.joran.action.NestedComplexPropertyIA - Assuming default type [ch.qos.logback.classic.encoder.PatternLayoutEncoder] for [encoder] property18:00:22,813 |-INFO in ch.qos.logback.core.joran.action.AppenderAction - About to instantiate appender of type [ch.qos.logback.core.rolling.RollingFileAppender]18:00:22,816 |-INFO in ch.qos.logback.core.joran.action.AppenderAction - Naming appender as [FILEOUT]18:00:22,817 |-INFO in ch.qos.logback.core.joran.action.NestedComplexPropertyIA - Assuming default type [ch.qos.logback.classic.encoder.PatternLayoutEncoder] for [encoder] property18:00:22,828 |-INFO in c.q.l.core.rolling.TimeBasedRollingPolicy@984849465 - No compression will be used18:00:22,829 |-INFO in c.q.l.core.rolling.TimeBasedRollingPolicy@984849465 - Will use the pattern ./logs//log.%d.%i.log for the active file18:00:22,830 |-INFO in ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP@2eee9593 - The date pattern is 'yyyy-MM-dd' from file name pattern './logs//log.%d.%i.log'.18:00:22,830 |-INFO in ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP@2eee9593 - Roll-over at midnight.18:00:22,832 |-INFO in ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP@2eee9593 - Setting initial period to Wed Apr 01 18:00:22 CST 202018:00:22,833 |-WARN in ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP@2eee9593 - SizeAndTimeBasedFNATP is deprecated. Use SizeAndTimeBasedRollingPolicy instead18:00:22,833 |-WARN in ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP@2eee9593 - For more information see http://logback.qos.ch/manual/appenders.html#SizeAndTimeBasedRollingPolicy18:00:22,834 |-INFO in ch.qos.logback.core.rolling.RollingFileAppender[FILEOUT] - Active log file name: ./logs//log.2020-04-01.0.log18:00:22,834 |-INFO in ch.qos.logback.core.rolling.RollingFileAppender[FILEOUT] - File property is set to [null]18:00:22,835 |-INFO in ch.qos.logback.classic.joran.action.RootLoggerAction - Setting level of ROOT logger to INFO18:00:22,835 |-INFO in ch.qos.logback.core.joran.action.AppenderRefAction - Attaching appender named [STDOUT] to Logger[ROOT]18:00:22,835 |-INFO in ch.qos.logback.core.joran.action.AppenderRefAction - Attaching appender named [FILEOUT] to Logger[ROOT]18:00:22,835 |-INFO in ch.qos.logback.classic.joran.action.ConfigurationAction - End of configuration.18:00:22,836 |-INFO in ch.qos.logback.classic.joran.JoranConfigurator@7907ec20 - Registering current configuration as safe fallback point<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="关闭logback自身调试信息打印"><a href="#关闭logback自身调试信息打印" class="headerlink" title="关闭logback自身调试信息打印"></a>关闭logback自身调试信息打印</h3><p>只需增加一行以下配置即可。将状态信息监听器设置为无操作监听器。</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>statusListener</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.core.status.NopStatusListener<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="完整logback-xml"><a href="#完整logback-xml" class="headerlink" title="完整logback.xml"></a>完整logback.xml</h3><pre class="line-numbers language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>statusListener</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.core.status.NopStatusListener<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ROOT<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>./logs/<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>FILESIZE<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100MB<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>MAXHISTORY<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>30<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>timestamp</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATETIME<span class="token punctuation">"</span></span> <span class="token attr-name">datePattern</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>yyyy-MM-dd HH:mm:ss<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token comment" spellcheck="true">&lt;!-- 控制台打印 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>STDOUT<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.core.ConsoleAppender<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">></span></span>[%-5level] %d{${DATETIME}} [%thread] %logger{36} - %m%n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!-- 输入到文件，按日期和文件大小 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>FILEOUT<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.core.rolling.RollingFileAppender<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">></span></span>[%-5level] %d{${DATETIME}} [%thread] %logger{36} - %m%n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rollingPolicy</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.core.rolling.TimeBasedRollingPolicy<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fileNamePattern</span><span class="token punctuation">></span></span>${ROOT}/log.%d.%i.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fileNamePattern</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maxHistory</span><span class="token punctuation">></span></span>${MAXHISTORY}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maxHistory</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>timeBasedFileNamingAndTriggeringPolicy</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maxFileSize</span><span class="token punctuation">></span></span>${FILESIZE}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maxFileSize</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>timeBasedFileNamingAndTriggeringPolicy</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rollingPolicy</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!-- Logger 根目录 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INFO<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>STDOUT<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>FILEOUT<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> logback </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springboot利用系统变量和配置文件实现灵活配置</title>
      <link href="/2020/03/31/spring-boot-li-yong-xi-tong-bian-liang-he-pei-zhi-wen-jian-shi-xian-ling-huo-pei-zhi/"/>
      <url>/2020/03/31/spring-boot-li-yong-xi-tong-bian-liang-he-pei-zhi-wen-jian-shi-xian-ling-huo-pei-zhi/</url>
      
        <content type="html"><![CDATA[<h3 id="静态方式"><a href="#静态方式" class="headerlink" title="静态方式"></a>静态方式</h3><p>直接在<code>bootstrap.yml</code>或者<code>application.yml</code>中写死；</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true">#mysql数据配置</span>  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver    <span class="token key atrule">username</span><span class="token punctuation">:</span> root    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//192.168.41.128<span class="token punctuation">:</span>3306/gw<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding</span>=utf8<span class="token important">&amp;useSSL</span>=false<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>缺点是参数需要改变时，需要重新改写配置，再打包。特别docker部署时，环境变化了，配置改动麻烦。</p><h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p>在<code>yml</code>文件中，通过<code>${Envirment_variable}</code>的方式可以获取系统环境变量中的值；如上面的配置改写成：</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true">#mysql数据配置</span>  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver    <span class="token key atrule">username</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>USER_NAME<span class="token punctuation">:</span>root<span class="token punctuation">}</span>    <span class="token key atrule">password</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>PASSWORD<span class="token punctuation">:</span><span class="token number">123456</span><span class="token punctuation">}</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//$<span class="token punctuation">{</span>IP<span class="token punctuation">:</span>192.168.41.128<span class="token punctuation">:</span><span class="token number">3306</span><span class="token punctuation">}</span>/gw<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding</span>=utf8<span class="token important">&amp;useSSL</span>=false<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上配置，优先设置系统环境变量（USER_NAME、PASSWORD、IP）的值，如果没有，才会使用默认值。</p><h3 id="docker部署传入环境变量"><a href="#docker部署传入环境变量" class="headerlink" title="docker部署传入环境变量"></a>docker部署传入环境变量</h3><ul><li>通过<code>-e</code>可以传入环境变量;</li><li><code>docker-compose</code>可以通过<code>environment</code>传入系统环境变量;</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> spring boot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring boot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flinkSQL-client初体验</title>
      <link href="/2020/03/26/flinksql-client-chu-ti-yan/"/>
      <url>/2020/03/26/flinksql-client-chu-ti-yan/</url>
      
        <content type="html"><![CDATA[<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>本章创建一个模拟数据源将模拟数据源源不断写到<code>kafka</code>中，然后使用<code>Flink SQL client</code>查询<code>kafka</code>中的数据。</p><p>模拟数据由java对象序列化而成的json格式字符串，包含book的id、type、price和时间。</p><h3 id="BookPojo-java"><a href="#BookPojo-java" class="headerlink" title="BookPojo.java"></a>BookPojo.java</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>deri<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>util<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>JSONField<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>Timestamp<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Date<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @ClassName: BookPojo * @Description: TODO * @Author: wuzhiyong * @Time: 2020/3/20 9:48 * @Version: v1.0 **/</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BookPojo</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>    <span class="token keyword">private</span> String type<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> price<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//Currently, JSON format only allowed the timestamp data is in RFC-3339, i.e. "2019-07-09 02:02:00.040Z".</span>    <span class="token comment" spellcheck="true">//注意引入的是java.util.Date;而不是java.sql.Date;</span>    <span class="token annotation punctuation">@JSONField</span><span class="token punctuation">(</span>format <span class="token operator">=</span> <span class="token string">"yyyy-MM-dd'T'HH:mm:ss'Z'"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> Date ts<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">BookPojo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> id<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> type<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setType</span><span class="token punctuation">(</span>String type<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> price<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token keyword">int</span> price<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>price <span class="token operator">=</span> price<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> Date <span class="token function">getTs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> ts<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTs</span><span class="token punctuation">(</span>Date ts<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>ts <span class="token operator">=</span> ts<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="模拟书籍Books-java"><a href="#模拟书籍Books-java" class="headerlink" title="模拟书籍Books.java"></a>模拟书籍Books.java</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>deri<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>util<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Random<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @ClassName: Books * @Description: TODO * @Author: wuzhiyong * @Time: 2020/3/20 10:52 * @Version: v1.0 **/</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Books</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> BookPojo <span class="token function">getBook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        List<span class="token operator">&lt;</span>BookPojo<span class="token operator">></span> bookPojos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">{</span>            BookPojo book1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BookPojo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string">"cs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            bookPojos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>book1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">{</span>            BookPojo book1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BookPojo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string">"math"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token number">70</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            bookPojos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>book1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">{</span>            BookPojo book1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BookPojo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string">"ph"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            bookPojos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>book1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">{</span>            BookPojo book1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BookPojo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string">"cs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            bookPojos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>book1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">{</span>            BookPojo book1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BookPojo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string">"math"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            bookPojos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>book1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">{</span>            BookPojo book1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BookPojo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string">"ph"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            bookPojos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>book1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> bookPojos<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="创建flink-source"><a href="#创建flink-source" class="headerlink" title="创建flink source"></a>创建flink source</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>deri<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>util<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>JSON<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>source<span class="token punctuation">.</span>SourceFunction<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>Timestamp<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Date<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Random<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @ClassName: MyNoParalleSource * @Description: TODO * @Author: wuzhiyong * @Time: 2020/3/4 10:15 * @Version: v1.0 **/</span><span class="token comment" spellcheck="true">//使用并行度为1的source</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyPojoSource</span> <span class="token keyword">implements</span> <span class="token class-name">SourceFunction</span><span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//1</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> isRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span>SourceContext<span class="token operator">&lt;</span>String<span class="token operator">></span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>isRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>            BookPojo book <span class="token operator">=</span> Books<span class="token punctuation">.</span><span class="token function">getBook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book<span class="token punctuation">.</span><span class="token function">setTs</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            ctx<span class="token punctuation">.</span><span class="token function">collectWithTimestamp</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span><span class="token punctuation">,</span>book<span class="token punctuation">.</span><span class="token function">getTs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        isRunning <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="创建flink任务，此任务只是将模拟数据写到kafka中"><a href="#创建flink任务，此任务只是将模拟数据写到kafka中" class="headerlink" title="创建flink任务，此任务只是将模拟数据写到kafka中"></a>创建flink任务，此任务只是将模拟数据写到kafka中</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>deri<span class="token punctuation">.</span>pojo<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>deri<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>util<span class="token punctuation">.</span>MyPojoSource<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span>SimpleStringSchema<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>DataStreamSource<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span>StreamExecutionEnvironment<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>FlinkKafkaProducer<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Properties<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @ClassName: KafkaProducer * @Description: TODO * @Author: wuzhiyong * @Time: 2020/3/4 10:16 * @Version: v1.0 **/</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaPojoProducer</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        StreamExecutionEnvironment env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        DataStreamSource<span class="token operator">&lt;</span>String<span class="token operator">></span> text <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyPojoSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">/*设置并行度*/</span><span class="token punctuation">;</span>        Properties properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"192.168.41.128:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//new FlinkKafkaProducer("topn",new KeyedSerializationSchemaWrapper(new SimpleStringSchema()),properties,FlinkKafkaProducer.Semantic.EXACTLY_ONCE);</span>        FlinkKafkaProducer<span class="token operator">&lt;</span>String<span class="token operator">></span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlinkKafkaProducer</span><span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token string">"pojo4"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//event-timestamp事件的发生时间</span>        producer<span class="token punctuation">.</span><span class="token function">setWriteTimestampToKafka</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        text<span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span>producer<span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"POJO Kafka Source"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="配置sql-client-defaults-yaml"><a href="#配置sql-client-defaults-yaml" class="headerlink" title="配置sql-client-defaults.yaml"></a>配置sql-client-defaults.yaml</h3><p>配置文件位于<code>flink根目录/conf</code>下</p><p>配置table</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">tables</span><span class="token punctuation">:</span>   <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> book    <span class="token key atrule">type</span><span class="token punctuation">:</span> source<span class="token punctuation">-</span>table    <span class="token key atrule">update-mode</span><span class="token punctuation">:</span> append    <span class="token key atrule">connector</span><span class="token punctuation">:</span>       <span class="token key atrule">property-version</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> kafka      <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"universal"</span>      <span class="token key atrule">topic</span><span class="token punctuation">:</span> pojo4      <span class="token key atrule">startup-mode</span><span class="token punctuation">:</span> earliest<span class="token punctuation">-</span>offset      <span class="token key atrule">properties</span><span class="token punctuation">:</span>        <span class="token key atrule">zookeeper.connect</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">2181</span>        <span class="token key atrule">bootstrap.servers</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">9092</span>        <span class="token key atrule">group.id</span><span class="token punctuation">:</span> testGroup    <span class="token key atrule">format</span><span class="token punctuation">:</span>       <span class="token key atrule">property-version</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> json      <span class="token comment" spellcheck="true"># derive-schema: true</span>      <span class="token key atrule">schema</span><span class="token punctuation">:</span> <span class="token string">"ROW&lt;id INT, type STRING, price INT, ts TIMESTAMP>"</span>    <span class="token key atrule">schema</span><span class="token punctuation">:</span>       <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> id        <span class="token key atrule">data-type</span><span class="token punctuation">:</span> INT      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> type        <span class="token key atrule">data-type</span><span class="token punctuation">:</span> STRING      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> price        <span class="token key atrule">data-type</span><span class="token punctuation">:</span> INT      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tss        <span class="token key atrule">data-type</span><span class="token punctuation">:</span> TIMESTAMP        <span class="token key atrule">rowtime</span><span class="token punctuation">:</span>          <span class="token key atrule">timestamps</span><span class="token punctuation">:</span>            <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"from-field"</span>            <span class="token key atrule">from</span><span class="token punctuation">:</span> <span class="token string">"ts"</span>          <span class="token key atrule">watermarks</span><span class="token punctuation">:</span>            <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"periodic-bounded"</span>            <span class="token key atrule">delay</span><span class="token punctuation">:</span> <span class="token string">"60000"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="启动SQL-client"><a href="#启动SQL-client" class="headerlink" title="启动SQL client"></a>启动SQL client</h3><p>进入到flink根目录下，执行</p><pre class="line-numbers language-sh"><code class="language-sh">./bin/sql-client.sh embedded<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果没有报错，可以看到一个小松鼠，并进入以下界面</p><pre><code>...Flink SQL&gt; </code></pre><h3 id="一些测试SQL语句"><a href="#一些测试SQL语句" class="headerlink" title="一些测试SQL语句"></a>一些测试SQL语句</h3><ol><li><p>最简单的查询</p><pre class="line-numbers language-SQL"><code class="language-SQL">SELECT * FROM book;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>查询价格大于50的</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> book <span class="token keyword">GROUP</span> <span class="token keyword">BY</span>  id<span class="token punctuation">,</span>price<span class="token punctuation">,</span><span class="token keyword">type</span><span class="token punctuation">,</span>tss  <span class="token keyword">having</span> price <span class="token operator">></span> <span class="token number">50</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>每五分钟book的总销售额</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> id<span class="token punctuation">,</span><span class="token keyword">type</span><span class="token punctuation">,</span>TUMBLE_END<span class="token punctuation">(</span>tss<span class="token punctuation">,</span> INTERVAL <span class="token string">'5'</span> MINUTE<span class="token punctuation">)</span> <span class="token keyword">AS</span> window_end<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">AS</span> sumprice<span class="token keyword">FROM</span> book<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>  id<span class="token punctuation">,</span><span class="token keyword">type</span><span class="token punctuation">,</span>TUMBLE<span class="token punctuation">(</span>tss<span class="token punctuation">,</span> INTERVAL <span class="token string">'5'</span> MINUTE<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>创建一个新的view，用于存放SELECT结果</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> book_view <span class="token keyword">AS</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> book <span class="token keyword">GROUP</span> <span class="token keyword">BY</span>  id<span class="token punctuation">,</span>price<span class="token punctuation">,</span><span class="token keyword">type</span><span class="token punctuation">,</span>tss  <span class="token keyword">having</span> price <span class="token operator">></span> <span class="token number">60</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>根据id查询卖出的总数量</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> id<span class="token punctuation">,</span><span class="token keyword">type</span><span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">AS</span> cnt <span class="token keyword">FROM</span> book <span class="token keyword">GROUP</span> <span class="token keyword">BY</span>  id<span class="token punctuation">,</span><span class="token keyword">type</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>根据type查询卖出的总数量</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token keyword">type</span><span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> cnt <span class="token keyword">FROM</span> book <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">type</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>查询过去5分钟不同id的书卖出的总额，每1分钟刷新一次</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> id<span class="token punctuation">,</span><span class="token keyword">type</span><span class="token punctuation">,</span>HOP_START <span class="token punctuation">(</span>tss<span class="token punctuation">,</span> INTERVAL <span class="token string">'60'</span> SECOND<span class="token punctuation">,</span> INTERVAL <span class="token string">'5'</span> MINUTE<span class="token punctuation">)</span> <span class="token keyword">AS</span> window_end<span class="token punctuation">,</span><span class="token function">SUM</span><span class="token punctuation">(</span>price<span class="token punctuation">)</span> <span class="token keyword">AS</span> sumprice<span class="token keyword">FROM</span> book<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>  id<span class="token punctuation">,</span><span class="token keyword">type</span><span class="token punctuation">,</span>HOP <span class="token punctuation">(</span>tss<span class="token punctuation">,</span> INTERVAL <span class="token string">'60'</span> SECOND<span class="token punctuation">,</span> INTERVAL <span class="token string">'5'</span> MINUTE<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>创建一个模拟列，存放系统处理的时间</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">select</span> id<span class="token punctuation">,</span>price<span class="token punctuation">,</span>tss<span class="token punctuation">,</span> PROCTIME<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> ts <span class="token keyword">from</span> book<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ol><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> flink </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flink </tag>
            
            <tag> sql </tag>
            
            <tag> kafka </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FlinkSQL中窗口函数</title>
      <link href="/2020/03/26/flinksql-zhong-chuang-kou-han-shu/"/>
      <url>/2020/03/26/flinksql-zhong-chuang-kou-han-shu/</url>
      
        <content type="html"><![CDATA[<h3 id="滚动窗口（TUMBLE）"><a href="#滚动窗口（TUMBLE）" class="headerlink" title="滚动窗口（TUMBLE）"></a>滚动窗口（TUMBLE）</h3><p>滚动窗口（TUMBLE）将每个元素分配到一个指定大小的窗口中。通常滚动窗口有一个固定的大小，并且不会出现重叠。例如：如果指定了一个5分钟大小的滚动窗口，无限流的数据会根据时间划分成[0:00 - 0:05)、[0:05, 0:10)、 [0:10, 0:15)等窗口。</p><p><img src="/images/flink28.png" alt="tumble"></p><h4 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h4><p>TUMBLE函数用在GROUP BY子句中，用来定义滚动窗口。</p><pre class="line-numbers language-sql"><code class="language-sql">TUMBLE<span class="token punctuation">(</span><span class="token operator">&lt;</span>time<span class="token operator">-</span>attr<span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>size<span class="token operator">-</span>interval<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">&lt;</span>size<span class="token operator">-</span>interval<span class="token operator">></span>: INTERVAL <span class="token string">'string'</span> timeUnit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">SELECT</span>TUMBLE_START<span class="token punctuation">(</span>ts<span class="token punctuation">,</span> INTERVAL <span class="token string">'1'</span> MINUTE<span class="token punctuation">)</span><span class="token punctuation">,</span>TUMBLE_END<span class="token punctuation">(</span>ts<span class="token punctuation">,</span> INTERVAL <span class="token string">'1'</span> MINUTE<span class="token punctuation">)</span><span class="token punctuation">,</span>username<span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span>click_url<span class="token punctuation">)</span><span class="token keyword">FROM</span> user_clicks<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> TUMBLE<span class="token punctuation">(</span>ts<span class="token punctuation">,</span> INTERVAL <span class="token string">'1'</span> MINUTE<span class="token punctuation">)</span><span class="token punctuation">,</span> username<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><a href="https://help.aliyun.com/document_detail/62511.html?spm=a2c4g.11186623.6.654.23083f50O8pvx8" target="_blank" rel="noopener">具体参考阿里云</a></p><h3 id="滑动窗口（HOP）"><a href="#滑动窗口（HOP）" class="headerlink" title="滑动窗口（HOP）"></a>滑动窗口（HOP）</h3><p>滑动窗口（HOP），也被称作Sliding Window。不同于滚动窗口，滑动窗口的窗口可以重叠。</p><p>滑动窗口有两个参数：slide和size。slide为每次滑动的步长，size为窗口的大小。</p><ul><li>slide &lt; size，则窗口会重叠，每个元素会被分配到多个窗口。</li><li>slide = size，则等同于滚动窗口（TUMBLE）。</li><li>slide &gt; size，则为跳跃窗口，窗口之间不重叠且有间隙。</li></ul><p><img src="/images/flink29.png" alt="hop"></p><p>通常情况下大部分元素符合多个窗口情景，窗口是重叠的。因此，滑动窗口在计算移动平均数（moving averages）时很实用。例如，计算过去5分钟数据的平均值，每10秒钟更新一次，可以设置slide为10秒，size为5分钟。</p><h4 id="滑动窗口函数语法"><a href="#滑动窗口函数语法" class="headerlink" title="滑动窗口函数语法"></a>滑动窗口函数语法</h4><p>HOP函数用在group by子句中，用来定义滑动窗口。</p><pre class="line-numbers language-sql"><code class="language-sql">HOP<span class="token punctuation">(</span><span class="token operator">&lt;</span>time<span class="token operator">-</span>attr<span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>slide<span class="token operator">-</span>interval<span class="token operator">></span><span class="token punctuation">,</span><span class="token operator">&lt;</span>size<span class="token operator">-</span>interval<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">&lt;</span>slide<span class="token operator">-</span>interval<span class="token operator">></span>: INTERVAL <span class="token string">'string'</span> timeUnit<span class="token operator">&lt;</span>size<span class="token operator">-</span>interval<span class="token operator">></span>: INTERVAL <span class="token string">'string'</span> timeUnit  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h4><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">SELECT</span>    HOP_START <span class="token punctuation">(</span>ts<span class="token punctuation">,</span> INTERVAL <span class="token string">'30'</span> SECOND<span class="token punctuation">,</span> INTERVAL <span class="token string">'1'</span> MINUTE<span class="token punctuation">)</span><span class="token punctuation">,</span>    HOP_END <span class="token punctuation">(</span>ts<span class="token punctuation">,</span> INTERVAL <span class="token string">'30'</span> SECOND<span class="token punctuation">,</span> INTERVAL <span class="token string">'1'</span> MINUTE<span class="token punctuation">)</span><span class="token punctuation">,</span>    username<span class="token punctuation">,</span>    <span class="token function">COUNT</span> <span class="token punctuation">(</span>click_url<span class="token punctuation">)</span><span class="token keyword">FROM</span>    user_clicks<span class="token keyword">GROUP</span> <span class="token keyword">BY</span>    HOP <span class="token punctuation">(</span>ts<span class="token punctuation">,</span> INTERVAL <span class="token string">'30'</span> SECOND<span class="token punctuation">,</span> INTERVAL <span class="token string">'1'</span> MINUTE<span class="token punctuation">)</span><span class="token punctuation">,</span>    username  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><a href="https://help.aliyun.com/document_detail/62512.html?spm=a2c4g.11186623.6.655.10d7ca8c6hnmCW" target="_blank" rel="noopener">具体参考阿里云</a></p><h3 id="会话窗口（SESSION）"><a href="#会话窗口（SESSION）" class="headerlink" title="会话窗口（SESSION）"></a>会话窗口（SESSION）</h3><p>会话窗口（SESSION）通过Session活动来对元素进行分组。会话窗口与滚动窗口和滑动窗口相比，没有窗口重叠，没有固定窗口大小。相反，当它在一个固定的时间周期内不再收到元素，即会话断开时，这个窗口就会关闭。</p><p>会话窗口通过一个间隔时间（Gap）来配置，这个间隔定义了非活跃周期的长度。例如，一个表示鼠标点击活动的数据流可能具有长时间的空闲时间，并在两段空闲之间散布着高浓度的点击。 如果数据在指定的间隔（Gap）之后到达，则会开始一个新的窗口。</p><p>会话窗口示例如下图。每个Key由于不同的数据分布，形成了不同的Window。<br><img src="/images/flink30.png" alt="session"></p><h4 id="会话窗口函数语法"><a href="#会话窗口函数语法" class="headerlink" title="会话窗口函数语法"></a>会话窗口函数语法</h4><p>SESSION函数用于在GROUP BY子句中定义会话窗口。</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">SESSION</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>time<span class="token operator">-</span>attr<span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>gap<span class="token operator">-</span>interval<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">&lt;</span>gap<span class="token operator">-</span>interval<span class="token operator">></span>: INTERVAL <span class="token string">'string'</span> timeUnit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h4><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">SELECT</span>SESSION_START<span class="token punctuation">(</span>ts<span class="token punctuation">,</span> INTERVAL <span class="token string">'30'</span> SECOND<span class="token punctuation">)</span><span class="token punctuation">,</span>SESSION_END<span class="token punctuation">(</span>ts<span class="token punctuation">,</span> INTERVAL <span class="token string">'30'</span> SECOND<span class="token punctuation">)</span><span class="token punctuation">,</span>username<span class="token punctuation">,</span><span class="token function">COUNT</span><span class="token punctuation">(</span>click_url<span class="token punctuation">)</span><span class="token keyword">FROM</span> user_clicks<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token keyword">SESSION</span><span class="token punctuation">(</span>ts<span class="token punctuation">,</span> INTERVAL <span class="token string">'30'</span> SECOND<span class="token punctuation">)</span><span class="token punctuation">,</span> username<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><a href="https://help.aliyun.com/document_detail/62513.html?spm=a2c4g.11186623.6.656.781b3d4249MJZT" target="_blank" rel="noopener">具体参考阿里云</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> flink </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flink </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flink时间属性</title>
      <link href="/2020/03/26/flink-shi-jian-shu-xing/"/>
      <url>/2020/03/26/flink-shi-jian-shu-xing/</url>
      
        <content type="html"><![CDATA[<h3 id="时间属性"><a href="#时间属性" class="headerlink" title="时间属性"></a>时间属性</h3><p>Flink支持三种与流数据处理相关的时间概念：<code>Processing Time</code>、<code>Event Time</code>和<code>Ingestion Time</code>。</p><p><img src="/images/flink27.png" alt="time"></p><p>Flink SQL仅支持其中的两种时间类型<code>Event Time</code>和<code>Processing Time</code>：</p><ul><li><code>Event Time</code>：您提供的事件时间（通常是数据的最原始的创建时间）.<code>Event Time</code>必须是您提供在数据储存里的数据。</li><li><code>Processing Time</code>：系统对事件进行处理的本地系统时间，单位为毫秒。</li></ul><h3 id="Event-Time"><a href="#Event-Time" class="headerlink" title="Event Time"></a>Event Time</h3><p><code>Event Time</code>也称为<code>Row Time</code>。EventTime时间属性必须在源表DDL中声明，可以将源表中的某一字段声明成Event Time。目前只支持将TIMESTAMP类型（将来会支持LONG类型）声明成Row Time字段。如果源表中需要声明为Event Time的列不是TIMESTAMP类型，需要借助<code>计算列</code>，基于现有列构造出一个TIMESTAMP类型的列。</p><p>由于数据本身的乱序、网络的抖动（网络堵塞导致的数据传输延迟的变化）或者其它原因，导致了数据到达的顺序和被处理的顺序，可能是不一致的（乱序）。因此定义一个Row Time字段，需要首先明文定义一个Watermark计算方法。</p><p>窗口函数基于Event Time聚合的示例如下:</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tt_stream <span class="token punctuation">(</span>  <span class="token number">a</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">,</span>  <span class="token number">b</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">,</span>  ts <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span>  WATERMARK wk1 <span class="token keyword">FOR</span> ts <span class="token keyword">as</span> withOffset <span class="token punctuation">(</span>ts<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">--Watermark计算方法。</span><span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>  <span class="token keyword">type</span> <span class="token operator">=</span> <span class="token string">'sls'</span><span class="token punctuation">,</span>  topic <span class="token operator">=</span> <span class="token string">'&lt;yourTopicName>'</span><span class="token punctuation">,</span>  accessId <span class="token operator">=</span> <span class="token string">'&lt;yourAccessId>'</span><span class="token punctuation">,</span>  accessKey <span class="token operator">=</span> <span class="token string">'&lt;yourAccessSecret>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>sql-client-default.yaml</code>中配置如下：</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token punctuation">...</span><span class="token key atrule">format</span><span class="token punctuation">:</span>     <span class="token key atrule">property-version</span><span class="token punctuation">:</span> <span class="token number">1</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> json    <span class="token comment" spellcheck="true"># derive-schema: true</span>    <span class="token key atrule">schema</span><span class="token punctuation">:</span> <span class="token string">"ROW&lt;id INT, type STRING, price INT, ts LONG>"</span><span class="token key atrule">schema</span><span class="token punctuation">:</span>     <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tss    <span class="token key atrule">data-type</span><span class="token punctuation">:</span> TIMESTAMP    <span class="token key atrule">rowtime</span><span class="token punctuation">:</span>        <span class="token key atrule">timestamps</span><span class="token punctuation">:</span>        <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"from-field"</span>        <span class="token key atrule">from</span><span class="token punctuation">:</span> <span class="token string">"ts"</span>        <span class="token key atrule">watermarks</span><span class="token punctuation">:</span>        <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"periodic-bounded"</span>        <span class="token key atrule">delay</span><span class="token punctuation">:</span> <span class="token string">"60000"</span><span class="token punctuation">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Processing-Time"><a href="#Processing-Time" class="headerlink" title="Processing Time"></a>Processing Time</h3><p><code>Processing Time</code>是系统产生的，不在您的原始数据中，您需要在数据源表的声明中明文定义一个<code>Processing Time</code>列。</p><pre class="line-numbers language-sql"><code class="language-sql">filedName <span class="token keyword">as</span> PROCTIME<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>窗口函数基于Processing Time聚合的示例如下。</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> mq_stream <span class="token punctuation">(</span>    <span class="token number">a</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">,</span>    <span class="token number">b</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">,</span>    <span class="token number">c</span> <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>    ts <span class="token keyword">AS</span> PROCTIME <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">--在数据源表的声明中明文定义一个Processing Time列。</span>  <span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>    <span class="token keyword">type</span> <span class="token operator">=</span> <span class="token string">'mq'</span><span class="token punctuation">,</span>    topic <span class="token operator">=</span> <span class="token string">'&lt;yourTopic>'</span><span class="token punctuation">,</span>    accessId <span class="token operator">=</span> <span class="token string">'&lt;yourAccessId>'</span><span class="token punctuation">,</span>    accessKey <span class="token operator">=</span> <span class="token string">'&lt;yourAccessSecret>'</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">select</span> id<span class="token punctuation">,</span>price<span class="token punctuation">,</span>tss<span class="token punctuation">,</span> PROCTIME<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> ts <span class="token keyword">from</span> book<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> flink </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flink </tag>
            
            <tag> time </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>互联网上的时间-RFC3339</title>
      <link href="/2020/03/26/rfc3339/"/>
      <url>/2020/03/26/rfc3339/</url>
      
        <content type="html"><![CDATA[<h3 id="RFC3339"><a href="#RFC3339" class="headerlink" title="RFC3339"></a>RFC3339</h3><p>本地时间只包括当前的时间，不包含任何时区信息。同一时刻，东八区的本地时间比零时区的本地时间快了8个小时。在不同时区之间交换时间数据，除了用纯数字的时间戳，还有一种更方便人类阅读的表示方式：标准时间的偏移量表示方法。</p><p><code>RFC3339</code>详细定义了互联网上日期/时间的偏移量表示：</p><pre><code>2017-12-08T00:00:00.00Z</code></pre><p>这个代表了UTC时间的2017年12月08日零时</p><pre><code>2017-12-08T00:08:00.00+08:00</code></pre><p>这个代表了同一时刻的，东八区北京时间（<code>CST</code>）表示的方法</p><p>上面两个时间的时间戳是等价的。两个的区别，就是在本地时间后面增加了时区信息。Z表示零时区。+08:00表示UTC时间增加8小时。</p><h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><p>目前很多软件都是采用<code>RFC3339</code>，如<code>Prometheus</code>、<code>Flink</code>、<code>InfluxDB</code>等，注意与北京时间相差8小时。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> timestamp </tag>
            
            <tag> RFC3339 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flinkSQL用户自定义函数(UDX)</title>
      <link href="/2020/03/25/flinksql-yong-hu-zi-ding-yi-han-shu/"/>
      <url>/2020/03/25/flinksql-yong-hu-zi-ding-yi-han-shu/</url>
      
        <content type="html"><![CDATA[<h3 id="UDX分类"><a href="#UDX分类" class="headerlink" title="UDX分类"></a>UDX分类</h3><p><a href="https://help.aliyun.com/document_detail/69463.html" target="_blank" rel="noopener">参考</a></p><table><thead><tr><th>UDX分类</th><th>描述</th></tr></thead><tbody><tr><td>UDF（User Defined Function）</td><td>用户自定义标量函数（User Defined Scalar Function）。其输入与输出是一对一的关系，即读入一行数据，写出一条输出值。</td></tr><tr><td>UDAF（User Defined Aggregation Function）</td><td>自定义聚合函数，其输入与输出是多对一的关系， 即将多条输入记录聚合成一条输出值。可以与SQL中的GROUP BY语句一起使用。</td></tr><tr><td>UDTF（User Defined Table-valued Function）</td><td>自定义表函数，调用一次函数输出多行或多列数据。</td></tr></tbody></table><h3 id="注册用户定义的函数"><a href="#注册用户定义的函数" class="headerlink" title="注册用户定义的函数"></a>注册用户定义的函数</h3><p>在大多数情况下，必须先注册用户定义的函数，然后才能在查询中使用它。没有必要为<code>Scala Table API</code>注册函数。</p><p><code>TableEnvironment</code>通过调用<code>registerFunction()</code>方法来注册函数。注册用户定义的函数时，会将其插入到函数目录中<code>TableEnvironment</code>，以便 <code>Table API</code>或<code>SQL</code>解析器可以识别并正确转换它。</p><p>请找到如何注册，如何调用每个类型的用户定义函数（详细的例子<code>ScalarFunction</code>，<code>TableFunction</code>和<code>AggregateFunction</code>下面的子会话）。</p><h3 id="自定义标量函数UDF"><a href="#自定义标量函数UDF" class="headerlink" title="自定义标量函数UDF"></a>自定义标量函数UDF</h3><h3 id="自定义聚合函数UDAF"><a href="#自定义聚合函数UDAF" class="headerlink" title="自定义聚合函数UDAF"></a>自定义聚合函数UDAF</h3><h3 id="自定义表值函数UDTF"><a href="#自定义表值函数UDTF" class="headerlink" title="自定义表值函数UDTF"></a>自定义表值函数UDTF</h3><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> flink </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flink </tag>
            
            <tag> udf </tag>
            
            <tag> udaf </tag>
            
            <tag> udtf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flinkSQL时间戳转换成日期格式</title>
      <link href="/2020/03/25/flinksql-shi-jian-chuo-zhuan-huan-cheng-ri-qi-ge-shi/"/>
      <url>/2020/03/25/flinksql-shi-jian-chuo-zhuan-huan-cheng-ri-qi-ge-shi/</url>
      
        <content type="html"><![CDATA[<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"id"</span><span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token property">"price"</span><span class="token operator">:</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token property">"ts"</span><span class="token operator">:</span><span class="token number">1585125854697</span><span class="token punctuation">,</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"math"</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token property">"id"</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token property">"price"</span><span class="token operator">:</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token property">"ts"</span><span class="token operator">:</span><span class="token number">1585125861687</span><span class="token punctuation">,</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"ph"</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token property">"id"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token property">"price"</span><span class="token operator">:</span><span class="token number">80</span><span class="token punctuation">,</span><span class="token property">"ts"</span><span class="token operator">:</span><span class="token number">1585125862380</span><span class="token punctuation">,</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"cs"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>模拟数据如上所示，时间字段是13位时间戳格式，在flink sql中直接转成TIMESTAMP格式会有问题。</p><p>参考<a href="https://helpcdn.aliyun.com/knowledge_list/62717.html?spm=a2c4g.11186623.6.662.3f6ba3c50vKfDl" target="_blank" rel="noopener">阿里云日期函数</a><code>TO_TIMESTAMP</code>，文档中示例支持三种入参，</p><pre class="line-numbers language-SQL"><code class="language-SQL">TIMESTAMP TO_TIMESTAMP(BIGINT time)TIMESTAMP TO_TIMESTAMP(VARCHAR date)TIMESTAMP TO_TIMESTAMP(VARCHAR date, VARCHAR format)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>实际使用<code>flink 1.10</code>版本测试，<code>TO_TIMESTAMP</code>不能直接将<code>BIGINT</code>转成<code>TIMESTAMP</code>.</p><pre class="line-numbers language-s"><code class="language-s">[ERROR] Could not execute SQL statement. Reason:org.apache.calcite.sql.validate.SqlValidatorException: Cannot apply 'TO_TIMESTAMP' to arguments of type 'TO_TIMESTAMP(<BIGINT>)'. Supported form(s): 'TO_TIMESTAMP(<CHARACTER>)' 'TO_TIMESTAMP(<CHARACTER>, <CHARACTER>)'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="创建UDF，并用SQL-client测试"><a href="#创建UDF，并用SQL-client测试" class="headerlink" title="创建UDF，并用SQL client测试"></a>创建UDF，并用SQL client测试</h3><p>创建一个<code>UDF</code>,传入一个<code>Long</code>型时间戳，返回<code>Timestamp</code>格式</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TimeUdf</span> <span class="token keyword">extends</span> <span class="token class-name">ScalarFunction</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Long timestamp<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">TimeUdf</span><span class="token punctuation">(</span>Long timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>timestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> Timestamp <span class="token function">eval</span><span class="token punctuation">(</span>Long timestamp<span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Timestamp</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>UDF需要的依赖</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!--Table Program Dependencies--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>flink-table-api-java-bridge_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.10.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>provided<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>flink-table-planner-blink_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.10.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>provided<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>flink-streaming-scala_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.10.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>provided<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>flink-table-common<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.10.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>provided<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用maven打包成jar，并拷贝到flink目录lib中，重启flink。</p><pre class="line-numbers language-sh"><code class="language-sh">mvn clean package<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>修改<code>sql-client-defaults.yaml</code>配置</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token punctuation">...</span><span class="token comment" spellcheck="true">#创建表</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> bookpojo    <span class="token key atrule">type</span><span class="token punctuation">:</span> source<span class="token punctuation">-</span>table    <span class="token key atrule">connector</span><span class="token punctuation">:</span>       <span class="token key atrule">property-version</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> kafka      <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"universal"</span>      <span class="token key atrule">topic</span><span class="token punctuation">:</span> pojo      <span class="token key atrule">startup-mode</span><span class="token punctuation">:</span> earliest<span class="token punctuation">-</span>offset      <span class="token key atrule">properties</span><span class="token punctuation">:</span>        <span class="token key atrule">zookeeper.connect</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">2181</span>        <span class="token key atrule">bootstrap.servers</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">9092</span>        <span class="token key atrule">group.id</span><span class="token punctuation">:</span> testGroup    <span class="token key atrule">format</span><span class="token punctuation">:</span>       <span class="token key atrule">property-version</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> json      <span class="token comment" spellcheck="true"># derive-schema: true</span>      <span class="token key atrule">schema</span><span class="token punctuation">:</span> <span class="token string">"ROW&lt;id INT, type STRING, price INT, ts BIGINT>"</span>    <span class="token key atrule">schema</span><span class="token punctuation">:</span>       <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> id        <span class="token key atrule">data-type</span><span class="token punctuation">:</span> INT      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> type        <span class="token key atrule">data-type</span><span class="token punctuation">:</span> STRING      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> price        <span class="token key atrule">data-type</span><span class="token punctuation">:</span> INT      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ts        <span class="token key atrule">data-type</span><span class="token punctuation">:</span> BIGINT<span class="token comment" spellcheck="true"># 创建UDF</span><span class="token key atrule">functions</span><span class="token punctuation">:</span>   <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> TimeUdf    <span class="token key atrule">from</span><span class="token punctuation">:</span> class    <span class="token key atrule">class</span><span class="token punctuation">:</span> com.deri.udx.TimeUdf    <span class="token key atrule">constructor</span><span class="token punctuation">:</span>       <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> BIGINT        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">111111111</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>启动<code>SQL client</code></p><pre class="line-numbers language-sh"><code class="language-sh">./bin/sql-client.sh embedded<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>SQL查询</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">-- 时间戳</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> bookpojo<span class="token punctuation">;</span><span class="token comment" spellcheck="true">-- 转成日期</span><span class="token keyword">select</span> id<span class="token punctuation">,</span>price<span class="token punctuation">,</span><span class="token keyword">type</span><span class="token punctuation">,</span>TimeUdf<span class="token punctuation">(</span>ts<span class="token punctuation">)</span> <span class="token keyword">AS</span> ts <span class="token keyword">from</span> bookpojo<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="最新研究：LONG型时间戳可以直接转成TIMESTAMP格式"><a href="#最新研究：LONG型时间戳可以直接转成TIMESTAMP格式" class="headerlink" title="最新研究：LONG型时间戳可以直接转成TIMESTAMP格式"></a>最新研究：LONG型时间戳可以直接转成TIMESTAMP格式</h3><p>需要在ROW中定义为LONG，Schema中定义为TIMESTAMP</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>t<span class="token punctuation">`</span> <span class="token punctuation">(</span>   ctm <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>  <span class="token string">'format.schema'</span> <span class="token operator">=</span> <span class="token string">'ROW&lt;ctm LONG>'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>sql-client-defaults.yaml</code>中详细配置，测试成功</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">tables</span><span class="token punctuation">:</span>   <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> bookpojo    <span class="token key atrule">type</span><span class="token punctuation">:</span> source<span class="token punctuation">-</span>table    <span class="token key atrule">update-mode</span><span class="token punctuation">:</span> append    <span class="token key atrule">connector</span><span class="token punctuation">:</span>       <span class="token key atrule">property-version</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> kafka      <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"universal"</span>      <span class="token key atrule">topic</span><span class="token punctuation">:</span> pojo      <span class="token key atrule">startup-mode</span><span class="token punctuation">:</span> earliest<span class="token punctuation">-</span>offset      <span class="token key atrule">properties</span><span class="token punctuation">:</span>        <span class="token key atrule">zookeeper.connect</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">2181</span>        <span class="token key atrule">bootstrap.servers</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">9092</span>        <span class="token key atrule">group.id</span><span class="token punctuation">:</span> testGroup    <span class="token key atrule">format</span><span class="token punctuation">:</span>       <span class="token key atrule">property-version</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> json      <span class="token key atrule">schema</span><span class="token punctuation">:</span> <span class="token string">"ROW&lt;id INT, type STRING, price INT, ts LONG>"</span>    <span class="token key atrule">schema</span><span class="token punctuation">:</span>       <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> id        <span class="token key atrule">data-type</span><span class="token punctuation">:</span> INT      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> type        <span class="token key atrule">data-type</span><span class="token punctuation">:</span> STRING      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> price        <span class="token key atrule">data-type</span><span class="token punctuation">:</span> INT      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tss        <span class="token key atrule">data-type</span><span class="token punctuation">:</span> TIMESTAMP        <span class="token key atrule">rowtime</span><span class="token punctuation">:</span>          <span class="token key atrule">timestamps</span><span class="token punctuation">:</span>            <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"from-field"</span>            <span class="token key atrule">from</span><span class="token punctuation">:</span> <span class="token string">"ts"</span>          <span class="token key atrule">watermarks</span><span class="token punctuation">:</span>            <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"periodic-bounded"</span>            <span class="token key atrule">delay</span><span class="token punctuation">:</span> <span class="token string">"60000"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> flink </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flink </tag>
            
            <tag> udf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flink中状态管理</title>
      <link href="/2020/03/25/flink-zhong-zhuang-tai-guan-li/"/>
      <url>/2020/03/25/flink-zhong-zhuang-tai-guan-li/</url>
      
        <content type="html"><![CDATA[<h3 id="流处理状态管理"><a href="#流处理状态管理" class="headerlink" title="流处理状态管理"></a>流处理状态管理</h3><p>有状态的计算是流处理框架要实现的重要功能，因为稍复杂的流处理场景都需要记录状态，然后在新流入数据的基础上不断更新状态。下面的几个场景都需要使用流处理的状态功能：</p><ul><li>数据流中的数据有重复，我们想对重复数据去重，需要记录哪些数据已经流入过应用，当新数据流入时，根据已流入过的数据来判断去重。</li><li>检查输入流是否符合某个特定的模式，需要将之前流入的元素以状态的形式缓存下来。比如，判断一个温度传感器数据流中的温度是否在持续上升。</li><li>对一个时间窗口内的数据进行聚合分析，分析一个小时内某项指标的75分位或99分位的数值。</li><li>在线机器学习场景下，需要根据新流入数据不断更新机器学习的模型参数。</li></ul><h3 id="flink状态管理"><a href="#flink状态管理" class="headerlink" title="flink状态管理"></a>flink状态管理</h3><p>Flink的一个算子有多个子任务，每个子任务分布在不同实例上，我们可以把状态理解为某个算子子任务在其当前实例上的一个变量，变量记录了数据流的历史信息。当新数据流入时，我们可以结合历史信息来进行计算。实际上，Flink的状态是由算子的子任务来创建和管理的。一个状态更新和获取的流程如下图所示，一个算子子任务接收输入流，获取对应的状态，根据新的计算结果更新状态。一个简单的例子是对一个时间窗口内输入流的某个整数字段求和，那么当算子子任务接收到新元素时，会获取已经存储在状态中的数值，然后将当前输入加到状态上，并将状态数据更新。<br><img src="/images/flink20.png" alt="状态管理"></p><p>获取和更新状态的逻辑其实并不复杂，但流处理框架还需要解决以下几类问题：</p><ul><li>数据的产出要保证实时性，延迟不能太高。</li><li>需要保证数据不丢不重，恰好计算一次，尤其是当状态数据非常大或者应用出现故障需要恢复时，要保证状态的计算不出任何错误。</li><li>一般流处理任务都是7*24小时运行的，程序的可靠性非常高。</li></ul><p>基于上述要求，我们不能将状态直接交由内存管理，因为内存的容量是有限制的，当状态数据稍微大一些时，就会出现内存不够的问题。作为一个计算框架，Flink提供了有状态的计算，封装了一些底层的实现，比如状态的高效存储、Checkpoint和Savepoint持久化备份机制、计算资源扩缩容等问题。因为Flink接管了这些问题，开发者只需调用Flink API，这样可以更加专注于业务逻辑。</p><h3 id="Flink的几种状态类型"><a href="#Flink的几种状态类型" class="headerlink" title="Flink的几种状态类型"></a>Flink的几种状态类型</h3><h4 id="Managed-State和Raw-State"><a href="#Managed-State和Raw-State" class="headerlink" title="Managed State和Raw State"></a>Managed State和Raw State</h4><p>Flink有两种基本类型的状态：托管状态（Managed State）和原生状态（Raw State）。从名称中也能读出两者的区别：Managed State是由Flink管理的，Flink帮忙存储、恢复和优化，Raw State是开发者自己管理的，需要自己序列化。<br>| |Managed State|Raw State|<br>|—|—|—|<br>|状态管理方式|Flink Runtime自动管理，自动存储，自动恢复，内存管理优化|用户自己管理；需要自己序列化|<br>|状态数据结构|已知的数据结构：value，list，map…|字节数组：byte[]|<br>|推荐使用场景|大多数场景|自定义Operator时可使用|</p><p>两者的具体区别有：</p><ul><li>从状态管理的方式上来说，Managed State由Flink Runtime托管，状态是自动存储、自动恢复的，Flink在存储管理和持久化上做了一些优化。当我们横向伸缩，或者说我们修改Flink应用的并行度时，状态也能自动重新分布到多个并行实例上。Raw State是用户自定义的状态。</li><li>从状态的数据结构上来说，Managed State支持了一系列常见的数据结构，如ValueState、ListState、MapState等。Raw State只支持字节，任何上层数据结构需要序列化为字节数组。使用时，需要用户自己序列化，以非常底层的字节数组形式存储，Flink并不知道存储的是什么样的数据结构。</li><li>从具体使用场景来说，绝大多数的算子都可以通过继承Rich函数类或其他提供好的接口类，在里面使用Managed State。Raw State是在已有算子和Managed State不够用时，用户自定义算子时使用。</li></ul><h4 id="Keyed-State和Operator-State"><a href="#Keyed-State和Operator-State" class="headerlink" title="Keyed State和Operator State"></a>Keyed State和Operator State</h4><p>对Managed State继续细分，它又有两种类型：Keyed State和Operator State。</p><h4 id="Keyed-State"><a href="#Keyed-State" class="headerlink" title="Keyed State"></a><strong>Keyed State</strong></h4><p>Keyed State是<code>KeyedStream</code>上的状态。假如输入流按照id为Key进行了keyBy分组，形成一个KeyedStream，数据流中所有id为1的数据共享一个状态，可以访问和更新这个状态，以此类推，每个Key对应一个自己的状态。下图展示了Keyed State，因为一个算子子任务可以处理一到多个Key，算子子任务1处理了两种Key，两种Key分别对应自己的状态。</p><p><img src="/images/flink21.png" alt="状态管理"></p><h4 id="Operator-State"><a href="#Operator-State" class="headerlink" title="Operator State"></a><strong>Operator State</strong></h4><p>Operator State可以用在所有算子上，每个算子子任务或者说每个算子实例共享一个状态，流入这个算子子任务的数据可以访问和更新这个状态。下图展示了Operator State，算子子任务1上的所有数据可以共享第一个Operator State，以此类推，每个算子子任务上的数据共享自己的状态。</p><p><img src="/images/flink22.png" alt="状态管理"></p><p>无论是Keyed State还是Operator State，Flink的状态都是基于本地的，即每个算子子任务维护着这个算子子任务对应的状态存储，算子子任务之间的状态不能相互访问。</p><p>在之前各算子的介绍中曾提到，为了自定义Flink的算子，我们可以重写Rich Function接口类，比如<code>RichFlatMapFunction</code>。使用Keyed State时，我们也可以通过重写<code>Rich Function</code>接口类，在里面创建和访问状态。对于Operator State，我们还需进一步实现<code>CheckpointedFunction</code>接口。</p><table><thead><tr><th></th><th>Keyed State</th><th>Operator State</th></tr></thead><tbody><tr><td>适用算子类型</td><td>只适用<code>keyedStream</code>上的算子</td><td>适用所有算子</td></tr><tr><td>状态分配</td><td>每一个key对应一个状态</td><td>一个算子上的子任务对应一个状态</td></tr><tr><td>创建和访问方式</td><td>重写<code>Rich Function</code>,通过里面的<code>RuntimeContext</code>访问</td><td>实现<code>CheckpointedFunction</code>或<code>ListCheckpointed</code>接口</td></tr><tr><td>横向扩展</td><td>状态随着key自动在多个算子子任务上迁移</td><td>有多种状态重新分配的方式:均匀分配、合并后每个得到全量</td></tr><tr><td>支持的数据结构</td><td><code>ValueState</code>、<code>ListState</code>、<code>MapState</code>、<code>ReducingState</code>等</td><td><code>ListState</code></td></tr></tbody></table><h4 id="几种KeyedState之间的关系"><a href="#几种KeyedState之间的关系" class="headerlink" title="几种KeyedState之间的关系"></a>几种KeyedState之间的关系</h4><p><img src="/images/flink23.png" alt="状态管理"></p><h4 id="几种KeyedState之间的差异"><a href="#几种KeyedState之间的差异" class="headerlink" title="几种KeyedState之间的差异"></a>几种KeyedState之间的差异</h4><p><img src="/images/flink24.png" alt="状态管理"></p><h3 id="状态的保存与恢复"><a href="#状态的保存与恢复" class="headerlink" title="状态的保存与恢复"></a>状态的保存与恢复</h3><p><img src="/images/flink25.png" alt="状态管理"></p><h3 id="可选的状态存储方式"><a href="#可选的状态存储方式" class="headerlink" title="可选的状态存储方式"></a>可选的状态存储方式</h3><h4 id="MemoryStateBackend"><a href="#MemoryStateBackend" class="headerlink" title="MemoryStateBackend"></a>MemoryStateBackend</h4><p>Checkpoint 的存储，第一种是内存存储，即 <code>MemoryStateBackend</code>，构造方法是设置最大的StateSize，选择是否做异步快照，这种存储状态本身存储在 TaskManager 节点也就是执行节点内存中的，因为内存有容量限制，所以单个 State maxStateSize 默认 5 M，且需要注意 maxStateSize &lt;= akka.framesize 默认 10 M。Checkpoint 存储在 JobManager 内存中，因此总大小不超过 JobManager 的内存。<strong>推荐使用的场景为：本地测试、几乎无状态的作业，比如 ETL、JobManager 不容易挂，或挂掉影响不大的情况。不推荐在生产场景使用</strong>。</p><h4 id="FsStateBackend"><a href="#FsStateBackend" class="headerlink" title="FsStateBackend"></a>FsStateBackend</h4><p>在文件系统上的 <code>FsStateBackend</code> ，构建方法是需要传一个文件路径和是否异步快照。State 依然在 TaskManager 内存中，但不会像 MemoryStateBackend 有 5 M 的设置上限，Checkpoint 存储在外部文件系统（本地或 HDFS），打破了总大小 Jobmanager 内存的限制。容量限制上，单 TaskManager 上 State 总量不超过它的内存，总大小不超过配置的文件系统容量。<strong>推荐使用的场景、常规使用状态的作业、例如分钟级窗口聚合或 join、需要开启HA的作业</strong>。</p><h4 id="RocksDBStateBacked"><a href="#RocksDBStateBacked" class="headerlink" title="RocksDBStateBacked"></a>RocksDBStateBacked</h4><p>还有一种存储为 <code>RocksDBStateBackend</code> ，RocksDB 是一个 key/value 的内存存储系统，和其他的 key/value 一样，先将状态放到内存中，如果内存快满时，则写入到磁盘中，但需要注意 <strong>RocksDB 不支持同步的 Checkpoint</strong>，构造方法中没有同步快照这个选项。不过 <strong>RocksDB 支持增量的 Checkpoint</strong>，也是目前唯一增量 Checkpoint 的 Backend，意味着并不需要把所有 sst 文件上传到 Checkpoint 目录，仅需要上传新生成的 sst 文件即可。它的 Checkpoint 存储在外部文件系统（本地或HDFS），其容量限制只要单个 TaskManager 上 State 总量不超过它的内存+磁盘，单 Key最大 2G，总大小不超过配置的文件系统容量即可。<strong>推荐使用的场景为：超大状态的作业，例如天级窗口聚合、需要开启 HA 的作业、最好是对状态读写性能要求不高的作业</strong>。</p><h4 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h4><ul><li><p><a href="https://mp.weixin.qq.com/s/JLl-LMjcnVrIyHCCq7Yv7A" target="_blank" rel="noopener">Flink状态管理详解：Keyed State和Operator List State深度解析</a></p></li><li><p><a href="https://ververica.cn/developers/state-management/" target="_blank" rel="noopener">Apache Flink 零基础入门（七）：状态管理及容错机制</a></p></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> flink </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flink </tag>
            
            <tag> 状态管理 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flink中ProcessFunction</title>
      <link href="/2020/03/25/flink-zhong-processfunction/"/>
      <url>/2020/03/25/flink-zhong-processfunction/</url>
      
        <content type="html"><![CDATA[<h3 id="ProcessFunction简介"><a href="#ProcessFunction简介" class="headerlink" title="ProcessFunction简介"></a>ProcessFunction简介</h3><p><code>ProcessFunction</code>是flink中最底层的API。<br><img src="/images/flink26.png" alt="low-api"></p><p>Flink的一些算子和函数能够进行一些时间上的操作，但是不能获取算子当前的<code>Processing Time</code>或者是<code>Watermark时间戳</code>，调用起来简单但功能相对受限。如果想获取数据流中Watermark的时间戳，或者在时间上前后穿梭，需要使用<code>ProcessFunction</code>系列函数，它们是Flink体系中<strong>最底层的API</strong>，提供了对数据流<strong>更细粒度的操作权限</strong>。Flink SQL是基于这些函数实现的，一些需要高度个性化的业务场景也需要使用这些函数。</p><p>目前，这个系列函数主要包括<code>KeyedProcessFunction</code>、<code>ProcessFunction</code>、<code>CoProcessFunction</code>、<code>KeyedCoProcessFunction</code>、<code>ProcessJoinFunction</code>和<code>ProcessWindowFunction</code>等多种函数，这些函数各有侧重，但核心功能比较相似，主要包括两点：</p><ul><li>状态：我们可以在这些函数中访问和更新<code>Keyed State</code>。</li><li>定时器（Timer）：像定闹钟一样设置定时器，我们可以在时间维度上设计更复杂的业务逻辑。使用前先在Timer中注册一个未来的时间，当这个时间到达，闹钟会“响起”，程序会执行一个回调函数，回调函数中执行一定的业务逻辑。</li></ul><h3 id="ProcessFunction使用"><a href="#ProcessFunction使用" class="headerlink" title="ProcessFunction使用"></a>ProcessFunction使用</h3><p><code>ProcessFunction</code>有两个重要的接口<code>processElement</code>和<code>onTimer</code></p><p>其中processElement函数在源码中的Java签名如下：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 处理数据流中的一条元素</span><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span>I value<span class="token punctuation">,</span> Context ctx<span class="token punctuation">,</span> Collector<span class="token operator">&lt;</span>O<span class="token operator">></span> out<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>processElement</code>方法处理数据流中的一条元素，并通过<code>Collector&lt;O&gt;</code>输出出来。<code>Context</code>是它的区别于<code>FlatMapFunction</code>等普通函数的特色，<strong>开发者可以通过Context来获取时间戳，访问<code>TimerService</code>，设置Timer</strong>。</p><p>另外一个接口是<code>onTimer</code>：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 时间到达后的回调函数</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onTimer</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> OnTimerContext ctx<span class="token punctuation">,</span> Collector<span class="token operator">&lt;</span>O<span class="token operator">></span> out<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>这是一个回调函数，当到了“闹钟”时间，<code>Flink</code>会调用<code>onTimer</code>，并执行一些业务逻辑。这里也有一个参数<code>OnTimerContext</code>，它实际上是继承了前面的<code>Context</code>，与<code>Context</code>几乎相同。</p><p>使用Timer的方法主要逻辑为：</p><ol><li>在<code>processElement</code>方法中通过<code>Context</code>注册一个未来的时间戳<code>t</code>。这个时间戳的语义可以是<code>Processing Time</code>，也可以是<code>Event Time</code>，根据业务需求来选择。</li><li>在<code>onTimer</code>方法中实现一些逻辑，到达<code>t</code>时刻，<code>onTimer</code>方法被自动调用。</li></ol><p><strong>获取、注册和删除<code>Timer</code></strong></p><ul><li><p>从<code>Context</code>中，我们可以获取一个<code>TimerService</code>，这是一个访问时间戳和Timer的接口。</p></li><li><p>我们可以通过<code>Context.timerService.registerProcessingTimeTimer</code>或<code>Context.timerService.registerEventTimeTimer</code>这两个方法来注册<code>Timer</code>，只需要传入一个时间戳即可。</p></li><li><p>我们可以通过<code>Context.timerService.deleteProcessingTimeTimer</code>和<code>Context.timerService.deleteEventTimeTimer</code>来删除之前注册的Timer。</p></li><li><p>此外，还可以从中获取当前的时间戳：<code>Context.timerService.currentProcessingTime</code>和<code>Context.timerService.currentWatermark</code>。</p></li></ul><blockquote><p>注意，我们只能在KeyedStream上注册Timer。每个Key下可以使用不同的时间戳注册不同的Timer，但是每个Key的每个时间戳只能注册一个Timer。如果想在一个DataStream上应用Timer，可以将所有数据映射到一个伪造的Key上，但这样所有数据会流入一个算子子任务。</p></blockquote><blockquote><p>Flink 框架会自动忽略同一时间的重复注册Timer。</p></blockquote><h3 id="使用ProcessFunction实现Join"><a href="#使用ProcessFunction实现Join" class="headerlink" title="使用ProcessFunction实现Join"></a>使用ProcessFunction实现Join</h3><p>如果想从更细的粒度上实现两个数据流的<code>Join</code>，可以使用<code>CoProcessFunction</code>或<code>KeyedCoProcessFunction</code>。这两个函数都有<code>processElement1</code>和<code>processElement2</code>方法，分别对第一个数据流和第二个数据流的每个元素进行处理。两个数据流的数据类型以及输出类型可以互不相同。尽管数据来自两个不同的流，但是他们可以共享同样的状态，所以可以参考下面的逻辑来实现<code>Join</code>：</p><ul><li>创建一到多个状态，两个数据流都能访问到这些状态，这里以状态<code>a</code>为例。</li><li><code>processElement1</code>方法处理第一个数据流，更新状态<code>a</code>。</li><li><code>processElement2</code>方法处理第二个数据流，根据状态<code>a</code>中的数据，生成相应的输出。</li></ul><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul><li><a href="https://juejin.im/post/5e3a7ebfe51d4526e03f8f8f" target="_blank" rel="noopener">ProcessFunction：Flink最底层API使用教程</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> flink </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flink </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java8中List&lt;&lt;Obj&gt;&gt;排序</title>
      <link href="/2020/03/24/java8-list-pai-xu/"/>
      <url>/2020/03/24/java8-list-pai-xu/</url>
      
        <content type="html"><![CDATA[<h3 id="List排序问题"><a href="#List排序问题" class="headerlink" title="List排序问题"></a>List排序问题</h3><p><code>java8</code>中引入了流的概念，还有<code>Lambda</code>函数的概念，那么针对<code>List&lt;Object&gt;</code>排序有哪些方法呢？</p><p>首先我们创建一个<code>User</code>实体类：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>        <span class="token keyword">public</span> String name<span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token function">User</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//重写了toString方法，方便打印观察</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token string">"User{"</span> <span class="token operator">+</span>                    <span class="token string">"name='"</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">'\''</span> <span class="token operator">+</span>                    <span class="token string">", age="</span> <span class="token operator">+</span> age <span class="token operator">+</span>                    <span class="token string">"}\n"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建<code>List&lt;User&gt;</code>对象</p><pre class="line-numbers language-java"><code class="language-java">List<span class="token operator">&lt;</span>User<span class="token operator">></span> users <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>        <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"zhang1"</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"zhang2"</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"zhang3"</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"zhang4"</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"zhang5"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"zhang6"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们想根据年龄来做个排序</p><p>方法一：</p><pre class="line-numbers language-java"><code class="language-java">users<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Comparator</span><span class="token operator">&lt;</span>User<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compare</span><span class="token punctuation">(</span>User o1<span class="token punctuation">,</span> User o2<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> o1<span class="token punctuation">.</span>age <span class="token operator">-</span> o2<span class="token punctuation">.</span>age<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>users<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>print<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>有了<code>Lambda</code>，直接可以简写成</p><pre class="line-numbers language-java"><code class="language-java">users<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>o1<span class="token punctuation">,</span> o2<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> o1<span class="token punctuation">.</span>age <span class="token operator">-</span> o2<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>users<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>print<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>方法二：</p><pre class="line-numbers language-java"><code class="language-java">users<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">(</span>o1<span class="token punctuation">,</span> o2<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> o1<span class="token punctuation">.</span>age <span class="token operator">-</span> o2<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>print<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>以上都可以实现<code>List&lt;User&gt;</code>根据年龄排序，打印结果</p><pre class="line-numbers language-json"><code class="language-json">User<span class="token punctuation">{</span>name='zhang6'<span class="token punctuation">,</span> age=<span class="token number">12</span><span class="token punctuation">}</span>User<span class="token punctuation">{</span>name='zhang1'<span class="token punctuation">,</span> age=<span class="token number">14</span><span class="token punctuation">}</span>User<span class="token punctuation">{</span>name='zhang3'<span class="token punctuation">,</span> age=<span class="token number">16</span><span class="token punctuation">}</span>User<span class="token punctuation">{</span>name='zhang5'<span class="token punctuation">,</span> age=<span class="token number">18</span><span class="token punctuation">}</span>User<span class="token punctuation">{</span>name='zhang2'<span class="token punctuation">,</span> age=<span class="token number">25</span><span class="token punctuation">}</span>User<span class="token punctuation">{</span>name='zhang4'<span class="token punctuation">,</span> age=<span class="token number">27</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java8 </tag>
            
            <tag> list </tag>
            
            <tag> stream </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flink结合kafka实时处理分析案例</title>
      <link href="/2020/03/23/flink-jie-he-kafka-shi-shi-chu-li-fen-xi-an-li/"/>
      <url>/2020/03/23/flink-jie-he-kafka-shi-shi-chu-li-fen-xi-an-li/</url>
      
        <content type="html"><![CDATA[<h3 id="案例说明"><a href="#案例说明" class="headerlink" title="案例说明"></a>案例说明</h3><p>本案例主要结合kafka，实现：</p><ul><li>通过flink，向kafka中写入模拟数据book贩卖信息，包括书籍id、类型、价格、时间戳；</li><li>flink任务每五秒输出最近五分钟，根据id，不同书籍卖出的总价。</li></ul><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><h4 id="BookPojo-java"><a href="#BookPojo-java" class="headerlink" title="BookPojo.java"></a>BookPojo.java</h4><p>书籍book基本类</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>deri<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>util<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @ClassName: BookPojo * @Description: TODO * @Author: wuzhiyong * @Time: 2020/3/20 9:48 * @Version: v1.0 **/</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BookPojo</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>    <span class="token keyword">private</span> String type<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> price<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">BookPojo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> id<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setId</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> type<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setType</span><span class="token punctuation">(</span>String type<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> price<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token keyword">int</span> price<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>price <span class="token operator">=</span> price<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> timestamp<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTimestamp</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>timestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Books-java"><a href="#Books-java" class="headerlink" title="Books.java"></a>Books.java</h4><p>创建模拟数据，6本书，随机返回一本书。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>deri<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>util<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Random<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @ClassName: Books * @Description: TODO * @Author: wuzhiyong * @Time: 2020/3/20 10:52 * @Version: v1.0 **/</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Books</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> BookPojo <span class="token function">getBook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        List<span class="token operator">&lt;</span>BookPojo<span class="token operator">></span> bookPojos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">{</span>            BookPojo book1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BookPojo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string">"cs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            bookPojos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>book1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">{</span>            BookPojo book1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BookPojo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string">"math"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token number">70</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            bookPojos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>book1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">{</span>            BookPojo book1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BookPojo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string">"ph"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            bookPojos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>book1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">{</span>            BookPojo book1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BookPojo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string">"cs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            bookPojos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>book1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">{</span>            BookPojo book1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BookPojo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string">"math"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            bookPojos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>book1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token punctuation">{</span>            BookPojo book1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BookPojo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token string">"ph"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book1<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            bookPojos<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>book1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> bookPojos<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="MyPojoSource-java"><a href="#MyPojoSource-java" class="headerlink" title="MyPojoSource.java"></a>MyPojoSource.java</h4><p>flink数据源，随机返回一本书并设置当时时间戳当作流水，并随机暂停几秒钟。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>deri<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>util<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>JSON<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>source<span class="token punctuation">.</span>SourceFunction<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Random<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @ClassName: MyNoParalleSource * @Description: TODO * @Author: wuzhiyong * @Time: 2020/3/4 10:15 * @Version: v1.0 **/</span><span class="token comment" spellcheck="true">//使用并行度为1的source</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyPojoSource</span> <span class="token keyword">implements</span> <span class="token class-name">SourceFunction</span><span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//1</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> isRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span>SourceContext<span class="token operator">&lt;</span>String<span class="token operator">></span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>isRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>            BookPojo book <span class="token operator">=</span> Books<span class="token punctuation">.</span><span class="token function">getBook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            book<span class="token punctuation">.</span><span class="token function">setTimestamp</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            ctx<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>book<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        isRunning <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="KafkaPojoProducer-java"><a href="#KafkaPojoProducer-java" class="headerlink" title="KafkaPojoProducer.java"></a>KafkaPojoProducer.java</h4><p>flink将书籍贩卖流水转成json字符串，输入到kafka中。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>deri<span class="token punctuation">.</span>pojo<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>deri<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>util<span class="token punctuation">.</span>MyPojoSource<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span>SimpleStringSchema<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>DataStreamSource<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span>StreamExecutionEnvironment<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>FlinkKafkaProducer<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Properties<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @ClassName: KafkaProducer * @Description: TODO * @Author: wuzhiyong * @Time: 2020/3/4 10:16 * @Version: v1.0 **/</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaPojoProducer</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        StreamExecutionEnvironment env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        DataStreamSource<span class="token operator">&lt;</span>String<span class="token operator">></span> text <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyPojoSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">/*设置并行度*/</span><span class="token punctuation">;</span>        Properties properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"192.168.41.128:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//new FlinkKafkaProducer("topn",new KeyedSerializationSchemaWrapper(new SimpleStringSchema()),properties,FlinkKafkaProducer.Semantic.EXACTLY_ONCE);</span>        FlinkKafkaProducer<span class="token operator">&lt;</span>String<span class="token operator">></span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlinkKafkaProducer</span><span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token string">"pojosource"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*        //event-timestamp事件的发生时间        producer.setWriteTimestampToKafka(true);*/</span>        text<span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span>producer<span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"POJO Kafka Source"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="KafkaPojoStream-java"><a href="#KafkaPojoStream-java" class="headerlink" title="KafkaPojoStream.java"></a>KafkaPojoStream.java</h4><p>从上面pojosource主题中，获取书籍贩卖流水，每10秒打印出过去5分钟每种书贩卖的总价。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>deri<span class="token punctuation">.</span>pojo<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>JSON<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>deri<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>util<span class="token punctuation">.</span>BookPojo<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>FlatMapFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>ReduceFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span>SimpleStringSchema<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>typeinfo<span class="token punctuation">.</span>Types<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Tuple2<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>typeutils<span class="token punctuation">.</span>TupleTypeInfo<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>TimeCharacteristic<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>DataStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span>StreamExecutionEnvironment<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span>AscendingTimestampExtractor<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span>Time<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>FlinkKafkaConsumer<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>connectors<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>FlinkKafkaProducer<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Collector<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Properties<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * @ClassName: KafkaWordCount * @Description: 从kafka主题中读取数据，进行word count * @Author: wuzhiyong * @Time: 2020/3/18 15:05 * @Version: v1.0 **/</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaPojoStream</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 创建Flink执行环境</span>        StreamExecutionEnvironment env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Properties properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"192.168.41.128:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"group.id"</span><span class="token punctuation">,</span> <span class="token string">"flink-group"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String inputTopic <span class="token operator">=</span> <span class="token string">"pojosource"</span><span class="token punctuation">;</span>        String outputTopic <span class="token operator">=</span> <span class="token string">"pojosink"</span><span class="token punctuation">;</span>        FlinkKafkaConsumer<span class="token operator">&lt;</span>String<span class="token operator">></span> consumer <span class="token operator">=</span>                <span class="token keyword">new</span> <span class="token class-name">FlinkKafkaConsumer</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>inputTopic<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>        FlinkKafkaProducer<span class="token operator">&lt;</span>String<span class="token operator">></span> producer <span class="token operator">=</span>                <span class="token keyword">new</span> <span class="token class-name">FlinkKafkaProducer</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>outputTopic<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SimpleStringSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//设置EventTime，结合assignTimestampsAndWatermarks一起使用</span>        env<span class="token punctuation">.</span><span class="token function">setStreamTimeCharacteristic</span><span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> stream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span>consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> bookPojoDataStream <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">></span> JSON<span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> BookPojo<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">assignTimestampsAndWatermarks</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AscendingTimestampExtractor</span><span class="token operator">&lt;</span>BookPojo<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">extractAscendingTimestamp</span><span class="token punctuation">(</span>BookPojo bookPojo<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">return</span> bookPojo<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//                .filter(bookPojo -> bookPojo.getType().equalsIgnoreCase("cs"))</span>                <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//                .timeWindow(Time.seconds(10))</span>                <span class="token comment" spellcheck="true">//设置一个5分钟滑动窗口，每10秒滑动一次</span>                <span class="token punctuation">.</span><span class="token function">timeWindow</span><span class="token punctuation">(</span>Time<span class="token punctuation">.</span><span class="token function">minutes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Time<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">//这边使用更加通用的reduce处理，累加书籍贩卖总流水</span>                <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReduceFunction</span><span class="token operator">&lt;</span>BookPojo<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> BookPojo <span class="token function">reduce</span><span class="token punctuation">(</span>BookPojo bookPojo<span class="token punctuation">,</span> BookPojo t1<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>                        BookPojo book <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BookPojo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        book<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>bookPojo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        book<span class="token punctuation">.</span><span class="token function">setPrice</span><span class="token punctuation">(</span>bookPojo<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span> t1<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        book<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span>t1<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        book<span class="token punctuation">.</span><span class="token function">setTimestamp</span><span class="token punctuation">(</span>t1<span class="token punctuation">.</span><span class="token function">getTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">return</span> book<span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">></span> JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//        bookPojoDataStream.addSink(producer);</span>        bookPojoDataStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// execute</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token string">"kafka streaming pojo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Tokenizer</span> <span class="token keyword">implements</span> <span class="token class-name">FlatMapFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">>></span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">flatMap</span><span class="token punctuation">(</span>String value<span class="token punctuation">,</span> Collector<span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">>></span> out<span class="token punctuation">)</span> <span class="token punctuation">{</span>            String<span class="token punctuation">[</span><span class="token punctuation">]</span> tokens <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\\W+"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span>String token <span class="token operator">:</span> tokens<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><pre class="line-numbers language-xml"><code class="language-xml"><span class="token comment" spellcheck="true">&lt;!--Licensed to the Apache Software Foundation (ASF) under oneor more contributor license agreements.  See the NOTICE filedistributed with this work for additional informationregarding copyright ownership.  The ASF licenses this fileto you under the Apache License, Version 2.0 (the"License"); you may not use this file except in compliancewith the License.  You may obtain a copy of the License at  http://www.apache.org/licenses/LICENSE-2.0Unless required by applicable law or agreed to in writing,software distributed under the License is distributed on an"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANYKIND, either express or implied.  See the License for thespecific language governing permissions and limitationsunder the License.--></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>    <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">></span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.deri<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>flink_kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>packaging</span><span class="token punctuation">></span></span>jar<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>packaging</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>Flink Quickstart Job<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">></span></span>http://www.myorganization.org<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.build.sourceEncoding</span><span class="token punctuation">></span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.build.sourceEncoding</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>flink.version</span><span class="token punctuation">></span></span>1.10.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>flink.version</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scala.binary.version</span><span class="token punctuation">></span></span>2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scala.binary.version</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.source</span><span class="token punctuation">></span></span>${java.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.source</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.target</span><span class="token punctuation">></span></span>${java.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.target</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repositories</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repository</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>apache.snapshots<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>Apache Development Snapshot Repository<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">></span></span>https://repository.apache.org/content/repositories/snapshots/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>releases</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">></span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>releases</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>snapshots</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>snapshots</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repository</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repositories</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>flink-connector-kafka_${scala.binary.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>${flink.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>        <span class="token comment" spellcheck="true">&lt;!-- Apache Flink dependencies --></span>        <span class="token comment" spellcheck="true">&lt;!-- These dependencies are provided, because they should not be packaged into the JAR file. --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>flink-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>${flink.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>provided<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>flink-streaming-java_${scala.binary.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>${flink.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>provided<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.2.54<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>        <span class="token comment" spellcheck="true">&lt;!-- Add connector dependencies here. They must be in the default scope (compile). --></span>        <span class="token comment" spellcheck="true">&lt;!-- Example:        &lt;dependency>            &lt;groupId>org.apache.flink&lt;/groupId>            &lt;artifactId>flink-connector-kafka-0.10_${scala.binary.version}&lt;/artifactId>            &lt;version>${flink.version}&lt;/version>        &lt;/dependency>        --></span>        <span class="token comment" spellcheck="true">&lt;!-- Add logging framework, to produce console output when running in the IDE. --></span>        <span class="token comment" spellcheck="true">&lt;!-- These dependencies are excluded from the application JAR by default. --></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.slf4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>slf4j-log4j12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.7.7<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.2.17<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>            <span class="token comment" spellcheck="true">&lt;!-- Java Compiler --></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-compiler-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span><span class="token punctuation">></span></span>${java.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>source</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span><span class="token punctuation">></span></span>${java.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>target</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>            <span class="token comment" spellcheck="true">&lt;!-- We use the maven-shade plugin to create a fat jar that contains all necessary dependencies. --></span>            <span class="token comment" spellcheck="true">&lt;!-- Change the value of &lt;mainClass>...&lt;/mainClass> if your program entry point changes. --></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-shade-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.1.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">></span></span>                    <span class="token comment" spellcheck="true">&lt;!-- Run shade goal on package phase --></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">></span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>shade<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactSet</span><span class="token punctuation">></span></span>                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>excludes</span><span class="token punctuation">></span></span>                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">></span></span>org.apache.flink:force-shading<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">></span></span>                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">></span></span>com.google.code.findbugs:jsr305<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">></span></span>                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">></span></span>org.slf4j:*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">></span></span>                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">></span></span>log4j:*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">></span></span>                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>excludes</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactSet</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filters</span><span class="token punctuation">></span></span>                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>filter</span><span class="token punctuation">></span></span>                                    <span class="token comment" spellcheck="true">&lt;!-- Do not copy the signatures in the META-INF folder.                                    Otherwise, this might cause SecurityExceptions when using the JAR. --></span>                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifact</span><span class="token punctuation">></span></span>*:*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifact</span><span class="token punctuation">></span></span>                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>excludes</span><span class="token punctuation">></span></span>                                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">></span></span>META-INF/*.SF<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">></span></span>                                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">></span></span>META-INF/*.DSA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">></span></span>                                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclude</span><span class="token punctuation">></span></span>META-INF/*.RSA<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclude</span><span class="token punctuation">></span></span>                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>excludes</span><span class="token punctuation">></span></span>                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filter</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>filters</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transformers</span><span class="token punctuation">></span></span>                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transformer</span> <span class="token attr-name">implementation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.apache.maven.plugins.shade.resource.ManifestResourceTransformer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mainClass</span><span class="token punctuation">></span></span>com.deri.kafka.KafkaProducer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mainClass</span><span class="token punctuation">></span></span>                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>transformer</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>transformers</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pluginManagement</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>                <span class="token comment" spellcheck="true">&lt;!-- This improves the out-of-the-box experience in Eclipse by resolving some warnings. --></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.eclipse.m2e<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>lifecycle-mapping<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>lifecycleMappingMetadata</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pluginExecutions</span><span class="token punctuation">></span></span>                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pluginExecution</span><span class="token punctuation">></span></span>                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pluginExecutionFilter</span><span class="token punctuation">></span></span>                                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>                                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-shade-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>                                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>versionRange</span><span class="token punctuation">></span></span>[3.1.1,)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>versionRange</span><span class="token punctuation">></span></span>                                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">></span></span>                                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>shade<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span>                                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">></span></span>                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pluginExecutionFilter</span><span class="token punctuation">></span></span>                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span><span class="token punctuation">></span></span>                                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ignore</span><span class="token punctuation">/></span></span>                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>action</span><span class="token punctuation">></span></span>                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pluginExecution</span><span class="token punctuation">></span></span>                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pluginExecution</span><span class="token punctuation">></span></span>                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pluginExecutionFilter</span><span class="token punctuation">></span></span>                                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>                                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-compiler-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>                                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>versionRange</span><span class="token punctuation">></span></span>[3.1,)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>versionRange</span><span class="token punctuation">></span></span>                                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">></span></span>                                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>testCompile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span>                                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span>                                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">></span></span>                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pluginExecutionFilter</span><span class="token punctuation">></span></span>                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span><span class="token punctuation">></span></span>                                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ignore</span><span class="token punctuation">/></span></span>                                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>action</span><span class="token punctuation">></span></span>                                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pluginExecution</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pluginExecutions</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>lifecycleMappingMetadata</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pluginManagement</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> flink </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flink </tag>
            
            <tag> kafka </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git拉取github项目比较慢解决办法</title>
      <link href="/2020/03/23/git-la-qu-github-xiang-mu-bi-jiao-man-jie-jue-ban-fa/"/>
      <url>/2020/03/23/git-la-qu-github-xiang-mu-bi-jiao-man-jie-jue-ban-fa/</url>
      
        <content type="html"><![CDATA[<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>国内git clone github项目由于网络原因比较慢</p><h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p>如</p><pre><code>git clone https://github.com/apache/flink.git</code></pre><p>改成</p><pre><code>git clone https://github.com.cnpmjs.org/apache/flink.git</code></pre><p>亲测有效。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
            <tag> github </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flink常用算子及代码</title>
      <link href="/2020/03/19/flink-chang-yong-suan-zi-ji-dai-ma/"/>
      <url>/2020/03/19/flink-chang-yong-suan-zi-ji-dai-ma/</url>
      
        <content type="html"><![CDATA[<p>以下列举下常用的算子，用到的代码例子都是Flink监听9000端口做为数据源。以下方法可以启动一个9000的socket端口服务。</p><p>Linux平台上可以使用</p><pre class="line-numbers language-sh"><code class="language-sh">bashnc -lk 9000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>如果是 Windows 平台，可以通过 <code>https://nmap.org/ncat/</code> 安装 ncat 然后运行：</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">bash</span>ncat -lk 9000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="map"><a href="#map" class="headerlink" title="map"></a>map</h3><p>map可以理解为映射，对每个元素进行一定的变换后，映射为另一个元素。</p><p>举例1：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> operators<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>DataStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span>StreamExecutionEnvironment<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//这个例子是监听9000 socket端口，对于发送来的数据，以\n为分隔符分割后进行处理，</span><span class="token comment" spellcheck="true">//将分割后的每个元素，添加上一个字符串后，打印出来。</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MapDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//1.获取执行环境配置信息</span>        StreamExecutionEnvironment env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//2.定义加载或创建数据源（source）,监听9000端口的socket消息</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> textStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">9000</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//3.map操作。</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> result <span class="token operator">=</span> textStream<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">(</span>index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".您输入的是："</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//4.打印输出sink</span>        result<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//5.开始执行</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>举例2：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>dataStreamMapOperator<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>UserAction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>MapFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>DataStreamSource<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>SingleOutputStreamOperator<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span>StreamExecutionEnvironment<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * Summary: *      Map: 一对一转换 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataStreamMapOperator</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{</span>        StreamExecutionEnvironment env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 输入: 用户行为。某个用户在某个时刻点击或浏览了某个商品，以及商品的价格。</span>        DataStreamSource<span class="token operator">&lt;</span>UserAction<span class="token operator">></span> source <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromCollection</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>                <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span><span class="token string">"userID1"</span><span class="token punctuation">,</span> <span class="token number">1293984000</span><span class="token punctuation">,</span> <span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token string">"productID1"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span><span class="token string">"userID2"</span><span class="token punctuation">,</span> <span class="token number">1293984001</span><span class="token punctuation">,</span> <span class="token string">"browse"</span><span class="token punctuation">,</span> <span class="token string">"productID2"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span><span class="token string">"userID1"</span><span class="token punctuation">,</span> <span class="token number">1293984002</span><span class="token punctuation">,</span> <span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token string">"productID1"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 转换: 商品的价格乘以8</span>        SingleOutputStreamOperator<span class="token operator">&lt;</span>UserAction<span class="token operator">></span> result <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapFunction</span><span class="token operator">&lt;</span>UserAction<span class="token punctuation">,</span> UserAction<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> UserAction <span class="token function">map</span><span class="token punctuation">(</span>UserAction value<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>                <span class="token keyword">int</span> newPrice <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">getProductPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">getUserID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">getEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">getEventType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span><span class="token function">getProductID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newPrice<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 输出: 输出到控制台</span>        <span class="token comment" spellcheck="true">// UserAction(userID=userID1, eventTime=1293984002, eventType=click, productID=productID1, productPrice=80)</span>        <span class="token comment" spellcheck="true">// UserAction(userID=userID1, eventTime=1293984000, eventType=click, productID=productID1, productPrice=80)</span>        <span class="token comment" spellcheck="true">// UserAction(userID=userID2, eventTime=1293984001, eventType=browse, productID=productID2, productPrice=64)</span>        result<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="flatmap"><a href="#flatmap" class="headerlink" title="flatmap"></a>flatmap</h3><p>flatmap可以理解为将元素摊平，每个元素可以变为0个、1个、或者多个元素。</p><p>举例1：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> operators<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>typeinfo<span class="token punctuation">.</span>Types<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>DataStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span>StreamExecutionEnvironment<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Collector<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//这个例子是用Flink监听9000端口，将接受的字符串用\n分割为一个个的元素</span><span class="token comment" spellcheck="true">//然后将每个元素拆为一个个的字符，并打印出来</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlatMapDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> index1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> index2 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//1.获取执行环境配置信息</span>        StreamExecutionEnvironment env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//2.定义加载或创建数据源（source）,监听9000端口的socket消息</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> textStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">9000</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//3.flatMap操作，对每一行字符串进行分割</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> result <span class="token operator">=</span> textStream<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String s<span class="token punctuation">,</span> Collector<span class="token operator">&lt;</span>String<span class="token operator">></span> collector<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span>String str <span class="token operator">:</span> s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                collector<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">//这个地方要注意，在flatMap这种参数里有泛型算子中。</span>        <span class="token comment" spellcheck="true">//如果用lambda表达式，必须将参数的类型显式地定义出来。</span>        <span class="token comment" spellcheck="true">//并且要有returns，指定返回的类型</span>        <span class="token comment" spellcheck="true">//详情可以参考Flink官方文档：https://ci.apache.org/projects/flink/flink-docs-release-1.6/dev/java_lambdas.html</span>        <span class="token punctuation">.</span><span class="token function">returns</span><span class="token punctuation">(</span>Types<span class="token punctuation">.</span>STRING<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//4.打印输出sink</span>        result<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//5.开始执行</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>举例2：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>dataStreamFlatMapOperator<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>FlatMapFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>DataStreamSource<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>SingleOutputStreamOperator<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span>StreamExecutionEnvironment<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Collector<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * Summary: *      FlatMap: 一行变任意行(0~多行) */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataStreamFlatMapOperator</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{</span>      StreamExecutionEnvironment env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 输入: 英文电影台词</span>      DataStreamSource<span class="token operator">&lt;</span>String<span class="token operator">></span> source <span class="token operator">=</span> env              <span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>                      <span class="token string">"You jump I jump"</span><span class="token punctuation">,</span>                      <span class="token string">"Life was like a box of chocolates"</span>              <span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 转换: 将包含chocolates的句子转换为每行一个单词</span>      SingleOutputStreamOperator<span class="token operator">&lt;</span>String<span class="token operator">></span> result <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlatMapFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token annotation punctuation">@Override</span>          <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">flatMap</span><span class="token punctuation">(</span>String value<span class="token punctuation">,</span> Collector<span class="token operator">&lt;</span>String<span class="token operator">></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>              <span class="token keyword">if</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"chocolates"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                  String<span class="token punctuation">[</span><span class="token punctuation">]</span> words <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token keyword">for</span> <span class="token punctuation">(</span>String word <span class="token operator">:</span> words<span class="token punctuation">)</span> <span class="token punctuation">{</span>                      out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token punctuation">}</span>              <span class="token punctuation">}</span>          <span class="token punctuation">}</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">// 输出: 输出到控制台</span>      <span class="token comment" spellcheck="true">// Life</span>      <span class="token comment" spellcheck="true">// was</span>      <span class="token comment" spellcheck="true">// like</span>      <span class="token comment" spellcheck="true">// a</span>      <span class="token comment" spellcheck="true">// box</span>      <span class="token comment" spellcheck="true">// of</span>      <span class="token comment" spellcheck="true">// chocolates</span>      result<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h3><p>filter是进行筛选。</p><p>举例：</p><pre><code>package operators;import org.apache.flink.streaming.api.datastream.DataStream;import org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;public class FilterDemo {    private static int index = 1;    public static void main(String[] args) throws Exception {        //1.获取执行环境配置信息        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();        //2.定义加载或创建数据源（source）,监听9000端口的socket消息        DataStream&lt;String&gt; textStream = env.socketTextStream("localhost", 9000, "\n");        //3.filter操作，筛选非空行。        DataStream&lt;String&gt; result = textStream.filter(line-&gt;!line.trim().equals(""));        //4.打印输出sink        result.print();        //5.开始执行        env.execute();    }}</code></pre><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>dataStreamFilterOperator<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>UserAction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>FilterFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>DataStreamSource<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>SingleOutputStreamOperator<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span>StreamExecutionEnvironment<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * Summary: *      Fliter: 过滤出需要的数据 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataStreamFilterOperator</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{</span>        StreamExecutionEnvironment env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 输入: 用户行为。某个用户在某个时刻点击或浏览了某个商品，以及商品的价格。</span>        DataStreamSource<span class="token operator">&lt;</span>UserAction<span class="token operator">></span> source <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromCollection</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>                <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span><span class="token string">"userID1"</span><span class="token punctuation">,</span> <span class="token number">1293984000</span><span class="token punctuation">,</span> <span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token string">"productID1"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span><span class="token string">"userID2"</span><span class="token punctuation">,</span> <span class="token number">1293984001</span><span class="token punctuation">,</span> <span class="token string">"browse"</span><span class="token punctuation">,</span> <span class="token string">"productID2"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span><span class="token string">"userID1"</span><span class="token punctuation">,</span> <span class="token number">1293984002</span><span class="token punctuation">,</span> <span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token string">"productID1"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 过滤: 过滤出用户ID为userID1的用户行为</span>        SingleOutputStreamOperator<span class="token operator">&lt;</span>UserAction<span class="token operator">></span> result <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FilterFunction</span><span class="token operator">&lt;</span>UserAction<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">filter</span><span class="token punctuation">(</span>UserAction value<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>                <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">getUserID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"userID1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 输出: 输出到控制台</span>        <span class="token comment" spellcheck="true">// UserAction(userID=userID1, eventTime=1293984002, eventType=click, productID=productID1, productPrice=10)</span>        <span class="token comment" spellcheck="true">// UserAction(userID=userID1, eventTime=1293984000, eventType=click, productID=productID1, productPrice=10)</span>        result<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="keyBy"><a href="#keyBy" class="headerlink" title="keyBy"></a>keyBy</h3><p>KeyBy: 按指定的Key对数据重分区。将同一Key的数据放到同一个分区。</p><p>注意:</p><ul><li>分区结果和KeyBy下游算子的并行度强相关。如下游算子只有一个并行度,不管怎么分，都会分到一起。</li><li>对于POJO类型，KeyBy可以通过keyBy(fieldName)指定字段进行分区。</li><li>对于Tuple类型，KeyBy可以通过keyBy(fieldPosition)指定字段进行分区。</li><li>对于一般类型，如上, KeyBy可以通过keyBy(new KeySelector {…})指定字段进行分区。</li></ul><p>举例：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> operators<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>typeinfo<span class="token punctuation">.</span>Types<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Tuple2<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>DataStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span>StreamExecutionEnvironment<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span>Time<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>TimeUnit<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//这个例子是每行输入一个单词，以单词为key进行计数</span><span class="token comment" spellcheck="true">//每10秒统计一次每个单词的个数</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KeyByDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//1.获取执行环境配置信息</span>        StreamExecutionEnvironment env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//2.定义加载或创建数据源（source）,监听9000端口的socket消息</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> textStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">9000</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//3.</span>        DataStream<span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">>></span> result <span class="token operator">=</span> textStream                <span class="token comment" spellcheck="true">//map是将每一行单词变为一个tuple2</span>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-</span><span class="token operator">></span> Tuple2<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">//如果要用Lambda表示是，Tuple2是泛型，那就得用returns指定类型。</span>                <span class="token punctuation">.</span><span class="token function">returns</span><span class="token punctuation">(</span>Types<span class="token punctuation">.</span><span class="token function">TUPLE</span><span class="token punctuation">(</span>Types<span class="token punctuation">.</span>STRING<span class="token punctuation">,</span> Types<span class="token punctuation">.</span>INT<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">//keyBy进行分区，按照第一列，也就是按照单词进行分区</span>                <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">//指定窗口，每10秒个计算一次</span>                <span class="token punctuation">.</span><span class="token function">timeWindow</span><span class="token punctuation">(</span>Time<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">//计算个数，计算第1列</span>                <span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//4.打印输出sink</span>        result<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//5.开始执行</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>dataStreamKeyByOperator<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>UserAction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>KeySelector<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>DataStreamSource<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>KeyedStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span>StreamExecutionEnvironment<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * Summary: *      KeyBy: 按指定的Key对数据重分区。将同一Key的数据放到同一个分区。 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataStreamKeyByOperator</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{</span>        StreamExecutionEnvironment env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 输入: 用户行为。某个用户在某个时刻点击或浏览了某个商品，以及商品的价格。</span>        DataStreamSource<span class="token operator">&lt;</span>UserAction<span class="token operator">></span> source <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromCollection</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>                <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span><span class="token string">"userID1"</span><span class="token punctuation">,</span> <span class="token number">1293984000</span><span class="token punctuation">,</span> <span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token string">"productID1"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span><span class="token string">"userID2"</span><span class="token punctuation">,</span> <span class="token number">1293984001</span><span class="token punctuation">,</span> <span class="token string">"browse"</span><span class="token punctuation">,</span> <span class="token string">"productID2"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span><span class="token string">"userID1"</span><span class="token punctuation">,</span> <span class="token number">1293984002</span><span class="token punctuation">,</span> <span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token string">"productID1"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 转换: 按指定的Key(这里,用户ID)对数据重分区，将相同Key(用户ID)的数据分到同一个分区</span>        KeyedStream<span class="token operator">&lt;</span>UserAction<span class="token punctuation">,</span> String<span class="token operator">></span> result <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">KeySelector</span><span class="token operator">&lt;</span>UserAction<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> String <span class="token function">getKey</span><span class="token punctuation">(</span>UserAction value<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>                <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">getUserID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 输出: 输出到控制台</span>        <span class="token comment" spellcheck="true">//3> UserAction(userID=userID1, eventTime=1293984000, eventType=click, productID=productID1, productPrice=10)</span>        <span class="token comment" spellcheck="true">//3> UserAction(userID=userID1, eventTime=1293984002, eventType=click, productID=productID1, productPrice=10)</span>        <span class="token comment" spellcheck="true">//2> UserAction(userID=userID2, eventTime=1293984001, eventType=browse, productID=productID2, productPrice=8)</span>        result<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setParallelism</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a>reduce</h3><p>reduce是归并操作，它可以将KeyedStream 转变为 DataStream。</p><p>Reduce: 基于ReduceFunction进行滚动聚合，并向下游算子输出每次滚动聚合后的结果。<br>注意: Reduce会输出每一次滚动聚合的结果。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> operators<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>typeinfo<span class="token punctuation">.</span>Types<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Tuple2<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>DataStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span>StreamExecutionEnvironment<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span>Time<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>TimeUnit<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//这个例子是对流进行分组，分组后进归并操作。</span><span class="token comment" spellcheck="true">//是wordcount的另外一种实现方法</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReduceDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//1.获取执行环境配置信息</span>        StreamExecutionEnvironment env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//2.定义加载或创建数据源（source）,监听9000端口的socket消息</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> textStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">9000</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//3.</span>        DataStream<span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">>></span> result <span class="token operator">=</span> textStream                <span class="token comment" spellcheck="true">//map是将每一行单词变为一个tuple2</span>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-</span><span class="token operator">></span> Tuple2<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">//如果要用Lambda表示是，Tuple2是泛型，那就得用returns指定类型。</span>                <span class="token punctuation">.</span><span class="token function">returns</span><span class="token punctuation">(</span>Types<span class="token punctuation">.</span><span class="token function">TUPLE</span><span class="token punctuation">(</span>Types<span class="token punctuation">.</span>STRING<span class="token punctuation">,</span> Types<span class="token punctuation">.</span>INT<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">//keyBy进行分区，按照第一列，也就是按照单词进行分区</span>                <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">//指定窗口，每10秒个计算一次</span>                <span class="token punctuation">.</span><span class="token function">timeWindow</span><span class="token punctuation">(</span>Time<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">//对每一组内的元素进行归并操作，即第一个和第二个归并，结果再与第三个归并...</span>                <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> t1<span class="token punctuation">,</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> t2<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token punctuation">(</span>t1<span class="token punctuation">.</span>f0<span class="token punctuation">,</span> t1<span class="token punctuation">.</span>f1 <span class="token operator">+</span> t2<span class="token punctuation">.</span>f1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//4.打印输出sink</span>        result<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//5.开始执行</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>dataStreamReduceOperator<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>UserAction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>ReduceFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>KeySelector<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>DataStreamSource<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>KeyedStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>SingleOutputStreamOperator<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span>StreamExecutionEnvironment<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * Summary: *     Reduce: 基于ReduceFunction进行滚动聚合，并向下游算子输出每次滚动聚合后的结果。 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataStreamReduceOperator</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{</span>        StreamExecutionEnvironment env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 输入: 用户行为。某个用户在某个时刻点击或浏览了某个商品，以及商品的价格。</span>        DataStreamSource<span class="token operator">&lt;</span>UserAction<span class="token operator">></span> source <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromCollection</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>                <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span><span class="token string">"userID1"</span><span class="token punctuation">,</span> <span class="token number">1293984000</span><span class="token punctuation">,</span> <span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token string">"productID1"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span><span class="token string">"userID2"</span><span class="token punctuation">,</span> <span class="token number">1293984001</span><span class="token punctuation">,</span> <span class="token string">"browse"</span><span class="token punctuation">,</span> <span class="token string">"productID2"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span><span class="token string">"userID2"</span><span class="token punctuation">,</span> <span class="token number">1293984002</span><span class="token punctuation">,</span> <span class="token string">"browse"</span><span class="token punctuation">,</span> <span class="token string">"productID2"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span><span class="token string">"userID2"</span><span class="token punctuation">,</span> <span class="token number">1293984003</span><span class="token punctuation">,</span> <span class="token string">"browse"</span><span class="token punctuation">,</span> <span class="token string">"productID2"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span><span class="token string">"userID1"</span><span class="token punctuation">,</span> <span class="token number">1293984002</span><span class="token punctuation">,</span> <span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token string">"productID1"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span><span class="token string">"userID1"</span><span class="token punctuation">,</span> <span class="token number">1293984003</span><span class="token punctuation">,</span> <span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token string">"productID3"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span><span class="token string">"userID1"</span><span class="token punctuation">,</span> <span class="token number">1293984004</span><span class="token punctuation">,</span> <span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token string">"productID1"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 转换: KeyBy对数据重分区</span>        KeyedStream<span class="token operator">&lt;</span>UserAction<span class="token punctuation">,</span> String<span class="token operator">></span> keyedStream <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">KeySelector</span><span class="token operator">&lt;</span>UserAction<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> String <span class="token function">getKey</span><span class="token punctuation">(</span>UserAction value<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>                <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">getUserID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 转换: Reduce滚动聚合。这里,滚动聚合每个用户对应的商品总价格。</span>        SingleOutputStreamOperator<span class="token operator">&lt;</span>UserAction<span class="token operator">></span> result <span class="token operator">=</span> keyedStream<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReduceFunction</span><span class="token operator">&lt;</span>UserAction<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> UserAction <span class="token function">reduce</span><span class="token punctuation">(</span>UserAction value1<span class="token punctuation">,</span> UserAction value2<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>                <span class="token keyword">int</span> newProductPrice <span class="token operator">=</span> value1<span class="token punctuation">.</span><span class="token function">getProductPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> value2<span class="token punctuation">.</span><span class="token function">getProductPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span>value1<span class="token punctuation">.</span><span class="token function">getUserID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> newProductPrice<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 输出: 将每次滚动聚合后的结果输出到控制台。</span>        <span class="token comment" spellcheck="true">//3> UserAction(userID=userID2, eventTime=1293984001, eventType=browse, productID=productID2, productPrice=8)</span>        <span class="token comment" spellcheck="true">//3> UserAction(userID=userID2, eventTime=-1, eventType=, productID=, productPrice=16)</span>        <span class="token comment" spellcheck="true">//3> UserAction(userID=userID2, eventTime=-1, eventType=, productID=, productPrice=24)</span>        <span class="token comment" spellcheck="true">//4> UserAction(userID=userID1, eventTime=1293984000, eventType=click, productID=productID1, productPrice=10)</span>        <span class="token comment" spellcheck="true">//4> UserAction(userID=userID1, eventTime=-1, eventType=, productID=, productPrice=20)</span>        <span class="token comment" spellcheck="true">//4> UserAction(userID=userID1, eventTime=-1, eventType=, productID=, productPrice=30)</span>        <span class="token comment" spellcheck="true">//4> UserAction(userID=userID1, eventTime=-1, eventType=, productID=, productPrice=40)</span>        result<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="fold"><a href="#fold" class="headerlink" title="fold"></a>fold</h3><p>基于初始值和FoldFunction进行滚动折叠(Fold)，并向下游算子输出每次滚动折叠后的结果。<br>注意: Fold会输出每一次滚动折叠的结果。</p><p>举例1：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> operators<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>typeinfo<span class="token punctuation">.</span>Types<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Tuple2<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>DataStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span>StreamExecutionEnvironment<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span>Time<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>TimeUnit<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FoldDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//1.获取执行环境配置信息</span>        StreamExecutionEnvironment env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//2.定义加载或创建数据源（source）,监听9000端口的socket消息</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> textStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">9000</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//3.</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> result <span class="token operator">=</span> textStream                <span class="token comment" spellcheck="true">//map是将每一行单词变为一个tuple2</span>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-</span><span class="token operator">></span> Tuple2<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">//如果要用Lambda表示是，Tuple2是泛型，那就得用returns指定类型。</span>                <span class="token punctuation">.</span><span class="token function">returns</span><span class="token punctuation">(</span>Types<span class="token punctuation">.</span><span class="token function">TUPLE</span><span class="token punctuation">(</span>Types<span class="token punctuation">.</span>STRING<span class="token punctuation">,</span> Types<span class="token punctuation">.</span>INT<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">//keyBy进行分区，按照第一列，也就是按照单词进行分区</span>                <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">//指定窗口，每10秒个计算一次</span>                <span class="token punctuation">.</span><span class="token function">timeWindow</span><span class="token punctuation">(</span>Time<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">//指定一个开始的值，对每一组内的元素进行归并操作，即第一个和第二个归并，结果再与第三个归并...</span>                <span class="token punctuation">.</span><span class="token function">fold</span><span class="token punctuation">(</span><span class="token string">"结果："</span><span class="token punctuation">,</span><span class="token punctuation">(</span>String current<span class="token punctuation">,</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> t2<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> current<span class="token operator">+</span>t2<span class="token punctuation">.</span>f0<span class="token operator">+</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//4.打印输出sink</span>        result<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//5.开始执行</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>dataStreamFoldOperator<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>UserAction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>FoldFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>KeySelector<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>DataStreamSource<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>KeyedStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>SingleOutputStreamOperator<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span>StreamExecutionEnvironment<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Arrays<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * Summary: *      Fold: 基于初始值和自定义的FoldFunction滚动折叠后发出新值 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataStreamFoldOperator</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{</span>        StreamExecutionEnvironment env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 输入: 用户行为。某个用户在某个时刻点击或浏览了某个商品，以及商品的价格。</span>        DataStreamSource<span class="token operator">&lt;</span>UserAction<span class="token operator">></span> source <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromCollection</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>                <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span><span class="token string">"userID1"</span><span class="token punctuation">,</span> <span class="token number">1293984000</span><span class="token punctuation">,</span> <span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token string">"productID1"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span><span class="token string">"userID2"</span><span class="token punctuation">,</span> <span class="token number">1293984001</span><span class="token punctuation">,</span> <span class="token string">"browse"</span><span class="token punctuation">,</span> <span class="token string">"productID2"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span><span class="token string">"userID2"</span><span class="token punctuation">,</span> <span class="token number">1293984002</span><span class="token punctuation">,</span> <span class="token string">"browse"</span><span class="token punctuation">,</span> <span class="token string">"productID2"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span><span class="token string">"userID2"</span><span class="token punctuation">,</span> <span class="token number">1293984003</span><span class="token punctuation">,</span> <span class="token string">"browse"</span><span class="token punctuation">,</span> <span class="token string">"productID2"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span><span class="token string">"userID1"</span><span class="token punctuation">,</span> <span class="token number">1293984002</span><span class="token punctuation">,</span> <span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token string">"productID1"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span><span class="token string">"userID1"</span><span class="token punctuation">,</span> <span class="token number">1293984003</span><span class="token punctuation">,</span> <span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token string">"productID3"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">UserAction</span><span class="token punctuation">(</span><span class="token string">"userID1"</span><span class="token punctuation">,</span> <span class="token number">1293984004</span><span class="token punctuation">,</span> <span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token string">"productID1"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 转换: KeyBy对数据重分区</span>        KeyedStream<span class="token operator">&lt;</span>UserAction<span class="token punctuation">,</span> String<span class="token operator">></span> keyedStream <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">KeySelector</span><span class="token operator">&lt;</span>UserAction<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> String <span class="token function">getKey</span><span class="token punctuation">(</span>UserAction value<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>                <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">getUserID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 转换: Fold 基于初始值和FoldFunction滚动折叠</span>        SingleOutputStreamOperator<span class="token operator">&lt;</span>String<span class="token operator">></span> result <span class="token operator">=</span> keyedStream<span class="token punctuation">.</span><span class="token function">fold</span><span class="token punctuation">(</span><span class="token string">"浏览的商品及价格:"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">FoldFunction</span><span class="token operator">&lt;</span>UserAction<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> String <span class="token function">fold</span><span class="token punctuation">(</span>String accumulator<span class="token punctuation">,</span> UserAction value<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>accumulator<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"userID"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>                    <span class="token keyword">return</span> accumulator <span class="token operator">+</span> <span class="token string">" -> "</span> <span class="token operator">+</span> value<span class="token punctuation">.</span><span class="token function">getProductID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>value<span class="token punctuation">.</span><span class="token function">getProductPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">getUserID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">" "</span> <span class="token operator">+</span>accumulator <span class="token operator">+</span> <span class="token string">" -> "</span> <span class="token operator">+</span> value<span class="token punctuation">.</span><span class="token function">getProductID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">":"</span><span class="token operator">+</span>value<span class="token punctuation">.</span><span class="token function">getProductPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 输出: 输出到控制台</span>        <span class="token comment" spellcheck="true">// 每一条数据都会触发计算并输出</span>        <span class="token comment" spellcheck="true">// userID1 浏览的商品及价格: -> productID1:10</span>        <span class="token comment" spellcheck="true">// userID1 浏览的商品及价格: -> productID1:10 -> productID1:10</span>        <span class="token comment" spellcheck="true">// userID1 浏览的商品及价格: -> productID1:10 -> productID1:10 -> productID3:10</span>        <span class="token comment" spellcheck="true">// userID1 浏览的商品及价格: -> productID1:10 -> productID1:10 -> productID3:10 -> productID1:10</span>        <span class="token comment" spellcheck="true">// userID2 浏览的商品及价格: -> productID2:8</span>        <span class="token comment" spellcheck="true">// userID2 浏览的商品及价格: -> productID2:8 -> productID2:8</span>        <span class="token comment" spellcheck="true">// userID2 浏览的商品及价格: -> productID2:8 -> productID2:8 -> productID2:8</span>        result<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Aggregate"><a href="#Aggregate" class="headerlink" title="Aggregate"></a>Aggregate</h3><p>Aggregate 对KeyedStream按指定字段滚动聚合并输出每一次滚动聚合后的结果。默认的聚合函数有:sum、min、minBy、max、mabBy。</p><p>注意:</p><ul><li>max(field)与maxBy(field)的区别: maxBy返回field最大的那条数据;而max则是将最大的field的值赋值给第一条数据并返回第一条数据。同理,min与minBy。</li><li>Aggregate聚合算子会滚动输出每一次聚合后的结果。</li></ul><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>dataStreamAggregateOperator<span class="token punctuation">;</span><span class="token keyword">import</span> com<span class="token punctuation">.</span>bigdata<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>UserActionLogPOJO<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>KeySelector<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>DataStreamSource<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>KeyedStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span>StreamExecutionEnvironment<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/** * Summary: *     Aggregate: min()、minBy()、max()、maxBy() 滚动聚合并输出每次滚动聚合后的结果 */</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataStreamAggregateOperator</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception<span class="token punctuation">{</span>        StreamExecutionEnvironment env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 输入: 用户行为。某个用户在某个时刻点击或浏览了某个商品，以及商品的价格。</span>        ArrayList<span class="token operator">&lt;</span>UserActionLogPOJO<span class="token operator">></span> userActionLogs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        UserActionLogPOJO userActionLog1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserActionLogPOJO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        userActionLog1<span class="token punctuation">.</span><span class="token function">setUserID</span><span class="token punctuation">(</span><span class="token string">"userID1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        userActionLog1<span class="token punctuation">.</span><span class="token function">setProductID</span><span class="token punctuation">(</span><span class="token string">"productID3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        userActionLog1<span class="token punctuation">.</span><span class="token function">setProductPrice</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        userActionLogs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>userActionLog1<span class="token punctuation">)</span><span class="token punctuation">;</span>        UserActionLogPOJO userActionLog2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserActionLogPOJO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        userActionLog2<span class="token punctuation">.</span><span class="token function">setUserID</span><span class="token punctuation">(</span><span class="token string">"userID2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        userActionLog2<span class="token punctuation">.</span><span class="token function">setProductPrice</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        userActionLogs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>userActionLog2<span class="token punctuation">)</span><span class="token punctuation">;</span>        UserActionLogPOJO userActionLog3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserActionLogPOJO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        userActionLog3<span class="token punctuation">.</span><span class="token function">setUserID</span><span class="token punctuation">(</span><span class="token string">"userID1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        userActionLog3<span class="token punctuation">.</span><span class="token function">setProductID</span><span class="token punctuation">(</span><span class="token string">"productID5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        userActionLog3<span class="token punctuation">.</span><span class="token function">setProductPrice</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        userActionLogs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>userActionLog3<span class="token punctuation">)</span><span class="token punctuation">;</span>        DataStreamSource<span class="token operator">&lt;</span>UserActionLogPOJO<span class="token operator">></span> source <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromCollection</span><span class="token punctuation">(</span>userActionLogs<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 转换: KeyBy对数据重分区</span>        <span class="token comment" spellcheck="true">// 这里, UserActionLog是POJO类型,也可通过keyBy("userID")进行分区</span>        KeyedStream<span class="token operator">&lt;</span>UserActionLogPOJO<span class="token punctuation">,</span> String<span class="token operator">></span> keyedStream <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">KeySelector</span><span class="token operator">&lt;</span>UserActionLogPOJO<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> String <span class="token function">getKey</span><span class="token punctuation">(</span>UserActionLogPOJO value<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>                <span class="token keyword">return</span> value<span class="token punctuation">.</span><span class="token function">getUserID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 转换: Aggregate并输出</span>        <span class="token comment" spellcheck="true">// 滚动求和并输出</span>        <span class="token comment" spellcheck="true">//keyedStream.sum("productPrice").print();</span>        <span class="token comment" spellcheck="true">// 滚动求最大值并输出</span>        keyedStream<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token string">"productPrice"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 滚动求最大值并输出</span>        keyedStream<span class="token punctuation">.</span><span class="token function">maxBy</span><span class="token punctuation">(</span><span class="token string">"productPrice"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 滚动求最小值并输出</span>        <span class="token comment" spellcheck="true">//keyedStream.min("productPrice").print();</span>        <span class="token comment" spellcheck="true">// 滚动求最小值并输出</span>        <span class="token comment" spellcheck="true">//keyedStream.minBy("productPrice").print();</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="union"><a href="#union" class="headerlink" title="union"></a>union</h3><p>union可以将多个流合并到一个流中，以便对合并的流进行统一处理。是对多个流的水平拼接。</p><p>参与合并的流必须是同一种类型。</p><p>举例：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> operators<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>DataStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span>StreamExecutionEnvironment<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//这个例子是将三个socket端口发送来的数据合并到一个流中</span><span class="token comment" spellcheck="true">//可以对这三个流发送来的数据，集中处理。</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UnionDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//1.获取执行环境配置信息</span>        StreamExecutionEnvironment env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//2.定义加载或创建数据源（source）,监听9000端口的socket消息</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> textStream9000 <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">9000</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> textStream9001 <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">9001</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> textStream9002 <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">9002</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> mapStream9000<span class="token operator">=</span>textStream9000<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">></span><span class="token string">"来自9000端口："</span><span class="token operator">+</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> mapStream9001<span class="token operator">=</span>textStream9001<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">></span><span class="token string">"来自9001端口："</span><span class="token operator">+</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> mapStream9002<span class="token operator">=</span>textStream9002<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">></span><span class="token string">"来自9002端口："</span><span class="token operator">+</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//3.union用来合并两个或者多个流的数据，统一到一个流中</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> result <span class="token operator">=</span>  mapStream9000<span class="token punctuation">.</span><span class="token function">union</span><span class="token punctuation">(</span>mapStream9001<span class="token punctuation">,</span>mapStream9002<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//4.打印输出sink</span>        result<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//5.开始执行</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="join"><a href="#join" class="headerlink" title="join"></a>join</h3><p>根据指定的Key将两个流进行关联。</p><p>举例：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> operators<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>MapFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Tuple2<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>DataStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span>StreamExecutionEnvironment<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>assigners<span class="token punctuation">.</span>TumblingProcessingTimeWindows<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span>Time<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WindowJoinDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//1.获取执行环境配置信息</span>        StreamExecutionEnvironment env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//2.定义加载或创建数据源（source）,监听9000端口的socket消息</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> textStream9000 <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">9000</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> textStream9001 <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">9001</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//将输入处理一下，变为tuple2</span>        DataStream<span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>String<span class="token operator">>></span> mapStream9000<span class="token operator">=</span>textStream9000                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>String<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> <span class="token function">map</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>                        <span class="token keyword">return</span> Tuple2<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token string">"来自9000端口："</span><span class="token operator">+</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        DataStream<span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>String<span class="token operator">>></span> mapStream9001<span class="token operator">=</span>textStream9001                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span>String<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> <span class="token function">map</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>                        <span class="token keyword">return</span> Tuple2<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span><span class="token string">"来自9001端口："</span><span class="token operator">+</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//3.两个流进行join操作，是inner join，关联上的才能保留下来</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> result <span class="token operator">=</span>  mapStream9000<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>mapStream9001<span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">//关联条件，以第0列关联（两个source输入的字符串）</span>                <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>t1<span class="token operator">-</span><span class="token operator">></span>t1<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span>t2<span class="token operator">-</span><span class="token operator">></span>t2<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">//以处理时间，每10秒一个滚动窗口</span>                <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span>TumblingProcessingTimeWindows<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>Time<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">//关联后输出</span>                <span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">(</span>t1<span class="token punctuation">,</span>t2<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span>t1<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"|"</span><span class="token operator">+</span>t2<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//4.打印输出sink</span>        result<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//5.开始执行</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="coGroup"><a href="#coGroup" class="headerlink" title="coGroup"></a>coGroup</h3><p>关联两个流，关联不上的也保留下来。</p><p>举例：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> operators<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>CoGroupFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>MapFunction<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Tuple2<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>DataStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span>StreamExecutionEnvironment<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>assigners<span class="token punctuation">.</span>TumblingProcessingTimeWindows<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span>Time<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Collector<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CoGroupDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//1.获取执行环境配置信息</span>        StreamExecutionEnvironment env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//2.定义加载或创建数据源（source）,监听9000端口的socket消息</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> textStream9000 <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">9000</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> textStream9001 <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">9001</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//将输入处理一下，变为tuple2</span>        DataStream<span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">>></span> mapStream9000 <span class="token operator">=</span> textStream9000                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> <span class="token function">map</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>                        <span class="token keyword">return</span> Tuple2<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"来自9000端口："</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        DataStream<span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">>></span> mapStream9001 <span class="token operator">=</span> textStream9001                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MapFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> <span class="token function">map</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>                        <span class="token keyword">return</span> Tuple2<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token string">"来自9001端口："</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//3.两个流进行coGroup操作,没有关联上的也保留下来，功能更强大</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> result <span class="token operator">=</span> mapStream9000<span class="token punctuation">.</span><span class="token function">coGroup</span><span class="token punctuation">(</span>mapStream9001<span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">//关联条件，以第0列关联（两个source输入的字符串）</span>                <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>t1 <span class="token operator">-</span><span class="token operator">></span> t1<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span>t2 <span class="token operator">-</span><span class="token operator">></span> t2<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">//以处理时间，每10秒一个滚动窗口</span>                <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span>TumblingProcessingTimeWindows<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>Time<span class="token punctuation">.</span><span class="token function">seconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">//关联后输出</span>                <span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CoGroupFunction</span><span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">,</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">coGroup</span><span class="token punctuation">(</span>Iterable<span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">>></span> iterable<span class="token punctuation">,</span> Iterable<span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">>></span> iterable1<span class="token punctuation">,</span> Collector<span class="token operator">&lt;</span>String<span class="token operator">></span> collector<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>                        StringBuffer stringBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        stringBuffer<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"来自9000的stream:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">for</span> <span class="token punctuation">(</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> item <span class="token operator">:</span> iterable<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            stringBuffer<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>f1 <span class="token operator">+</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        stringBuffer<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"来自9001的stream:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">for</span> <span class="token punctuation">(</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> item <span class="token operator">:</span> iterable1<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            stringBuffer<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>f1 <span class="token operator">+</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        collector<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>stringBuffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//4.打印输出sink</span>        result<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//5.开始执行</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h3><p>参考：<a href="https://www.jianshu.com/p/5b0574d466f8" target="_blank" rel="noopener">https://www.jianshu.com/p/5b0574d466f8</a></p><p>将两个流纵向地连接起来。DataStream的connect操作创建的是ConnectedStreams或BroadcastConnectedStream，它用了两个泛型，即不要求两个dataStream的element是同一类型。</p><p>举例：</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> operators<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Tuple2<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>DataStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>SingleOutputStreamOperator<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span>StreamExecutionEnvironment<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>co<span class="token punctuation">.</span>CoMapFunction<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>regex<span class="token punctuation">.</span>Matcher<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>regex<span class="token punctuation">.</span>Pattern<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConnectDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//1.获取执行环境配置信息</span>        StreamExecutionEnvironment env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//2.定义加载或创建数据源（source）,监听9000端口的socket消息</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> textStream9000 <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">9000</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> textStream9001 <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">9001</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//转为Integer类型流</span>        DataStream<span class="token operator">&lt;</span>Integer<span class="token operator">></span> intStream <span class="token operator">=</span> textStream9000<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">></span> <span class="token function">isNumeric</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>s <span class="token operator">-</span><span class="token operator">></span> Integer<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//连接起来，分别处理，返回同样的一种类型。</span>        SingleOutputStreamOperator result <span class="token operator">=</span> intStream<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>textStream9001<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CoMapFunction</span><span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Tuple2<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> Tuple2<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token operator">></span> <span class="token function">map1</span><span class="token punctuation">(</span>Integer value<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>                        <span class="token keyword">return</span> Tuple2<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token annotation punctuation">@Override</span>                    <span class="token keyword">public</span> Tuple2<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> String<span class="token operator">></span> <span class="token function">map2</span><span class="token punctuation">(</span>String value<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>                        <span class="token keyword">return</span> Tuple2<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//4.打印输出sink</span>        result<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//5.开始执行</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isNumeric</span><span class="token punctuation">(</span>String str<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Pattern pattern <span class="token operator">=</span> Pattern<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">"[0-9]*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Matcher isNum <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isNum<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="split"><a href="#split" class="headerlink" title="split"></a>split</h3><p>参考：<a href="https://cloud.tencent.com/developer/article/1382892" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1382892</a></p><p>将一个流拆分为多个流。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> operators<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>typeinfo<span class="token punctuation">.</span>Types<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Tuple2<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>DataStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span>SplitStream<span class="token punctuation">;</span><span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span>StreamExecutionEnvironment<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ArrayList<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>regex<span class="token punctuation">.</span>Matcher<span class="token punctuation">;</span><span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>regex<span class="token punctuation">.</span>Pattern<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SplitDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//1.获取执行环境配置信息</span>        StreamExecutionEnvironment env <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//2.定义加载或创建数据源（source）,监听9000端口的socket消息</span>        DataStream<span class="token operator">&lt;</span>String<span class="token operator">></span> textStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">socketTextStream</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">9000</span><span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//3.</span>        SplitStream<span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">>></span> result <span class="token operator">=</span> textStream                <span class="token comment" spellcheck="true">//map是将每一行单词变为一个tuple2</span>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-</span><span class="token operator">></span> Tuple2<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token comment" spellcheck="true">//如果要用Lambda表示是，Tuple2是泛型，那就得用returns指定类型。</span>                <span class="token punctuation">.</span><span class="token function">returns</span><span class="token punctuation">(</span>Types<span class="token punctuation">.</span><span class="token function">TUPLE</span><span class="token punctuation">(</span>Types<span class="token punctuation">.</span>STRING<span class="token punctuation">,</span> Types<span class="token punctuation">.</span>INT<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>t <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>                    List<span class="token operator">&lt;</span>String<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">//根据逻辑拆分，并定义outputName</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNumeric</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>f0<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"num"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"str"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">return</span> list<span class="token punctuation">;</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//选择指定名称的流</span>        DataStream<span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">>></span> strSplitStream <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"str"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>t <span class="token operator">-</span><span class="token operator">></span> Tuple2<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"字符串："</span> <span class="token operator">+</span> t<span class="token punctuation">.</span>f0<span class="token punctuation">,</span> t<span class="token punctuation">.</span>f1<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">returns</span><span class="token punctuation">(</span>Types<span class="token punctuation">.</span><span class="token function">TUPLE</span><span class="token punctuation">(</span>Types<span class="token punctuation">.</span>STRING<span class="token punctuation">,</span>Types<span class="token punctuation">.</span>INT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//选择指定名称的流</span>        DataStream<span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">>></span> intSplitStream <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">"num"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>t <span class="token operator">-</span><span class="token operator">></span> Tuple2<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"数字："</span> <span class="token operator">+</span> t<span class="token punctuation">.</span>f0<span class="token punctuation">,</span> t<span class="token punctuation">.</span>f1<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">returns</span><span class="token punctuation">(</span>Types<span class="token punctuation">.</span><span class="token function">TUPLE</span><span class="token punctuation">(</span>Types<span class="token punctuation">.</span>STRING<span class="token punctuation">,</span>Types<span class="token punctuation">.</span>INT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//4.打印输出sink</span>        strSplitStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        intSplitStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//5.开始执行</span>        env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isNumeric</span><span class="token punctuation">(</span>String str<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Pattern pattern <span class="token operator">=</span> Pattern<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">"[0-9]*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Matcher isNum <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isNum<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="原文链接"><a href="#原文链接" class="headerlink" title="原文链接"></a>原文链接</h3><ul><li><a href="https://blog.csdn.net/chybin500/article/details/87260869" target="_blank" rel="noopener">原文链接1</a></li><li><a href="https://blog.csdn.net/wangpei1949/article/details/101625394" target="_blank" rel="noopener">原文链接2</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> flink </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flink </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flink中returns函数使用</title>
      <link href="/2020/03/18/flink-zhong-returns-han-shu-shi-yong/"/>
      <url>/2020/03/18/flink-zhong-returns-han-shu-shi-yong/</url>
      
        <content type="html"><![CDATA[<p>Java8出来之后，lambda表达式由于简单易读，在流式计算中的使用开始变得普遍。</p><p>同样,Flink也支持lambda表达式，例如我们改写一下wordcount样例</p><pre class="line-numbers language-java"><code class="language-java">DataSource<span class="token operator">&lt;</span>String<span class="token operator">></span> lines <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>    <span class="token string">"Apache Flink is a community-driven open source framework for distributed big data analytics,"</span><span class="token punctuation">,</span>    <span class="token string">"like Hadoop and Spark. The core of Apache Flink is a distributed streaming dataflow engine written"</span><span class="token punctuation">,</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>lines<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FlatMapFunction</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">flatMap</span><span class="token punctuation">(</span>String line<span class="token punctuation">,</span> Collector<span class="token operator">&lt;</span> Object<span class="token operator">></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>String word <span class="token operator">:</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\\W+"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这段代码很简单，先把每一行按空格拆分成若干单词，并将每个单词和数字1组成一个Tuple，然后把所有Tuple按照单词聚合，计算出每个单词的出现次数</p><p>尝试用lambda表达式来替换FlatMapFunction，代码如下</p><pre class="line-numbers language-java"><code class="language-java">lines<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> out<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>String word <span class="token operator">:</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\\W+"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>但当运行这段代码时，会抛出如下异常：</p><pre class="line-numbers language-java"><code class="language-java">Caused by<span class="token operator">:</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>InvalidTypesException<span class="token operator">:</span> The generic type parameters of <span class="token string">'Collector'</span> are missing<span class="token punctuation">.</span> It seems that your compiler has not stored them into the <span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token class-name">file<span class="token punctuation">.</span></span> Currently<span class="token punctuation">,</span> only the Eclipse JDT compiler preserves the type information necessary to use the lambdas feature type<span class="token operator">-</span>safely<span class="token punctuation">.</span> See the documentation <span class="token keyword">for</span> more information about how to compile jobs containing lambda expressions<span class="token punctuation">.</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>typeutils<span class="token punctuation">.</span>TypeExtractor<span class="token punctuation">.</span><span class="token function">validateLambdaGenericParameter</span><span class="token punctuation">(</span>TypeExtractor<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1653</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>typeutils<span class="token punctuation">.</span>TypeExtractor<span class="token punctuation">.</span><span class="token function">validateLambdaGenericParameters</span><span class="token punctuation">(</span>TypeExtractor<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1639</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>typeutils<span class="token punctuation">.</span>TypeExtractor<span class="token punctuation">.</span><span class="token function">getUnaryOperatorReturnType</span><span class="token punctuation">(</span>TypeExtractor<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">573</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>typeutils<span class="token punctuation">.</span>TypeExtractor<span class="token punctuation">.</span><span class="token function">getFlatMapReturnTypes</span><span class="token punctuation">(</span>TypeExtractor<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">188</span><span class="token punctuation">)</span>    at org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>DataSet<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>DataSet<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">266</span><span class="token punctuation">)</span>    at TestFlink<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>TestFlink<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">21</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这是因为Flink在用户自定义的函数中会使用泛型来创建serializer，当我们使用匿名函数时，类型信息会被保留。但Lambda表达式并不是匿名函数，所以javac编译的时候并不会把泛型保存到class文件里。</p><p>解决办法有两种:</p><p>第一种办法在异常中已经提示，使用Eclipse JDT编译器会保留对lambda表达式来说必要的类型信息。在Maven中使用Eclipse JDT编译器，只需要在把下面的插件加入到pom.xml中</p><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-compiler-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>source</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span><span class="token punctuation">></span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>target</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>compilerId</span><span class="token punctuation">></span></span>jdt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>compilerId</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.eclipse.tycho<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>tycho-compiler-jdt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.21.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>另一种办法是，使用Flink提供的returns方法来指定flatMap的返回类型，</p><pre class="line-numbers language-java"><code class="language-java">text<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> out<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>String word <span class="token operator">:</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\\W+"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">returns</span><span class="token punctuation">(</span><span class="token punctuation">(</span>TypeInformation<span class="token punctuation">)</span> TupleTypeInfo<span class="token punctuation">.</span><span class="token function">getBasicTupleTypeInfo</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> Integer<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java"><code class="language-java">text<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> out<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>String word <span class="token operator">:</span> line<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\\W+"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">returns</span><span class="token punctuation">(</span>Types<span class="token punctuation">.</span><span class="token function">TUPLE</span><span class="token punctuation">(</span>Types<span class="token punctuation">.</span>STRING<span class="token punctuation">,</span> Types<span class="token punctuation">.</span>INT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>returns</code>函数接收TypeInformation类型的参数，这里我们创建TupleTypeInfo来指定Tuple的参数类型。</p><ul><li><p><a href="http://kane-xie.github.io/2017/07/12/2017-07-12_Flink%E4%BD%BF%E7%94%A8lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/" target="_blank" rel="noopener">参考链接1</a></p></li><li><p><a href="https://blog.csdn.net/November_28/article/details/100020400" target="_blank" rel="noopener">参考链接2</a></p></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> flink </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flink </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flink多数据流转换操作：join、union、connect</title>
      <link href="/2020/03/18/flink-duo-shu-ju-liu-zhuan-huan-cao-zuo/"/>
      <url>/2020/03/18/flink-duo-shu-ju-liu-zhuan-huan-cao-zuo/</url>
      
        <content type="html"><![CDATA[<h3 id="操作概览"><a href="#操作概览" class="headerlink" title="操作概览"></a>操作概览</h3><p><img src="/images/flink13.png" alt="操作概览"></p><p>本文主要讲flink中多条数据流转换操作：join、union、connect</p><h3 id="join"><a href="#join" class="headerlink" title="join"></a>join</h3><p>批处理经常要解决的问题是将两个数据源做关联Join操作。比如，很多手机APP都有一个用户数据源User，同时APP会记录用户的行为，我们称之为Behavior，两个表按照userId来进行Join。在流处理场景下，Flink也支持了Join，只不过Flink是在一个时间窗口上来进行两个表的Join。<br><img src="/images/flink14.png" alt="操作概览"><br>目前，Flink支持了两种Join：<code>Window Join</code>（窗口连接）和<code>Interval Join</code>（时间间隔连接）。</p><h4 id="Window-Join"><a href="#Window-Join" class="headerlink" title="Window Join"></a>Window Join</h4><p>从名字中能猜到，Window Join主要在Flink的窗口上进行操作，它将两个流中落在相同窗口的元素按照某个Key进行Join。一个Window Join的大致骨架结构为：</p><pre class="line-numbers language-java"><code class="language-java">input1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>input2<span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>KeySelector<span class="token operator">></span><span class="token punctuation">)</span>      <span class="token operator">&lt;</span><span class="token operator">-</span> input1使用哪个字段作为Key    <span class="token punctuation">.</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>KeySelector<span class="token operator">></span><span class="token punctuation">)</span>    <span class="token operator">&lt;</span><span class="token operator">-</span> input2使用哪个字段作为Key    <span class="token punctuation">.</span><span class="token function">window</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>WindowAssigner<span class="token operator">></span><span class="token punctuation">)</span>  <span class="token operator">&lt;</span><span class="token operator">-</span> 指定WindowAssigner    <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Trigger<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">]</span>      <span class="token operator">&lt;</span><span class="token operator">-</span> 指定Trigger（可选）    <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token function">evictor</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Evictor<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">]</span>      <span class="token operator">&lt;</span><span class="token operator">-</span> 指定Evictor（可选）    <span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>JoinFunction<span class="token operator">></span><span class="token punctuation">)</span>     <span class="token operator">&lt;</span><span class="token operator">-</span> 指定JoinFunction<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>下图展示了Join的大致过程。两个输入数据流先分别按Key进行分组，然后将元素划分到窗口中。窗口的划分需要使用WindowAssigner来定义，这里可以使用Flink提供的滚动窗口、滑动窗口或会话窗口等默认的WindowAssigner。随后两个数据流中的元素会被分配到各个窗口上，也就是说一个窗口会包含来自两个数据流的元素。相同窗口内的数据会以INNER JOIN的语义来相互关联，形成一个数据对。当窗口的时间结束，Flink会调用JoinFunction来对窗口内的数据对进行处理。当然，我们也可以使用Trigger或Evictor做一些自定义优化，他们的使用方法和普通窗口的使用方法一样。<br><img src="/images/flink15.png" alt="join"></p><p>接下来我们重点分析一下两个数据流是如何INNER JOIN的：<br><img src="/images/flink16.png" alt="join"><br>一般滴，INNER JOIN只对两个数据源都出现的元素做Join，形成一个数据对，即数据源input1中的某个元素与数据源input2中的所有元素逐个配对。当数据源某个窗口内没数据时，比如图中的第三个窗口，Join的结果也是空的。</p><p>如果INNER JOIN不能满足我们的需求，CoGroupFunction提供了更多可自定义的功能。需要注意的是，在调用时，要写成<code>input1.coGroup(input2).where(&lt;KeySelector&gt;).equalTo(&lt;KeySelecotr&gt;)</code>。</p><h4 id="Interval-Join"><a href="#Interval-Join" class="headerlink" title="Interval Join"></a>Interval Join</h4><p>与Window Join不同，Interval Join不依赖Flink的WindowAssigner，而是根据一个时间间隔（Interval）界定时间。Interval需要一个时间下界（<code>lower bound</code>）和上界（<code>upper bound</code>），如果我们将input1和input2进行Interval Join，input1中的某个元素为<code>input1.element1</code>，时间戳为<code>input1.element1.ts</code>，那么一个Interval就是<code>[input1.element1.ts + lower bound, input1.element1.ts + upper bound]</code>，input2中落在这个时间段内的元素将会和<code>input1.element1</code>组成一个数据对。</p><p>用数学公式表达为，凡是符合下面公式<code>input1.element1.ts + lower bound &lt;= input2.elementx.ts &lt;=input1.element1.ts + upper bound</code>的元素使用INNER JOIN语义，两两组合在一起。上下界可以是正数也可以是负数。</p><p>注意，目前Flink（1.9）的Interval Join只支持<code>Event Time</code>语义。</p><p><img src="/images/flink17.png" alt="join"></p><p>默认的时间间隔是包含上下界的，我们可以使用<code>.lowerBoundExclusive()</code> 和<code>.upperBoundExclusive</code>来确定是否需要包含上下界。</p><pre class="line-numbers language-java"><code class="language-java">val intervalJoinResult <span class="token operator">=</span> input1<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>_1<span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">intervalJoin</span><span class="token punctuation">(</span>input2<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>_1<span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">between</span><span class="token punctuation">(</span>Time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">upperBoundExclusive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">lowerBoundExclusive</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyProcessFunction</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Interval Join内部是用缓存来存储所有数据的，因此需要注意缓存数据不能太大，以免对内存造成绝大压力。</p><h3 id="union"><a href="#union" class="headerlink" title="union"></a>union</h3><p>在<code>DataStream</code>上使用union算子可以合并多个同类型的数据流，并生成同类型的数据流，即可以将多个<code>DataStream[T]</code>合并为一个新的<code>DataStream[T]</code>。数据将按照先进先出（<code>First In First Out</code>）的模式合并，且<strong>不去重</strong>。下图<code>union</code>对白色和深色两个数据流进行合并，生成一个数据流。</p><p><img src="/images/flink18.png" alt="union"></p><h3 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h3><p><code>union</code>虽然可以合并多个数据流，但有一个限制，即多个数据流的数据类型必须相同。<code>connect</code>提供了和<code>union</code>类似的功能，用来连接两个数据流，它与<code>union</code>的区别在于：</p><ul><li><code>connect</code>只能连接<strong>两个数据流</strong>，<code>union</code>可以连接<strong>多个数据流</strong>。</li><li><code>connect</code>所连接的两个数据流的<strong>数据类型可以不一致</strong>，<code>union</code>所连接的两个数据流的<strong>数据类型必须一致</strong>。</li><li>两个<code>DataStream</code>经过<code>connect</code>之后被转化为<code>ConnectedStreams</code>，<code>ConnectedStreams</code>会对两个流的数据应用不同的处理方法，且双流之间可以<strong>共享状态</strong>。</li></ul><p><code>connect</code>经常被应用在对一个数据流使用另外一个流进行控制处理的场景上，如下图所示。控制流可以是阈值、规则、机器学习模型或其他参数。<br><img src="/images/flink19.png" alt="connect"></p><ul><li>对于ConnectedStreams，我们需要重写CoMapFunction或CoFlatMapFunction。这两个接口都提供了三个泛型，这三个泛型分别对应第一个输入流的数据类型、第二个输入流的数据类型和输出流的数据类型。</li><li>在重写函数时，对于CoMapFunction，map1处理第一个流的数据，map2处理第二个流的数据；对于CoFlatMapFunction，flatMap1处理第一个流的数据，flatMap2处理第二个流的数据。</li><li>Flink并不能保证两个函数调用顺序，两个函数的调用依赖于两个数据流数据的流入先后顺序，即第一个数据流有数据到达时，map1或flatMap1会被调用，第二个数据流有数据到达时，map2或flatMap2会被调用。</li><li>Flink允许我们将connect和keyBy或broadcast结合起来使用。</li></ul><h3 id="原文链接"><a href="#原文链接" class="headerlink" title="原文链接"></a>原文链接</h3><ul><li><a href="https://zhuanlan.zhihu.com/p/103342602" target="_blank" rel="noopener">Flink时间系列：如何在两个DataStream上进行Join操作</a></li><li><a href="https://zhuanlan.zhihu.com/p/99425612" target="_blank" rel="noopener">Flink算子使用方法及实例演示：union和connect</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> flink </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flink </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flink数据类型转换</title>
      <link href="/2020/03/18/flink-shu-ju-lei-xing-zhuan-huan/"/>
      <url>/2020/03/18/flink-shu-ju-lei-xing-zhuan-huan/</url>
      
        <content type="html"><![CDATA[<h3 id="转换关系总图"><a href="#转换关系总图" class="headerlink" title="转换关系总图"></a>转换关系总图</h3><p><img src="/images/flink8.png" alt="转换关系"></p><h3 id="DataStream"><a href="#DataStream" class="headerlink" title="DataStream"></a>DataStream</h3><p>DataStream 是 Flink 流处理 API 中最核心的数据结构。它代表了一个运行在多个分区上的并行流。一个 DataStream 可以从 StreamExecutionEnvironment 通过env.addSource(SourceFunction) 获得。</p><p>DataStream 上的转换操作都是逐条的，比如 map()，flatMap()，filter()。DataStream 也可以执行 rebalance（再平衡，用来减轻数据倾斜）和 broadcaseted（广播）等分区转换。</p><h3 id="KeyedStream"><a href="#KeyedStream" class="headerlink" title="KeyedStream"></a>KeyedStream</h3><p>KeyedStream用来表示根据指定的key进行分组的数据流。一个KeyedStream可以通过调用DataStream.keyBy()来获得。而在KeyedStream上进行任何transformation都将转变回DataStream。在实现中，KeyedStream是把key的信息写入到了transformation中。每条记录只能访问所属key的状态，其上的聚合函数可以方便地操作和保存对应key的状态。</p><h3 id="WindowedStream-amp-AllWindowedStream"><a href="#WindowedStream-amp-AllWindowedStream" class="headerlink" title="WindowedStream &amp; AllWindowedStream"></a>WindowedStream &amp; AllWindowedStream</h3><p>WindowedStream代表了根据key分组，并且基于WindowAssigner切分窗口的数据流。所以WindowedStream都是从KeyedStream衍生而来的。而在WindowedStream上进行任何transformation也都将转变回DataStream。</p><p>在key分组的流上进行窗口切分是比较常用的场景，也能够很好地并行化（不同的key上的窗口聚合可以分配到不同的task去处理）。不过有时候我们也需要在普通流上进行窗口的操作，这就是 AllWindowedStream。AllWindowedStream是直接在DataStream上进行windowAll(…)操作。</p><p>Flink 的窗口实现中会将到达的数据缓存在对应的窗口buffer中（一个数据可能会对应多个窗口）。当到达窗口发送的条件时（由Trigger控制），Flink 会对整个窗口中的数据进行处理。Flink 在聚合类窗口有一定的优化，即不会保存窗口中的所有值，而是每到一个元素执行一次聚合函数，最终只保存一份数据即可。</p><p><img src="/images/flink9.png" alt="window"></p><h3 id="JoinedStreams-amp-CoGroupedStreams"><a href="#JoinedStreams-amp-CoGroupedStreams" class="headerlink" title="JoinedStreams &amp; CoGroupedStreams"></a>JoinedStreams &amp; CoGroupedStreams</h3><h3 id="ConnectedStreams"><a href="#ConnectedStreams" class="headerlink" title="ConnectedStreams"></a>ConnectedStreams</h3><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="http://wuchong.me/blog/2016/05/20/flink-internals-streams-and-operations-on-streams/" target="_blank" rel="noopener">http://wuchong.me/</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> flink </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flink </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java8流-Stream用法</title>
      <link href="/2020/03/16/java8-liu-stream-yong-fa/"/>
      <url>/2020/03/16/java8-liu-stream-yong-fa/</url>
      
        <content type="html"><![CDATA[<h3 id="用法"><a href="#用法" class="headerlink" title="::用法"></a><code>::</code>用法</h3><p>jdk8中使用了<code>::</code>的用法。就是把方法当做参数传到stream内部，使stream的每个元素都传入到该方法里面执行一下，双冒号运算就是Java中的<code>[方法引用]</code>,<code>[方法引用]</code>的格式是：</p><pre><code>类名：：方法名</code></pre><p><strong>例如：</strong></p><p>表达式：</p><pre class="line-numbers language-java"><code class="language-java">person <span class="token operator">-</span><span class="token operator">></span> person<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>使用双冒号：</p><pre class="line-numbers language-java"><code class="language-java">Person <span class="token operator">:</span><span class="token operator">:</span> getAge<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="stream和parallelStream"><a href="#stream和parallelStream" class="headerlink" title="stream和parallelStream"></a>stream和parallelStream</h3><p>用于生成数据流</p><pre class="line-numbers language-java"><code class="language-java">List<span class="token operator">&lt;</span>String<span class="token operator">></span> strings <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"abc"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"bc"</span><span class="token punctuation">,</span> <span class="token string">"efg"</span><span class="token punctuation">,</span> <span class="token string">"abcd"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"jkl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//生成顺序流</span>strings<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">//生成并行流</span>strings<span class="token punctuation">.</span><span class="token function">parallelStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="forEach"><a href="#forEach" class="headerlink" title="forEach"></a>forEach</h3><p>用于迭代数据流中每个数据</p><pre class="line-numbers language-java"><code class="language-java">List<span class="token operator">&lt;</span>String<span class="token operator">></span> strings <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"abc"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"bc"</span><span class="token punctuation">,</span> <span class="token string">"efg"</span><span class="token punctuation">,</span> <span class="token string">"abcd"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"jkl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>strings<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="map"><a href="#map" class="headerlink" title="map"></a>map</h3><p>对数据流中每个数据执行方法</p><pre class="line-numbers language-java"><code class="language-java">List<span class="token operator">&lt;</span>Integer<span class="token operator">></span> strings <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 每个数据加1操作</span>strings<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>x <span class="token operator">-</span><span class="token operator">></span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="distinct"><a href="#distinct" class="headerlink" title="distinct"></a>distinct</h3><p>去重</p><pre class="line-numbers language-java"><code class="language-java">List<span class="token operator">&lt;</span>Integer<span class="token operator">></span> strings <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 去除重复的4,5,5</span>strings<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">distinct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h3><p>过滤</p><pre class="line-numbers language-java"><code class="language-java">List<span class="token operator">&lt;</span>String<span class="token operator">></span>strings <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"abc"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"bc"</span><span class="token punctuation">,</span> <span class="token string">"efg"</span><span class="token punctuation">,</span> <span class="token string">"abcd"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"jkl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 获取空字符串的数量</span><span class="token keyword">long</span> count <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>string <span class="token operator">-</span><span class="token operator">></span> string<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//获取非空数量</span><span class="token keyword">long</span> count <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>string <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">!</span>string<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="limit"><a href="#limit" class="headerlink" title="limit"></a>limit</h3><p>限制流的大小</p><pre class="line-numbers language-java"><code class="language-java">List<span class="token operator">&lt;</span>Integer<span class="token operator">></span> strings <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 只会打印前4个</span>strings<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="sorted"><a href="#sorted" class="headerlink" title="sorted"></a>sorted</h3><p>排序</p><pre class="line-numbers language-java"><code class="language-java">List<span class="token operator">&lt;</span>Integer<span class="token operator">></span> strings <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 排序打印</span>strings<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="Collectors"><a href="#Collectors" class="headerlink" title="Collectors"></a>Collectors</h3><p>归约操作</p><pre class="line-numbers language-java"><code class="language-java">List<span class="token operator">&lt;</span>String<span class="token operator">></span>strings <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"abc"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"bc"</span><span class="token punctuation">,</span> <span class="token string">"efg"</span><span class="token punctuation">,</span> <span class="token string">"abcd"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"jkl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> filtered <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>string <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">!</span>string<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"筛选列表: "</span> <span class="token operator">+</span> filtered<span class="token punctuation">)</span><span class="token punctuation">;</span>String mergedString <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>string <span class="token operator">-</span><span class="token operator">></span> <span class="token operator">!</span>string<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">", "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"合并字符串: "</span> <span class="token operator">+</span> mergedString<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="summaryStatistics"><a href="#summaryStatistics" class="headerlink" title="summaryStatistics"></a>summaryStatistics</h3><p>统计</p><pre class="line-numbers language-java"><code class="language-java">List<span class="token operator">&lt;</span>Integer<span class="token operator">></span> numbers <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>IntSummaryStatistics stats <span class="token operator">=</span> numbers<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mapToInt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> x<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">summaryStatistics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"列表中最大的数 : "</span> <span class="token operator">+</span> stats<span class="token punctuation">.</span><span class="token function">getMax</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"列表中最小的数 : "</span> <span class="token operator">+</span> stats<span class="token punctuation">.</span><span class="token function">getMin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"所有数之和 : "</span> <span class="token operator">+</span> stats<span class="token punctuation">.</span><span class="token function">getSum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"平均数 : "</span> <span class="token operator">+</span> stats<span class="token punctuation">.</span><span class="token function">getAverage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://www.runoob.com/java/java8-streams.html" target="_blank" rel="noopener">参考1</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java8 </tag>
            
            <tag> stream </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flink代码学习笔记</title>
      <link href="/2020/03/16/flink-dai-ma-xue-xi-bi-ji/"/>
      <url>/2020/03/16/flink-dai-ma-xue-xi-bi-ji/</url>
      
        <content type="html"><![CDATA[<h2 id="一些关键字的解释说明"><a href="#一些关键字的解释说明" class="headerlink" title="一些关键字的解释说明"></a>一些关键字的解释说明</h2><h3 id="split-“-s”"><a href="#split-“-s”" class="headerlink" title=".split(“\s”)"></a>.split(“\s”)</h3><p><code>\\s</code>表示空格、回车、换行等空白符<br><code>\\s+</code>表示一个或多个空格、回车、换行等空白符</p><h3 id="split-“-w-”"><a href="#split-“-w-”" class="headerlink" title=".split(“\w+”)"></a>.split(“\w+”)</h3><p>表示匹配数字和字母下划线的多个字符</p><h3 id="tuple元组"><a href="#tuple元组" class="headerlink" title="tuple元组"></a>tuple元组</h3><p><code>tuple</code>是flink中自定义的一种组合类型，类似java中Map&lt;String,String&gt;，只不过Map只有两个字段，相当于<code>Tuple2</code>。</p><p>flink中<code>tuple</code>最多支持25个字段，不支持空字段.</p><blockquote><p>复合类型有：</p><ul><li>Flink Java Tuples(Flink Java API的一部分)：最多25个字段，空字段不支持</li><li>Scala Case classes(包括Scala tuples):最多25个字段，空字段不支持</li><li>Row:具有任意数量字段的元组，并支持空字段</li><li>POJO:遵循某种Bean模式的类</li></ul></blockquote><h4 id="tuple使用"><a href="#tuple使用" class="headerlink" title="tuple使用"></a>tuple使用</h4><p>最简单的情况是在元组的一个或多个字段上对元组进行分组：</p><pre class="line-numbers language-java"><code class="language-java">DataStream<span class="token operator">&lt;</span>Tuple3<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span>String<span class="token punctuation">,</span>Long<span class="token operator">>></span> input <span class="token operator">=</span> <span class="token comment" spellcheck="true">// [...]</span>KeyedStream<span class="token operator">&lt;</span>Tuple3<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span>String<span class="token punctuation">,</span>Long<span class="token operator">></span><span class="token punctuation">,</span>Tuple<span class="token operator">></span> keyed <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>元组在第一个字段（整数类型）上分组。</p><pre class="line-numbers language-java"><code class="language-java">DataStream<span class="token operator">&lt;</span>Tuple3<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span>String<span class="token punctuation">,</span>Long<span class="token operator">>></span> input <span class="token operator">=</span> <span class="token comment" spellcheck="true">// [...]</span>KeyedStream<span class="token operator">&lt;</span>Tuple3<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span>String<span class="token punctuation">,</span>Long<span class="token operator">></span><span class="token punctuation">,</span>Tuple<span class="token operator">></span> keyed <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>在这里，我们将元组分组在由第一个和第二个字段组成的复合键上。</p><p>关于嵌套元组的注释：如果你有一个带有嵌套元组的DataStream，例如：</p><pre class="line-numbers language-java"><code class="language-java">DataStream<span class="token operator">&lt;</span>Tuple3<span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> Float<span class="token operator">></span><span class="token punctuation">,</span>String<span class="token punctuation">,</span>Long<span class="token operator">>></span> ds<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>指定keyBy(0)将导致系统使用full Tuple2作为键（以Integer和Float为键）。</p><p>更多参考<a href="https://flink.sojb.cn/dev/api_concepts.html" target="_blank" rel="noopener">官网</a></p><h3 id="map和flatMap"><a href="#map和flatMap" class="headerlink" title="map和flatMap"></a>map和flatMap</h3><h4 id="map"><a href="#map" class="headerlink" title="map"></a>map</h4><p>把数组流中的每一个值，使用所提供的函数执行一遍，一一对应。得到元素个数相同的数组流。<br><img src="/images/flink6.png" alt="map"></p><p>map算子对一个DataStream中的每个元素使用用户自定义的map函数进行处理，每个输入元素对应一个输出元素，最终整个数据流被转换成一个新的DataStream。输出的数据流DataStream[OUT]类型可能和输入的数据流DataStream[IN]不同。</p><h4 id="flatMap"><a href="#flatMap" class="headerlink" title="flatMap"></a>flatMap</h4><p>flat是扁平的意思。它把数组流中的每一个值，使用所提供的函数执行一遍，一一对应。得到元素相同的数组流。只不过，里面的元素也是一个子数组流。把这些子数组合并成一个数组以后，元素个数大概率会和原数组流的个数不同。<br><img src="/images/flink7.png" alt="flatMap"></p><h3 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h3><p>filter算子对每个元素进行过滤，过滤的过程使用一个filter函数进行逻辑判断。对于输入的每个元素，如果filter函数返回True，则保留，如果返回False，则丢弃。<br><img src="/images/flink12.png" alt="filter"></p><h3 id="keyBy"><a href="#keyBy" class="headerlink" title="keyBy"></a><a href="https://zhuanlan.zhihu.com/p/98975650" target="_blank" rel="noopener">keyBy</a></h3><p>绝大多数情况，我们要根据事件的某种属性或数据的某个字段进行分组，对一个分组内的数据进行处理。如下图所示，keyBy算子根据元素的形状对数据进行分组，相同形状的元素被分到了一起，可被后续算子统一处理。比如，多支股票数据流处理时，可以根据股票代号进行分组，然后对同一股票代号的数据统计其价格变动。又如，电商用户行为日志把所有用户的行为都记录了下来，如果要分析某一个用户行为，需要先按用户ID进行分组。<br><img src="/images/flink10.png" alt="keyby"></p><h3 id="aggregation"><a href="#aggregation" class="headerlink" title="aggregation"></a>aggregation</h3><p>常见的聚合操作有sum、max、min等，这些聚合操作统称为aggregation。aggregation需要一个参数来指定按照哪个字段进行聚合。跟keyBy相似，我们可以使用数字位置来指定对哪个字段进行聚合，也可以使用字段名。</p><p>与批处理不同，这些聚合函数是对流数据进行数据，流数据是依次进入Flink的，聚合操作是对之前流入的数据进行统计聚合。</p><ul><li>max算子对该字段求最大值，并将结果保存在该字段上。对于其他字段，该操作并不能保证其数值。</li><li>maxBy算子对该字段求最大值，maxBy与max的区别在于，maxBy同时保留其他字段的数值，即maxBy可以得到数据流中最大的元素。</li><li>同样，min和minBy的区别在于，min算子对某字段求最小值，minBy返回具有最小值的元素。</li></ul><blockquote><p>其实，这些aggregation操作里已经封装了状态数据，比如，sum算子内部记录了当前的和，max算子内部记录了当前的最大值。由于内部封装了状态数据，而且状态数据并不会被清理，因此一定要避免在一个无限数据流上使用aggregation。</p></blockquote><blockquote><p>注意，对于一个KeyedStream,一次只能使用一个aggregation操作，无法链式使用多个。</p></blockquote><h3 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a>reduce</h3><p>前面几个aggregation是几个较为特殊的操作，对分组数据进行处理更为通用的方法是使用reduce算子。<br><img src="/images/flink11.png" alt="reduce"></p><p>上图展示了reduce算子的原理：reduce在按照同一个Key分组的数据流上生效，它接受两个输入，生成一个输出，即两两合一地进行汇总操作，生成一个同类型的新元素。</p><pre class="line-numbers language-java"><code class="language-java">DataStream<span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">>></span> counts <span class="token operator">=</span>    <span class="token comment" spellcheck="true">// split up the lines in pairs (2-tuples) containing: (word,1)</span>    text<span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Tokenizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// group by the tuple field "0" and sum up tuple field "1"</span>        <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">//ReduceFunction定义了reduce方法，它主要是用来将两个同类型的值操作为一个同类型的值，第一个参数为前面reduce的结果，第二参数为当前的元素</span>        <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReduceFunction</span><span class="token operator">&lt;</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> <span class="token function">reduce</span><span class="token punctuation">(</span>Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> value1<span class="token punctuation">,</span> Tuple2<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Integer<span class="token operator">></span> value2<span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"value1:"</span><span class="token operator">+</span>value1<span class="token punctuation">.</span>f1<span class="token operator">+</span><span class="token string">";value2:"</span><span class="token operator">+</span>value2<span class="token punctuation">.</span>f1<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>value1<span class="token punctuation">.</span>f0<span class="token punctuation">,</span> value1<span class="token punctuation">.</span>f1 <span class="token operator">+</span> value2<span class="token punctuation">.</span>f1<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://zhuanlan.zhihu.com/c_1127896820252299264" target="_blank" rel="noopener">皮皮鲁的AI星球</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> flink </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flink </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flink典型应用场景</title>
      <link href="/2020/03/12/flink-dian-xing-ying-yong-chang-jing/"/>
      <url>/2020/03/12/flink-dian-xing-ying-yong-chang-jing/</url>
      
        <content type="html"><![CDATA[<h2 id="flink应用场景"><a href="#flink应用场景" class="headerlink" title="flink应用场景"></a><a href="https://flink.apache.org/zh/usecases.html" target="_blank" rel="noopener">flink应用场景</a></h2><p>Apache Flink 功能强大，支持开发和运行多种不同种类的应用程序。它的主要特性包括：批流一体化、精密的状态管理、事件时间支持以及精确一次的状态一致性保障等。Flink 不仅可以运行在包括 YARN、 Mesos、Kubernetes 在内的多种资源管理框架上，还支持在裸机集群上独立部署。在启用高可用选项的情况下，它不存在单点失效问题。事实证明，Flink 已经可以扩展到数千核心，其状态可以达到 TB 级别，且仍能保持高吞吐、低延迟的特性。世界各地有很多要求严苛的流处理应用都运行在 Flink 之上。</p><h3 id="事件驱动型应用"><a href="#事件驱动型应用" class="headerlink" title="事件驱动型应用"></a>事件驱动型应用</h3><h4 id="什么是事件驱动型应用？"><a href="#什么是事件驱动型应用？" class="headerlink" title="什么是事件驱动型应用？"></a>什么是事件驱动型应用？</h4><p>事件驱动型应用是一类具有状态的应用，它从一个或多个事件流提取数据，并根据到来的事件触发计算、状态更新或其他外部动作。</p><p>事件驱动型应用是在计算存储分离的传统应用基础上进化而来。在传统架构中，应用需要读写远程事务型数据库。</p><p>相反，事件驱动型应用是基于状态化流处理来完成。在该设计中，数据和计算不会分离，应用只需访问本地（内存或磁盘）即可获取数据。系统容错性的实现依赖于定期向远程持久化存储写入 checkpoint。下图描述了传统应用和事件驱动型应用架构的区别。<br><img src="/images/flink1.png" alt="事件驱动型应用"></p><h4 id="事件驱动型应用的优势？"><a href="#事件驱动型应用的优势？" class="headerlink" title="事件驱动型应用的优势？"></a>事件驱动型应用的优势？</h4><p>事件驱动型应用无须查询远程数据库，本地数据访问使得它具有更高的吞吐和更低的延迟。而由于定期向远程持久化存储的 checkpoint 工作可以异步、增量式完成，因此对于正常事件处理的影响甚微。事件驱动型应用的优势不仅限于本地数据访问。传统分层架构下，通常多个应用会共享同一个数据库，因而任何对数据库自身的更改（例如：由应用更新或服务扩容导致数据布局发生改变）都需要谨慎协调。反观事件驱动型应用，由于只需考虑自身数据，因此在更改数据表示或服务扩容时所需的协调工作将大大减少。</p><h4 id="Flink-如何支持事件驱动型应用？"><a href="#Flink-如何支持事件驱动型应用？" class="headerlink" title="Flink 如何支持事件驱动型应用？"></a>Flink 如何支持事件驱动型应用？</h4><p>事件驱动型应用会受制于底层流处理系统对时间和状态的把控能力，Flink 诸多优秀特质都是围绕这些方面来设计的。它提供了一系列丰富的状态操作原语，允许以精确一次的一致性语义合并海量规模（TB 级别）的状态数据。此外，Flink 还支持事件时间和自由度极高的定制化窗口逻辑，而且它内置的 ProcessFunction 支持细粒度时间控制，方便实现一些高级业务逻辑。同时，Flink 还拥有一个复杂事件处理（CEP）类库，可以用来检测数据流中的模式。</p><p>Flink 中针对事件驱动应用的明星特性当属 savepoint。Savepoint 是一个一致性的状态映像，它可以用来初始化任意状态兼容的应用。在完成一次 savepoint 后，即可放心对应用升级或扩容，还可以启动多个版本的应用来完成 A/B 测试。</p><h4 id="典型的事件驱动型应用实例"><a href="#典型的事件驱动型应用实例" class="headerlink" title="典型的事件驱动型应用实例"></a>典型的事件驱动型应用实例</h4><ul><li>反欺诈</li><li>异常检测</li><li>基于规则的报警</li><li>业务流程监控</li><li>（社交网络）Web 应用</li></ul><h3 id="数据分析应用"><a href="#数据分析应用" class="headerlink" title="数据分析应用"></a>数据分析应用</h3><h4 id="什么是数据分析应用？"><a href="#什么是数据分析应用？" class="headerlink" title="什么是数据分析应用？"></a>什么是数据分析应用？</h4><p>数据分析任务需要从原始数据中提取有价值的信息和指标。传统的分析方式通常是利用批查询，或将事件记录下来并基于此有限数据集构建应用来完成。为了得到最新数据的分析结果，必须先将它们加入分析数据集并重新执行查询或运行应用，随后将结果写入存储系统或生成报告。</p><p>借助一些先进的流处理引擎，还可以实时地进行数据分析。和传统模式下读取有限数据集不同，流式查询或应用会接入实时事件流，并随着事件消费持续产生和更新结果。这些结果数据可能会写入外部数据库系统或以内部状态的形式维护。仪表展示应用可以相应地从外部数据库读取数据或直接查询应用的内部状态。</p><p>如下图所示，Apache Flink 同时支持流式及批量分析应用。<br><img src="/images/flink2.png" alt="数据分析应用"></p><h4 id="流式分析应用的优势？"><a href="#流式分析应用的优势？" class="headerlink" title="流式分析应用的优势？"></a>流式分析应用的优势？</h4><p>和批量分析相比，由于流式分析省掉了周期性的数据导入和查询过程，因此从事件中获取指标的延迟更低。不仅如此，批量查询必须处理那些由定期导入和输入有界性导致的人工数据边界，而流式查询则无须考虑该问题。</p><p>另一方面，流式分析会简化应用抽象。批量查询的流水线通常由多个独立部件组成，需要周期性地调度提取数据和执行查询。如此复杂的流水线操作起来并不容易，一旦某个组件出错将会影响流水线的后续步骤。而流式分析应用整体运行在 Flink 之类的高端流处理系统之上，涵盖了从数据接入到连续结果计算的所有步骤，因此可以依赖底层引擎提供的故障恢复机制。</p><h4 id="Flink-如何支持数据分析类应用？"><a href="#Flink-如何支持数据分析类应用？" class="headerlink" title="Flink 如何支持数据分析类应用？"></a>Flink 如何支持数据分析类应用？</h4><p>Flink 为持续流式分析和批量分析都提供了良好的支持。具体而言，它内置了一个符合 ANSI 标准的 SQL 接口，将批、流查询的语义统一起来。无论是在记录事件的静态数据集上还是实时事件流上，相同 SQL 查询都会得到一致的结果。同时 Flink 还支持丰富的用户自定义函数，允许在 SQL 中执行定制化代码。如果还需进一步定制逻辑，可以利用 Flink DataStream API 和 DataSet API 进行更低层次的控制。此外，Flink 的 Gelly 库为基于批量数据集的大规模高性能图分析提供了算法和构建模块支持。</p><h4 id="典型的数据分析应用实例"><a href="#典型的数据分析应用实例" class="headerlink" title="典型的数据分析应用实例"></a>典型的数据分析应用实例</h4><ul><li>电信网络质量监控</li><li>移动应用中的产品更新及实验评估分析</li><li>消费者技术中的实时数据即席分析</li><li>大规模图分析</li></ul><h3 id="数据管道应用"><a href="#数据管道应用" class="headerlink" title="数据管道应用"></a>数据管道应用</h3><h4 id="什么是数据管道？"><a href="#什么是数据管道？" class="headerlink" title="什么是数据管道？"></a>什么是数据管道？</h4><p>提取-转换-加载（ETL）是一种在存储系统之间进行数据转换和迁移的常用方法。ETL 作业通常会周期性地触发，将数据从事务型数据库拷贝到分析型数据库或数据仓库。</p><p>数据管道和 ETL 作业的用途相似，都可以转换、丰富数据，并将其从某个存储系统移动到另一个。但数据管道是以持续流模式运行，而非周期性触发。因此它支持从一个不断生成数据的源头读取记录，并将它们以低延迟移动到终点。例如：数据管道可以用来监控文件系统目录中的新文件，并将其数据写入事件日志；另一个应用可能会将事件流物化到数据库或增量构建和优化查询索引。</p><p>下图描述了周期性 ETL 作业和持续数据管道的差异。<br><img src="/images/flink3.png" alt="数据管道应用"></p><h4 id="数据管道的优势？"><a href="#数据管道的优势？" class="headerlink" title="数据管道的优势？"></a>数据管道的优势？</h4><p>和周期性 ETL 作业相比，持续数据管道可以明显降低将数据移动到目的端的延迟。此外，由于它能够持续消费和发送数据，因此用途更广，支持用例更多。</p><h4 id="Flink-如何支持数据管道应用？"><a href="#Flink-如何支持数据管道应用？" class="headerlink" title="Flink 如何支持数据管道应用？"></a>Flink 如何支持数据管道应用？</h4><p>很多常见的数据转换和增强操作可以利用 Flink 的 SQL 接口（或 Table API）及用户自定义函数解决。如果数据管道有更高级的需求，可以选择更通用的 DataStream API 来实现。Flink 为多种数据存储系统（如：Kafka、Kinesis、Elasticsearch、JDBC数据库系统等）内置了连接器。同时它还提供了文件系统的连续型数据源及数据汇，可用来监控目录变化和以时间分区的方式写入文件。</p><h4 id="典型的数据管道应用实例"><a href="#典型的数据管道应用实例" class="headerlink" title="典型的数据管道应用实例"></a>典型的数据管道应用实例</h4><ul><li>电子商务中的实时查询索引构建</li><li>电子商务中的持续 ETL</li></ul><h2 id="阿里蒋晓伟谈计算引擎Flink和Spark的对比"><a href="#阿里蒋晓伟谈计算引擎Flink和Spark的对比" class="headerlink" title="阿里蒋晓伟谈计算引擎Flink和Spark的对比"></a><a href="https://www.cnblogs.com/xiaodf/p/11751110.html" target="_blank" rel="noopener">阿里蒋晓伟谈计算引擎Flink和Spark的对比</a></h2><h3 id="相比Spark、Hadoop、Storm等，是什么样的场景需求让阿里搜索团队选择了Flink？"><a href="#相比Spark、Hadoop、Storm等，是什么样的场景需求让阿里搜索团队选择了Flink？" class="headerlink" title="相比Spark、Hadoop、Storm等，是什么样的场景需求让阿里搜索团队选择了Flink？"></a>相比Spark、Hadoop、Storm等，是什么样的场景需求让阿里搜索团队选择了Flink？</h3><p>首先我们希望有个流计算和批处理的一体化处理方案。Spark和Flink都具有流和批处理能力，但是他们的做法是相反的。Spark Streaming是把流转化成一个个小的批来处理，这种方案的一个问题是我们需要的延迟越低，额外开销占的比例就会越大，这导致了Spark Streaming很难做到秒级甚至亚秒级的延迟。Flink是把批当作一种有限的流，这种做法的一个特点是在流和批共享大部分代码的同时还能够保留批处理特有的一系列的优化。因为这个原因，如果要用一套引擎来解决流和批处理，那就必须以流处理为基础，所以我们决定先选择一个优秀的流处理引擎。从功能上流处理可以分为无状态的和有状态两种。在流处理的框架里引入状态管理大大提升了系统的表达能力，让用户能够很方便地实现复杂的处理逻辑，是流处理在功能上的一个飞跃。流处理引擎对一致性的支持可以分为：best effort，at least once 和 exactly once。Exactly once的语义才能真正保证完全的一致性，Flink采用的架构比较优雅地实现了exactly once的有状态流处理。另外在保证了一致性的前提下Flink在性能上也是相当优秀的。</p><p>总结一下:</p><ul><li>我们觉得在流处理方面Flink在功能，延迟，一致性和性能上综合来看是目前社区最优秀的。</li><li>实现流和批的一体化方案。</li><li>Flink有一个比较活跃的社区。</li></ul><h3 id="您认为Flink未来的杀手级应用会是什么？"><a href="#您认为Flink未来的杀手级应用会是什么？" class="headerlink" title="您认为Flink未来的杀手级应用会是什么？"></a>您认为Flink未来的杀手级应用会是什么？</h3><p>…,我觉得Flink在流计算上的优势是非常大的，随着在线学习等流计算需求的增长，在这方面Flink一定会大放异彩。</p><h2 id="企业实践经典案例"><a href="#企业实践经典案例" class="headerlink" title="企业实践经典案例"></a><a href="https://ververica.cn/corporate-practice/" target="_blank" rel="noopener">企业实践经典案例</a></h2><h3 id="日均处理万亿数据！Apache-Flink在快手的应用实践与技术演进之路"><a href="#日均处理万亿数据！Apache-Flink在快手的应用实践与技术演进之路" class="headerlink" title="日均处理万亿数据！Apache Flink在快手的应用实践与技术演进之路"></a><a href="https://ververica.cn/corporate_practice/kuaishou/" target="_blank" rel="noopener">日均处理万亿数据！Apache Flink在快手的应用实践与技术演进之路</a></h3><p><img src="/images/flink4.png" alt="快手"></p><p>快手计算链路是从 DB/Binlog 以及 WebService Log 实时入到 Kafka 中，然后接入 Flink 做实时计算，其中包括实时 ETL、实时分析、Interval Join 以及实时训练，最后的结果存到 Druid、ES 或者 HBase 里面，后面接入一些数据应用产品；同时这一份 Kafka 数据实时 Dump 一份到 Hadoop 集群，然后接入离线计算。</p><h4 id="Flink-在快手应用的类别主要分为三大类："><a href="#Flink-在快手应用的类别主要分为三大类：" class="headerlink" title="Flink 在快手应用的类别主要分为三大类："></a>Flink 在快手应用的类别主要分为三大类：</h4><ul><li>80% 统计监控：实时统计，包括各项数据的指标，监控项报警，用于辅助业务进行实时分析和监控；</li><li>15% 数据处理：对数据的清洗、拆分、Join 等逻辑处理，例如大 Topic 的数据拆分、清洗；</li><li>5% 数据处理：实时业务处理，针对特定业务逻辑的实时处理，例如实时调度。</li></ul><h4 id="Flink-在快手应用的典型场景包括："><a href="#Flink-在快手应用的典型场景包括：" class="headerlink" title="Flink 在快手应用的典型场景包括："></a>Flink 在快手应用的典型场景包括：</h4><ul><li>快手是分享短视频跟直播的平台，快手短视频、直播的质量监控是通过 Flink 进行实时统计，比如直播观众端、主播端的播放量、卡顿率、开播失败率等跟直播质量相关的多种监控指标；</li><li>用户增长分析，实时统计各投放渠道拉新情况，根据效果实时调整各渠道的投放量；</li><li>实时数据处理，广告展现流、点击流实时 Join，客户端日志的拆分等；</li><li>直播 CDN 调度，实时监控各 CDN 厂商质量，通过 Flink 实时训练调整各个 CDN 厂商流量配比。</li></ul><h4 id="规模"><a href="#规模" class="headerlink" title="规模"></a>规模</h4><p>快手目前集群规模有 1500 台左右，作业数量大约是 500 左右，日处理条目数总共有 1.7 万亿，峰值处理条目数大约是 3.7 千万。集群部署都是 On Yarn 模式，分为离线集群和实时集群两类集群，其中离线集群混合部署，机器通过标签进行物理隔离，实时集群是 Flink 专用集群，针对隔离性、稳定性要求极高的业务部署。</p><h4 id="Interval-Join-应用场景"><a href="#Interval-Join-应用场景" class="headerlink" title="Interval Join 应用场景"></a>Interval Join 应用场景</h4><p><img src="/images/flink5.png" alt="快手"></p><p>Interval Join 在快手的一个应用场景是广告展现点击流实时 Join 场景：打开快手 App 可能会收到广告服务推荐的广告视频，用户有时会点击展现的广告视频。这样在后端形成两份数据流，一份是广告展现日志，一份是客户端点击日志。这两份数据需进行实时 Join，将 Join 结果作为样本数据用于模型训练，训练出的模型会被推送到线上的广告服务。</p><p>该场景下展现以后 20 分钟的点击被认为是有效点击，实时 Join 逻辑则是点击数据 Join 过去 20 分钟展现。其中，展现流的数据量相对比较大，20 分钟数据在 1 TB 以上。最初实时 Join 过程是业务自己实现，通过 Redis 缓存广告展现日志，Kafka 延迟消费客户端点击日志实现 Join 逻辑，该方式缺点是实时性不高，并且随着业务增长需要堆积更多机器，运维成本非常高。基于 Flink 使用 Interval Join 完美契合此场景，并且实时性高，能够实时输出 Join 后的结果数据，对业务来说维护成本非常低，只需要维护一个 Flink 作业即可。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> flink </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flink </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flink视频教程学习笔记</title>
      <link href="/2020/03/10/flink-shi-pin-jiao-cheng-xue-xi-bi-ji/"/>
      <url>/2020/03/10/flink-shi-pin-jiao-cheng-xue-xi-bi-ji/</url>
      
        <content type="html"><![CDATA[<h1 id="视频地址"><a href="#视频地址" class="headerlink" title="视频地址"></a>视频地址</h1><p><a href="https://ververica.cn/developers/flink-training-course1/" target="_blank" rel="noopener">视频地址</a></p><h2 id="基础定义"><a href="#基础定义" class="headerlink" title="基础定义"></a>基础定义</h2><h3 id="有界-无界数据流"><a href="#有界-无界数据流" class="headerlink" title="有界/无界数据流"></a>有界/无界数据流</h3><h3 id="有状态计算"><a href="#有状态计算" class="headerlink" title="有状态计算"></a>有状态计算</h3><blockquote><p>例如：过去一段时间的点击量<br><strong>状态可持久化</strong></p></blockquote><h3 id="时间官网"><a href="#时间官网" class="headerlink" title="时间官网"></a>时间<a href="https://flink.apache.org/zh/flink-applications.html" target="_blank" rel="noopener">官网</a></h3><ul><li>事件发生时间</li><li>事件进入flink时间</li><li>flink处理事件时间</li></ul><h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><p>3层API</p><h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><ul><li>Data Pipeline</li><li>Data Analytics</li><li>Data Driven</li></ul><h1 id="flink-maven构建项目命令"><a href="#flink-maven构建项目命令" class="headerlink" title="flink - maven构建项目命令"></a>flink - maven构建项目命令</h1><pre><code>mvn archetype:generate -DarchetypeGroupId=org.apache.flink -DarchetypeArtifactId=flink-quickstart-java -DarchetypeVersion=1.10.0</code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> flink </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flink </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kafka单机版部署</title>
      <link href="/2020/03/03/kafka-dan-ji-ban-bu-shu/"/>
      <url>/2020/03/03/kafka-dan-ji-ban-bu-shu/</url>
      
        <content type="html"><![CDATA[<h1 id="下载kafka"><a href="#下载kafka" class="headerlink" title="下载kafka"></a>下载kafka</h1><p>在官网<a href="https://kafka.apache.org/downloads" target="_blank" rel="noopener">下载</a>kafka最新版本。</p><p>如：当前最新<code>2.4.0</code>，针对Scala不同版本有不同的编译包，下载<code>Scala 2.12</code>的测试。</p><pre><code>wget http://mirrors.tuna.tsinghua.edu.cn/apache/kafka/2.4.0/kafka_2.12-2.4.0.tgz</code></pre><pre class="line-numbers language-sh"><code class="language-sh"># 解压tar -xzf kafka_2.12-2.4.0.tgz#进入目录cd kafka_2.12-2.4.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h1><h2 id="启动zookeeper"><a href="#启动zookeeper" class="headerlink" title="启动zookeeper"></a>启动zookeeper</h2><pre><code>bin/zookeeper-server-start.sh config/zookeeper.properties</code></pre><h2 id="启动kafka"><a href="#启动kafka" class="headerlink" title="启动kafka"></a>启动kafka</h2><pre><code>bin/kafka-server-start.sh config/server.properties</code></pre><blockquote><p>如果需要放到后台运行，可以加上<code>&amp;</code>或者 <code>nohup</code>命令.<br><code>nohup bin/zookeeper-server-start.sh config/zookeeper.properties &amp;</code></p></blockquote><h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><h2 id="创建主题"><a href="#创建主题" class="headerlink" title="创建主题"></a>创建主题</h2><pre><code>bin/kafka-topics.sh --create --bootstrap-server localhost:9092 --replication-factor 1 --partitions 1 --topic test</code></pre><h2 id="查看主题列表"><a href="#查看主题列表" class="headerlink" title="查看主题列表"></a>查看主题列表</h2><pre><code>bin/kafka-topics.sh --list --bootstrap-server localhost:9092</code></pre><h2 id="向主题发送消息"><a href="#向主题发送消息" class="headerlink" title="向主题发送消息"></a>向主题发送消息</h2><pre><code>bin/kafka-console-producer.sh --broker-list localhost:9092 --topic test</code></pre><h2 id="从主题消费消息"><a href="#从主题消费消息" class="headerlink" title="从主题消费消息"></a>从主题消费消息</h2><pre><code>bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic test --from-beginning</code></pre><h1 id="搭建kafka集群"><a href="#搭建kafka集群" class="headerlink" title="搭建kafka集群"></a>搭建kafka集群</h1><p>参考<a href="https://kafka.apache.org/quickstart" target="_blank" rel="noopener">官网</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kafka </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zookeeper单机版部署</title>
      <link href="/2020/03/03/zookeeper-dan-ji-ban-bu-shu/"/>
      <url>/2020/03/03/zookeeper-dan-ji-ban-bu-shu/</url>
      
        <content type="html"><![CDATA[<h1 id="下载压缩包"><a href="#下载压缩包" class="headerlink" title="下载压缩包"></a>下载压缩包</h1><pre class="line-numbers language-sh"><code class="language-sh">wget http://mirror.bit.edu.cn/apache/zookeeper/zookeeper-3.5.7/apache-zookeeper-3.5.7-bin.tar.gztar -zxvf apache-zookeeper-3.5.7-bin.tar.gz cd apache-zookeeper-3.5.7-bin/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>注意：<code>zookeeper</code>从<code>3.5.5</code>版本开始，需要下载<code>*-bin.tar.gz</code>的包才能运行，否则启动会报错，缺少类。</p></blockquote><h1 id="拷贝zoo-cfg"><a href="#拷贝zoo-cfg" class="headerlink" title="拷贝zoo.cfg"></a>拷贝zoo.cfg</h1><p>用默认配置即可</p><pre><code>cp conf/zoo_sample.cfg conf/zoo.cfg</code></pre><h1 id="启动-amp-检查"><a href="#启动-amp-检查" class="headerlink" title="启动&amp;检查"></a>启动&amp;检查</h1><p>启动</p><pre><code>./bin/zkServer.sh start</code></pre><p>检查</p><pre><code>./bin/zkServer.sh status</code></pre><p>停止</p><pre><code>./bin/zkServer.sh stop</code></pre><p>重启</p><pre><code>./bin/zkServer.sh restart</code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>国内提升github访问速度</title>
      <link href="/2020/03/03/guo-nei-ti-sheng-github-fang-wen-su-du/"/>
      <url>/2020/03/03/guo-nei-ti-sheng-github-fang-wen-su-du/</url>
      
        <content type="html"><![CDATA[<h1 id="修改hosts文件"><a href="#修改hosts文件" class="headerlink" title="修改hosts文件"></a>修改hosts文件</h1><pre><code>151.101.72.133 assets-cdn.github.com151.101.73.194 github.global.ssl.fastly.net192.30.253.113 github.com11.238.159.92 git.node5.mirror.et2sqa</code></pre><blockquote><p>如果使用<code>Windows</code>系统，则是配置在<code>C:\Windows\System32\drivers\etc\hosts</code>文件中。<br>如果使用<code>Linux</code>系统，则是配置在的<code>/etc/hosts</code>文件中。</p></blockquote><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> github </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>centos卸载openjdk，并安装jdk</title>
      <link href="/2020/02/28/centos-xie-zai-openjdk-bing-an-zhuang-jdk/"/>
      <url>/2020/02/28/centos-xie-zai-openjdk-bing-an-zhuang-jdk/</url>
      
        <content type="html"><![CDATA[<h1 id="查找本机安装的openjdk"><a href="#查找本机安装的openjdk" class="headerlink" title="查找本机安装的openjdk"></a>查找本机安装的openjdk</h1><pre class="line-numbers language-sh"><code class="language-sh">rpm -qa | grep javapython-javapackages-3.4.1-11.el7.noarchjava-1.8.0-openjdk-1.8.0.181-7.b13.el7.x86_64java-1.8.0-openjdk-headless-1.8.0.181-7.b13.el7.x86_64tzdata-java-2018e-3.el7.noarchjavapackages-tools-3.4.1-11.el7.noarch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h1 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h1><p>依次使用命令<code>rpm -e --nodeps</code>卸载</p><pre><code>rpm -e --nodeps java-1.8.0-openjdk-1.8.0.181-7.b13.el7.x86_64</code></pre><h1 id="安装jdk1-8"><a href="#安装jdk1-8" class="headerlink" title="安装jdk1.8"></a>安装jdk1.8</h1><pre><code>#进入到安装目录cd /usr/local/tar -zxvf jdk-8u112-linux-x64.tar.gz</code></pre><pre><code>vim /etc/profile</code></pre><p>文件末尾增加</p><pre><code>#java_homeexport JAVA_HOME=/usr/local/bin/jdk1.8.0_112export PATH=$PATH:$JAVA_HOME/bin</code></pre><p>测试</p><pre class="line-numbers language-sh"><code class="language-sh">[root@node1 jdk1.8.0_112]# java -versionjava version "1.8.0_112"Java(TM) SE Runtime Environment (build 1.8.0_112-b15)Java HotSpot(TM) 64-Bit Server VM (build 25.112-b15, mixed mode)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> openjdk </tag>
            
            <tag> jdk </tag>
            
            <tag> centos </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redis总结</title>
      <link href="/2020/02/28/redis-zong-jie/"/>
      <url>/2020/02/28/redis-zong-jie/</url>
      
        <content type="html"><![CDATA[<h1 id="redis高可用"><a href="#redis高可用" class="headerlink" title="redis高可用"></a>redis高可用</h1><h2 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h2><p><img src="/images/redis1.png" alt="主从复制"></p><ul><li>一个master可以拥有多个slave，一个slave又可以拥有多个slave，如此下去，形成了强大的多级服务器集群架构</li><li>master用来写数据，slave用来读数据，经统计：网站的读写比率是10:1</li><li>通过主从配置可以实现读写分离</li><li>master和slave都是一个redis实例(redis服务)</li></ul><h3 id="全量同步过程"><a href="#全量同步过程" class="headerlink" title="全量同步过程"></a>全量同步过程</h3><p><img src="/images/redis2.png" alt="主从复制"></p><ol><li>当一个从数据库启动时，会向主数据库发送sync命令</li><li>主数据库接收到sync命令后会开始在后台保存快照（执行rdb操作），并用缓存区记录后续的所有写操作</li><li>当主服务器快照保存完成后，redis会将快照文件发送给从数据库。</li><li>从数据库收到快照文件后，会丢弃所有旧数据，载入收到的快照。</li><li>主服务器快照发送完毕后开始向从服务器发送缓冲区中的写命令。</li><li>从服务器完成对快照的载入，开始接收命令请求，并执行来自主服务器缓冲区的写命令。</li></ol><h3 id="增量同步的过程"><a href="#增量同步的过程" class="headerlink" title="增量同步的过程"></a>增量同步的过程</h3><p>Redis增量复制是指slave初始化后开始正常工作时主服务器发生的写操作同步到从服务器的过程。 </p><p>增量复制的过程主要是主服务器每执行一个写命令就会向从服务器发送相同的写命令，从服务器接收并执行收到的写命令。</p><h3 id="Redis主从复制全量与增量同步的选择"><a href="#Redis主从复制全量与增量同步的选择" class="headerlink" title="Redis主从复制全量与增量同步的选择"></a>Redis主从复制全量与增量同步的选择</h3><p>主从服务器刚刚连接的时候，会先进行全量同步；全同步结束后，再进行增量同步。当然，如果有需要，slave 在任何时候都可以发起全量同步。redis 策略是，无论如何，首先会尝试进行增量同步，如不成功，要求从机进行全量同步。</p><h3 id="主从复制优缺点："><a href="#主从复制优缺点：" class="headerlink" title="主从复制优缺点："></a>主从复制优缺点：</h3><p><strong>优点：</strong></p><ul><li>支持主从复制，主机会自动将数据同步到从机，可以进行读写分离</li><li>为了分载Master的读操作压力，Slave服务器可以为客户端提供只读操作的服务，写服务仍然必须由Master来完成</li><li>Slave同样可以接受其它Slaves的连接和同步请求，这样可以有效的分载Master的同步压力。</li><li>Master Server是以非阻塞的方式为Slaves提供服务。所以在Master-Slave同步期间，客户端仍然可以提交查询或修改请求。</li><li>Slave Server同样是以非阻塞的方式完成数据同步。在同步期间，如果有客户端提交查询请求，Redis则返回同步之前的数据</li></ul><p><strong>缺点：</strong></p><ul><li>Redis不具备自动容错和恢复功能，主机从机的宕机都会导致前端部分读写请求失败，需要等待机器重启或者手动切换前端的IP才能恢复。</li><li>主机宕机，宕机前有部分数据未能及时同步到从机，切换IP后还会引入数据不一致的问题，降低了系统的可用性。</li><li>Redis较难支持在线扩容，在集群容量达到上限时在线扩容会变得很复杂。</li></ul><h2 id="哨兵模式（Redis-Sentinel）"><a href="#哨兵模式（Redis-Sentinel）" class="headerlink" title="哨兵模式（Redis Sentinel）"></a>哨兵模式（Redis Sentinel）</h2><p><img src="/images/redis3.png" alt="哨兵模式"></p><h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><p>Sentinel 的主要功能包括 主节点存活检测、主从运行情况检测、自动故障转移 （failover）、主从切换。Redis 的 Sentinel 最小配置是 一主一从。<br>Redis 的 Sentinel 系统可以用来管理多个 Redis 服务器，该系统可以执行以下四个任务：</p><ul><li><p>监控</p><blockquote><p>Sentinel 会不断的检查 主服务器 和 从服务器 是否正常运行。</p></blockquote></li><li><p>通知</p><blockquote><p>当被监控的某个 Redis 服务器出现问题，Sentinel 通过 API 脚本 向 管理员 或者其他的 应用程序 发送通知。</p></blockquote></li></ul><p>-自动故障转移</p><blockquote><p>当 主节点 不能正常工作时，Sentinel 会开始一次 自动的 故障转移操作，它会将与 失效主节点 是 主从关系 的其中一个 从节点 升级为新的 主节点，并且将其他的 从节点 指向 新的主节点。</p></blockquote><ul><li>配置提供者<blockquote><p>在 Redis Sentinel 模式下，客户端应用 在初始化时连接的是 Sentinel 节点集合，从中获取 主节点 的信息。</p></blockquote></li></ul><h3 id="主观下线和客观下线"><a href="#主观下线和客观下线" class="headerlink" title="主观下线和客观下线"></a>主观下线和客观下线</h3><p>默认情况下，每个 Sentinel 节点会以 每秒一次 的频率对 Redis 节点和 其它 的 Sentinel 节点发送 PING 命令，并通过节点的 回复 来判断节点是否在线。</p><h4 id="主观下线"><a href="#主观下线" class="headerlink" title="主观下线"></a>主观下线</h4><p>主观下线 适用于所有 主节点 和 从节点。如果在 down-after-milliseconds 毫秒内，Sentinel 没有收到 目标节点 的有效回复，则会判定 该节点 为 主观下线。</p><h4 id="客观下线"><a href="#客观下线" class="headerlink" title="客观下线"></a>客观下线</h4><p>客观下线 只适用于 主节点。如果 主节点 出现故障，Sentinel 节点会通过 sentinel is-master-down-by-addr 命令，向其它 Sentinel 节点询问对该节点的 状态判断。如果超过 <quorum> 个数的节点判定 主节点 不可达，则该 Sentinel 节点会判断 主节点 为 客观下线。</quorum></p><p><a href="https://juejin.im/post/5b7d226a6fb9a01a1e01ff64" target="_blank" rel="noopener">更多参考</a></p><h3 id="哨兵模式的优缺点"><a href="#哨兵模式的优缺点" class="headerlink" title="哨兵模式的优缺点"></a>哨兵模式的优缺点</h3><p><strong>优点</strong></p><ul><li>哨兵模式是基于主从模式的，所有主从的优点，哨兵模式都具有。</li><li>主从可以自动切换，系统更健壮，可用性更高。</li></ul><p><strong>缺点</strong></p><ul><li>Redis较难支持在线扩容，在集群容量达到上限时在线扩容会变得很复杂。</li></ul><h2 id="集群模式"><a href="#集群模式" class="headerlink" title="集群模式"></a>集群模式</h2><p>在 <code>Redis 3.0</code> 之前，使用 哨兵（<code>sentinel</code>）机制来监控各个节点之间的状态。Redis Cluster 是 Redis 的 分布式解决方案，在 3.0 版本正式推出，有效地解决了 Redis 在 分布式 方面的需求。当遇到 单机内存、并发、流量 等瓶颈时，可以采用 Cluster 架构方案达到 负载均衡 的目的。</p><h3 id="数据分区"><a href="#数据分区" class="headerlink" title="数据分区"></a>数据分区</h3><p><img src="/images/redis4.png" alt="虚拟槽分区"></p><p>redis集群中数据是和槽（slot）挂钩的，其总共定义了16384个槽，所有的数据根据一致哈希算法会被映射到这16384个槽中的某个槽中；</p><p>另一方面，这16384个槽是按照设置被分配到不同的redis节点上的，比如启动了三个redis实例：cluster-A，cluster-B和cluster-C，这里将0-5460号槽分配给cluster-A，将5461-10922号槽分配给cluster-B，将10923-16383号槽分配给cluster-C（总共有16384个槽，但是其标号类似数组下标，是从0到16383）。也就是说数据的存储只和槽有关，并且槽的数量是一定的，由于一致hash算法是一定的，因而将这16384个槽分配给无论多少个redis实例，对于确认的数据其都将被分配到确定的槽位上。redis集群通过这种方式来达到redis的高效和高可用性目的。</p><p><a href="https://juejin.im/post/5b8fc5536fb9a05d2d01fb11#heading-4" target="_blank" rel="noopener">更多参考</a></p><h3 id="Redis虚拟槽分区的特点"><a href="#Redis虚拟槽分区的特点" class="headerlink" title="Redis虚拟槽分区的特点"></a>Redis虚拟槽分区的特点</h3><ul><li>解耦数据和节点之间的关系，简化了节点扩容和收缩难度。</li><li>节点自身维护槽的映射关系，不需要客户端或者代理服务维护槽分区元数据。</li><li>支持节点、槽、键 之间的映射查询，用于数据路由、在线伸缩等场景</li></ul><h3 id="Redis集群的功能限制"><a href="#Redis集群的功能限制" class="headerlink" title="Redis集群的功能限制"></a>Redis集群的功能限制</h3><p>Redis 集群相对单机在功能上存在一些限制。</p><ul><li><p>key批量操作支持有限。</p><blockquote><p>类似mset、mget操作，目前只支持对具有相同slot值的key执行 批量操作。对于映射为不同slot值的key由于执行mget、mget等操作可能存在于多个节点上，因此不被支持。</p></blockquote></li><li><p>key事务操作支持有限。</p><blockquote><p>只支持多key在同一节点上的事务操作，当多个key分布在不同的节点上时无法使用事务功能。</p></blockquote></li><li><p>key作为数据分区的最小粒度</p><blockquote><p>不能将一个大的键值对象如hash、list等映射到不同的节点。</p></blockquote></li><li><p>不支持多数据库空间</p><blockquote><p>单机下的<code>Redis</code>可以支持<code>16</code>个数据库（db0 ~ db15），集群模式 下只能使用一个数据库空间，即<code>db0</code>。</p></blockquote></li><li><p>复制结构只支持一层</p><blockquote><p>从节点只能复制主节点，不支持<code>嵌套树状复制</code>结构。</p></blockquote></li></ul><h1 id="redis常见问题"><a href="#redis常见问题" class="headerlink" title="redis常见问题"></a>redis常见问题</h1><h2 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h2><p>缓存雪崩我们可以简单的理解为：由于原有缓存失效，新缓存未到期间(例如：我们设置缓存时采用了相同的过期时间，在同一时刻出现大面积的缓存过期)，所有原本应该访问缓存的请求都去查询数据库了，而对数据库CPU和内存造成巨大压力，严重的会造成数据库宕机。从而形成一系列连锁反应，造成整个系统崩溃。</p><p>解决方案：</p><ul><li>排队加锁</li><li>缓存增加标记，过期前就更新</li><li>缓存时间增加随机属性，错开同一时间过期</li></ul><h2 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h2><p>缓存穿透是指用户查询数据，在数据库没有，自然在缓存中也不会有。这样就导致用户查询的时候，在缓存中找不到，每次都要去数据库再查询一遍，然后返回空（相当于进行了两次无用的查询）。这样请求就绕过缓存直接查数据库，这也是经常提的缓存命中率问题。</p><p>解决方案：</p><ul><li>采用布隆过滤器，将所有可能存在的数据哈希到一个足够大的bitmap中，一个一定不存在的数据会被这个bitmap拦截掉，从而避免了对底层存储系统的查询压力。</li><li>如果一个查询返回的数据为空（不管是数据不存在，还是系统故障），我们仍然把这个空结果进行缓存，但它的过期时间会很短，最长不超过五分钟。通过这个直接设置的默认值存放到缓存，这样第二次到缓存中获取就有值了，而不会继续访问数据库，这种办法最简单粗暴！</li></ul><h2 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h2><p>对于一些设置了过期时间的key，如果这些key可能会在某些时间点被超高并发地访问，是一种非常“热点”的数据。这个时候，需要考虑一个问题：缓存被“击穿”的问题，这个和缓存雪崩的区别在于这里针对某一key缓存，前者则是很多key。</p><p>缓存在某个时间点过期的时候，恰好在这个时间点对这个Key有大量的并发请求过来，这些请求发现缓存过期一般都会从后端DB加载数据并回设到缓存，这个时候大并发的请求可能会瞬间把后端DB压垮。</p><p>解决方案：</p><ul><li>使用互斥锁(mutex key)</li><li>“设置永不过期”，<a href="https://blog.csdn.net/zeb_perfect/article/details/54135506" target="_blank" rel="noopener">参考</a></li></ul><h2 id="缓存预热"><a href="#缓存预热" class="headerlink" title="缓存预热"></a>缓存预热</h2><p>缓存预热就是系统上线后，提前将相关的缓存数据直接加载到缓存系统。避免在用户请求的时候，先查询数据库，然后再将数据缓存的问题！用户直接查询事先被预热的缓存数据！</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>流式计算</title>
      <link href="/2020/02/27/liu-shi-ji-suan/"/>
      <url>/2020/02/27/liu-shi-ji-suan/</url>
      
        <content type="html"><![CDATA[<h1 id="什么是流式计算"><a href="#什么是流式计算" class="headerlink" title="什么是流式计算"></a>什么是流式计算</h1><p>流式计算一般被用来和批量计算做比较。批量计算往往有一个固定的数据集作为输入并计算结果。而流式计算的输入往往是“无界”的（Unbounded Data），持续输入的，即永远拿不到全量数据去做计算；同时，计算结果也是持续输出的，只能拿到某一个时刻的结果，而不是最终的结果。（批量计算是全量的：拿到一批数据，计算一个结果；流式计算是增量的：数据持续输入，持续计算最新的结果）</p><h1 id="流式计算框架"><a href="#流式计算框架" class="headerlink" title="流式计算框架"></a>流式计算框架</h1><table><thead><tr><th></th><th>Storm</th><th>Trident</th><th>Spark Streaming</th><th>Flink</th><th>Samza</th><th>Kafka streams</th></tr></thead><tbody><tr><td>数据流模型</td><td>原生</td><td>微批</td><td>微批</td><td>原生</td><td>原生</td><td>原生</td></tr><tr><td>状态存储</td><td>不支持状态管理</td><td>本地存储，外部数据库</td><td>多种状态存储方式</td><td>多种状态存储方式</td><td>本地存储，Kafka主题</td><td>本地存储，日志变更主题</td></tr><tr><td>时延</td><td>低</td><td>高</td><td>高</td><td>低</td><td>低</td><td>低</td></tr><tr><td>吞吐量</td><td>低</td><td>高</td><td>高</td><td>高</td><td>高</td><td>高</td></tr><tr><td>保障机制</td><td>at-least-once</td><td>exactly-once</td><td>exactly-once</td><td>exactly-once</td><td>at-least-once</td><td>exactly-once</td></tr><tr><td>容错机制</td><td>record ack</td><td>record ack</td><td>RDD based，checkpoint</td><td>checkpoint</td><td>Kafka log-base</td><td>Kafka log</td></tr><tr><td>成熟度</td><td>较多不足，但实际应用比较广泛</td><td>Storm基础上改进</td><td>流行的框架之一，Spark大环境</td><td>较新的流处理框架，性能非常优秀</td><td>基于Kafka作为数据源</td><td>完全基于Kafka集群实现</td></tr><tr><td>定位</td><td>框架</td><td>框架</td><td>框架</td><td>框架</td><td>框架</td><td>类库</td></tr></tbody></table><h1 id="Kafka-Streams"><a href="#Kafka-Streams" class="headerlink" title="Kafka Streams"></a>Kafka Streams</h1><blockquote><p>Kafka Streams is a client library for building applications and microservices, where the input and output data are stored in Kafka clusters. It combines the simplicity of writing and deploying standard Java and Scala applications on the client side with the benefits of Kafka’s server-side cluster technology.</p></blockquote><p>Kafka Streams是一个构建应用程序和微服务的<strong>客户端库</strong>，并且输入数据个输出数据均是保存在Kafka集群上的。Kafka Streams主要有如下特点：</p><ul><li>非常简单的客户端库，可以非常容易的嵌入到任何java应用程序与任何应用程序进行封装集成。</li><li>使用Kafka集群作为消息层，没有外部依赖。</li><li>支持本地状态存储。</li><li>提供了快速故障切换分布式处理和容错能力。</li><li>提供了非常方便的API。</li><li>支持<code>exactly-once</code>语义</li><li>支持纪录级的处理，实现毫秒级的延迟</li><li>提供High-Level的Stream DSL和Low-Level的Processor API</li></ul><p>采用<code>one-record-at-a-time</code>的消息处理方式，实现消息处理的低延迟。<br>但是Kafka Streams的设计目标是足够轻量，所以很难满足对大体量的复杂计算需求，并且数据的输入和输出均是依靠Kafka集群，对于其他的数据源需要借助Kafka connect将数据输入到Kafka主题中，然后在通过Kafka Streams程序进行处理，并通过Kafka connect将主题中的数据转存到其他数据源。</p><p>所以Kafka Streams更适合计算复杂度较小，数据流动过程是<code>Kafka-&gt;Kafka</code>的场景。</p><h1 id="Storm"><a href="#Storm" class="headerlink" title="Storm"></a>Storm</h1><p>在Storm中，需要先设计一个实时计算结构，我们称之为拓扑（topology）。之后，这个拓扑结构会被提交给集群，其中主节点（master node）负责给工作节点（worker node）分配代码，工作节点负责执行代码。在一个拓扑结构中，包含spout和bolt两种角色。数据在spouts之间传递，这些spouts将数据流以tuple元组的形式发送；而bolt则负责转换数据流。</p><ul><li>状态管理：无状态，需用户自行进行状态管理</li><li>窗口支持：对事件窗口支持较弱，缓存整个窗口的所有数据，窗口结束时一起计算</li><li>消息投递：At Most Once/At Least Once</li><li>容错方式：对每个消息进行全链路跟踪，失败或超时进行重发。</li></ul><h1 id="Spark-Streaming"><a href="#Spark-Streaming" class="headerlink" title="Spark Streaming"></a>Spark Streaming</h1><p>采用微批的方式，提高了吞吐性能。Spark streaming批量读取数据源中的数据，然后把每个batch转化成内部的RDD。Spark streaming以batch为单位进行计算，而不是以record为单位，大大减少了ack所需的开销，显著满足了高吞吐、低延迟的要求，同时也提供exactly once功能。但也因为处理数据的粒度变大，导致Spark streaming的数据延时不如Storm，Spark streaming是秒级返回结果（与设置的batch间隔有关），Storm则是毫秒级。</p><p>但是Spark Streaming的优点是可以与Spark大环境进行有效的结合。</p><h1 id="Flink"><a href="#Flink" class="headerlink" title="Flink"></a>Flink</h1><p>Flink 是一种可以处理批处理任务的流处理框架。Flink 流处理为先的方法可提供低延迟，高吞吐率，近乎逐项处理的能力，并且提供了复杂计算的能力。</p><p>Flink 完全支持流处理，也就是说作为流处理看待时，输入数据流是无界的；批处理被作为一种特殊的流处理，只是它的输入数据流被定义为有界的。这与 Spark streaming 不同，Spark streaming 是将流处理视为无限个有界的批处理（microbatch）。</p><ul><li>有状态计算的 Exactly-once 语义。状态是指 flink 能够维护数据在时序上的聚类和聚合，同时它的 checkpoint 机制可以方便快速的做出失败重试； </li><li>支持带有事件时间（event time）语义的流处理和窗口处理。事件时间的语义使流计算的结果更加精确，尤其在事件到达无序或者延迟的情况下； </li><li>支持高度灵活的窗口（window）操作。支持基于 time、count、session，以及 data-driven 的窗口操作，能很好的对现实环境中的创建的数据进行建模；</li><li>轻量的容错处理（fault tolerance）。它使得系统既能保持高的吞吐率又能保证 exactly-once 的一致性。通过轻量的 state snapshots 实现；</li><li>支持高吞吐、低延迟、高性能的流处理；</li><li>支持 savepoints 机制（一般手动触发），可以将应用的运行状态保存下来；在升级应用或者处理历史数据上，能够做到无状态丢失和最小停机时间；</li><li>支持大规模的集群模式，支持 yarn、Mesos。可运行在成千上万的节点上；</li><li>支持具有 Backpressure 功能的持续流模型； </li><li>Flink 在 JVM 内部实现了自己的内存管理，包括完善的内存架构和 OOM error prevention；</li><li>支持迭代计算；</li><li>支持程序自动优化：避免特定情况下 Shuffle、排序等昂贵操作，中间结果进行缓存。</li></ul><h1 id="说明一"><a href="#说明一" class="headerlink" title="说明一"></a>说明一</h1><p>通常来说，对于单独的消息系统而言，语义分为如下三种：</p><p><strong>至多一次（At most once）</strong>：不管 Writer 在等待 ACK 时是否发生超时或者得到错误异常，Writer 都不会重新发送 Event，因此会有数据丢失的风险。在具体的实现过程中，这一种语义无需做任何额外的控制，实现起来最为简单，因此也通常有着最优的性能。在某些特定的场景中，我们只希望追求极致的性能而不关心数据的丢失，可能会选用此方案。</p><p><strong>至少一次（At least once）</strong>：如果 Writer 在等待 ACK 时发生超时或者得到错误异常，Writer 将会重新发送消息，这样能保证每个 Event 至少被处理一次，保证了数据不会丢失，从而提高了系统的可靠性，但同时会带来数据重复的问题，例如，当 Writer 往 Stream 中成功写入一个 Event，但是当系统尝试给 Writer 返回 ACK 的时候出现网络异常，Writer 因没有收到 ACK 而判断为写入 Event 失败，因此 Writer 还是会重新发送此 Event，导致数据重复。</p><p><strong>仅一次（Exactly once）</strong>：在系统发生异常时，Writer 可以尝试多次重新发送 Event，同时能保证最终每个 Event 只被写入一次。一些对数据准确性要求非常高的系统需要保证 exactly-once 语义，譬如支付系统，当用户在移动端付款时，很有可能会因为网络原因导致延时较长甚至超时，用户可能会手动进行刷新操作，如果没有 exactly-once 的语义支持，很有可能会发生两次扣费，我们绝对不希望此类错误发生。</p><h1 id="说明二"><a href="#说明二" class="headerlink" title="说明二"></a>说明二</h1><p><a href="https://tech.meituan.com/2017/11/17/flink-benchmark.html" target="_blank" rel="noopener">美团flink测试</a></p><p><strong>测试结论</strong></p><p>推荐使用 Flink 的场景</p><ul><li>实时计算场景建议考虑使用 Flink 框架进行计算：</li><li>要求消息投递语义为 Exactly Once 的场景；</li><li>数据量较大，要求高吞吐低延迟的场景； </li><li>需要进行状态管理或窗口统计的场景。</li></ul><h1 id="说明三-语言支持"><a href="#说明三-语言支持" class="headerlink" title="说明三 - 语言支持"></a>说明三 - 语言支持</h1><p>Spark和flink都是JVM语言开发，在API层对java和Scala语言支持较好，python语言API支持，但是效率不高，其它语言几乎不支持。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> flink </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 流式计算 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Serverless简介</title>
      <link href="/2020/02/27/serverless-jian-jie/"/>
      <url>/2020/02/27/serverless-jian-jie/</url>
      
        <content type="html"><![CDATA[<h1 id="什么是serverless？"><a href="#什么是serverless？" class="headerlink" title="什么是serverless？"></a>什么是serverless？</h1><h2 id="简单的定义"><a href="#简单的定义" class="headerlink" title="简单的定义"></a>简单的定义</h2><p>Serverless（无服务器架构）指的是服务端逻辑由开发者实现，运行在无状态的计算容器中，由事件触发，完全被第三方管理，而业务层面的状态则记录在数据库或存储资源中。</p><h2 id="进阶的定义"><a href="#进阶的定义" class="headerlink" title="进阶的定义"></a>进阶的定义</h2><p>Serverless是由事件（event）驱动（例如 HTTP、pub/sub）的全托管计算服务。用户无需管理服务器等基础设施，只需编写代码和选择触发器（trigger)，比如 RPC 请求、定时器等并上传，其余的工作（如实例选择、扩缩容、部署、容灾、监控、日志、安全补丁等）全部由 serverless 系统托管。用户只需要为代码实际运行消耗的资源付费——代码未运行则不产生费用。</p><h2 id="对比serverful"><a href="#对比serverful" class="headerlink" title="对比serverful"></a>对比serverful</h2><p>Serverless 相对于 serverful，对业务用户强调 noserver（serverless 并不是说没有服务器，只是业务人员无需关注服务器了，代码仍然是运行在真实存在的服务器上）的运维理念，业务人员只需要聚焦业务逻辑代码。</p><p>Serverless 相比 serverful，有以下 3 个改变（来自 Berkeley 的总结）：</p><ul><li>弱化了存储和计算之间的联系。服务的储存和计算被分开部署和收费，存储不再是服务本身的一部分，而是演变成了独立的云服务，这使得计算变得无状态化，更容易调度和扩缩容，同时也降低了数据丢失的风险。</li><li>代码的执行不再需要手动分配资源。不需要为服务的运行指定需要的资源（比如使用几台机器、多大的带宽、多大的磁盘等），只需要提供一份代码，剩下的交由 serverless 平台去处理就行了。当前阶段的实现平台分配资源时还需要用户方提供一些策略，例如单个实例的规格和最大并发数，单实例的最大 CPU 使用率。理想的情况是通过某些学习算法来进行完全自动的自适应分配。</li><li>按使用量计费。Serverless按照服务的使用量（调用次数、时长等）计费，而不是像传统的 serverful 服务那样，按照使用的资源（ECS 实例、VM 的规格等）计费。</li></ul><h1 id="serverless分类"><a href="#serverless分类" class="headerlink" title="serverless分类"></a>serverless分类</h1><p>Serverless 不如 IaaS 和 PaaS 那么好理解，因为它通常包含了两个领域 BaaS（Backend as a Service）和 FaaS（Function as a Service）。</p><h2 id="BaaS"><a href="#BaaS" class="headerlink" title="BaaS"></a>BaaS</h2><p>BaaS（Backend as a Service）后端即服务，一般是一个个的 API 调用后端或别人已经实现好的程序逻辑，比如身份验证服务 Auth0，这些 BaaS 通常会用来管理数据，还有很多公有云上提供的我们常用的开源软件的商用服务，比如亚马逊的 RDS 可以替代我们自己部署的 MySQL，还有各种其它数据库和存储服务。</p><h2 id="FaaS"><a href="#FaaS" class="headerlink" title="FaaS"></a>FaaS</h2><p>FaaS（Functions as a Service）函数即服务，FaaS 是无服务器计算的一种形式，当前使用最广泛的是 AWS 的 Lambada。</p><h1 id="Serverless-的使用场景"><a href="#Serverless-的使用场景" class="headerlink" title="Serverless 的使用场景"></a>Serverless 的使用场景</h1><p>虽然 Serverless 的应用很广泛，但是其也有局限性，Serverless 比较适合以下场景：</p><ul><li>异步的并发，组件可独立部署和扩展</li><li>应对突发或服务使用量不可预测（主要是为了节约成本，因为 Serverless 应用在不运行时不收费）</li><li>短暂、无状态的应用，对冷启动时间不敏感</li><li>需要快速开发迭代的业务（因为无需提前申请资源，因此可以加快业务上线速度）</li></ul><p>Serverless 的使用场景示例如：</p><ul><li>ETL</li><li>机器学习及 AI 模型处理</li><li>图片处理</li><li>IoT 传感器数据分析</li><li>流处理</li><li>聊天机器人</li></ul><h1 id="serverless与云原生"><a href="#serverless与云原生" class="headerlink" title="serverless与云原生"></a>serverless与云原生</h1><p>Serverless 是云原生技术发展的高级阶段，可以使开发者更聚焦在业务逻辑，而减少对基础设施的关注。<br><img src="/images/serverless1.jpg" alt="Serverless 在云原生技术中的地位"></p><h1 id="开源serverless框架"><a href="#开源serverless框架" class="headerlink" title="开源serverless框架"></a>开源serverless框架</h1><p>Kubernetes 的蓬勃发展由催生了一系列以它为基础的 Serverless 应用，目前开源的 Serverless 框架大多以 Kubernetes 为基础。</p><p><img src="/images/serverless2.png" alt="开源框架"></p><ul><li>Apache OpenWhisk，一种多功能、具有行业优势的 Serverless 解决方案</li><li>Fission，第一个真正的 Kubernetes Serverless 平台</li><li>Kubeless，在 Serverless 中使用 Kubernetes API 的早期先驱</li><li>OpenFaaS，Kubernetes 上的简单 serverless</li><li>Knative，又被戏称为：所有你的 OSS serverless（和 Ingress）均属于我们</li><li>其他开源 serverless 平台,仔细观察#serverless 空间，你还会注意到还有很多其他产品，比如 -来自Oracle 的Fn , Pivotal 的Riff, VMWare 的 Dispatch, Galatic Fog , Nuclio , Virtual Kubelet ，PipelineAI, Nuclio ，可能还有更多。对不起，乍一眼看的话，它们中的大多数都很快就会不敌 Knative。</li></ul><blockquote><p><a href="https://jimmysong.io/awesome-cloud-native/#serverless。" target="_blank" rel="noopener">更多请点击…</a></p></blockquote><h1 id="原文链接"><a href="#原文链接" class="headerlink" title="原文链接"></a>原文链接</h1><p><a href="https://jimmysong.io/serverless-handbook/concepts/what-is-serverless.html" target="_blank" rel="noopener">原文链接</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> serverless </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>influxdb2.0-k8s部署</title>
      <link href="/2020/02/25/influxdb2-0-k8s-bu-shu/"/>
      <url>/2020/02/25/influxdb2-0-k8s-bu-shu/</url>
      
        <content type="html"><![CDATA[<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><pre><code>kubectl apply -f https://raw.githubusercontent.com/influxdata/docs-v2/master/static/downloads/influxdb-k8-minikube.yaml</code></pre><pre><code>kubectl get pods -n influxdb</code></pre><pre><code>kubectl describe service -n influxdb influxdb</code></pre><pre><code>kubectl port-forward -n influxdb service/influxdb 9999:9999</code></pre><h3 id="yaml"><a href="#yaml" class="headerlink" title="yaml"></a>yaml</h3><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace<span class="token key atrule">metadata</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> influxdb<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>    <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> influxdb    <span class="token key atrule">name</span><span class="token punctuation">:</span> influxdb    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> influxdb<span class="token key atrule">spec</span><span class="token punctuation">:</span>    <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>    <span class="token key atrule">selector</span><span class="token punctuation">:</span>        <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>            <span class="token key atrule">app</span><span class="token punctuation">:</span> influxdb    <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> influxdb    <span class="token key atrule">template</span><span class="token punctuation">:</span>        <span class="token key atrule">metadata</span><span class="token punctuation">:</span>            <span class="token key atrule">labels</span><span class="token punctuation">:</span>                <span class="token key atrule">app</span><span class="token punctuation">:</span> influxdb        <span class="token key atrule">spec</span><span class="token punctuation">:</span>            <span class="token key atrule">containers</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/influxdb/influxdb<span class="token punctuation">:</span>2.0.0<span class="token punctuation">-</span>beta                <span class="token key atrule">name</span><span class="token punctuation">:</span> influxdb                <span class="token key atrule">ports</span><span class="token punctuation">:</span>                  <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9999</span>                    <span class="token key atrule">name</span><span class="token punctuation">:</span> influxdb                <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>                  <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /root/.influxdbv2                    <span class="token key atrule">name</span><span class="token punctuation">:</span> data    <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> data            <span class="token key atrule">namespace</span><span class="token punctuation">:</span> influxdb        <span class="token key atrule">spec</span><span class="token punctuation">:</span>            <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>              <span class="token punctuation">-</span> ReadWriteOnce            <span class="token key atrule">resources</span><span class="token punctuation">:</span>                <span class="token key atrule">requests</span><span class="token punctuation">:</span>                    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10G<span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> influxdb    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> influxdb<span class="token key atrule">spec</span><span class="token punctuation">:</span>    <span class="token key atrule">ports</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> influxdb        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9999</span>        <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">9999</span>    <span class="token key atrule">selector</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> influxdb    <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> influxdb </category>
          
      </categories>
      
      
        <tags>
            
            <tag> influxdb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>influxdb2.0-docker部署</title>
      <link href="/2020/02/25/influxdb2-0-docker-bu-shu/"/>
      <url>/2020/02/25/influxdb2-0-docker-bu-shu/</url>
      
        <content type="html"><![CDATA[<pre><code>docker run --name influxdb -p 9999:9999 quay.io/influxdb/influxdb:2.0.0-beta</code></pre><pre><code>docker run -p 9999:9999 quay.io/influxdb/influxdb:2.0.0-beta --reporting-disabled</code></pre><pre><code>docker exec -it influxdb /bin/bash</code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> influxdb </category>
          
      </categories>
      
      
        <tags>
            
            <tag> influxdb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>influxdb-schema设计</title>
      <link href="/2020/02/25/influxdb-schema-she-ji/"/>
      <url>/2020/02/25/influxdb-schema-she-ji/</url>
      
        <content type="html"><![CDATA[<h3 id="tag的使用"><a href="#tag的使用" class="headerlink" title="tag的使用"></a>tag的使用</h3><ul><li>把你经常查询的字段作为tag</li><li>如果你要对其使用GROUP BY()，也要放在tag中</li><li>如果你要对其使用InfluxQL函数，则将其放到field中</li><li>如果你需要存储的值不是字符串，则需要放到field中，因为tag value只能是字符串</li><li>tags不要包含高度可变的信息，如UUID，哈希值和随机字符串，这将导致数据库中的大量series cardinality。<blockquote><p>series cardinality高是许多数据库高内存使用的主要原因</p></blockquote></li><li>用tag区分数据比使用详细的measurement名字更好</li><li>不要把多条信息放到一个tag里面</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> influxdb </category>
          
      </categories>
      
      
        <tags>
            
            <tag> influxdb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>influxdb-javaAPI</title>
      <link href="/2020/02/25/influxdb-javaapi/"/>
      <url>/2020/02/25/influxdb-javaapi/</url>
      
        <content type="html"><![CDATA[<script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> influxdb </category>
          
      </categories>
      
      
        <tags>
            
            <tag> influxdb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>influxdb-写入性能测试</title>
      <link href="/2020/02/25/influxdb-xie-ru-xing-neng-ce-shi/"/>
      <url>/2020/02/25/influxdb-xie-ru-xing-neng-ce-shi/</url>
      
        <content type="html"><![CDATA[<h3 id="influx-stress"><a href="#influx-stress" class="headerlink" title="influx-stress"></a>influx-stress</h3><pre><code>Flags:  -b, --batch-size uint      number of points in a batch (default 10000)  -c, --consistency string   Write consistency (only applicable to clusters) (default "one")      --create string        Use a custom create database command      --db string            Database that will be written to (default "stress")      --dump string          Dump to given file instead of writing over HTTP  -f, --fast                 Run as fast as possible      --gzip int             If non-zero, gzip write bodies with given compression level. 1=best speed, 9=best compression, -1=gzip default.      --host string          Address of InfluxDB instance (default "http://localhost:8086")      --pass string          Password for user  -n, --points uint          number of points that will be written (default 18446744073709551615)      --pps uint             Points Per Second (default 200000)  -p, --precision string     Resolution of data being written (default "n")  -q, --quiet                Only print the write throughput      --rp string            Retention Policy that will be written to  -r, --runtime duration     Total time that the test will run (default 2562047h47m16.854775807s)  -s, --series int           number of series that will be written (default 100000)      --strict               Strict mode will exit as soon as an error or unexpected status is encountered      --user string          User to write data as</code></pre><h4 id="Example-Usage"><a href="#Example-Usage" class="headerlink" title="Example Usage"></a>Example Usage</h4><pre><code>Runs forever$ influx-stress insertRuns forever writing as fast as possible$ influx-stress insert -fRuns for 1 minute writing as fast as possible$ influx-stress insert -r 1m -fWriting an example series key$ influx-stress insert cpu,host=server,location=us-west,id=myidWriting an example series key with 20,000 series$ influx-stress insert -s 20000 cpu,host=server,location=us-west,id=myidWriting an example point$ influx-stress insert cpu,host=server,location=us-west,id=myid busy=100,idle=10,random=5i</code></pre><h4 id="测试命令"><a href="#测试命令" class="headerlink" title="测试命令"></a>测试命令</h4><pre><code>influx_stress.exe insert -r 1m -fTotal Requests: 2000        Success: 2000        Fail: 0Average Response Time: 93.270662msPoints Per Second: 484339Total Queries: 250Average Query Response Time: 3.372889ms</code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> influxdb </category>
          
      </categories>
      
      
        <tags>
            
            <tag> influxdb </tag>
            
            <tag> influx-stress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>influxdb-数学运算符</title>
      <link href="/2020/02/25/influxdb-shu-xue-yun-suan-fu/"/>
      <url>/2020/02/25/influxdb-shu-xue-yun-suan-fu/</url>
      
        <content type="html"><![CDATA[<h3 id="加法"><a href="#加法" class="headerlink" title="加法"></a>加法</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#加一个常数</span><span class="token keyword">SELECT</span> <span class="token string">"A"</span> <span class="token operator">+</span> <span class="token number">5</span> <span class="token keyword">FROM</span> <span class="token string">"add"</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"add"</span> <span class="token keyword">WHERE</span> <span class="token string">"A"</span> <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">></span> <span class="token number">10</span><span class="token comment" spellcheck="true">#两个字段相加。</span><span class="token keyword">SELECT</span> <span class="token string">"A"</span> <span class="token operator">+</span> <span class="token string">"B"</span> <span class="token keyword">FROM</span> <span class="token string">"add"</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"add"</span> <span class="token keyword">WHERE</span> <span class="token string">"A"</span> <span class="token operator">+</span> <span class="token string">"B"</span> <span class="token operator">>=</span> <span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="减法"><a href="#减法" class="headerlink" title="减法"></a>减法</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#减法里带常数。</span><span class="token keyword">SELECT</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token string">"A"</span> <span class="token keyword">FROM</span> <span class="token string">"sub"</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"sub"</span> <span class="token keyword">WHERE</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token string">"A"</span> <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token comment" spellcheck="true">#两个字段做减法。</span><span class="token keyword">SELECT</span> <span class="token string">"A"</span> <span class="token operator">-</span> <span class="token string">"B"</span> <span class="token keyword">FROM</span> <span class="token string">"sub"</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"sub"</span> <span class="token keyword">WHERE</span> <span class="token string">"A"</span> <span class="token operator">-</span> <span class="token string">"B"</span> <span class="token operator">&lt;=</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="乘法"><a href="#乘法" class="headerlink" title="乘法"></a>乘法</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#乘以一个常数。</span><span class="token keyword">SELECT</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token string">"A"</span> <span class="token keyword">FROM</span> <span class="token string">"mult"</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"mult"</span> <span class="token keyword">WHERE</span> <span class="token string">"A"</span> <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">>=</span> <span class="token number">20</span><span class="token comment" spellcheck="true">#两个字段相乘。</span><span class="token keyword">SELECT</span> <span class="token string">"A"</span> <span class="token operator">*</span> <span class="token string">"B"</span> <span class="token operator">*</span> <span class="token string">"C"</span> <span class="token keyword">FROM</span> <span class="token string">"mult"</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"mult"</span> <span class="token keyword">WHERE</span> <span class="token string">"A"</span> <span class="token operator">*</span> <span class="token string">"B"</span> <span class="token operator">&lt;=</span> <span class="token number">80</span><span class="token comment" spellcheck="true">#乘法和其他运算符混用。</span><span class="token keyword">SELECT</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token string">"A"</span> <span class="token operator">+</span> <span class="token string">"B"</span> <span class="token operator">+</span> <span class="token string">"C"</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token string">"mult"</span><span class="token keyword">SELECT</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token string">"A"</span> <span class="token operator">-</span> <span class="token string">"B"</span> <span class="token operator">-</span> <span class="token string">"C"</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token string">"mult"</span><span class="token keyword">SELECT</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token string">"A"</span> <span class="token operator">+</span> <span class="token string">"B"</span> <span class="token operator">-</span> <span class="token string">"C"</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token string">"mult"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="除法"><a href="#除法" class="headerlink" title="除法"></a>除法</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#除法里带常数。</span><span class="token keyword">SELECT</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token string">"A"</span> <span class="token keyword">FROM</span> <span class="token string">"div"</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"div"</span> <span class="token keyword">WHERE</span> <span class="token string">"A"</span> <span class="token operator">/</span> <span class="token number">10</span> <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token comment" spellcheck="true">#两个字段相除。</span><span class="token keyword">SELECT</span> <span class="token string">"A"</span> <span class="token operator">/</span> <span class="token string">"B"</span> <span class="token keyword">FROM</span> <span class="token string">"div"</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"div"</span> <span class="token keyword">WHERE</span> <span class="token string">"A"</span> <span class="token operator">/</span> <span class="token string">"B"</span> <span class="token operator">>=</span> <span class="token number">10</span><span class="token comment" spellcheck="true">#除法和其他运算符混用。</span><span class="token keyword">SELECT</span> <span class="token number">10</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token string">"A"</span> <span class="token operator">+</span> <span class="token string">"B"</span> <span class="token operator">+</span> <span class="token string">"C"</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> <span class="token string">"mult"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="求模"><a href="#求模" class="headerlink" title="求模"></a>求模</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">#模一个常数。</span><span class="token keyword">SELECT</span> <span class="token string">"B"</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token keyword">FROM</span> <span class="token string">"modulo"</span><span class="token keyword">SELECT</span> <span class="token string">"B"</span> <span class="token keyword">FROM</span> <span class="token string">"modulo"</span> <span class="token keyword">WHERE</span> <span class="token string">"B"</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token comment" spellcheck="true">#两个字段求模。</span><span class="token keyword">SELECT</span> <span class="token string">"A"</span> <span class="token operator">%</span> <span class="token string">"B"</span> <span class="token keyword">FROM</span> <span class="token string">"modulo"</span><span class="token keyword">SELECT</span> <span class="token string">"A"</span> <span class="token keyword">FROM</span> <span class="token string">"modulo"</span> <span class="token keyword">WHERE</span> <span class="token string">"A"</span> <span class="token operator">%</span> <span class="token string">"B"</span> <span class="token operator">=</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="按位与"><a href="#按位与" class="headerlink" title="按位与"></a>按位与</h3><p>你可以在任何整数和布尔值中使用这个操作符，无论是字段或常数。该操作符不支持浮点数或字符串数据类型。并且不能混合使用整数和布尔值。</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token string">"A"</span> <span class="token operator">&amp;</span> <span class="token number">255</span> <span class="token keyword">FROM</span> <span class="token string">"bitfields"</span><span class="token keyword">SELECT</span> <span class="token string">"A"</span> <span class="token operator">&amp;</span> <span class="token string">"B"</span> <span class="token keyword">FROM</span> <span class="token string">"bitfields"</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"data"</span> <span class="token keyword">WHERE</span> <span class="token string">"bitfield"</span> <span class="token operator">&amp;</span> <span class="token number">15</span> <span class="token operator">></span> <span class="token number">0</span><span class="token keyword">SELECT</span> <span class="token string">"A"</span> <span class="token operator">&amp;</span> <span class="token string">"B"</span> <span class="token keyword">FROM</span> <span class="token string">"booleans"</span><span class="token keyword">SELECT</span> <span class="token punctuation">(</span><span class="token string">"A"</span> <span class="token operator">^</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token string">"B"</span> <span class="token keyword">FROM</span> <span class="token string">"booleans"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="按位或"><a href="#按位或" class="headerlink" title="按位或"></a>按位或</h3><p>你可以在任何整数和布尔值中使用这个操作符，无论是字段或常数。该操作符不支持浮点数或字符串数据类型。并且不能混合使用整数和布尔值。</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token string">"A"</span> <span class="token operator">|</span> <span class="token number">5</span> <span class="token keyword">FROM</span> <span class="token string">"bitfields"</span><span class="token keyword">SELECT</span> <span class="token string">"A"</span> <span class="token operator">|</span> <span class="token string">"B"</span> <span class="token keyword">FROM</span> <span class="token string">"bitfields"</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"data"</span> <span class="token keyword">WHERE</span> <span class="token string">"bitfield"</span> <span class="token operator">|</span> <span class="token number">12</span> <span class="token operator">=</span> <span class="token number">12</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="按位异或"><a href="#按位异或" class="headerlink" title="按位异或"></a>按位异或</h3><p>你可以在任何整数和布尔值中使用这个操作符，无论是字段或常数。该操作符不支持浮点数或字符串数据类型。并且不能混合使用整数和布尔值。</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token string">"A"</span> <span class="token operator">^</span> <span class="token number">255</span> <span class="token keyword">FROM</span> <span class="token string">"bitfields"</span><span class="token keyword">SELECT</span> <span class="token string">"A"</span> <span class="token operator">^</span> <span class="token string">"B"</span> <span class="token keyword">FROM</span> <span class="token string">"bitfields"</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"data"</span> <span class="token keyword">WHERE</span> <span class="token string">"bitfield"</span> <span class="token operator">^</span> <span class="token number">6</span> <span class="token operator">></span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="原文链接与常见问题"><a href="#原文链接与常见问题" class="headerlink" title="原文链接与常见问题"></a><a href="https://jasper-zhang1.gitbooks.io/influxdb/content/Query_language/math_operators.html" target="_blank" rel="noopener">原文链接与常见问题</a></h3><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> influxdb </category>
          
      </categories>
      
      
        <tags>
            
            <tag> influxdb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>influxdb-查询函数</title>
      <link href="/2020/02/25/influxdb-cha-xun-han-shu/"/>
      <url>/2020/02/25/influxdb-cha-xun-han-shu/</url>
      
        <content type="html"><![CDATA[<h3 id="COUNT计数"><a href="#COUNT计数" class="headerlink" title="COUNT计数"></a>COUNT计数</h3><h3 id="DISTINCT查找不同"><a href="#DISTINCT查找不同" class="headerlink" title="DISTINCT查找不同"></a>DISTINCT查找不同</h3><h3 id="INTEGRAL积分"><a href="#INTEGRAL积分" class="headerlink" title="INTEGRAL积分"></a>INTEGRAL积分</h3><h3 id="MEAN平均值"><a href="#MEAN平均值" class="headerlink" title="MEAN平均值"></a>MEAN平均值</h3><h3 id="MEDIAN中位数"><a href="#MEDIAN中位数" class="headerlink" title="MEDIAN中位数"></a>MEDIAN中位数</h3><h3 id="MODE频率最高的数"><a href="#MODE频率最高的数" class="headerlink" title="MODE频率最高的数"></a>MODE频率最高的数</h3><h3 id="SPREAD最大和最小差值"><a href="#SPREAD最大和最小差值" class="headerlink" title="SPREAD最大和最小差值"></a>SPREAD最大和最小差值</h3><h3 id="STDDEV标准差"><a href="#STDDEV标准差" class="headerlink" title="STDDEV标准差"></a>STDDEV标准差</h3><h3 id="SUM求和"><a href="#SUM求和" class="headerlink" title="SUM求和"></a>SUM求和</h3><h3 id="BOTTOM返回最小的N个数"><a href="#BOTTOM返回最小的N个数" class="headerlink" title="BOTTOM返回最小的N个数"></a>BOTTOM返回最小的N个数</h3><h3 id="TOP返回最大的N个field值"><a href="#TOP返回最大的N个field值" class="headerlink" title="TOP返回最大的N个field值"></a>TOP返回最大的N个field值</h3><h3 id="FIRST返回时间戳最早的数"><a href="#FIRST返回时间戳最早的数" class="headerlink" title="FIRST返回时间戳最早的数"></a>FIRST返回时间戳最早的数</h3><h3 id="LAST返回时间戳最近的数"><a href="#LAST返回时间戳最近的数" class="headerlink" title="LAST返回时间戳最近的数"></a>LAST返回时间戳最近的数</h3><h3 id="MAX最大值"><a href="#MAX最大值" class="headerlink" title="MAX最大值"></a>MAX最大值</h3><h3 id="MIN最小值"><a href="#MIN最小值" class="headerlink" title="MIN最小值"></a>MIN最小值</h3><h3 id="PERCENTILE返回较大百分之N的字段值"><a href="#PERCENTILE返回较大百分之N的字段值" class="headerlink" title="PERCENTILE返回较大百分之N的字段值"></a>PERCENTILE返回较大百分之N的字段值</h3><h3 id="SAMPLE返回N个随机抽样的字段值"><a href="#SAMPLE返回N个随机抽样的字段值" class="headerlink" title="SAMPLE返回N个随机抽样的字段值"></a>SAMPLE返回N个随机抽样的字段值</h3><h3 id="CUMULATIVE-SUM返回字段实时前序字段值的和"><a href="#CUMULATIVE-SUM返回字段实时前序字段值的和" class="headerlink" title="CUMULATIVE_SUM返回字段实时前序字段值的和"></a>CUMULATIVE_SUM返回字段实时前序字段值的和</h3><h3 id="DERIVATIVE返回字段的相邻两个点的变化率"><a href="#DERIVATIVE返回字段的相邻两个点的变化率" class="headerlink" title="DERIVATIVE返回字段的相邻两个点的变化率"></a>DERIVATIVE返回字段的相邻两个点的变化率</h3><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> influxdb </category>
          
      </categories>
      
      
        <tags>
            
            <tag> influxdb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>influxdb-连续查询</title>
      <link href="/2020/02/25/influxdb-lian-xu-cha-xun/"/>
      <url>/2020/02/25/influxdb-lian-xu-cha-xun/</url>
      
        <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>InfluxDB每秒可以处理数十万的数据点。如果要长时间地存储大量的数据，对于存储会是很大的压力。一个很自然的方式就是对数据进行采样，对于高精度的裸数据存储较短的时间，而对于低精度的的数据可以保存得久一些甚至永久保存。<br>InfluxDB提供了两个特性——连续查询(<code>Continuous Queries</code>简称<code>CQ</code>)和保留策略(<code>Retention Policies</code>简称<code>RP</code>)，分别用来处理数据采样和管理老数据的。</p><blockquote><p><code>Continuous Query</code> (CQ)是在数据库内部自动周期性跑着的一个InfluxQL的查询，CQs需要在SELECT语句中使用一个函数，并且一定包括一个GROUP BY time()语句。</p></blockquote><blockquote><p><code>Retention Policy</code> (RP)是InfluxDB数据架构的一部分，它描述了InfluxDB保存数据的时间。InfluxDB会比较服务器本地的时间戳和请求数据里的时间戳，并删除比你在RPs里面用DURATION设置的更老的数据。一个数据库中可以有多个RPs但是每个数据库的RPs是唯一的。</p></blockquote><h3 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> CONTINUOUS QUERY <span class="token operator">&lt;</span>cq_name<span class="token operator">></span> <span class="token keyword">ON</span> <span class="token operator">&lt;</span>database_name<span class="token operator">></span><span class="token keyword">BEGIN</span>  <span class="token operator">&lt;</span>cq_query<span class="token operator">></span><span class="token keyword">END</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="cq-query"><a href="#cq-query" class="headerlink" title="cq_query"></a>cq_query</h4><p>cq_query需要一个函数，一个<code>INTO</code>子句和一个<code>GROUP BY time()</code>子句：</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">&lt;</span><span class="token keyword">function</span><span class="token punctuation">[</span>s<span class="token punctuation">]</span><span class="token operator">></span> <span class="token keyword">INTO</span> <span class="token operator">&lt;</span>destination_measurement<span class="token operator">></span> <span class="token keyword">FROM</span> <span class="token operator">&lt;</span>measurement<span class="token operator">></span> <span class="token punctuation">[</span><span class="token keyword">WHERE</span> <span class="token operator">&lt;</span>stuff<span class="token operator">></span><span class="token punctuation">]</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> time<span class="token punctuation">(</span><span class="token operator">&lt;</span>interval<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">,</span><span class="token operator">&lt;</span>tag_key<span class="token punctuation">[</span>s<span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>注意：请注意，在<code>WHERE</code>子句中，cq_query不需要时间范围。 InfluxDB在执行CQ时自动生成cq_query的时间范围。cq_query的WHERE子句中的任何用户指定的时间范围将被系统忽略。</p></blockquote><h4 id="运行时间点以及覆盖的时间范围"><a href="#运行时间点以及覆盖的时间范围" class="headerlink" title="运行时间点以及覆盖的时间范围"></a>运行时间点以及覆盖的时间范围</h4><ul><li>CQ对实时数据进行操作。他们使用本地服务器的时间戳，GROUP BY time()间隔和InfluxDB的预设时间边界来确定何时执行以及查询中涵盖的时间范围。</li><li>CQs以与cq_query的GROUP BY time()间隔相同的间隔执行，并且它们在InfluxDB的预设时间边界开始时运行。如果GROUP BY time()间隔为1小时，则CQ每小时开始执行一次。</li><li>当CQ执行时，它对于now()和now()减去GROUP BY time()间隔的时间范围运行单个查询。 如果GROUP BY time()间隔为1小时，当前时间为17:00，查询的时间范围为16:00至16:59999999999。</li></ul><h3 id="高级语法"><a href="#高级语法" class="headerlink" title="高级语法"></a>高级语法</h3><p><a href="https://jasper-zhang1.gitbooks.io/influxdb/content/Query_language/continuous_queries.html" target="_blank" rel="noopener">链接</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> influxdb </category>
          
      </categories>
      
      
        <tags>
            
            <tag> influxdb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>influxQL</title>
      <link href="/2020/02/25/influxql/"/>
      <url>/2020/02/25/influxql/</url>
      
        <content type="html"><![CDATA[<p>InfluxQL是一种类似于SQL的查询语言，用于与InfluxDB进行交互。它经过精心设计，可以使来自其他SQL或类似SQL环境的用户熟悉，同时还提供特定于存储和分析时间序列数据的功能。</p><p>InfluxQL的SELECT语句遵循SQL SELECT语句的形式：</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">&lt;</span>stuff<span class="token operator">></span> <span class="token keyword">FROM</span> <span class="token operator">&lt;</span>measurement_name<span class="token operator">></span> <span class="token keyword">WHERE</span> <span class="token operator">&lt;</span>some_conditions<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>WHERE是可选的。</p><p>要在上面的部分中获取InfluxDB输出，请输入：</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"foodships"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果您只想查看有关该行的数据<code>Saturn</code>，请输入：</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"foodships"</span> <span class="token keyword">WHERE</span> <span class="token string">"planet"</span> <span class="token operator">=</span> <span class="token string">'Saturn'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如果您想Saturn在2015年4月16日世界标准时间<code>12:00:01</code>之后查看行星的数据，请输入：</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"foodships"</span> <span class="token keyword">WHERE</span> <span class="token string">"planet"</span> <span class="token operator">=</span> <span class="token string">'Saturn'</span> <span class="token operator">AND</span> time <span class="token operator">></span> <span class="token string">'2015-04-16 12:00:01'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>如上面的示例所示，InfluxQL允许您在WHERE子句中指定查询的时间范围。您可以使用日期时间字符串，这些日期时间字符串用单引号引起来，其格式为<code>YYYY-MM-DD HH:MM:SS.mmm</code> （mmm是毫秒，是可选的，还可以指定微秒或纳秒）。您还可以使用相对时间now()来引用服务器的当前时间戳：</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token string">"foodships"</span> <span class="token keyword">WHERE</span> time <span class="token operator">></span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> 1h<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>该查询foodships以时间戳记比服务器当前时间减去一小时新的量度输出数据。用于指定持续时间的选项<code>now()</code>有：</p><table><thead><tr><th>格式</th><th>单位</th></tr></thead><tbody><tr><td>ns</td><td>纳秒</td></tr><tr><td>u或µ</td><td>微秒</td></tr><tr><td>ms</td><td>毫秒</td></tr><tr><td>s</td><td>秒</td></tr><tr><td>m</td><td>分钟</td></tr><tr><td>H</td><td>小时</td></tr><tr><td>d</td><td>天</td></tr><tr><td>w</td><td>周</td></tr></tbody></table><ul><li><p>InfluxQL还支持正则表达式，表达式，SHOW语句和GROUP BY语句中的算术运算。</p></li><li><p>InfluxQL功能包括<code>COUNT</code>，<code>MIN</code>，<code>MAX</code>，<code>MEDIAN</code>，<code>DERIVATIVE</code>等等。</p></li><li><p>查询中的基本计算</p></li></ul><p>SELECT声明支持使用基本数学运算符，如+，-，/，*，()，等。</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">-- Add two field keys</span><span class="token keyword">SELECT</span> field_key1 <span class="token operator">+</span> field_key2 <span class="token keyword">AS</span> <span class="token string">"field_key_sum"</span> <span class="token keyword">FROM</span> <span class="token string">"measurement_name"</span> <span class="token keyword">WHERE</span> time <span class="token operator">&lt;</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> 15m<span class="token comment" spellcheck="true">-- Subtract one field from another</span><span class="token keyword">SELECT</span> field_key1 <span class="token operator">-</span> field_key2 <span class="token keyword">AS</span> <span class="token string">"field_key_difference"</span> <span class="token keyword">FROM</span> <span class="token string">"measurement_name"</span> <span class="token keyword">WHERE</span> time <span class="token operator">&lt;</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> 15m<span class="token comment" spellcheck="true">-- Grouping and chaining mathematical calculations</span><span class="token keyword">SELECT</span> <span class="token punctuation">(</span>field_key1 <span class="token operator">+</span> field_key2<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>field_key3 <span class="token operator">+</span> field_key4<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">"some_calculation"</span> <span class="token keyword">FROM</span> <span class="token string">"measurement_name"</span> <span class="token keyword">WHERE</span> time <span class="token operator">&lt;</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> 15m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>计算查询中的百分比</li></ul><p>使用基本的数学函数，您可以通过将一个字段值除以另一字段值并将结果乘以100来计算百分比：</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token punctuation">(</span>field_key1 <span class="token operator">/</span> field_key2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token keyword">AS</span> <span class="token string">"calculated_percentage"</span> <span class="token keyword">FROM</span> <span class="token string">"measurement_name"</span> <span class="token keyword">WHERE</span> time <span class="token operator">&lt;</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> 15m<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>使用聚合函数计算百分比</li></ul><p>如果在百分比计算中使用汇总函数，则必须使用汇总函数引用所有数据。 您不能混合使用汇总数据和非汇总数据。</p><p>所有聚合功能都需要一个<code>GROUP BY time()</code>子句，该子句定义将数据点分组和聚合的时间间隔。</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>field_key1<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">sum</span><span class="token punctuation">(</span>field_key2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token keyword">AS</span> <span class="token string">"calculated_percentage"</span> <span class="token keyword">FROM</span> <span class="token string">"measurement_name"</span> <span class="token keyword">WHERE</span> time <span class="token operator">&lt;</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> 15m <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> time<span class="token punctuation">(</span>1m<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> influxdb </category>
          
      </categories>
      
      
        <tags>
            
            <tag> influxdb </tag>
            
            <tag> influxQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>influxdb-API</title>
      <link href="/2020/02/25/influxdb-api/"/>
      <url>/2020/02/25/influxdb-api/</url>
      
        <content type="html"><![CDATA[<h3 id="支持的API-client"><a href="#支持的API-client" class="headerlink" title="支持的API client"></a>支持的API client</h3><p><a href="https://docs.influxdata.com/influxdb/v1.7/tools/api_client_libraries/" target="_blank" rel="noopener">参考官网</a></p><h3 id="http"><a href="#http" class="headerlink" title="http"></a>http</h3><h4 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h4><pre><code>curl -i -XPOST http://localhost:8086/query --data-urlencode "q=CREATE DATABASE mydb"</code></pre><h4 id="写入数据"><a href="#写入数据" class="headerlink" title="写入数据"></a>写入数据</h4><pre><code>curl -i -XPOST 'http://localhost:8086/write?db=mydb' --data-binary 'cpu_load_short,host=server01,region=us-west value=0.64 1434055562000000000'</code></pre><h4 id="配置gzip压缩"><a href="#配置gzip压缩" class="headerlink" title="配置gzip压缩"></a>配置gzip压缩</h4><p>InfluxDB支持gzip压缩。要减少网络流量，请考虑以下选项：</p><ul><li>要接受来自InfluxDB的压缩数据，请将Accept-Encoding: gzip标头添加到InfluxDB API请求中。</li><li>要在将数据发送到InfluxDB之前压缩数据，请将Content-Encoding: gzip标头添加到InfluxDB API请求中。</li></ul><h4 id="批量写入"><a href="#批量写入" class="headerlink" title="批量写入"></a>批量写入</h4><pre><code>curl -i -XPOST 'http://localhost:8086/write?db=mydb' --data-binary 'cpu_load_short,host=server02 value=0.67cpu_load_short,host=server02,region=us-west value=0.55 1422568543702900257cpu_load_short,direction=in,host=server01,region=us-west value=2.0 1422568543702900257</code></pre><h4 id="从文件写入"><a href="#从文件写入" class="headerlink" title="从文件写入"></a>从文件写入</h4><p>通过传递<code>@filename</code>到文件来写入文件中的点curl。文件中的数据应遵循InfluxDB行协议语法。</p><p>格式正确的文件（cpu_data.txt）的示例：</p><pre><code>cpu_load_short,host=server02 value=0.67cpu_load_short,host=server02,region=us-west value=0.55 1422568543702900257cpu_load_short,direction=in,host=server01,region=us-west value=2.0 1422568543702900257</code></pre><p>写入数据<code>cpu_data.txt</code>到<code>mydb</code>与数据库：</p><pre><code>curl -i -XPOST 'http://localhost:8086/write?db=mydb' --data-binary @cpu_data.txt</code></pre><blockquote><p>注意：如果您的数据文件具有5,000个以上的点，则可能有必要将该文件拆分为几个文件，以便将数据批量写入InfluxDB。默认情况下，HTTP请求在五秒钟后超时。超时后，InfluxDB仍将尝试写入这些点，但是不会确认它们已成功写入。</p></blockquote><h4 id="HTTP响应摘要"><a href="#HTTP响应摘要" class="headerlink" title="HTTP响应摘要"></a>HTTP响应摘要</h4><ul><li>2xx：如果收到您的写请求HTTP 204 No Content，那就成功了！</li><li>4xx：InfluxDB无法理解该请求。</li><li>5xx：系统过载或严重损坏</li></ul><h4 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h4><pre><code>curl -G 'http://localhost:8086/query?pretty=true' --data-urlencode "db=mydb" --data-urlencode "q=SELECT \"value\" FROM \"cpu_load_short\" WHERE \"region\"='us-west'"</code></pre><p>InfluxDB返回JSON。您的查询结果将显示在”results”数组中。如果发生错误，InfluxDB会设置一个”error”包含错误说明的密钥。</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"results"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span>            <span class="token property">"statement_id"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token property">"series"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token punctuation">{</span>                    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"cpu_load_short"</span><span class="token punctuation">,</span>                    <span class="token property">"columns"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                        <span class="token string">"time"</span><span class="token punctuation">,</span>                        <span class="token string">"value"</span>                    <span class="token punctuation">]</span><span class="token punctuation">,</span>                    <span class="token property">"values"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                        <span class="token punctuation">[</span>                            <span class="token string">"2015-01-29T21:55:43.702900257Z"</span><span class="token punctuation">,</span>                            <span class="token number">2</span>                        <span class="token punctuation">]</span><span class="token punctuation">,</span>                        <span class="token punctuation">[</span>                            <span class="token string">"2015-01-29T21:55:43.702900257Z"</span><span class="token punctuation">,</span>                            <span class="token number">0.55</span>                        <span class="token punctuation">]</span><span class="token punctuation">,</span>                        <span class="token punctuation">[</span>                            <span class="token string">"2015-06-11T20:46:02Z"</span><span class="token punctuation">,</span>                            <span class="token number">0.64</span>                        <span class="token punctuation">]</span>                    <span class="token punctuation">]</span>                <span class="token punctuation">}</span>            <span class="token punctuation">]</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>注意：附加pretty=true到URL会启用精美打印的JSON输出。尽管这对于调试或在使用诸如之类的工具直接查询时很有用curl，但不建议用于生产环境，因为它会消耗不必要的网络带宽。</p></blockquote><h4 id="多个查询"><a href="#多个查询" class="headerlink" title="多个查询"></a>多个查询</h4><p>通过单个API调用将多个查询发送到InfluxDB。只需使用分号分隔每个查询，例如：</p><pre><code>curl -G 'http://localhost:8086/query?pretty=true' --data-urlencode "db=mydb" --data-urlencode "q=SELECT \"value\" FROM \"cpu_load_short\" WHERE \"region\"='us-west';SELECT count(\"value\") FROM \"cpu_load_short\" WHERE \"region\"='us-west'"</code></pre><p>返回：</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"results"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">{</span>            <span class="token property">"statement_id"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token property">"series"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token punctuation">{</span>                    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"cpu_load_short"</span><span class="token punctuation">,</span>                    <span class="token property">"columns"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                        <span class="token string">"time"</span><span class="token punctuation">,</span>                        <span class="token string">"value"</span>                    <span class="token punctuation">]</span><span class="token punctuation">,</span>                    <span class="token property">"values"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                        <span class="token punctuation">[</span>                            <span class="token string">"2015-01-29T21:55:43.702900257Z"</span><span class="token punctuation">,</span>                            <span class="token number">2</span>                        <span class="token punctuation">]</span><span class="token punctuation">,</span>                        <span class="token punctuation">[</span>                            <span class="token string">"2015-01-29T21:55:43.702900257Z"</span><span class="token punctuation">,</span>                            <span class="token number">0.55</span>                        <span class="token punctuation">]</span><span class="token punctuation">,</span>                        <span class="token punctuation">[</span>                            <span class="token string">"2015-06-11T20:46:02Z"</span><span class="token punctuation">,</span>                            <span class="token number">0.64</span>                        <span class="token punctuation">]</span>                    <span class="token punctuation">]</span>                <span class="token punctuation">}</span>            <span class="token punctuation">]</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">{</span>            <span class="token property">"statement_id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>            <span class="token property">"series"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                <span class="token punctuation">{</span>                    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"cpu_load_short"</span><span class="token punctuation">,</span>                    <span class="token property">"columns"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                        <span class="token string">"time"</span><span class="token punctuation">,</span>                        <span class="token string">"count"</span>                    <span class="token punctuation">]</span><span class="token punctuation">,</span>                    <span class="token property">"values"</span><span class="token operator">:</span> <span class="token punctuation">[</span>                        <span class="token punctuation">[</span>                            <span class="token string">"1970-01-01T00:00:00Z"</span><span class="token punctuation">,</span>                            <span class="token number">3</span>                        <span class="token punctuation">]</span>                    <span class="token punctuation">]</span>                <span class="token punctuation">}</span>            <span class="token punctuation">]</span>        <span class="token punctuation">}</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="java"><a href="#java" class="headerlink" title="java"></a>java</h3><p><a href="https://github.com/influxdata/influxdb-java" target="_blank" rel="noopener">influxdb-java</a></p><blockquote><ul><li>Java 1.8+ (tested with jdk8 and jdk11)</li><li>Maven 3.0+ (tested with maven 3.5.0)</li></ul></blockquote><pre class="line-numbers language-maven"><code class="language-maven"><dependency>  <groupId>org.influxdb</groupId>  <artifactId>influxdb-java</artifactId>  <version>2.17</version></dependency><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-gradle"><code class="language-gradle">compile 'org.influxdb:influxdb-java:2.17'<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="python"><a href="#python" class="headerlink" title="python"></a>python</h3><p><a href="https://github.com/influxdb/influxdb-python" target="_blank" rel="noopener">influxdb-python</a></p><h3 id="go"><a href="#go" class="headerlink" title="go"></a>go</h3><p><a href="https://github.com/influxdata/influxdb1-client" target="_blank" rel="noopener">influxdb1-client</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> influxdb </category>
          
      </categories>
      
      
        <tags>
            
            <tag> influxdb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>influxdb使用</title>
      <link href="/2020/02/25/influxdb-shi-yong/"/>
      <url>/2020/02/25/influxdb-shi-yong/</url>
      
        <content type="html"><![CDATA[<h3 id="CLI连接"><a href="#CLI连接" class="headerlink" title="CLI连接"></a>CLI连接</h3><p><a href="https://docs.influxdata.com/influxdb/v1.7/introduction/getting-started" target="_blank" rel="noopener">参考链接</a></p><pre><code>influx -precision rfc3339</code></pre><ul><li><code>influx</code>默认使用本地<code>8086</code>端口和<code>localhost</code>连接，更多参考<code>influx --help</code></li><li><code>-precision</code>格式化时间，<code>rfc3339</code>使用<code>RFC3339</code> format (<code>YYYY-MM-DDTHH:MM:SS.nnnnnnnnnZ</code>).</li></ul><h3 id="管理连接"><a href="#管理连接" class="headerlink" title="管理连接"></a>管理连接</h3><p><code>exit</code></p><h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h3><pre><code>CREATE DATABASE &lt;db-name&gt;</code></pre><p>例如<code>CREATE DATABASE mydb</code>.<code>default</code>是默认关键字，不能用于数据库名.</p><h3 id="查看数据库"><a href="#查看数据库" class="headerlink" title="查看数据库"></a>查看数据库</h3><p>创建完数据库可以用<code>SHOW DATABASES</code>查看所有数据库.</p><pre><code>&gt; SHOW DATABASESname: databasesname----_internalmydb</code></pre><h3 id="使用数据库"><a href="#使用数据库" class="headerlink" title="使用数据库"></a>使用数据库</h3><pre><code>USE &lt;db-name&gt;&gt; USE mydbUsing database mydb</code></pre><h3 id="存储策略"><a href="#存储策略" class="headerlink" title="存储策略"></a>存储策略</h3><p>查看当前数据库Retention Policies</p><pre><code>show retention policies on "db_name"</code></pre><p>创建新的Retention Policies</p><pre><code>create retention policy "rp_name" on "db_name" duration 3w replication 1 default</code></pre><h3 id="数据格式"><a href="#数据格式" class="headerlink" title="数据格式"></a>数据格式</h3><pre><code>&lt;measurement&gt;[,&lt;tag-key&gt;=&lt;tag-value&gt;...] &lt;field-key&gt;=&lt;field-value&gt;[,&lt;field2-key&gt;=&lt;field2-value&gt;...] [unix-nano-timestamp]</code></pre><blockquote><ul><li><code>measurement</code>相当于表名.  </li><li><code>tag</code>是数据的标签，可以有多个  </li><li><code>field</code>是数据的值，可以有多个，例如 “value=0.64”, or “temperature=21.2”  </li><li><code>timestamp</code>是数据的时间戳</li></ul></blockquote><blockquote><p>每一条数据称之为<code>points</code>.</p></blockquote><h3 id="插入一条数据"><a href="#插入一条数据" class="headerlink" title="插入一条数据"></a>插入一条数据</h3><pre><code>INSERT cpu,host=serverA,region=us_west value=0.64</code></pre><pre><code>INSERT temperature,machine=unit42,type=assembly external=25,internal=37</code></pre><h3 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h3><pre><code>SELECT "host", "region", "value" FROM "cpu"</code></pre><pre><code>SELECT * FROM "temperature"</code></pre><pre><code>&gt; SELECT * FROM /.*/ LIMIT 1--&gt; SELECT * FROM "cpu_load_short"--&gt; SELECT * FROM "cpu_load_short" WHERE "value" &gt; 0.9</code></pre><pre><code>SELECT * FROM cpu where time = '2020-02-20T06:43:42.9206681Z'</code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> influxdb </category>
          
      </categories>
      
      
        <tags>
            
            <tag> influxdb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>influxdb安装</title>
      <link href="/2020/02/25/influxdb-an-zhuang/"/>
      <url>/2020/02/25/influxdb-an-zhuang/</url>
      
        <content type="html"><![CDATA[<h3 id="influxdb简介"><a href="#influxdb简介" class="headerlink" title="influxdb简介"></a>influxdb简介</h3><p>influxdb是一款常年在db-engine使用排名第一的时序数据库，提供存储管理、用户管理、http接口、各类语言API接口。</p><h4 id="TSM"><a href="#TSM" class="headerlink" title="TSM"></a>TSM</h4><p>时序数据使用类似 LSM Tree 的 TSM Tree （<code>Time Series Merge Tree</code>）存储，而且是一种「列式」存储结构。</p><p>数据写入时：</p><ul><li>先保存到 cache 和 WAL 当中</li><li>当 WAL 当中数据超出阈值时，将 WAL 文件写入到 level 1 的 TSM 文件当中，cache 和 WAL 也随之清空</li><li>每个 TSM 文件主要分成两部分：时序数据，以及时序数据的索引，通过索引可以使用二分查找找到我们需要的数据</li><li>随着 TSM 文件变多，系统会将多个小 的TSM 文件会合并成一个的更大的 TSM 文件，持续这个过程保证文件数量不会过多</li><li>TSM 文件的合并策略是比较老的 size-tiered 策略，将小的文件压缩成大的文件，这一点和 leveldb 不太一样，leveldb 要严格保证每个 level 下的文件没有重叠，但是 influxdb 不会。</li></ul><p>之所以这么设计，应该是因为查询时序数据的时候，一般会根据时间进行筛选，而大部分时候每个 TSM 文件当中都是越老的文件数据也越老，数据天然会按照时间排序，虽然会有重叠的情况，但是权衡利弊，最终可以容忍这种情况，查询的时候做数据合并的成本更小。</p><h4 id="TSI"><a href="#TSI" class="headerlink" title="TSI"></a>TSI</h4><p>TSI 是 <code>Time Series Index</code> 的缩写，influxdb 用 TSI 来保存时序数据的倒排索引。可以通过 TSI 快速查询到某个表中，包含某个 tag 的 series 都有哪些。</p><p>TSI 的另一个工作是将倒排索引保存在磁盘当中，在 TSI 之前，influxdb 完全是使用内存存储倒排索引的，当时序数据变多的时候，特别是「表」变多的时候，倒排索引消耗的内存会飙升。TSI 使用类似 TSM 的文件结构来存储索引。</p><h3 id="inflxdb数据库安装"><a href="#inflxdb数据库安装" class="headerlink" title="inflxdb数据库安装"></a>inflxdb数据库安装</h3><h4 id="centos安装"><a href="#centos安装" class="headerlink" title="centos安装"></a>centos安装</h4><ol><li>下载<a href="https://portal.influxdata.com/downloads/" target="_blank" rel="noopener">地址</a><pre><code>wget https://dl.influxdata.com/influxdb/releases/influxdb-1.7.10.x86_64.rpmsudo yum localinstall influxdb-1.7.10.x86_64.rpm</code></pre></li><li>安装<pre><code>yum localinstall influxdb-1.7.10.x86_64.rpm</code></pre></li><li>卸载<pre><code>rpm -qa | grep influxrpm -e influxdb-1.7.10.x86_64</code></pre></li><li>启动<pre><code>service influxdb startsystemctl enable influxdbsystemctl start influxdbsystemctl restart influxdbsystemctl stop influxdb</code></pre></li></ol><h4 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h4><p><code>https://dl.influxdata.com/influxdb/releases/influxdb-1.7.10_windows_amd64.zipunzip influxdb-1.7.10_windows_amd64.zip</code></p><h4 id="docker安装"><a href="#docker安装" class="headerlink" title="docker安装"></a>docker安装</h4><pre><code>docker pull influxdb</code></pre><h3 id="可视化UI-Chronograf"><a href="#可视化UI-Chronograf" class="headerlink" title="可视化UI-Chronograf"></a>可视化UI-Chronograf</h3><h4 id="docker安装-1"><a href="#docker安装-1" class="headerlink" title="docker安装"></a>docker安装</h4><pre><code>docker pull quay.io/influxdb/chronograf:1.7.17</code></pre><h4 id="centos"><a href="#centos" class="headerlink" title="centos"></a>centos</h4><pre><code>wget https://dl.influxdata.com/chronograf/releases/chronograf-1.7.17.x86_64.rpmsudo yum localinstall chronograf-1.7.17.x86_64.rpm</code></pre><h4 id="windows-1"><a href="#windows-1" class="headerlink" title="windows"></a>windows</h4><pre><code>https://dl.influxdata.com/chronograf/releases/chronograf-1.7.17_windows_amd64.zipunzip chronograf-1.7.17_windows_amd64.zip</code></pre><h3 id="数据收集器-Telegraf"><a href="#数据收集器-Telegraf" class="headerlink" title="数据收集器-Telegraf"></a>数据收集器-Telegraf</h3><h4 id="docker安装-2"><a href="#docker安装-2" class="headerlink" title="docker安装"></a>docker安装</h4><pre><code>docker pull telegraf</code></pre><h4 id="centos-1"><a href="#centos-1" class="headerlink" title="centos"></a>centos</h4><pre><code>wget https://dl.influxdata.com/telegraf/releases/telegraf-1.13.3-1.x86_64.rpmsudo yum localinstall telegraf-1.13.3-1.x86_64.rpm</code></pre><h4 id="windows-2"><a href="#windows-2" class="headerlink" title="windows"></a>windows</h4><pre><code>wget https://dl.influxdata.com/telegraf/releases/telegraf-1.13.3_windows_amd64.zipunzip telegraf-1.13.3_windows_amd64.zip</code></pre><h3 id="处理和监控服务-Kapacitor"><a href="#处理和监控服务-Kapacitor" class="headerlink" title="处理和监控服务-Kapacitor"></a>处理和监控服务-Kapacitor</h3><h4 id="docker安装-3"><a href="#docker安装-3" class="headerlink" title="docker安装"></a>docker安装</h4><pre><code>docker pull kapacitor</code></pre><h4 id="centos-2"><a href="#centos-2" class="headerlink" title="centos"></a>centos</h4><pre><code>wget https://dl.influxdata.com/kapacitor/releases/kapacitor-1.5.4-1.x86_64.rpmsudo yum localinstall kapacitor-1.5.4-1.x86_64.rpm</code></pre><h4 id="windows-3"><a href="#windows-3" class="headerlink" title="windows"></a>windows</h4><pre><code>wget https://dl.influxdata.com/kapacitor/releases/kapacitor-1.5.4_windows_amd64.zipunzip kapacitor-1.5.4_windows_amd64.zip</code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> influxdb </category>
          
      </categories>
      
      
        <tags>
            
            <tag> influxdb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>istio架构【数据平面与控制平面】</title>
      <link href="/2020/01/15/istio-jia-gou/"/>
      <url>/2020/01/15/istio-jia-gou/</url>
      
        <content type="html"><![CDATA[<h3 id="架构综述"><a href="#架构综述" class="headerlink" title="架构综述"></a>架构综述</h3><p><code>Istio</code>在逻辑上分为数据平面(<code>data plane</code>)和控制平面(<code>control plane</code>)两部分：</p><ul><li><strong>数据平面</strong>：由一系列以<code>sidecar</code>形式部署的智能代理(<code>Envoy</code>)组成。这些代理可以调节和控制微服务及混合器(Mixer)之间的所有网络通信</li><li><strong>控制平面</strong>：负责管理和配置代理来路由流量，除此之外控制平面还配置混合器(<code>Mixer</code>)以执行策略和收集遥测数据</li></ul><p><img src="/images/istio2.png" alt="istio 架构"></p><h3 id="数据平面"><a href="#数据平面" class="headerlink" title="数据平面"></a>数据平面</h3><ul><li><code>Envoy</code>是以C++开发的高性能代理，用于接管服务网格中所有服务的所有<code>inbound</code>和<code>outbound</code>流量。 Istio实际上利用了很多Envoy已有的特性，例如：服务的动态发现、负载均衡、TSL终止、HTTP/2和gRPC代理、断路器、健康检查、基于百分比流量拆分的灰度发布、故障注入以及丰富的度量指标。</li><li>Envoy以sidecar部署，与对应的服务在同一个Kubernetes Pod中。这样的部署方式使得Istio可以将大量了关于流量行为的信号作为属性(<code>Attribute</code>)提取出来。这些属性可以被用来在混合器(Mixer)中执行策略决策，并发送给监控系统，以提供整个Service Mesh的行为信息。Sidecar模式允许我们将istio的功能添加到现有的部署中，而无需重构或重写现有的代码。</li></ul><h3 id="控制平面"><a href="#控制平面" class="headerlink" title="控制平面"></a>控制平面</h3><ul><li><p><strong>Pilot为</strong> Envoy <code>sidecar</code> 提供服务发现功能，为智能路由（例如 A/B 测试、金丝雀部署等）和弹性（超时、重试、熔断器等）提供流量管理功能。 将控制流量行为的高级路由规则转换为Envoy的相关配置，并在运行时将它们传播到sidecar。</p></li><li><p><strong>Mixer</strong>分为<code>Policy</code>和<code>Telemetry</code>两个子模块。<code>Policy</code>用于向Envoy提供准入策略控制，黑白名单控制，速率限制等相关策略；<code>Telemetry</code>为Envoy提供了数据上报和日志搜集服务，以用于监控告警和日志查询。</p></li><li><p><strong>Galley</strong>在Istio中，承担配置的导入、处理和分发任务，为Istio提供了配置管理服务,提供在k8s服务端验证Istio的<code>CRD</code> 资源的合法性的方法，是整个控制面的配置管理中心。</p></li><li><p><strong>Citadel</strong>主要关注安全，为服务之间以及与终端用户提供认证、授权、凭据管理等功能。</p></li></ul><h3 id="类比"><a href="#类比" class="headerlink" title="类比"></a>类比</h3><p><img src="/images/istio3.jpg" alt="istio 架构"></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> istio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Service Mesh简介</title>
      <link href="/2020/01/15/fu-wu-wang-ge/"/>
      <url>/2020/01/15/fu-wu-wang-ge/</url>
      
        <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><strong>服务网格（<code>Service mesh</code>）是服务间通信的基础设施层</strong>。它对全局流量和通信进行监控和管理，提供包括可观察性、流量转移（用于灰度发布）、弹性能力（例如断路和重试/超时）等一系列功能，并为服务之间的通信提供双向 TLS 认证能力，让网格能够对请求和响应进行自动加密和解密。<br><img src="/images/sm1.jpg" alt="Service Mesh"></p><h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h4><ul><li>治理能力独立（Sidecar）</li><li>应用程序无感知</li><li>服务通信的基础设施层</li></ul><h4 id="关注的方面"><a href="#关注的方面" class="headerlink" title="关注的方面"></a>关注的方面</h4><ul><li>可观察性</li><li>安全性</li><li>可运维性</li><li>可拓展性</li></ul><h3 id="为什么需要？"><a href="#为什么需要？" class="headerlink" title="为什么需要？"></a>为什么需要？</h3><p><img src="/images/sm4.png" alt="Service Mesh"><br><code>Kubernetes</code> 提供平台基础设施层强大的容器编排与调度能力</p><ul><li>服务部署与弹性伸缩：<code>Deployment</code></li><li>服务拆分与服务发现：<code>Service</code></li></ul><p><code>Kubernetes</code> 提供简单的负载均衡</p><ul><li>负载均衡：基于<code>IPVS</code>或<code>Iptables</code>的简单均衡机制</li></ul><p>但是<code>Kubernetes</code>在服务治理方面并不完备，缺少了动态路由、熔断、灰度发布等等功能，需要由服务网格互补。</p><h3 id="什么时候用Service-Mesh？"><a href="#什么时候用Service-Mesh？" class="headerlink" title="什么时候用Service Mesh？"></a>什么时候用Service Mesh？</h3><p><img src="/images/sm2.jpg" alt="Service Mesh"></p><p>随着我们的微服务越来越细分，我们所要管理的服务正在成倍的增长着，<code>Kubernetes</code> 提供了丰富的功能，使得我们可以快速的部署和调度这些服务，同时也提供了我们熟悉的方式来实现那些复杂的功能，但是随着部署的应该越来越多，复杂度越来越高，当临界点到来时，可能就是我们真正要去考虑使用 <code>Service Mesh</code> 的时候了。</p><h3 id="Istio问世"><a href="#Istio问世" class="headerlink" title="Istio问世"></a>Istio问世</h3><p><img src="/images/sm3.jpg" alt="Service Mesh"><br><code>Istio</code>是一个开放服务网格，是<code>Service Mesh</code>标准实现，也是当下最流行的，提供了一种连接，管理和保护微服务的统一方法。它支持管理服务之间的流量，执行访问策略以及汇总遥测数据，所有这些都无需更改微服务代码。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> istio </tag>
            
            <tag> service mesh </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>日志聚合工具Loki使用【LogQL】</title>
      <link href="/2020/01/13/ri-zhi-ju-he-gong-ju-loki-shi-yong-logql/"/>
      <url>/2020/01/13/ri-zhi-ju-he-gong-ju-loki-shi-yong-logql/</url>
      
        <content type="html"><![CDATA[<p><a href="https://github.com/grafana/loki/blob/master/docs/logql.md" target="_blank" rel="noopener">LogQL github</a></p><h3 id="LogQL简介"><a href="#LogQL简介" class="headerlink" title="LogQL简介"></a>LogQL简介</h3><p>LogQL: Log Query Language<br>Loki comes with its very own language for querying logs called LogQL. LogQL can be considered a distributed grep with labels for filtering.</p><p>A basic LogQL query consists of two parts: the log stream selector and a filter expression. Due to Loki’s design, all LogQL queries are required to contain a log stream selector.</p><p>The log stream selector will reduce the number of log streams to a manageable volume. Depending how many labels you use to filter down the log streams will affect the relative performance of the query’s execution. The filter expression is then used to do a distributed grep over the retrieved log streams.</p><h3 id="Loki选择器"><a href="#Loki选择器" class="headerlink" title="Loki选择器"></a>Loki选择器</h3><p>对于查询表达式的标签部分，将其包装在花括号中<code>{}</code>，然后使用键值对的语法来选择标签，多个标签表达式用逗号分隔，比如：</p><pre><code>{app="mysql",name="mysql-backup"}</code></pre><p>目前支持以下标签匹配运算符：</p><ul><li>=等于</li><li>!=不相等</li><li>=~正则表达式匹配</li><li>!~不匹配正则表达式</li><li>比如：<pre><code>{name=~"mysql.+"}{name!~"mysql.+"}</code></pre></li></ul><h3 id="日志过滤器"><a href="#日志过滤器" class="headerlink" title="日志过滤器"></a>日志过滤器</h3><p>编写日志流选择器后，您可以通过编写搜索表达式来进一步过滤结果。搜索表达式可以只是文本或正则表达式。<br>查询示例：</p><pre><code>{job="mysql"} |= "error"{name="kafka"} |~ "tsdb-ops.*io:2003"{instance=~"kafka-[23]",name="kafka"} != kafka.server:type=ReplicaManager</code></pre><p>过滤器运算符可以被链接，并将顺序过滤表达式-结果日志行将满足每个过滤器。例如：</p><pre><code>{job="mysql"} |= "error" != "timeout"</code></pre><p>已实现以下过滤器类型：</p><ul><li>|= 行包含字符串。</li><li>!= 行不包含字符串。</li><li>|~ 行匹配正则表达式。</li><li>!~ 行与正则表达式不匹配。<br><code>regex</code>表达式接受<code>RE2</code>语法。默认情况下，匹配项区分大小写，并且可以将<code>regex</code>切换为不区分大小写的前缀<code>(?i)</code>。</li></ul><h3 id="日志统计"><a href="#日志统计" class="headerlink" title="日志统计"></a>日志统计</h3><ul><li>rate: calculate the number of entries per second</li></ul><pre><code>rate( ( {job="mysql"} |= "error" != "timeout)[10s] ) )</code></pre><ul><li>count_over_time: counts the entries for each log stream within the given range.</li></ul><pre><code>count_over_time({job="mysql"}[5m])</code></pre><h3 id="聚合运算"><a href="#聚合运算" class="headerlink" title="聚合运算"></a>聚合运算</h3><ul><li>sum: Calculate sum over labels</li><li>min: Select minimum over labels</li><li>max: Select maximum over labels</li><li>avg: Calculate the average over labels</li><li>stddev: Calculate the population standard deviation over labels</li><li>stdvar: Calculate the population standard variance over labels</li><li>count: Count number of elements in the vector</li><li>bottomk: Select smallest k elements by sample value</li><li>topk: Select largest k elements by sample value</li></ul><p>示例：<br>Get the top 10 applications by the highest log throughput:</p><pre><code>topk(10,sum(rate({region="us-east1"}[5m])) by (name))</code></pre><p>Get the count of logs during the last five minutes, grouping by level:</p><pre><code>sum(count_over_time({job="mysql"}[5m])) by (level)</code></pre><p>Get the rate of HTTP GET requests from NGINX logs:</p><pre><code>avg(rate(({job="nginx"} |= "GET")[10s])) by (region)</code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> logQL </tag>
            
            <tag> loki </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux系统磁盘使用情况相关命令</title>
      <link href="/2020/01/08/linux-xi-tong-ci-pan-shi-yong-qing-kuang-xiang-guan-ming-ling/"/>
      <url>/2020/01/08/linux-xi-tong-ci-pan-shi-yong-qing-kuang-xiang-guan-ming-ling/</url>
      
        <content type="html"><![CDATA[<h3 id="df命令"><a href="#df命令" class="headerlink" title="df命令"></a>df命令</h3><p>Linux df命令用于显示目前在Linux系统上的文件系统的磁盘使用情况统计。</p><pre><code>df -h</code></pre><pre><code>df -h /home</code></pre><pre><code>df --total</code></pre><h3 id="du命令"><a href="#du命令" class="headerlink" title="du命令"></a>du命令</h3><p>Linux du命令用于显示目录或文件的大小。<br>du会显示指定的目录或文件所占用的磁盘空间。</p><ul><li>查看当前目录下文件夹所占磁盘大小<pre><code>du</code></pre></li><li>查看当前目录下文件夹所占磁盘大小，并格式单位<pre><code>du -h</code></pre></li><li>查看当前目录下文件夹所占磁盘大小，并显示时间<pre><code>du --time</code></pre></li><li>查看文件占用空间<pre><code>du test.log</code></pre></li><li>查看文件占用空间<pre><code>du test</code></pre></li><li>以M为单位<pre><code>du -m</code></pre></li><li>以K为单位<pre><code>du -k</code></pre></li><li>只显示总计，不显示子目录<pre><code>du -s</code></pre></li><li>设置目录层数<pre><code>du --max-depth=1</code></pre></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> 磁盘 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>docker垃圾收集</title>
      <link href="/2020/01/08/docker-la-ji-shou-ji/"/>
      <url>/2020/01/08/docker-la-ji-shou-ji/</url>
      
        <content type="html"><![CDATA[<h3 id="查看tag为none的镜像"><a href="#查看tag为none的镜像" class="headerlink" title="查看tag为none的镜像"></a>查看tag为none的镜像</h3><pre class="line-numbers language-bash"><code class="language-bash">docker images -f <span class="token string">"dangling=true"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="删除tag为none的镜像"><a href="#删除tag为none的镜像" class="headerlink" title="删除tag为none的镜像"></a>删除tag为none的镜像</h3><pre class="line-numbers language-bash"><code class="language-bash">docker rmi <span class="token punctuation">$(</span>docker images -f <span class="token string">"dangling=true"</span> -q<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="查看docker占用的磁盘空间"><a href="#查看docker占用的磁盘空间" class="headerlink" title="查看docker占用的磁盘空间"></a>查看docker占用的磁盘空间</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># docker system df</span>TYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLEImages              35                  3                   5.039GB             4.603GB <span class="token punctuation">(</span>91%<span class="token punctuation">)</span>Containers          3                   2                   19.69kB             19.5kB <span class="token punctuation">(</span>99%<span class="token punctuation">)</span>Local Volumes       28                  0                   3.782MB             3.782MB <span class="token punctuation">(</span>100%<span class="token punctuation">)</span>Build Cache         0                   0                   0B                  0B<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="查找所有无用的volume"><a href="#查找所有无用的volume" class="headerlink" title="查找所有无用的volume"></a>查找所有无用的volume</h3><pre class="line-numbers language-bash"><code class="language-bash">docker volume <span class="token function">ls</span> -qf dangling<span class="token operator">=</span>true<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="删除所有无用的volume"><a href="#删除所有无用的volume" class="headerlink" title="删除所有无用的volume"></a>删除所有无用的volume</h3><pre class="line-numbers language-bash"><code class="language-bash">docker volume <span class="token function">rm</span> <span class="token variable"><span class="token variable">$(</span>docker volume <span class="token function">ls</span> -qf dangling<span class="token operator">=</span>true<span class="token variable">)</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="查看所有docker文件夹"><a href="#查看所有docker文件夹" class="headerlink" title="查看所有docker文件夹"></a>查看所有docker文件夹</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">find</span> / -name docker<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>可以使用<code>df</code>或者<code>du</code>命令查看文件夹具体使用情况，参考<a href="https://haolin.club/2020/01/08/linux-xi-tong-ci-pan-shi-yong-qing-kuang-xiang-guan-ming-ling/">Linux系统磁盘使用情况相关命令</a>.<br>如:  </p><pre><code>du -hs /var/lib/docker/</code></pre></blockquote><h3 id="查找所有未运行的容器"><a href="#查找所有未运行的容器" class="headerlink" title="查找所有未运行的容器"></a>查找所有未运行的容器</h3><pre class="line-numbers language-bash"><code class="language-bash">docker <span class="token function">ps</span> -a<span class="token operator">|</span><span class="token function">grep</span> Exited<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash"><code class="language-bash">docker <span class="token function">ps</span> -qf status<span class="token operator">=</span>exited<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="删除所有未运行的容器"><a href="#删除所有未运行的容器" class="headerlink" title="删除所有未运行的容器"></a>删除所有未运行的容器</h3><pre class="line-numbers language-bash"><code class="language-bash">docker <span class="token function">rm</span> <span class="token punctuation">$(</span>docker <span class="token function">ps</span> -a<span class="token operator">|</span><span class="token function">grep</span> Exited <span class="token operator">|</span><span class="token function">awk</span> <span class="token string">'{print <span class="token variable">$1</span>}'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="prune命令"><a href="#prune命令" class="headerlink" title="prune命令"></a><font color="red"><strong>prune命令</strong></font></h3><ul><li>删除所有无用的容器</li></ul><pre class="line-numbers language-bash"><code class="language-bash">docker container prune<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>删除所有无用的镜像</li></ul><pre class="line-numbers language-bash"><code class="language-bash">docker image prune<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>删除所有无用的volume</li></ul><pre class="line-numbers language-bash"><code class="language-bash">docker volume prune<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>删除所有无用的network</li></ul><pre class="line-numbers language-bash"><code class="language-bash">docker network prune<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>删除docker系统中所有无用的，包括容器、镜像、volume、网络等</li></ul><pre class="line-numbers language-bash"><code class="language-bash">docker system prune<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p><strong>注意</strong><code>docker system prune</code>和<code>docker system prune -a</code>两者的区别：  </p><hr><p>[root@node1 ~]# <code>docker system prune</code><br>WARNING! This will remove:</p><ul><li>all stopped containers</li><li>all networks not used by at least one container</li><li>all dangling images</li><li>all dangling build cache<br>Are you sure you want to continue? [y/N]</li></ul><hr><p>[root@node1 ~]# <code>docker system prune -a</code><br>WARNING! This will remove:</p><ul><li>all stopped containers</li><li>all networks not used by at least one container</li><li>all images without at least one container associated to them</li><li>all build cache<br>Are you sure you want to continue? [y/N]</li></ul></blockquote><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
            <tag> 垃圾清理 </tag>
            
            <tag> prune </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s证书管理【Cert-manager自动签发/更新证书】</title>
      <link href="/2020/01/07/k8s-zheng-shu-guan-li-cert-manager-zi-dong-qian-fa-geng-xin-zheng-shu/"/>
      <url>/2020/01/07/k8s-zheng-shu-guan-li-cert-manager-zi-dong-qian-fa-geng-xin-zheng-shu/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Cert-manager 是一个云原生证书管理开源项目，用于在 Kubernetes 集群中提供 HTTPS 证书并自动续期，支持 Let’s Encrypt, HashiCorp Vault 这些免费证书的签发。在Kubernetes集群中，我们可以通过 Kubernetes Ingress 和 Let’s Encrypt 实现外部服务的自动化 HTTPS。<br>本文 Cert manager使用版本：<font color="red"><strong>v0.12.0</strong></font><br><img src="/images/cert-manager.png" alt="cert-manager"><br>强烈建议参考官方文档：<a href="https://cert-manager.io/docs" target="_blank" rel="noopener">https://cert-manager.io/docs</a></p></blockquote><h3 id="添加helm源"><a href="#添加helm源" class="headerlink" title="添加helm源"></a>添加helm源</h3><blockquote><p>注意<a href="https://github.com/helm/charts/tree/master/stable/cert-manager" target="_blank" rel="noopener">stable/cert-manager</a>已经过时不再维护了，转到<a href="https://github.com/jetstack/cert-manager/tree/master/deploy/charts/cert-manager" target="_blank" rel="noopener">jetstack/cert-manager</a>。</p></blockquote><pre class="line-numbers language-bash"><code class="language-bash">helm repo add jetstack https://charts.jetstack.io<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="更新源"><a href="#更新源" class="headerlink" title="更新源"></a>更新源</h3><pre class="line-numbers language-bash"><code class="language-bash">helm repo update<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="创建CRDs"><a href="#创建CRDs" class="headerlink" title="创建CRDs"></a>创建CRDs</h3><pre class="line-numbers language-bash"><code class="language-bash">kubectl apply --validate<span class="token operator">=</span>false -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.12/deploy/manifests/00-crds.yaml或kubectl create -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.12/deploy/manifests/00-crds.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><blockquote><p>这里设置了两个默认值<br>–set ingressShim.defaultIssuerName=<font color="red"><strong>letsencrypt-prod</strong></font><br>–set ingressShim.defaultIssuerKind=ClusterIssuer<br>–set ingressShim.defaultIssuerGroup=cert-manager.io<br>用于在后续创建Ingress时，配合annotations<br>kubernetes.io/tls-acme: “true”<br>kubernetes.io/ingress.class: “nginx”<br>实现<strong>自动创建</strong>证书。</p></blockquote><pre class="line-numbers language-bash"><code class="language-bash">helm <span class="token function">install</span> --name cert-manager --namespace cert-manager --set ingressShim.defaultIssuerName<span class="token operator">=</span>letsencrypt-prod --set ingressShim.defaultIssuerKind<span class="token operator">=</span>ClusterIssuer --set ingressShim.defaultIssuerGroup<span class="token operator">=</span>cert-manager.io jetstack/cert-manager<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="查看安装是否完成"><a href="#查看安装是否完成" class="headerlink" title="查看安装是否完成"></a>查看安装是否完成</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master cert<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get pod -n cert-manager</span>NAME                                      READY   STATUS    RESTARTS   AGEcert-manager-5cd477f7bb-fxpvf             1/1     Running   0          22mcert-manager-cainjector-df4dc78cd-l527b   1/1     Running   0          22mcert-manager-webhook-5f78ff89bc-ggvqt     1/1     Running   0          22m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master cert<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get crd | grep cert-manager</span>certificaterequests.cert-manager.io         2020-01-07T01:38:32Zcertificates.cert-manager.io                2020-01-07T01:38:32Zchallenges.acme.cert-manager.io             2020-01-07T01:38:32Zclusterissuers.cert-manager.io              2020-01-07T01:38:32Zissuers.cert-manager.io                     2020-01-07T01:38:32Zorders.acme.cert-manager.io                 2020-01-07T01:38:32Z<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="创建默认签发机构"><a href="#创建默认签发机构" class="headerlink" title="创建默认签发机构"></a>创建默认签发机构</h3><p>刚刚安装时已经指定了默认签发类型是<code>ClusterIssuer</code> ，签发机构名称是<code>letsencrypt-prod</code> ，但是我们还没有创建，现在需要创建<code>cluster-issuer.yaml</code>。 </p><blockquote><p>cert-manager 给我们提供了 <code>Issuer</code> 和 <code>ClusterIssuer</code> 这两种用于创建签发机构的自定义资源对象，<code>Issuer</code> 只能用来签发自己所在 namespace 下的证书，<code>ClusterIssuer</code> 可以签发任意 namespace 下的证书.</p></blockquote><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> cert<span class="token punctuation">-</span>manager.io/v1alpha2<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterIssuer<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> letsencrypt<span class="token punctuation">-</span>prod<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">acme</span><span class="token punctuation">:</span>    <span class="token key atrule">server</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//acme<span class="token punctuation">-</span>v02.api.letsencrypt.org/directory    <span class="token key atrule">email</span><span class="token punctuation">:</span> 1154365135@qq.com    <span class="token key atrule">privateKeySecretRef</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> letsencrypt<span class="token punctuation">-</span>prod    <span class="token key atrule">solvers</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">http01</span><span class="token punctuation">:</span>        <span class="token key atrule">ingress</span><span class="token punctuation">:</span>          <span class="token key atrule">class</span><span class="token punctuation">:</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>上述配置，更多配置参考<a href="https://cert-manager.io/docs/reference/api-docs/#cert-manager.io/v1alpha2.ClusterIssuer" target="_blank" rel="noopener">ClusterIssuer</a></p><ul><li><code>metadata.name</code> 是我们创建的签发机构的名称，后面我们创建证书的时候会引用它</li><li><code>spec.acme.email</code> 是你自己的邮箱，证书快过期的时候会有邮件提醒，不过 cert-manager 会利用 acme 协议自动给我们重新颁发证书来续期</li><li><code>spec.acme.server</code> 是 acme 协议的服务端，我们这里用 Let’s Encrypt，这个地址就写死成这样就行</li><li><code>spec.acme.privateKeySecretRef</code> 指示此签发机构的私钥将要存储到哪个 Secret 对象中，名称不重要</li><li><code>spec.acme.solvers.http01</code> 这里指示签发机构使用 HTTP-01 的方式进行 acme 协议 (还可以用 DNS 方式，acme 协议的目的是证明这台机器和域名都是属于你的，然后才准许给你颁发证书)</li></ul></blockquote><pre class="line-numbers language-bash"><code class="language-bash">kubectl create -f cluster-issuer.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash"><code class="language-bash">kubectl get clusterissuer<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="配置ingress"><a href="#配置ingress" class="headerlink" title="配置ingress"></a>配置ingress</h3><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">kubernetes.io/ingress.class</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">kubernetes.io/tls-acme</span><span class="token punctuation">:</span> <span class="token string">"true"</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/backend-protocol</span><span class="token punctuation">:</span> HTTPS    <span class="token key atrule">nginx.ingress.kubernetes.io/ssl-redirect</span><span class="token punctuation">:</span> <span class="token string">"true"</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard    <span class="token key atrule">chart</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>1.10.0    <span class="token key atrule">heritage</span><span class="token punctuation">:</span> Tiller    <span class="token key atrule">release</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> k8s.deri.com    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">443</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /  <span class="token key atrule">tls</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> k8s.deri.com    <span class="token key atrule">secretName</span><span class="token punctuation">:</span> deri<span class="token punctuation">-</span>com<span class="token punctuation">-</span>tls<span class="token punctuation">-</span>secret<span class="token punctuation">-</span>cc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>由于添加了<code>annotations kubernetes.io/tls-acme: "true"</code>，tls这个secret会自动创建。</p><blockquote><p>创建完成后隔一会儿我们可以看到会多出现一个随机名称的 Ingress 对象<code>cm-acme-http-solver-hl5sx</code>，这个 Ingress 对象就是用来专门验证证书的：</p><pre class="line-numbers language-bash"><code class="language-bash">$ kubectl get ingress -n gatewayNAME                        HOSTS                   ADDRESS   PORTS     AGEcm-acme-http-solver-hl5sx   cs.deri.com             80        37skube-ui                     cs.deri.com             80, 443   41s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></blockquote><p>验证成功后，这个 Ingress 对象会自动删除.</p><h3 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h3><pre class="line-numbers language-bash"><code class="language-bash">helm delete --purge cert-manager<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash"><code class="language-bash">kubectl delete -f https://raw.githubusercontent.com/jetstack/cert-manager/release-0.12/deploy/manifests/00-crds.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="Check"><a href="#Check" class="headerlink" title="Check"></a>Check</h3><p>检查服务是否正常</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get certificate -n gateway </span>NAME              READY   SECRET            AGEconsul-tls-test   True    consul-tls-test   19m<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get clusterissuer</span>NAME               READY   AGEletsencrypt-prod   True    157m<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get certificate -n gateway </span>NAME              READY   SECRET            AGEconsul-tls-test   True    consul-tls-test   19m<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get Order -n gateway</span>NAME                                    STATE   AGEconsul-tls-test-3546184973-1845474898   valid   20m<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get  CertificateRequest -n gateway</span>NAME                         READY   AGEconsul-tls-test-3546184973   True    27m<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get secret -ngateway</span>NAME                      TYPE                                  DATA   AGEconsul-tls-test           kubernetes.io/tls                     3      29m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="用到的镜像"><a href="#用到的镜像" class="headerlink" title="用到的镜像"></a>用到的镜像</h3><pre><code>quay.io/jetstack/cert-manager-cainjector:v0.12.0quay.io/jetstack/cert-manager-webhook:v0.12.0quay.io/jetstack/cert-manager-controller:v0.12.0#这里由于上面配置solve是acme所以用到这个镜像，如果你配置别的，可能不一致quay.io/jetstack/cert-manager-acmesolver:v0.12.0</code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> cert-manager </tag>
            
            <tag> 证书 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>docker拉取国外镜像失败【quay.io和gcr.io解决办法】</title>
      <link href="/2020/01/07/docker-la-qu-guo-wai-jing-xiang-shi-bai-quay-io-he-gcr-io-jie-jue-ban-fa/"/>
      <url>/2020/01/07/docker-la-qu-guo-wai-jing-xiang-shi-bai-quay-io-he-gcr-io-jie-jue-ban-fa/</url>
      
        <content type="html"><![CDATA[<blockquote><p>使用国内镜像源。</p></blockquote><h3 id="quay-io"><a href="#quay-io" class="headerlink" title="quay.io"></a>quay.io</h3><p>例如下面拉取比较慢</p><pre class="line-numbers language-bash"><code class="language-bash">docker pull quay.io/jetstack/cert-manager-cainjector:v0.12.0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>可以换成</p><pre class="line-numbers language-bash"><code class="language-bash">docker pull quay-mirror.qiniu.com/jetstack/cert-manager-cainjector:v0.12.0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="gcr-io"><a href="#gcr-io" class="headerlink" title="gcr.io"></a>gcr.io</h3><p>例如下面拉取比较慢</p><pre class="line-numbers language-bash"><code class="language-bash">docker pull gcr.io/google_containers/kube-proxy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>可以换成阿里云的</p><pre class="line-numbers language-bash"><code class="language-bash">docker pull registry.aliyuncs.com/google_containers/kube-proxy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="下载完成"><a href="#下载完成" class="headerlink" title="下载完成"></a>下载完成</h3><p>可以使用tag命令改回去</p><pre class="line-numbers language-bash"><code class="language-bash">docker tag <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
            <tag> quay.io </tag>
            
            <tag> gcr.io </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s问题【删除namespace一直处于Terminating状态】</title>
      <link href="/2020/01/03/k8s-wen-ti-shan-chu-namespace-yi-zhi-chu-yu-terminating-zhuang-tai/"/>
      <url>/2020/01/03/k8s-wen-ti-shan-chu-namespace-yi-zhi-chu-yu-terminating-zhuang-tai/</url>
      
        <content type="html"><![CDATA[<blockquote><p><code>kubernetes</code>在删除<code>namespace</code>时，或多或少出现过删除后一直处于<code>Terminating</code>状态，这时又该如何删除呢？<br>本文介绍各种手段删除处于<code>Terminating</code>状态的<code>namespace</code>。</p></blockquote><h3 id="一般删除"><a href="#一般删除" class="headerlink" title="一般删除"></a>一般删除</h3><pre class="line-numbers language-bash"><code class="language-bash">kubectl delete namespace NAMESPACENAME<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="强制删除"><a href="#强制删除" class="headerlink" title="强制删除"></a>强制删除</h3><pre class="line-numbers language-bash"><code class="language-bash">kubectl delete namespace NAMESPACENAME --force --grace-period<span class="token operator">=</span>0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="删除finalizers"><a href="#删除finalizers" class="headerlink" title="删除finalizers"></a>删除finalizers</h3><blockquote><p>修改<code>namespace</code>配置，删除<font color="red">红色框</font>中内容</p></blockquote><pre class="line-numbers language-bash"><code class="language-bash">kubectl edit namespace NAMESPACE_NAME<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><img src="/images/k8s_namespace.jpg" alt="NAMESPACE"></p><h3 id="调用接口删除"><a href="#调用接口删除" class="headerlink" title="调用接口删除"></a>调用接口删除</h3><blockquote><p>也有可能，上述方法中没有看到<code>finalizers</code>，这时可以通过调用接口的方式删除</p></blockquote><ul><li>第一步：将namespace内容导出到tmp.json文件中：</li></ul><pre class="line-numbers language-bash"><code class="language-bash">kubectl get namespace NAMESPACE_NAME -o json <span class="token operator">></span> tmp.json<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><p>第二步：修改tmp.json内容，删除json中以下内容：</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  //删除spec整个内容  <span class="token property">"spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span>      <span class="token property">"finalizers"</span><span class="token operator">:</span> <span class="token punctuation">[</span>          <span class="token string">"kubernetes"</span>      <span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token property">"status"</span><span class="token operator">:</span> <span class="token punctuation">{</span>      <span class="token property">"phase"</span><span class="token operator">:</span> <span class="token string">"Terminating"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>第三步：开启k8s接口代理，新开一个窗口，执行</p></li></ul><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl proxy</span>Starting to serve on 127.0.0.1:8001<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>第四步：调用接口删除<code>Namespace</code>，注意URL中修改成要删除的<code>NAMESPACE_NAME</code></li></ul><pre class="line-numbers language-bash"><code class="language-bash">curl -k -H <span class="token string">"Content-Type: application/json"</span> -X PUT --data-binary @tmp.json http://127.0.0.1:8001/api/v1/namespaces/NAMESPACE_NAME/finalize<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> namespace </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>istio使用【CRDs】</title>
      <link href="/2020/01/03/istio-shi-yong-crds/"/>
      <url>/2020/01/03/istio-shi-yong-crds/</url>
      
        <content type="html"><![CDATA[<blockquote><p><strong>本文使用istio版本号：<font size="4" color="#D2691E">1.4.2</font></strong></p></blockquote><blockquote><p> Istio安装时，第一步就是创建了各种自定义资源类型（CRD），参考<a href="">istio部署【在kubernetes上部署】</a>，其中最重要的几个CRD包括：<strong>Gateway</strong>、<strong>VirtualService</strong>、<strong>DestinationRule</strong>、<strong>ServiceEntry</strong>。主要架构如下图：<br><img src="/images/istio_CRDs.jpg" alt="CRDs"></p></blockquote><h2 id="DestinationRule"><a href="#DestinationRule" class="headerlink" title="DestinationRule"></a>DestinationRule</h2><p>DestinationRule用于定义目标服务的访问策略，如在subset定义版本，定义负载均衡策略，熔断，一级TLS等。</p><h3 id="基本示例"><a href="#基本示例" class="headerlink" title="基本示例"></a>基本示例</h3><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1    <span class="token key atrule">labels</span><span class="token punctuation">:</span>      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2    <span class="token key atrule">labels</span><span class="token punctuation">:</span>      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="定义负载均衡策略"><a href="#定义负载均衡策略" class="headerlink" title="定义负载均衡策略"></a>定义负载均衡策略</h3><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews  <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>    <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>      <span class="token key atrule">simple</span><span class="token punctuation">:</span> RANDOM  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1    <span class="token key atrule">labels</span><span class="token punctuation">:</span>      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2    <span class="token key atrule">labels</span><span class="token punctuation">:</span>      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2    <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>      <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>        <span class="token key atrule">simple</span><span class="token punctuation">:</span> ROUND_ROBIN<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="定义熔断器"><a href="#定义熔断器" class="headerlink" title="定义熔断器"></a>定义熔断器</h3><p>参考<a href="https://istio.io/docs/tasks/traffic-management/circuit-breaking/" target="_blank" rel="noopener">官网</a></p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1    <span class="token key atrule">labels</span><span class="token punctuation">:</span>      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1    <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>      <span class="token key atrule">connectionPool</span><span class="token punctuation">:</span>        <span class="token key atrule">tcp</span><span class="token punctuation">:</span>          <span class="token key atrule">maxConnections</span><span class="token punctuation">:</span> <span class="token number">100</span>      <span class="token key atrule">http</span><span class="token punctuation">:</span>        <span class="token key atrule">http1MaxPendingRequests</span><span class="token punctuation">:</span> <span class="token number">100</span>        <span class="token key atrule">maxRequestsPerConnection</span><span class="token punctuation">:</span> <span class="token number">100</span>    <span class="token key atrule">outlierDetection</span><span class="token punctuation">:</span>      <span class="token key atrule">consecutiveErrors</span><span class="token punctuation">:</span> <span class="token number">1</span>      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 1s      <span class="token key atrule">baseEjectionTime</span><span class="token punctuation">:</span> 3m      <span class="token key atrule">maxEjectionPercent</span><span class="token punctuation">:</span> <span class="token number">100</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="VirtualService"><a href="#VirtualService" class="headerlink" title="VirtualService"></a>VirtualService</h2><p>VirtualService是最重要的配置接口，定义服务的所有路由规则，包括条件判断、权重、路径重写等。</p><h3 id="定义权重示例"><a href="#定义权重示例" class="headerlink" title="定义权重示例"></a>定义权重示例</h3><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> reviews  <span class="token key atrule">http</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">90</span>    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="定义超时和重试策略"><a href="#定义超时和重试策略" class="headerlink" title="定义超时和重试策略"></a>定义超时和重试策略</h3><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> ratings  <span class="token key atrule">http</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 10s    <span class="token key atrule">retries</span><span class="token punctuation">:</span>      <span class="token key atrule">attempts</span><span class="token punctuation">:</span> <span class="token number">3</span>      <span class="token key atrule">perTryTimeout</span><span class="token punctuation">:</span> 2s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="故障注入：模拟失败的场景"><a href="#故障注入：模拟失败的场景" class="headerlink" title="故障注入：模拟失败的场景"></a>故障注入：模拟失败的场景</h3><p>参考<a href="https://istio.io/docs/tasks/traffic-management/fault-injection/" target="_blank" rel="noopener">Fault Injection</a></p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> ratings  <span class="token key atrule">http</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">fault</span><span class="token punctuation">:</span>      <span class="token comment" spellcheck="true">#定义10%请求+5秒延迟， 也可以是percent: 10</span>      <span class="token key atrule">delay</span><span class="token punctuation">:</span>        <span class="token key atrule">percentage</span><span class="token punctuation">:</span>          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">10</span>        <span class="token key atrule">fixedDelay</span><span class="token punctuation">:</span> 5s      <span class="token comment" spellcheck="true">#定义10%请求返回400错误， 也可以是percent: 10</span>      <span class="token key atrule">abort</span><span class="token punctuation">:</span>        <span class="token key atrule">percentage</span><span class="token punctuation">:</span>          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">10</span>        <span class="token key atrule">httpStatus</span><span class="token punctuation">:</span> <span class="token number">400</span>    <span class="token key atrule">route</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>        <span class="token key atrule">host</span><span class="token punctuation">:</span> ratings        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="条件判断——标签"><a href="#条件判断——标签" class="headerlink" title="条件判断——标签"></a>条件判断——标签</h3><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> ratings  <span class="token key atrule">http</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">sourceLabels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> reviews        <span class="token key atrule">version</span><span class="token punctuation">:</span> v2    <span class="token punctuation">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="条件判断——Header"><a href="#条件判断——Header" class="headerlink" title="条件判断——Header"></a>条件判断——Header</h3><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> reviews  <span class="token key atrule">http</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>        <span class="token key atrule">end-user</span><span class="token punctuation">:</span>          <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason    <span class="token key atrule">route</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="条件判断——URI路径"><a href="#条件判断——URI路径" class="headerlink" title="条件判断——URI路径"></a>条件判断——URI路径</h3><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> productpage<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> productpage  <span class="token key atrule">http</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /api/v1    <span class="token punctuation">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="多条件判断"><a href="#多条件判断" class="headerlink" title="多条件判断"></a>多条件判断</h3><p>如果是嵌套在一个匹配语句中，为<font color="red"><strong>AND</strong></font>关系。</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> ratings  <span class="token key atrule">http</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">sourceLabels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> reviews        <span class="token key atrule">version</span><span class="token punctuation">:</span> v2      <span class="token key atrule">headers</span><span class="token punctuation">:</span>        <span class="token key atrule">end-user</span><span class="token punctuation">:</span>          <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason    <span class="token punctuation">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果是单独的匹配语句，为<font color="red"><strong>OR</strong></font>关系。</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ratings<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> ratings  <span class="token key atrule">http</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">sourceLabels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> reviews        <span class="token key atrule">version</span><span class="token punctuation">:</span> v2    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>        <span class="token key atrule">end-user</span><span class="token punctuation">:</span>          <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason    <span class="token punctuation">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ServiceEntry"><a href="#ServiceEntry" class="headerlink" title="ServiceEntry"></a>ServiceEntry</h2><p>将外部服务接入到服务注册表中，让Istio中自动发现的服务能够访问和路由到这些手工加入的服务。与<code>VirtualService</code>或<code>DestinationRule</code>配合使用。</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceEntry<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> foo<span class="token punctuation">-</span>ext<span class="token punctuation">-</span>svc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> *.foo.com  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> http    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP  <span class="token punctuation">-</span> <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">443</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> https    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTPS<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> bar<span class="token punctuation">-</span>foo<span class="token punctuation">-</span>ext<span class="token punctuation">-</span>svc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> bar.foo.com  <span class="token key atrule">http</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>        <span class="token key atrule">host</span><span class="token punctuation">:</span> bar.foo.com    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 10s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Gateway"><a href="#Gateway" class="headerlink" title="Gateway"></a>Gateway</h2><p>提供外部服务访问接入，可发布任意内部端口的服务，供外部访问。配合<code>VirtualService</code>使用。</p><p>Bookinfo示例:</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> bookinfo<span class="token punctuation">-</span>gateway<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway <span class="token comment" spellcheck="true"># use istio default controller</span>  <span class="token key atrule">servers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token string">"*"</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> bookinfo<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token string">"*"</span>  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> bookinfo<span class="token punctuation">-</span>gateway  <span class="token key atrule">http</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>        <span class="token key atrule">exact</span><span class="token punctuation">:</span> /productpage    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /static    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>        <span class="token key atrule">exact</span><span class="token punctuation">:</span> /login    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>        <span class="token key atrule">exact</span><span class="token punctuation">:</span> /logout    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /api/v1/products    <span class="token key atrule">route</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>        <span class="token key atrule">host</span><span class="token punctuation">:</span> productpage        <span class="token key atrule">port</span><span class="token punctuation">:</span>          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">9080</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> istio </tag>
            
            <tag> CRDs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>docker镜像导入导出</title>
      <link href="/2019/12/31/docker-jing-xiang-dao-ru-dao-chu/"/>
      <url>/2019/12/31/docker-jing-xiang-dao-ru-dao-chu/</url>
      
        <content type="html"><![CDATA[<p>docker镜像导入导出有两种方式</p><ul><li>export/import</li><li>load/save</li></ul><h3 id="export-import"><a href="#export-import" class="headerlink" title="export/import"></a>export/import</h3><pre><code>docker export -o "导出的镜像文件名.tar" CONTATINERdocker import "导出的镜像文件名.tar" "镜像名:版本号"</code></pre><h3 id="load-save"><a href="#load-save" class="headerlink" title="load/save"></a>load/save</h3><pre><code>docker load --input "导出的镜像文件名.tar"docker save -o "导出的镜像文件名.tar" "要导出的镜像名"</code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
            <tag> docker镜像导入/导出 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s修改POD内核参数【sysctl】</title>
      <link href="/2019/12/31/k8s-xiu-gai-pod-nei-he-can-shu-sysctl/"/>
      <url>/2019/12/31/k8s-xiu-gai-pod-nei-he-can-shu-sysctl/</url>
      
        <content type="html"><![CDATA[<p>有时候需要在启动POD前，修改POD内核相关参数，除了使用<code>initContainer</code>还可以使用<code>sysctl</code>。<br>参考<a href="https://kubernetes.io/docs/tasks/administer-cluster/sysctl-cluster/" target="_blank" rel="noopener">链接Using sysctls in a Kubernetes Cluster</a></p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> sysctl<span class="token punctuation">-</span>example<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>    <span class="token key atrule">sysctls</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kernel.shm_rmid_forced      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"0"</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> net.core.somaxconn      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"1024"</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kernel.msgmax      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"65536"</span>  <span class="token punctuation">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> sysctl </tag>
            
            <tag> pod </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DevOps与CI/CD</title>
      <link href="/2019/12/31/devops-yu-cicd/"/>
      <url>/2019/12/31/devops-yu-cicd/</url>
      
        <content type="html"><![CDATA[<h2 id="了解-DevOps"><a href="#了解-DevOps" class="headerlink" title="了解 DevOps"></a>了解 DevOps</h2><p>DevOps 是指对企业文化、业务自动化和平台设计等方面进行全方位变革，从而实现迅捷、优质的服务交付，提升企业响应能力和价值。只有通过快速迭代的 IT 服务交付，这一切才能实现。<code>DevOps</code>可以将传统应用和最新的云原生应用与基础架构彼此相连。</p><h2 id="DevOps简介"><a href="#DevOps简介" class="headerlink" title="DevOps简介"></a>DevOps简介</h2><p>DevOps 就是开发（Development）、测试（QA）、运维（Operations）这三个领域的合并。<br><img src="/images/DevOps.jpg" alt="DevOps"></p><p>从字面上来看，”DevOps”一词是由英文 <code>Development</code>（开发）和 <code>Operations</code> （运维）组合而成，但它所代表的理念和实践要比这广阔的多。DevOps 涵盖了安全、协作方式、数据分析等许多方面。</p><p>DevOps 强调通过一系列手段来实现既快又稳的工作流程，使每个想法（比如一个新的软件功能，一个功能增强请求或者一个 bug 修复）在从开发到生产环境部署的整个流程中，都能不断地为用户带来价值。这种方式需要开发团队和运维团队密切交流、高效协作并且彼此体谅。此外，DevOps 还要能够方便扩展，灵活部署。有了 DevOps，需求最迫切的工作就能通过自助服务和自动化得到解决；通常在标准开发环境编写代码的开发人员也可与 IT 运维人员紧密合作，加速软件的构建、测试和发布，同时保障开发成果的稳定可靠。</p><h2 id="容器与-DevOps-有什么关系？"><a href="#容器与-DevOps-有什么关系？" class="headerlink" title="容器与 DevOps 有什么关系？"></a>容器与 DevOps 有什么关系？</h2><p>DevOps 可以加快一个想法从提出到部署的整个过程。DevOps 的核心在于，在应用的整个生命周期中，都要确保日常<strong>运维任务自动化和环境的标准化</strong>。容器可以提供标准化的环境，你需要一个平台来管理它们，同时提供内置的自动化功能并支持各种基础架构。</p><h2 id="DevOps-与-CI-CD"><a href="#DevOps-与-CI-CD" class="headerlink" title="DevOps 与 CI/CD"></a>DevOps 与 CI/CD</h2><p>选择支持流程的工具对于 DevOps 的成功至关重要。运维团队要跟上快速开发周期，就需要利用高度灵活的平台，并像开发团队对待代码一样，对待平台的基础架构。手动部署不仅速度慢，而且可能出错。因此，您也可通过自动化来简化平台调配和部署。</p><p>持续集成和持续部署管道（CI/CD）是实施 DevOps 的一大重要成果。CI/CD 可帮助您频繁地向客户交付应用并检验软件质量，而且只需极少的人工干预。</p><p>具体而言，CI/CD 在整个应用生命周期内（从集成和测试阶段，到交付和部署）都引入了持续自动化和持续监控，让您能够快速识别和改正问题与缺陷。这些彼此关联的实践通常被统称为“CI/CD 管道”，需要开发和运维团队以敏捷方式协同支持。</p><h2 id="CICD简介"><a href="#CICD简介" class="headerlink" title="CICD简介"></a>CICD简介</h2><ul><li>持续集成（Continuous Integration ，CI）</li><li>持续交付（Continuous Delivery）</li><li>持续部署（Continuous Deploy）</li></ul><p>参考<a href="https://www.jianshu.com/p/654505d42180" target="_blank" rel="noopener">链接</a></p><h2 id="云原生CICD实现"><a href="#云原生CICD实现" class="headerlink" title="云原生CICD实现"></a>云原生CICD实现</h2><p><img src="/images/CICD.jpg" alt="CICD"><br>流程：</p><ol><li>用户本地完成开发；</li><li>代码提交到<code>GitLab</code>上；</li><li>Gitlab收到代码提交请求后通过webhook触发Jenkins;</li><li><code>Jenkins</code>被触发后，首先从代码仓库拉取源码，进行构建、静态分析和单元测试，然后创建镜像推送到镜像仓库<code>Harbor</code>，最后调用<code>Kubernetes API</code>更新应用；</li><li>Kubernetes从Harbor拉取最新镜像，更新应用。</li></ol><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DevOps </tag>
            
            <tag> CI/CD </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mybatis注解方式动态拼接SQL</title>
      <link href="/2019/12/31/mybatis-zhu-jie-fang-shi-dong-tai-pin-jie-sql/"/>
      <url>/2019/12/31/mybatis-zhu-jie-fang-shi-dong-tai-pin-jie-sql/</url>
      
        <content type="html"><![CDATA[<p>在spring boot中，集成Mybatis可以使用完全注解的方式，完全不用新增任何配置文件。多条件判断，可以使用<code>&lt;script&gt;</code>和<code>&lt;set&gt;</code>搭配实现。</p><h3 id="Update"><a href="#Update" class="headerlink" title="@Update"></a>@Update</h3><pre><code>@Update("&lt;script&gt;update t_user " +        "&lt;set&gt; " +        "&lt;if test='userName != null'&gt; user_name = #{userName},&lt;/if&gt;" +        "&lt;if test='userPwd != null'&gt; user_pwd = #{userPwd},&lt;/if&gt;" +        "&lt;if test='userRemark != null'&gt; user_remark = #{userRemark},&lt;/if&gt;" +        "&lt;if test='userPhone != null'&gt; user_phone = #{userPhone},&lt;/if&gt;" +        "&lt;if test='userEmail != null'&gt; user_email = #{userEmail},&lt;/if&gt;" +        "&lt;/set&gt; " +        "where user_id = #{userId}&lt;/script&gt;")</code></pre><h3 id="Select"><a href="#Select" class="headerlink" title="@Select"></a>@Select</h3><pre><code>@Select("select id,name,description,enabled,deleted,date_created as dateCreated,last_modified as lastModified from admin_role (#{roleParam})")</code></pre><h3 id="Insert"><a href="#Insert" class="headerlink" title="@Insert"></a>@Insert</h3><pre><code>@Insert("insert into t_alert_log (alert_name,severity,message,start_at,end_at) " +            "values(#{alertName},#{severity},#{message},#{startAt},#{endAt})")@Options(useGeneratedKeys = true, keyProperty = "id", keyColumn = "id")</code></pre><h3 id="Update-1"><a href="#Update-1" class="headerlink" title="@Update"></a>@Update</h3><pre><code>@Update("update t_alert_log set status=true,remark=#{remark} where token=#{token}")</code></pre><h3 id="ResultType"><a href="#ResultType" class="headerlink" title="@ResultType"></a>@ResultType</h3><pre><code>@ResultType(String.class)</code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> spring boot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mybatis注解 </tag>
            
            <tag> 动态sql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>helm常用命令总结</title>
      <link href="/2019/12/30/helm-chang-yong-ming-ling-zong-jie/"/>
      <url>/2019/12/30/helm-chang-yong-ming-ling-zong-jie/</url>
      
        <content type="html"><![CDATA[<blockquote><h2 id="Helm用途"><a href="#Helm用途" class="headerlink" title="Helm用途"></a>Helm用途</h2><p>做为Kubernetes的一个包管理工具，Helm具有如下功能：</p><ul><li>创建新的chart</li><li>chart打包成tgz格式</li><li>上传chart到chart仓库或从仓库中下载chart</li><li>在Kubernetes集群中安装或卸载chart</li><li>管理用Helm安装的chart的发布周期<br>Helm有三个重要概念：</li><li>chart：包含了创建Kubernetes的一个应用实例的必要信息</li><li>config：包含了应用发布配置信息</li><li>release：是一个chart及其配置的一个运行实例</li></ul></blockquote><h2 id="Helm常用命令"><a href="#Helm常用命令" class="headerlink" title="Helm常用命令"></a>Helm常用命令</h2><table><thead><tr><th>操作类型</th><th>命令</th></tr></thead><tbody><tr><td>添加仓库</td><td>helm repo add loki <a href="https://grafana.github.io/loki/charts" target="_blank" rel="noopener">https://grafana.github.io/loki/charts</a></td></tr><tr><td>更新仓库</td><td>helm repo update</td></tr><tr><td>查看helm仓库列表</td><td>helm repo list</td></tr><tr><td>查看本地已安装的包</td><td>helm list (ls)</td></tr><tr><td>查看全部release(包括删除的…)</td><td>helm list -a</td></tr><tr><td>查看helm版本</td><td>helm version</td></tr><tr><td>删除release</td><td>helm delete loki</td></tr><tr><td>设置安装release名称</td><td>–name test</td></tr><tr><td>设置安装的namespace</td><td>–namespace test</td></tr><tr><td>设置自定义属性</td><td>–set “loki.serviceName=loki”</td></tr><tr><td>从文件读取自定义属性集合</td><td>-f values.yaml</td></tr><tr><td>查找本地release的版本列表</td><td>helm search testapi -l</td></tr><tr><td>指定charts版本</td><td>–version 8.2.4</td></tr><tr><td>查看安装历史</td><td>helm history prometheus-operator</td></tr><tr><td>版本回滚</td><td>helm rollback prometheus-operator 1</td></tr><tr><td>打包chart</td><td>helm package mychart</td></tr><tr><td>获取charts</td><td>helm fetch stable/mysql –version 0.2.8 –untar</td></tr><tr><td>检查chart是否存在问题</td><td>helm lint mysql</td></tr><tr><td>创建一个本地仓库</td><td>helm serve –address 0.0.0.0:8879 –repo-path ./charts</td></tr><tr><td>创建一个chart</td><td>helm create mychart</td></tr><tr><td>查看release状态</td><td>helm status mysql</td></tr><tr><td>更新release</td><td>helm upgrade mysql -f mysql/values.yaml –set resources.requests.memory=1024Mi mysql</td></tr><tr><td>查看指定release的历史版本部署时部分配置信息</td><td>helm get –revision 1 mysql</td></tr><tr><td>对chart的模板和配置进行测试</td><td>helm install –dry-run –debug ./</td></tr><tr><td>查看release默认配置</td><td>helm inspect values stable/prometheus-operator</td></tr></tbody></table><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> helm常用命令 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Istio使用【Bookinfo示例之简单路由管理】</title>
      <link href="/2019/12/30/istio-shi-yong-bookinfo-shi-li-zhi-jian-dan-lu-you-guan-li/"/>
      <url>/2019/12/30/istio-shi-yong-bookinfo-shi-li-zhi-jian-dan-lu-you-guan-li/</url>
      
        <content type="html"><![CDATA[<blockquote><p><strong>本文使用的istio版本：<code>1.4.2</code></strong></p></blockquote><blockquote><p>上章内容只是简单运行了<code>Bookinfo</code>示例（<a href="">Istio使用【Bookinfo示例】</a>），访问页面，<code>Reviews</code>虽然有三个版本，但是刷新浏览器，三个版本是随机返回。本章内容仍然使用官方样例配置，定义一些自定义路由规则。在这之前最好了解下<a href="https://haolin.club/2020/01/03/istio-shi-yong-crds/">Istio使用【CRDs】</a>。</p></blockquote><h3 id="创建所有服务的DestinationRule"><a href="#创建所有服务的DestinationRule" class="headerlink" title="创建所有服务的DestinationRule"></a>创建所有服务的<code>DestinationRule</code></h3><pre class="line-numbers language-bash"><code class="language-bash">kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="定义V1和V2版本8-2比重，V3不返回"><a href="#定义V1和V2版本8-2比重，V3不返回" class="headerlink" title="定义V1和V2版本8:2比重，V3不返回"></a>定义<code>V1</code>和<code>V2</code>版本<code>8:2</code>比重，<code>V3</code>不返回</h3><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> reviews  <span class="token key atrule">http</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">20</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="定义如果Header中包含jason用户返回V2版本，否则返回V3版本"><a href="#定义如果Header中包含jason用户返回V2版本，否则返回V3版本" class="headerlink" title="定义如果Header中包含jason用户返回V2版本，否则返回V3版本"></a>定义如果<code>Header</code>中包含<code>jason</code>用户返回<code>V2</code>版本，否则返回<code>V3</code>版本</h3><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> reviews<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> reviews  <span class="token key atrule">http</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>        <span class="token key atrule">end-user</span><span class="token punctuation">:</span>          <span class="token key atrule">exact</span><span class="token punctuation">:</span> jason    <span class="token key atrule">route</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>        <span class="token key atrule">host</span><span class="token punctuation">:</span> reviews        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其它可以参考<code>samples/bookinfo/networking/</code>目录下配置。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> istio </tag>
            
            <tag> bookinfo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Istio使用【Bookinfo示例】</title>
      <link href="/2019/12/26/istio-shi-yong-bookinfo-shi-li/"/>
      <url>/2019/12/26/istio-shi-yong-bookinfo-shi-li/</url>
      
        <content type="html"><![CDATA[<h3 id="Bookinfo示例简介"><a href="#Bookinfo示例简介" class="headerlink" title="Bookinfo示例简介"></a>Bookinfo示例简介</h3><p><code>Bookinfo</code>是<code>istio</code>官网示例，应用程序分为四个单独的微服务：</p><ul><li><code>productpage</code>。该<code>productpage</code>微服务调用<code>details</code>和<code>reviews</code>微服务来填充页面。</li><li><code>details</code>。该<code>details</code>微服务包含图书信息。</li><li><code>reviews</code>。该<code>reviews</code>微服务包含了书评。它们调用<code>ratings</code>微服务。</li><li><code>ratings</code>。该<code>ratings</code>微服务包含预定伴随书评排名信息。</li></ul><p><code>reviews</code>微服务有3个版本：</p><ul><li>版本<code>v1</code>不会调用该<code>ratings</code>服务。</li><li>版本<code>v2</code>调用该<code>ratings</code>服务，并将每个等级显示为1到5个黑星<font color="black">★</font>。</li><li>版本<code>v3</code>调用该<code>ratings</code>服务，并将每个等级显示为1到5个红色星号<font color="red">★</font>。</li></ul><p><img src="/images/bookinfo1.jpg" alt="Bookinfo架构图"></p><h3 id="Bookinfo在Istio中架构"><a href="#Bookinfo在Istio中架构" class="headerlink" title="Bookinfo在Istio中架构"></a><code>Bookinfo</code>在<code>Istio</code>中架构</h3><p>如果想要在<code>Istio</code>中运行<code>Bookinfo</code>，<code>Bookinfo</code>本身不需要任何改动，只需要为<code>Bookinfo</code>的微服务注入<code>Istio</code>的<code>Sidecar</code>。最终架构图如下：</p><p><img src="/images/bookinfo2.jpg" alt="Bookinfo架构图"></p><p>所有的微服务都与<code>Envoy</code>边车打包在一起，该<code>Envoy</code>边车拦截对服务的出/入请求，并与<code>Istio</code>控制面交互，提供路由、采集、实施各种策略等。</p><h3 id="启动Bookinfo服务，参考官网"><a href="#启动Bookinfo服务，参考官网" class="headerlink" title="启动Bookinfo服务，参考官网"></a>启动<code>Bookinfo</code>服务，参考<a href="https://istio.io/docs/examples/bookinfo/" target="_blank" rel="noopener">官网</a></h3><h4 id="进入istio目录"><a href="#进入istio目录" class="headerlink" title="进入istio目录"></a>进入istio目录</h4><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master istio-1.4.2<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># pwd</span>/root/istio/istio-1.4.2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="设置namespace自动注入sidecar"><a href="#设置namespace自动注入sidecar" class="headerlink" title="设置namespace自动注入sidecar"></a>设置namespace自动注入sidecar</h4><pre class="line-numbers language-bash"><code class="language-bash">kubectl label namespace default istio-injection<span class="token operator">=</span>enabled<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="部署bookinfo服务"><a href="#部署bookinfo服务" class="headerlink" title="部署bookinfo服务"></a>部署bookinfo服务</h4><pre class="line-numbers language-bash"><code class="language-bash">kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>你也可以手动为这个yaml注入sidecar再部署，参考<a href="">Istio使用【sidecar注入】</a></p><pre class="line-numbers language-bash"><code class="language-bash">kubectl apply -f <span class="token operator">&lt;</span><span class="token punctuation">(</span>istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="确定启动完成"><a href="#确定启动完成" class="headerlink" title="确定启动完成"></a>确定启动完成</h4><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master istio-1.4.2<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get pod</span>NAME                                                       READY   STATUS    RESTARTS   AGEdetails-v1-74f858558f-7gx6r                                2/2     Running   0          31hproductpage-v1-8554d58bff-fwcj4                            2/2     Running   0          31hratings-v1-7855f5bcb9-r7z5l                                2/2     Running   0          31hreviews-v1-59fd8b965b-jppqr                                2/2     Running   0          31hreviews-v2-d6cfdb7d6-rx648                                 2/2     Running   0          31hreviews-v3-75699b5cfb-qpdjm                                2/2     Running   0          31h<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master istio-1.4.2<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get svc</span>NAME          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>     AGEdetails       ClusterIP   10.102.10.128    <span class="token operator">&lt;</span>none<span class="token operator">></span>        9080/TCP    31hproductpage   ClusterIP   10.110.251.239   <span class="token operator">&lt;</span>none<span class="token operator">></span>        9080/TCP    31hratings       ClusterIP   10.99.146.247    <span class="token operator">&lt;</span>none<span class="token operator">></span>        9080/TCP    31hreviews       ClusterIP   10.102.77.22     <span class="token operator">&lt;</span>none<span class="token operator">></span>        9080/TCP    31h<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="确定程序运行正常"><a href="#确定程序运行正常" class="headerlink" title="确定程序运行正常"></a>确定程序运行正常</h4><pre class="line-numbers language-bash"><code class="language-bash">kubectl <span class="token function">exec</span> -it <span class="token punctuation">$(</span>kubectl get pod -l app<span class="token operator">=</span>ratings -o jsonpath<span class="token operator">=</span><span class="token string">'{.items[0].metadata.name}'</span><span class="token punctuation">)</span> -c ratings -- curl productpage:9080/productpage <span class="token operator">|</span> <span class="token function">grep</span> -o <span class="token string">"&lt;title>.*&lt;/title>"</span><span class="token operator">&lt;</span>title<span class="token operator">></span>Simple Bookstore App<span class="token operator">&lt;</span>/title<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="定义应用的入口网关"><a href="#定义应用的入口网关" class="headerlink" title="定义应用的入口网关"></a>定义应用的入口网关</h4><pre class="line-numbers language-bash"><code class="language-bash">kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="确认网关已创建"><a href="#确认网关已创建" class="headerlink" title="确认网关已创建"></a>确认网关已创建</h4><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master istio-1.4.2<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get gateway</span>NAME               AGEbookinfo-gateway   30h<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>下面可以通过<code>Isito</code>的入口网关来访问了，在访问前，需要确定<code>Isito网关IP和端口</code>。</p><h3 id="获取Istio入口网关IP和端口：参考官网"><a href="#获取Istio入口网关IP和端口：参考官网" class="headerlink" title="获取Istio入口网关IP和端口：参考官网"></a>获取Istio入口网关IP和端口：参考<a href="https://istio.io/docs/tasks/traffic-management/ingress/ingress-control/#determining-the-ingress-ip-and-ports" target="_blank" rel="noopener">官网</a></h3><pre class="line-numbers language-bash"><code class="language-bash">kubectl get svc istio-ingressgateway -n istio-systemNAME                   TYPE           CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                                                                                                                                      AGEistio-ingressgateway   LoadBalancer   10.110.94.234   <span class="token operator">&lt;</span>pending<span class="token operator">></span>     15020:32344/TCP,80:31380/TCP,443:31390/TCP,31400:31400/TCP,15029:31933/TCP,15030:30470/TCP,15031:31361/TCP,15032:31151/TCP,15443:31081/TCP   2d2h<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>如果<code>EXTERNAL-IP</code>设置了该值，则您的环境具有可用于入口网关的外部负载平衡器。如果<code>EXTERNAL-IP</code>值是<code>&lt;none&gt;</code>（或永久<code>&lt;pending&gt;</code>），则您的环境不为入口网关提供外部负载平衡器。在这种情况下，您可以使用服务的节点端口来访问网关。</p><h4 id="确定端口"><a href="#确定端口" class="headerlink" title="确定端口"></a>确定端口</h4><ul><li><p>这里<code>80</code>对应的端口是<code>Http</code>服务的端口，映射的主机端口<code>31380</code>；</p></li><li><p>这里<code>443</code>对应的端口是<code>Https</code>服务的端口，映射的主机端口<code>31390</code>；</p></li></ul><h4 id="确定IP"><a href="#确定IP" class="headerlink" title="确定IP"></a>确定IP</h4><p>可以通过下面命令找个<code>hostIP</code></p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master istio-1.4.2<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get po -l istio=ingressgateway -n istio-system -o yaml | grep hostIP: -C3</span>---      state:        running:          startedAt: <span class="token string">"2019-12-24T06:46:29Z"</span>    hostIP: 192.168.1.212    phase: Running    podIP: 10.244.3.136    qosClass: Burstable---<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>也可以通过下面的命令找到Ingress部署的节点。</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master istio-1.4.2<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get po -l istio=ingressgateway -n istio-system -o wide</span>NAME                                    READY   STATUS    RESTARTS   AGE    IP             NODE     NOMINATED NODE   READINESS GATESistio-ingressgateway-6b7bfd7459-wljhh   1/1     Running   0          2d2h   10.244.3.136   k8s-02   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="访问Bookinfo应用"><a href="#访问Bookinfo应用" class="headerlink" title="访问Bookinfo应用"></a>访问Bookinfo应用</h3><p>浏览器访问刚刚或者的<code>IP</code>+<code>端口</code>+<code>/productpage</code>，例如我的是<a href="">http://192.168.1.212:31380/productpage</a></p><p><img src="/images/bookinfo3.jpg" alt="Reviewer-v1"><br><img src="/images/bookinfo4.jpg" alt="Reviewer-v2"><br><img src="/images/bookinfo5.jpg" alt="Reviewer-v3"></p><p>不停的刷新页面，可以看到返回的<code>Reviewer</code>是不同的版本。</p><h3 id="简单分析下"><a href="#简单分析下" class="headerlink" title="简单分析下"></a>简单分析下</h3><p>针对<code>samples/bookinfo/networking/bookinfo-gateway.yaml</code>，我们可以看看默认配置做了啥。</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token punctuation">[</span>root@k8s<span class="token punctuation">-</span>master istio<span class="token punctuation">-</span>1.4.2<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat samples/bookinfo/networking/bookinfo-gateway.yaml</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> bookinfo<span class="token punctuation">-</span>gateway<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway <span class="token comment" spellcheck="true"># use istio default controller</span>  <span class="token key atrule">servers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>      <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> http      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token string">"*"</span><span class="token punctuation">---</span><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> bookinfo<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token string">"*"</span>  <span class="token key atrule">gateways</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> bookinfo<span class="token punctuation">-</span>gateway  <span class="token key atrule">http</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>        <span class="token key atrule">exact</span><span class="token punctuation">:</span> /productpage    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /static    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>        <span class="token key atrule">exact</span><span class="token punctuation">:</span> /login    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>        <span class="token key atrule">exact</span><span class="token punctuation">:</span> /logout    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /api/v1/products    <span class="token key atrule">route</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>        <span class="token key atrule">host</span><span class="token punctuation">:</span> productpage        <span class="token key atrule">port</span><span class="token punctuation">:</span>          <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">9080</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>首先创建一个<code>Gateway</code>，这是<code>Istio</code>的一个自定义资源类型(<code>CRD</code>)，它创建了这个<code>bookinfo</code>应用的网关<code>bookinfo-gateway</code>，使用了<code>istio</code>默认的<code>controller——ingressgateway</code>，如上文，<code>istio</code>的<code>ingress</code>网关定义了很多类型端口，这里<code>bookinfo-gateway</code>使用了<code>80</code>端口，域名使用的通配符 <code>*</code> 。</p></li><li><p>定义<code>VirtualService</code>，这里需要绑定刚刚创建的<code>bookinfo-gateway</code>，定义了匹配的<code>URI</code>和后台服务。</p></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> istio </tag>
            
            <tag> bookinfo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Istio使用【链路监控】</title>
      <link href="/2019/12/26/istio-shi-yong-lian-lu-jian-kong/"/>
      <url>/2019/12/26/istio-shi-yong-lian-lu-jian-kong/</url>
      
        <content type="html"><![CDATA[<blockquote><p><strong>本文使用的istio版本：<code>1.4.2</code></strong></p></blockquote><h3 id="开启链路监控"><a href="#开启链路监控" class="headerlink" title="开启链路监控"></a>开启链路监控</h3><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token punctuation">...</span>.<span class="token comment" spellcheck="true">#</span><span class="token comment" spellcheck="true"># addon jaeger tracing configuration</span><span class="token comment" spellcheck="true">#</span><span class="token key atrule">tracing</span><span class="token punctuation">:</span>  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">...</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看出。<code>istio</code>链路监控集成使用的是<code>Jaeger</code>，<code>Jaeger</code>是什么，参考<a href="https://blog.csdn.net/wzy_168/article/details/103628084" target="_blank" rel="noopener">开发分布式追踪OpenTracing与Jaeger相关文档整理</a>。</p><h3 id="查看是否启动成功"><a href="#查看是否启动成功" class="headerlink" title="查看是否启动成功"></a>查看是否启动成功</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master istio-1.4.2<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get po -n istio-system --show-labels | grep jaeger</span>istio-tracing-795c9c64c4-224wm            1/1     Running     0          47h   app<span class="token operator">=</span>jaeger,chart<span class="token operator">=</span>tracing,heritage<span class="token operator">=</span>Tiller,pod-template-hash<span class="token operator">=</span>795c9c64c4,release<span class="token operator">=</span>istio<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="访问jaeger-UI"><a href="#访问jaeger-UI" class="headerlink" title="访问jaeger UI"></a>访问<code>jaeger UI</code></h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master istio-1.4.2<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get svc -n istio-system | grep jaeger</span>jaeger-agent             ClusterIP      None             <span class="token operator">&lt;</span>none<span class="token operator">></span>        5775/UDP,6831/UDP,6832/UDP                                                                                                                   47hjaeger-collector         ClusterIP      10.110.206.207   <span class="token operator">&lt;</span>none<span class="token operator">></span>        14267/TCP,14268/TCP,14250/TCP                                                                                                                47hjaeger-query             NodePort       10.101.53.38     <span class="token operator">&lt;</span>none<span class="token operator">></span>        16686:31944/TCP <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>如上所示，默认情况下，<code>jaeger-query</code>类型也是<code>ClusterIP</code>，为了便于访问，直接修改成<code>NodePort</code>类型:</p><pre class="line-numbers language-bash"><code class="language-bash">kubectl edit svc jaeger-query  -n istio-system<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>然后访问<code>IP:31944</code>即可。</p><h3 id="UI预览"><a href="#UI预览" class="headerlink" title="UI预览"></a>UI预览</h3><p><img src="/images/jaeger1.jpg" alt="Jaeger UI"><br><img src="/images/jaeger2.jpg" alt="Jaeger UI"><br><img src="/images/jaeger3.jpg" alt="Jaeger UI"></p><h3 id="采集频率控制"><a href="#采集频率控制" class="headerlink" title="采集频率控制"></a>采集频率控制</h3><p>如果所有的请求都采集监控，不管出于性能考虑还是资源考虑，都是不实际的。</p><p><code>pilot</code>组件中<code>PILOT_TRACE_SAMPLING</code>环境变量用于控制采集率，默认为<code>1</code>（<code>0~100</code>），测试的时候可以改大点便于分析:</p><pre class="line-numbers language-bash"><code class="language-bash"> kubectl -n istio-system get deploy istio-pilot -oyaml <span class="token operator">|</span> <span class="token function">grep</span> PILOT_TRACE_SAMPLING -A5--        - name: PILOT_TRACE_SAMPLING          value: <span class="token string">"1"</span>        - name: PILOT_ENABLE_PROTOCOL_SNIFFING_FOR_OUTBOUND          value: <span class="token string">"true"</span>        - name: PILOT_ENABLE_PROTOCOL_SNIFFING_FOR_INBOUND          value: <span class="token string">"false"</span>---<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="监控数据采集存储"><a href="#监控数据采集存储" class="headerlink" title="监控数据采集存储"></a>监控数据采集存储</h3><p>参考<a href="https://blog.csdn.net/wzy_168/article/details/103699618" target="_blank" rel="noopener">控制台kiali配置</a>，其中配置了<code>Prometheus</code>和<code>grafana</code>。参考<a href="https://cloud.tencent.com/developer/article/1435739" target="_blank" rel="noopener">Istio链路监控和监控可视化</a></p><ul><li><code>prometheus</code>作为基础数据采集和存储方式，可以通过<code>PromQL</code>查询指标。</li><li><code>grafana</code>可定制化报表展示。</li></ul><p><img src="/images/istio1.jpg" alt="grafana"></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> istio </tag>
            
            <tag> 链路监控 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>istio简介</title>
      <link href="/2019/12/25/istio/"/>
      <url>/2019/12/25/istio/</url>
      
        <content type="html"><![CDATA[<h2 id="Istio简介"><a href="#Istio简介" class="headerlink" title="Istio简介"></a>Istio简介</h2><p>Istio是一个开放服务网格，提供了一种连接，管理和保护微服务的统一方法。它支持管理服务之间的流量，执行访问策略以及汇总遥测数据，所有这些都无需更改微服务代码。<br>Istio：</p><ul><li>HTTP，gRPC，WebSocket，MongoDB和TCP通信的自动负载平衡。  </li><li>通过丰富的路由规则，重试，故障转移和故障注入对流量行为进行细粒度控制。  </li><li>可配置的策略层和API，支持访问控制，速率限制和配额。  </li><li>群集内所有流量的自动指标，日志和跟踪，包括群集入口和出口。  </li><li>通过强大的基于身份的身份验证和授权，在群集中进行安全的服务间通信。  </li></ul><h2 id="Istio架构图"><a href="#Istio架构图" class="headerlink" title="Istio架构图"></a>Istio架构图</h2><p><img src="/images/istio.jpg" alt="istio" title="istio架构图"></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> istio </tag>
            
            <tag> service mesh </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>logback配置文件模板</title>
      <link href="/2019/12/25/logback-pei-zhi-wen-jian-mo-ban/"/>
      <url>/2019/12/25/logback-pei-zhi-wen-jian-mo-ban/</url>
      
        <content type="html"><![CDATA[<h2 id="Logback默认配置的步骤"><a href="#Logback默认配置的步骤" class="headerlink" title="Logback默认配置的步骤"></a>Logback默认配置的步骤</h2><ol><li>尝试在 classpath下查找文件logback-test.xml；</li><li>如果文件不存在，则查找文件logback.xml；</li><li>如果两个文件都不存在，logback用BasicConfigurator自动对自己进行配置，这会导致记录输出到控制台。</li></ol><h2 id="logback配置文件模板"><a href="#logback配置文件模板" class="headerlink" title="logback配置文件模板"></a>logback配置文件模板</h2><pre class="line-numbers language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>statusListener</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.core.status.NopStatusListener<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ROOT<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>./logs/<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>FILESIZE<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>100MB<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>MAXHISTORY<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>30<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>timestamp</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>DATETIME<span class="token punctuation">"</span></span> <span class="token attr-name">datePattern</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>yyyy-MM-dd HH:mm:ss<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token comment" spellcheck="true">&lt;!-- 控制台打印 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>STDOUT<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.core.ConsoleAppender<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">></span></span>[%-5level] %d{yyyy-MM-dd HH:mm:ss:SSS} [%thread] %logger{36} - %m%n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!-- 输入到文件，按日期和文件大小 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>FILEOUT<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.core.rolling.RollingFileAppender<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>encoder</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pattern</span><span class="token punctuation">></span></span>[%-5level] %d{yyyy-MM-dd HH:mm:ss:SSS} [%thread] %logger{36} - %m%n<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pattern</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>encoder</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rollingPolicy</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.core.rolling.TimeBasedRollingPolicy<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>fileNamePattern</span><span class="token punctuation">></span></span>${ROOT}/log.%d.%i.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>fileNamePattern</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maxHistory</span><span class="token punctuation">></span></span>${MAXHISTORY}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maxHistory</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>timeBasedFileNamingAndTriggeringPolicy</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maxFileSize</span><span class="token punctuation">></span></span>${FILESIZE}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maxFileSize</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>timeBasedFileNamingAndTriggeringPolicy</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rollingPolicy</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appender</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!-- Logger 根目录 --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>INFO<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>STDOUT<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appender-ref</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>FILEOUT<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> logback </tag>
            
            <tag> logback配置 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Istio使用【dashboard—kiali】</title>
      <link href="/2019/12/25/istio-shi-yong-dashboard-kiali/"/>
      <url>/2019/12/25/istio-shi-yong-dashboard-kiali/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本文使用的istio版本号：<code>1.4.2</code></p></blockquote><h3 id="配置安装kiali"><a href="#配置安装kiali" class="headerlink" title="配置安装kiali"></a>配置安装kiali</h3><p>默认配置，istio并未选择安装kiali，参考上一章<a href="">安装</a>，修改<code>values.yaml</code></p><pre class="line-numbers language-sh"><code class="language-sh">vim install/kubernetes/helm/istio/values.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-yml"><code class="language-yml"># ....kiali:  enabled: true# ....<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>同时如果需要链路监控，需要开启安装<code>jaeger</code></p><pre class="line-numbers language-yml"><code class="language-yml">#....tracing:  enabled: true#....<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>如果系统中没有安装<code>grafana</code>和<code>Prometheus</code>，也需要开启</p><pre class="line-numbers language-yml"><code class="language-yml">#.....grafana:  enabled: trueprometheus:  enabled: true#.....<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="配置kiali"><a href="#配置kiali" class="headerlink" title="配置kiali"></a>配置kiali</h3><p>可以在安装前配置好<code>kaili</code>，主要配置集中在</p><pre><code>vim install/kubernetes/helm/istio/charts/kiali/values.yaml</code></pre><pre class="line-numbers language-yml"><code class="language-yml">#......ingress:  enabled: false  hosts:    - kiali.localdashboard:  auth:    strategy: login  secretName: kiali   viewOnlyMode: false   grafanaURL:    jaegerURL:  prometheusAddr: http://prometheus:9090#.....<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>配置访问：ingress是否开启，hosts地址，tls…</li><li><code>strategy</code>：认证策略，可以是anonymous, login, openshift，默认login</li><li><code>secretName</code>：登录用户名/密码，需要提前创建好secret<pre class="line-numbers language-yml"><code class="language-yml">apiVersion: v1kind: Secretmetadata:name: kialilabels:  app: kiali  version: v1.9type: Opaquedata:username: YWRtaW4=    # adminpassphrase: YWRtaW4=    # admin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><pre class="line-numbers language-sh"><code class="language-sh">#base64 加密echo -n "admin" | base64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li><p>grafanaURL：grafana地址，如果是在同一个namespace下，可以是</p><pre><code>http://grafana:3000 或者 http://grafana.monitoring.svc.cluster.local:3000</code></pre></li><li><p>prometheusAddr：Prometheus地址，如果是在同一个namespace下，可以是</p><pre><code>http://prometheus:9090 或者 http://prometheus.monitoring.svc.cluster.local:9090</code></pre></li><li><p>jaegerURL：jaeger地址，默认在同一个namespace istio-system下，可以是</p><pre><code>http://jaeger-query:16686/jaeger</code></pre></li></ul><p>如果是在安装后，想要修改kiali配置，可以修改<code>istio-system</code>下<code>configmap</code> <code>kiali</code></p><pre><code>kubectl edit cm  kiali   -n istio-system</code></pre><p>修改<code>configmap</code>里面的<code>config.yaml</code>文件，对应的</p><pre class="line-numbers language-yml"><code class="language-yml">istio_namespace: istio-systemdeployment:  accessible_namespaces: ['**']auth:  strategy: loginserver:  port: 20001  web_root: /kialiexternal_services:  tracing:    url: http://jaeger-query:16686/jaeger  grafana:    url: http://grafana:3000  prometheus:    url: http://prometheus:9090<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改完需要重启<code>kiali POD</code>。</p><h3 id="预览"><a href="#预览" class="headerlink" title="预览"></a>预览</h3><p><img src="/images/istio4.png" alt="istio"></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> istio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>istio使用【dashboard—Naftis】</title>
      <link href="/2019/12/25/istio-shi-yong-dashboard-naftis/"/>
      <url>/2019/12/25/istio-shi-yong-dashboard-naftis/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本文使用的istio版本号：<code>1.4.2</code></p></blockquote><h3 id="简介（参考官网，Naftis小米开源，不在维护）"><a href="#简介（参考官网，Naftis小米开源，不在维护）" class="headerlink" title="简介（参考官网，Naftis小米开源，不在维护）"></a>简介（参考<a href="https://github.com/xiaomi/naftis/blob/master/README-CN.md" target="_blank" rel="noopener">官网</a>，Naftis小米开源，不在维护）</h3><p><code>Naftis</code> 是一个基于 web 的 <code>Istio dashboard</code>，通过任务模板的方式来帮助用户更方便地执行 Istio 任务。 用户可以在 Naftis 中定义自己的任务模板，并填充变量来构造单个或多个构造任务实例，从而完成各种服务治理功能。</p><ul><li>内部集成了一些常用 dashboard</li><li>可定制的任务模板支持</li><li>支持回滚指定任务</li><li>支持指定根服务节点的服务拓扑图</li><li>提供查看 Istio 的 Services 和 Pod 的支持</li><li>开箱即用，通过 Kubectl 相关指令即可快速部署</li><li>支持 Istio 1.0</li></ul><h3 id="快速安装"><a href="#快速安装" class="headerlink" title="快速安装"></a>快速安装</h3><pre class="line-numbers language-sh"><code class="language-sh"># 下载最新 release 文件和部署清单wget -O - https://raw.githubusercontent.com/XiaoMi/naftis/master/tool/getlatest.sh | bash# 创建 Naftis 命名空间$ kubectl create namespace naftis# 确认 Naftis 命名空间已创建$ kubectl get namespace naftisNAME           STATUS    AGEnaftis         Active    18m# 部署 Naftis MySQL 服务（本地 Kuberenetes 集群）$ kubectl apply -n naftis -f mysql.yaml# 部署 Naftis MySQL 服务（云服务商提供的 Kuberenetes 集群）$ kubectl apply -n naftis -f mysql-cloud.yaml# 确认 MySQL 已部署NAME                           READY     STATUS    RESTARTS   AGEnaftis-mysql-c78f99d6c-kblbq   0/1       Running   0          9snaftis-mysql-test              1/1       Running   0          10s# 部署 Naftis API 和 UI 服务kubectl apply -n naftis -f naftis.yaml# 确认 Naftis 所有的服务已经正确定义并正常运行中kubectl get svc -n naftisNAME           TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGEnaftis-api     ClusterIP      10.233.3.144    <none>        50000/TCP      7snaftis-mysql   ClusterIP      10.233.57.230   <none>        3306/TCP       55snaftis-ui      LoadBalancer   10.233.18.125   <pending>     80:31286/TCP   6skubectl get pod -n naftisNAME                           READY     STATUS    RESTARTS   AGEnaftis-api-0                   1/2       Running   0          19snaftis-mysql-c78f99d6c-kblbq   1/1       Running   0          1mnaftis-mysql-test              1/1       Running   0          1mnaftis-ui-69f7d75f47-4jzwz     1/1       Running   0          19s# 端口转发访问 Naftiskubectl -n naftis port-forward $(kubectl -n naftis get pod -l app=naftis-ui -o jsonpath='{.items[0].metadata.name}') 8080:80 &# 打开浏览器，访问 http://localhost:8080 即可。默认用户名和密码分别为 admin、admin。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="预览"><a href="#预览" class="headerlink" title="预览"></a>预览</h3><p><img src="/images/k8s11.png" alt="naftis"></p><p>安装比较简单，功能也比较简单。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> istio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Istio使用【sidecar注入】</title>
      <link href="/2019/12/25/istio-shi-yong-sidecar-zhu-ru/"/>
      <url>/2019/12/25/istio-shi-yong-sidecar-zhu-ru/</url>
      
        <content type="html"><![CDATA[<blockquote><p><strong>本文使用的istio版本：<code>1.4.2</code></strong></p></blockquote><h3 id="查看默认sidecar配置"><a href="#查看默认sidecar配置" class="headerlink" title="查看默认sidecar配置"></a>查看默认sidecar配置</h3><pre class="line-numbers language-bash"><code class="language-bash">kubectl get mutatingwebhookconfiguration istio-sidecar-injector -o yaml <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"namespaceSelector:"</span> -A5  namespaceSelector:    matchLabels:      istio-injection: enabled  objectSelector: <span class="token punctuation">{</span><span class="token punctuation">}</span>  reinvocationPolicy: Never  rules:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看出，<code>istio</code>默认<code>sidecar</code>注入规则是，<code>namespace</code>带有标签<code>istio-injection: enabled</code>才会注入sidecar。</p><p>查看哪些<code>namespace</code>已经配置注入：</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master istio-1.4.2<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl get namespace -L istio-injection</span>NAME              STATUS   AGE   ISTIO-INJECTIONdefault           Active   70d   ingress-nginx     Active   69d   istio-system      Active   19h   kube-node-lease   Active   70d   kube-public       Active   70d   kube-system       Active   70d   naftis            Active   19h   test-deri         Active   47d <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>为<code>namespace</code>打上注入<code>sidecar</code>标签：</p><pre class="line-numbers language-bash"><code class="language-bash">kubectl label namespace default istio-injection<span class="token operator">=</span>enabled --overwrite<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>默认情况，是没有设置。</p><h3 id="为namespace设置不注入sidecar"><a href="#为namespace设置不注入sidecar" class="headerlink" title="为namespace设置不注入sidecar"></a>为namespace设置不注入sidecar</h3><p>有些k8s系统组件<code>namespace</code>不应该注入<code>sidecar</code>，如<code>kube-system</code>等，参考如下设置</p><pre class="line-numbers language-bash"><code class="language-bash">kubectl get mutatingwebhookconfiguration istio-sidecar-injector -o yaml <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"namespaceSelector:"</span> -A5  namespaceSelector:    matchExpressions:    - key: istio-injection      operator: NotIn      values:      - disabled  rules:  - apiGroups:    - <span class="token string">""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>为<code>namespace</code>打上不注入<code>sidecar</code>标签:</p><pre class="line-numbers language-bash"><code class="language-bash">kubectl label namespace istio-system istio-injection<span class="token operator">=</span>disabled --overwrite<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash"><code class="language-bash">kubectl get namespace -L istio-injectionNAME           STATUS    AGE       ISTIO-INJECTIONdefault        Active    18distio-system   Active    3d        disabledkube-public    Active    18d       disabledkube-system    Active    18d       disabled<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="查看sidecar配置策略"><a href="#查看sidecar配置策略" class="headerlink" title="查看sidecar配置策略"></a>查看sidecar配置策略</h3><p><code>sidecar</code>配置保存在<code>configmap-istio-sidecar-injector</code>中，更多配置可以在<code>install/kubernetes/helm/istio/charts/sidecarInjectorWebhook/values.yaml</code>中查看。</p><p>主要配置，默认策略：</p><pre class="line-numbers language-bash"><code class="language-bash">kubectl -n istio-system get configmap istio-sidecar-injector -o jsonpath<span class="token operator">=</span><span class="token string">'{.data.config}'</span> <span class="token operator">|</span> <span class="token function">grep</span> policy:<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>允许的值为<code>disabled</code>和<code>enabled</code>。仅当<code>Webhook namespaceSelector</code>匹配目标名称空间时，才应用默认策略。无法识别的策略导致注入被完全禁用。</p><blockquote><p><font color="red">注意</font>：①策略为<code>disabled</code>，但是想要为POD注入<code>sidecar</code>，增加<code>annotation sidecar.istio.io/inject: "true"</code>即可<br> ②策略为<code>enabled</code>，但是不想要为POD注入<code>sidecar</code>，增加<code>annotation sidecar.istio.io/inject: "false"</code>即可</p></blockquote><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> ignored<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>        <span class="token key atrule">sidecar.istio.io/inject</span><span class="token punctuation">:</span> <span class="token string">"false"</span>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ignored        <span class="token key atrule">image</span><span class="token punctuation">:</span> tutum/curl        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sleep"</span><span class="token punctuation">,</span><span class="token string">"infinity"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="手动注入sidecar"><a href="#手动注入sidecar" class="headerlink" title="手动注入sidecar"></a>手动注入<code>sidecar</code></h3><p>为一个写好的yaml文件手动注入sidecar，我们可以使用<code>istioctl kube-inject</code>:</p><pre class="line-numbers language-bash"><code class="language-bash">istioctl kube-inject -f samples/sleep/sleep.yaml <span class="token operator">|</span> kubectl apply -f -<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>默认情况下，这将使用集群内配置。或者，可以使用配置的本地副本来完成注入。下面命令可以将默认配置导出到文件：</p><pre class="line-numbers language-bash"><code class="language-bash">kubectl -n istio-system get configmap istio-sidecar-injector -o<span class="token operator">=</span>jsonpath<span class="token operator">=</span><span class="token string">'{.data.config}'</span> <span class="token operator">></span> inject-config.yamlkubectl -n istio-system get configmap istio-sidecar-injector -o<span class="token operator">=</span>jsonpath<span class="token operator">=</span><span class="token string">'{.data.values}'</span> <span class="token operator">></span> inject-values.yamlkubectl -n istio-system get configmap istio -o<span class="token operator">=</span>jsonpath<span class="token operator">=</span><span class="token string">'{.data.mesh}'</span> <span class="token operator">></span> mesh-config.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>然后再将文件中配置注入到已建好的<code>YAML</code>中并运行：</p><pre class="line-numbers language-bash"><code class="language-bash">istioctl kube-inject \    --injectConfigFile inject-config.yaml \    --meshConfigFile mesh-config.yaml \    --valuesFile inject-values.yaml \    --filename samples/sleep/sleep.yaml \    <span class="token operator">|</span> kubectl apply -f -<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这和第一条命令效果一样。验证<code>sidecar</code>已经注入：</p><pre class="line-numbers language-bash"><code class="language-bash">kubectl get pod  -l app<span class="token operator">=</span>sleepNAME                     READY   STATUS    RESTARTS   AGEsleep-64c6f57bc8-f5n4x   2/2     Running   0          24s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="其它配置：neverInjectSelector-alwaysInjectSelector"><a href="#其它配置：neverInjectSelector-alwaysInjectSelector" class="headerlink" title="其它配置：neverInjectSelector/alwaysInjectSelector"></a>其它配置：<code>neverInjectSelector/alwaysInjectSelector</code></h3><p>参考<a href="https://istio.io/docs/setup/additional-setup/sidecar-injection/#more-control-adding-exceptions" target="_blank" rel="noopener">官网</a></p><p>示例：</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>sidecar<span class="token punctuation">-</span>injector<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>    <span class="token key atrule">policy</span><span class="token punctuation">:</span> enabled    <span class="token key atrule">neverInjectSelector</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token key atrule">key</span><span class="token punctuation">:</span> openshift.io/build.name<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists<span class="token punctuation">}</span>      <span class="token punctuation">-</span> <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token key atrule">key</span><span class="token punctuation">:</span> openshift.io/deployer<span class="token punctuation">-</span>pod<span class="token punctuation">-</span>for.name<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists<span class="token punctuation">}</span>    <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span><span class="token punctuation">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="配置优先级"><a href="#配置优先级" class="headerlink" title="配置优先级"></a>配置优先级</h3><p>如果<code>POD</code>配置了<code>注解</code>、<code>neverInjectSelector/alwaysInjectSelector</code>也都配置了，默认策略也配置了，那么他们之间的优先级参考如下：</p><pre><code>Pod Annotations → NeverInjectSelector → AlwaysInjectSelector → Default Policy</code></pre><h3 id="卸载自动注入sidecar"><a href="#卸载自动注入sidecar" class="headerlink" title="卸载自动注入sidecar"></a>卸载自动注入sidecar</h3><h4 id="卸载istio中sidecar组件"><a href="#卸载istio中sidecar组件" class="headerlink" title="卸载istio中sidecar组件"></a>卸载istio中sidecar组件</h4><pre class="line-numbers language-bash"><code class="language-bash">kubectl delete mutatingwebhookconfiguration istio-sidecar-injectorkubectl -n istio-system delete <span class="token function">service</span> istio-sidecar-injectorkubectl -n istio-system delete deployment istio-sidecar-injectorkubectl -n istio-system delete serviceaccount istio-sidecar-injector-service-accountkubectl delete clusterrole istio-sidecar-injector-istio-systemkubectl delete clusterrolebinding istio-sidecar-injector-admin-role-binding-istio-system<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="删除某个namespace自动注入"><a href="#删除某个namespace自动注入" class="headerlink" title="删除某个namespace自动注入"></a>删除某个namespace自动注入</h4><pre class="line-numbers language-bash"><code class="language-bash">kubectl label namespace default istio-injection-<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="sidecar注入问题"><a href="#sidecar注入问题" class="headerlink" title="sidecar注入问题"></a>sidecar注入问题</h3><p>更多可以参考<a href="https://istio.io/docs/ops/common-problems/injection/" target="_blank" rel="noopener">官网</a>.</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> istio </tag>
            
            <tag> sidecar </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>istio使用【安装配置】</title>
      <link href="/2019/12/25/istio-shi-yong-an-zhuang-pei-zhi/"/>
      <url>/2019/12/25/istio-shi-yong-an-zhuang-pei-zhi/</url>
      
        <content type="html"><![CDATA[<blockquote><p>本文使用的版本号：<code>1.4.2</code></p></blockquote><h3 id="自定义安装组件"><a href="#自定义安装组件" class="headerlink" title="自定义安装组件"></a>自定义安装组件</h3><p>参考<a href="https://istio.io/docs/setup/install/helm/" target="_blank" rel="noopener">安装页面</a>，官网给配置分了几个级别，</p><p><img src="/images/k8s9.png" alt="istio"></p><p>分别代表：</p><ul><li>default：根据IstioControlPlaneAPI的默认设置启用组件 （建议用于生产部署）。您可以通过运行命令显示默认设置istioctl profile dump。</li><li>demo：旨在展示Istio功能且资源需求适中的配置。适合运行Bookinfo应用程序和相关任务。这是随快速入门说明一起安装的配置，但是 如果您想探索更高级的任务，则可以稍后自定义配置以启用其他功能。<blockquote><p>此配置文件可实现高级别的跟踪和访问日志记录，因此不适合进行性能测试。</p></blockquote></li><li>minimal：使用Istio的流量管理功能所需的最少组件集。</li><li>sds：类似于默认配置文件，但也启用Istio的SDS（​​秘密发现服务）。此配置文件附带默认情况下启用的其他身份验证功能（严格双向TLS）。</li><li>remote：用于配置共享控制平面的多集群服务网格multicluster mesh。</li></ul><p>不同配置安装的的组件也不一样，参考<a href="https://istio.io/docs/setup/additional-setup/config-profiles/" target="_blank" rel="noopener">配置</a>，打<code>X</code>是要安装的<br><img src="/images/k8s10.png" alt="istio"></p><p>当然我们也可以自定义安装组件</p><pre><code>cd install/kubernetes/helm/istiovim values.yaml</code></pre><pre class="line-numbers language-yml"><code class="language-yml">gateways:  enabled: truesidecarInjectorWebhook:  enabled: truegalley:  enabled: truemixer:  policy:    enabled: true  telemetry:    enabled: truepilot:  enabled: truesecurity:  enabled: truenodeagent:  enabled: falsegrafana:  enabled: falseprometheus:  enabled: truetracing:  enabled: falsekiali:  enabled: falsecertmanager:  enabled: falseistio_cni:  enabled: falseistiocoredns:  enabled: false# ...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以将我们需要安装的组件定义为<code>true</code>之后，参考<a href="">部署</a>再安装。</p><p>所有的配置说明参考<a href="https://istio.io/docs/reference/config/installation-options/" target="_blank" rel="noopener">官网配置选项</a>.</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> istio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>istio部署【在kubernetes上部署】</title>
      <link href="/2019/12/24/istio-bu-shu-zai-kubernetes-shang-bu-shu/"/>
      <url>/2019/12/24/istio-bu-shu-zai-kubernetes-shang-bu-shu/</url>
      
        <content type="html"><![CDATA[<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><h3 id="下载istio"><a href="#下载istio" class="headerlink" title="下载istio"></a>下载istio</h3><p>下载页面，下载与您的操作系统相对应的安装文件。Linux上可以直接执行下面命令下载并解压最新版</p><pre><code>curl -L https://istio.io/downloadIstio | sh -</code></pre><h3 id="移至Istio软件包目录"><a href="#移至Istio软件包目录" class="headerlink" title="移至Istio软件包目录"></a>移至Istio软件包目录</h3><p>例如，如果软件包为 <code>istio-1.4.2</code>：</p><pre><code>cd istio-1.4.2</code></pre><h3 id="安装目录包含："><a href="#安装目录包含：" class="headerlink" title="安装目录包含："></a>安装目录包含：</h3><ul><li><code>Kubernetes</code>的安装<code>YAML</code>文件在 <code>install/kubernetes</code></li><li>示例应用程序 <code>samples/</code></li><li>目录中的客户端二进制文件。手动注入<code>Envoy</code>作为<code>Sidecar</code>代理时使用。<code>istioctlbin/istioctl</code></li><li>将<code>istioctl</code>命令添加到环境变量，如下命令是临时加入<pre><code>export PATH=$PWD/bin:$PATH</code></pre></li></ul><h2 id="两种安装方式"><a href="#两种安装方式" class="headerlink" title="两种安装方式"></a>两种安装方式</h2><p>istio在kubenetes上有两种安装方式，参考<a href="https://istio.io/docs/setup/install/helm/" target="_blank" rel="noopener">官网</a></p><h3 id="helm-template方式安装Istio"><a href="#helm-template方式安装Istio" class="headerlink" title="helm template方式安装Istio"></a>helm template方式安装Istio</h3><h4 id="创建namespace"><a href="#创建namespace" class="headerlink" title="创建namespace"></a>创建namespace</h4><pre><code>kubectl create namespace istio-system</code></pre><h4 id="安装所有istio的CRD"><a href="#安装所有istio的CRD" class="headerlink" title="安装所有istio的CRD"></a>安装所有istio的CRD</h4><p>先将<code>template</code>导出到<code>istio.yaml</code></p><pre><code>helm template install/kubernetes/helm/istio-init --name istio-init --namespace istio-system &gt; istio.yaml</code></pre><p>然后执行</p><pre><code>kubectl apply -f istio.yaml</code></pre><p>或者，两个步骤合二为一 </p><pre><code>helm template install/kubernetes/helm/istio-init --name istio-init --namespace istio-system | kubectl apply -f -</code></pre><h4 id="等待所有CRD创建完毕"><a href="#等待所有CRD创建完毕" class="headerlink" title="等待所有CRD创建完毕"></a>等待所有CRD创建完毕</h4><pre><code>kubectl -n istio-system wait --for=condition=complete job --all</code></pre><h4 id="使用默认配置安装isito，其它配置参考官网，同上，命令也可以分开执行"><a href="#使用默认配置安装isito，其它配置参考官网，同上，命令也可以分开执行" class="headerlink" title="使用默认配置安装isito，其它配置参考官网，同上，命令也可以分开执行"></a>使用默认配置安装isito，其它配置参考官网，同上，命令也可以分开执行</h4><pre><code>helm template install/kubernetes/helm/istio --name istio --namespace istio-system | kubectl apply -f -</code></pre><h3 id="helm-install方式安装Istio"><a href="#helm-install方式安装Istio" class="headerlink" title="helm install方式安装Istio"></a>helm install方式安装Istio</h3><h4 id="为Tiller创建service-account，如果已安装好Tiller直接跳过。"><a href="#为Tiller创建service-account，如果已安装好Tiller直接跳过。" class="headerlink" title="为Tiller创建service-account，如果已安装好Tiller直接跳过。"></a>为Tiller创建service-account，如果已安装好Tiller直接跳过。</h4><pre><code>kubectl apply -f install/kubernetes/helm/helm-service-account.yaml</code></pre><h4 id="安装Tiller，如果已安装好Tiller直接跳过。"><a href="#安装Tiller，如果已安装好Tiller直接跳过。" class="headerlink" title="安装Tiller，如果已安装好Tiller直接跳过。"></a>安装Tiller，如果已安装好Tiller直接跳过。</h4><pre><code>helm init --service-account tiller</code></pre><h4 id="安装istio-init，其中包括了创建istio的CRDs。"><a href="#安装istio-init，其中包括了创建istio的CRDs。" class="headerlink" title="安装istio-init，其中包括了创建istio的CRDs。"></a>安装istio-init，其中包括了创建istio的CRDs。</h4><pre><code>helm install install/kubernetes/helm/istio-init --name istio-init --namespace istio-system</code></pre><h4 id="等待CRD创建完成。"><a href="#等待CRD创建完成。" class="headerlink" title="等待CRD创建完成。"></a>等待CRD创建完成。</h4><pre><code>kubectl -n istio-system wait --for=condition=complete job --all</code></pre><h4 id="使用默认配置安装istio，其它配置参考官网"><a href="#使用默认配置安装istio，其它配置参考官网" class="headerlink" title="使用默认配置安装istio，其它配置参考官网"></a>使用默认配置安装istio，其它配置参考官网</h4><pre><code>helm install install/kubernetes/helm/istio --name istio --namespace istio-system</code></pre><h4 id="确定安装完成"><a href="#确定安装完成" class="headerlink" title="确定安装完成"></a>确定安装完成</h4><pre><code>kubectl get svc -n istio-system</code></pre><pre><code>kubectl get pods -n istio-system</code></pre><h2 id="卸载Istio"><a href="#卸载Istio" class="headerlink" title="卸载Istio"></a>卸载Istio</h2><h3 id="使用helm-template安装方式卸载"><a href="#使用helm-template安装方式卸载" class="headerlink" title="使用helm template安装方式卸载"></a>使用helm template安装方式卸载</h3><pre><code>helm template install/kubernetes/helm/istio --name istio --namespace istio-system | kubectl delete -f -kubectl delete namespace istio-system</code></pre><h3 id="使用helm-install安装方式卸载"><a href="#使用helm-install安装方式卸载" class="headerlink" title="使用helm install安装方式卸载"></a>使用helm install安装方式卸载</h3><pre><code>helm delete --purge istiohelm delete --purge istio-inithelm delete --purge istio-cnikubectl delete namespace istio-system</code></pre><h3 id="删除CRDs"><a href="#删除CRDs" class="headerlink" title="删除CRDs"></a>删除CRDs</h3><pre><code>kubectl delete -f install/kubernetes/helm/istio-init/files</code></pre><p>以上就是通过默认配置安装和卸载istio。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> istio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>开放分布式追踪OpenTracing与Jaeger相关文档整理</title>
      <link href="/2019/12/18/kai-fang-fen-bu-shi-zhui-zong-opentracing-yu-jaeger-xiang-guan-wen-dang-zheng-li/"/>
      <url>/2019/12/18/kai-fang-fen-bu-shi-zhui-zong-opentracing-yu-jaeger-xiang-guan-wen-dang-zheng-li/</url>
      
        <content type="html"><![CDATA[<h1 id="为什么需要服务追踪？"><a href="#为什么需要服务追踪？" class="headerlink" title="为什么需要服务追踪？"></a>为什么需要服务追踪？</h1><p>开发和工程团队因为系统组件水平扩展、开发团队小型化、敏捷开发、CD（持续集成）、解耦等各种需求，正在使用现代的微服务架构替换老旧的单片机系统，当一个生产系统面对真正的高并发，或者解耦成大量微服务时，以前很容易实现的重点任务变得困难了，如<strong>用户体验优化</strong>、<strong>后台真实错误原因分析</strong>，<strong>分布式系统内各组件的调用情况</strong>等。 </p><h1 id="分布式服务追踪现状"><a href="#分布式服务追踪现状" class="headerlink" title="分布式服务追踪现状"></a>分布式服务追踪现状</h1><p>当代分布式跟踪系统（例如，<code>Zipkin</code>, <code>Dapper</code>, <code>HTrace</code>, <code>X-Trace</code>等）旨在解决这些问题，但是他们使用不兼容的<code>API</code>来实现各自的应用需求。尽管这些分布式追踪系统有着相似的API语法，但各种语言的开发人员依然很难将他们各自的系统（使用不同的语言和技术）和特定的分布式追踪系统进行整合。</p><h1 id="OpenTracing"><a href="#OpenTracing" class="headerlink" title="OpenTracing"></a>OpenTracing</h1><p>OpenTracing通过提供平台无关、厂商无关的API，使得开发人员能够方便的添加（或更换）追踪系统的实现。 OpenTracing提供了用于运营支撑系统的和针对特定平台的辅助程序库。</p><h1 id="典型服务追踪案例"><a href="#典型服务追踪案例" class="headerlink" title="典型服务追踪案例"></a>典型服务追踪案例</h1><p><img src="/images/ot1.png" alt="案例"></p><p>在一个分布式系统中，追踪一个事务或者调用流一般如上图所示。虽然这种图对于看清各组件的组合关系是很有用的，但是，它不能很好显示组件的调用时间，是串行调用还是并行调用，如果展现更复杂的调用关系，会更加复杂，甚至无法画出这样的图。这种图也无法显示调用间的时间间隔以及是否通过定时调用来启动调用.</p><p><img src="/images/ot2.png" alt="案例"></p><p>这种展现方式增加显示了执行时间的上下文，相关服务间的层次关系，进程或者任务的串行或并行调用关系。这样的视图有助于发现系统调用的关键路径。通过关注关键路径的执行过程，项目团队可能专注于优化路径中的关键位置，最大幅度的提升系统性能。例如：可以通过追踪一个资源定位的调用情况，明确底层的调用情况，发现哪些操作有阻塞的情况。</p><h1 id="Jaeger-架构"><a href="#Jaeger-架构" class="headerlink" title="Jaeger 架构"></a>Jaeger 架构</h1><p><code>Jaeger</code>是OpenTracing的一种实现。<br><img src="/images/jaeger.jpg" alt="jaeger"></p><p>如上图所示，<code>Jaeger</code> 主要由以下几部分组成。</p><ul><li><strong>Jaeger Client</strong> - 为不同语言实现了符合 OpenTracing 标准的 SDK。应用程序通过 API 写入数据，client library 把 trace 信息按照应用程序指定的采样策略传递给 jaeger-agent。在 Application 中调用 Jaeger Client Library 记录 Span 的过程通常被称为埋点。</li><li><strong>Agent</strong> - 它是一个监听在 UDP 端口上接收 span 数据的网络守护进程，它会将数据批量发送给 collector。它被设计成一个基础组件，部署到所有的宿主机上。Agent 将 client library 和 collector 解耦，为 client library 屏蔽了路由和发现 collector 的细节。</li><li><strong>Collector</strong> - 接收 jaeger-agent 发送来的数据，然后将数据写入后端存储。Collector 被设计成无状态的组件，因此您可以同时运行任意数量的 jaeger-collector。</li><li><strong>Data Store</strong> - 后端存储被设计成一个可插拔的组件，支持将数据写入 cassandra、elastic search。</li><li><strong>Query</strong> - 接收查询请求，然后从后端存储系统中检索 trace 并通过 UI 进行展示。Query 是无状态的，您可以启动多个实例，把它们部署在 nginx 这样的负载均衡器后面。</li></ul><h1 id="Istio-Trace链路追踪方案"><a href="#Istio-Trace链路追踪方案" class="headerlink" title="Istio Trace链路追踪方案"></a>Istio Trace链路追踪方案</h1><ul><li><p><code>Envoy</code>原生就支持分布式追踪系统的接入，如支持<code>jaeger</code>和<code>zipkin</code>；</p></li><li><p>生成<code>Request Id</code>，填充<code>HTTP</code>的<code>header</code>字段<code>x-request-id</code>;</p></li><li><p>如果<code>incoming</code>的请求没有trace相关的headers，则会在流量进入pods之前创建一个<code>root span</code>;</p></li><li><p>如果<code>incoming</code>的请求包含有trace相关的headers，Sidecar的proxy将会extract这些span的上下文信息，然后在流量进入pods之前创建一个继承上一个span的新的span;</p></li><li><p>Jaeger本身支持在client端调整和通过collector调整采样策略，但是在Istio中并没有Jaeger的client，只是envoy里面支持了trace，不过Istio中提供了一个全局的设置，通过设置pilot的参数可以用来控制采用策略。</p></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> istio </category>
          
      </categories>
      
      
        <tags>
            
            <tag> istio </tag>
            
            <tag> OpenTracing </tag>
            
            <tag> jaeger </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>日志聚合工具Loki安装使用【采用helm安装】</title>
      <link href="/2019/12/17/ri-zhi-ju-he-gong-ju-loki-an-zhuang-shi-yong-cai-yong-helm-an-zhuang/"/>
      <url>/2019/12/17/ri-zhi-ju-he-gong-ju-loki-an-zhuang-shi-yong-cai-yong-helm-an-zhuang/</url>
      
        <content type="html"><![CDATA[<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>Loki是 Grafana Labs 团队最新的开源项目，是一个水平可扩展，高可用性，多租户的日志聚合系统。它的设计非常经济高效且易于操作，因为它不会为日志内容编制索引，而是为每个日志流编制一组标签。项目受 Prometheus 启发，官方的介绍就是：Like Prometheus, but for logs.，类似于 Prometheus 的日志系统。</p><p>与其他日志聚合系统相比，Loki具有下面的一些特性：</p><ul><li>不对日志进行全文索引。通过存储压缩非结构化日志和仅索引元数据，Loki 操作起来会更简单，更省成本。</li><li>通过使用与 Prometheus 相同的标签记录流对日志进行索引和分组，这使得日志的扩展和操作效率更高。</li><li>特别适合储存 Kubernetes Pod 日志; 诸如 Pod 标签之类的元数据会被自动删除和编入索引。</li><li>受 Grafana 原生支持。</li></ul><p>Loki 由以下3个部分组成：<br><img src="/images/loki.png" alt="Loki"></p><ol><li>loki是主服务器，负责存储日志和处理查询。</li><li>promtail是代理，负责收集日志并将其发送给 loki 。</li><li>Grafana用于 UI 展示。</li></ol><h3 id="Loki安装"><a href="#Loki安装" class="headerlink" title="Loki安装"></a>Loki安装</h3><p>参考<a href="https://github.com/grafana/loki/blob/master/docs/installation/helm.md" target="_blank" rel="noopener">官网</a></p><h4 id="添加-更新helm"><a href="#添加-更新helm" class="headerlink" title="添加/更新helm"></a>添加/更新helm</h4><pre class="line-numbers language-bash"><code class="language-bash">helm repo add loki https://grafana.github.io/loki/chartshelm repo update<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="安装loki（使用默认配置）"><a href="#安装loki（使用默认配置）" class="headerlink" title="安装loki（使用默认配置）"></a>安装loki（使用默认配置）</h4><pre class="line-numbers language-bash"><code class="language-bash">helm upgrade --install loki loki/loki-stack<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="安装loki（设置namespace）"><a href="#安装loki（设置namespace）" class="headerlink" title="安装loki（设置namespace）"></a>安装loki（设置namespace）</h4><pre class="line-numbers language-bash"><code class="language-bash">helm upgrade --install loki --namespace<span class="token operator">=</span>loki loki/loki<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="安装loki（更改一些配置）"><a href="#安装loki（更改一些配置）" class="headerlink" title="安装loki（更改一些配置）"></a>安装loki（更改一些配置）</h4><pre class="line-numbers language-bash"><code class="language-bash">helm upgrade --install loki loki/loki-stack  --set grafana.enabled<span class="token operator">=</span>true,prometheus.enabled<span class="token operator">=</span>true,prometheus.alertmanager.persistentVolume.enabled<span class="token operator">=</span>false,prometheus.server.persistentVolume.enabled<span class="token operator">=</span>false<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>这边loki使用的镜像是<code>grafana/loki:v1.2.0</code>，建议提前拉取下来。</p><pre class="line-numbers language-bash"><code class="language-bash">docker pull grafana/loki:v1.2.0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>其它一些信息，可以参考官网配置。</p></blockquote><h3 id="Promtail安装"><a href="#Promtail安装" class="headerlink" title="Promtail安装"></a>Promtail安装</h3><p>参考<a href="https://github.com/grafana/loki/blob/master/docs/clients/promtail/installation.md" target="_blank" rel="noopener">官网</a></p><pre class="line-numbers language-bash"><code class="language-bash">helm upgrade --install promtail loki/promtail --set <span class="token string">"loki.serviceName=loki"</span> --namespace<span class="token operator">=</span>loki<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>这边loki使用的镜像是<code>grafana/promtail:v1.2.0</code>，建议提前拉取下来。</p><pre class="line-numbers language-bash"><code class="language-bash">docker pull grafana/promtail:v1.2.0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>其它一些信息，可以参考官网配置。</p></blockquote><h3 id="集成Grafana，实现页面查询日志"><a href="#集成Grafana，实现页面查询日志" class="headerlink" title="集成Grafana，实现页面查询日志"></a>集成Grafana，实现页面查询日志</h3><blockquote><p>前文使用<a href="">Helm一键安装Prometheus Operator</a>已经安装了grafana服务，我们可以直接使用。</p></blockquote><h4 id="登录grafana，选择添加数据源"><a href="#登录grafana，选择添加数据源" class="headerlink" title="登录grafana，选择添加数据源"></a>登录grafana，选择添加数据源</h4><p><img src="/images/loki1.jpg" alt="添加Loki数据源"></p><h4 id="数据源列表中选择Loki，配置服务地址"><a href="#数据源列表中选择Loki，配置服务地址" class="headerlink" title="数据源列表中选择Loki，配置服务地址"></a>数据源列表中选择Loki，配置服务地址</h4><blockquote><p>如果<code>grafana</code>与<code>loki</code>在同一个<code>namespace</code>，只需写服务名即可。<br>如果是在不同的<code>namespace</code>，那么要写完整<code>DNS</code>地址。</p></blockquote><p><img src="/images/loki2.jpg" alt="添加Loki数据源"></p><h4 id="切换到grafana左侧区域的Explore，进入loki页面"><a href="#切换到grafana左侧区域的Explore，进入loki页面" class="headerlink" title="切换到grafana左侧区域的Explore，进入loki页面"></a>切换到<code>grafana</code>左侧区域的<code>Explore</code>，进入<code>loki</code>页面</h4><p><img src="/images/loki3.jpg" alt="添加Loki数据源"></p><p>点击Log labels就可以把当前系统采集的日志标签给显示出来，可以根据这些标签进行日志的过滤查询</p><p><img src="/images/loki4.jpg" alt="添加Loki数据源"></p><h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><pre><code>...........level=error ts=2019-12-17T05:43:00.189385282Z caller=filetarget.go:272 msg="failed to tail file, stat failed" error="stat /var/log/pods/kube-system_kube-flannel-ds-amd64-btn7m_5088625c-bba8-41d6-86c8-dc738d3b43ab/kube-flannel/3.log: no such file or directory" filename=/var/log/pods/kube-system_kube-flannel-ds-amd64-btn7m_5088625c-bba8-41d6-86c8-dc738d3b43ab/kube-flannel/3.loglevel=error ts=2019-12-17T05:43:00.192476724Z caller=filetarget.go:272 msg="failed to tail file, stat failed" error="stat /var/log/pods/kube-system_kube-flannel-ds-amd64-btn7m_5088625c-bba8-41d6-86c8-dc738d3b43ab/install-cni/5.log: no such file or directory" filename=/var/log/pods/kube-system_kube-flannel-ds-amd64-btn7m_5088625c-bba8-41d6-86c8-dc738d3b43ab/install-cni/5.log......</code></pre><p>提示找不到<code>/var/log/pods</code>目录下的日志文件，无法<code>tail</code>。</p><p>首先我们可以进入<code>promtail</code>容器内，到该目录下查看下是否有该文件，通过<code>cat</code>命令看看是否有日志。</p><p>默认安装<code>promtail</code>，它会将主机<code>/var/log/pods</code>和<code>/var/lib/docker/containers</code>目录通过<code>volumes</code>方式挂载到<code>promtail</code>容器内。如果安装<code>docker</code>和<code>k8s</code>都是采用默认配置，应该不会存在读不到日志的问题。</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"docker"</span><span class="token punctuation">,</span>    <span class="token property">"hostPath"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"/var/lib/docker/containers"</span><span class="token punctuation">,</span>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">""</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"pods"</span><span class="token punctuation">,</span>    <span class="token property">"hostPath"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"/var/log/pods"</span><span class="token punctuation">,</span>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">""</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>本人因为主机系统盘太小，设置了<code>docker</code>镜像的目录到挂载磁盘<code>/data</code>目录下，所以需要修改默认<code>volumes</code>配置。</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"docker"</span><span class="token punctuation">,</span>    <span class="token property">"hostPath"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"/data/docker/containers"</span><span class="token punctuation">,</span>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">""</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">{</span>    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"pods"</span><span class="token punctuation">,</span>    <span class="token property">"hostPath"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"/var/log/pods"</span><span class="token punctuation">,</span>        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">""</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>//注意对应的volumeMounts也要修改<span class="token property">"volumeMounts"</span><span class="token operator">:</span> <span class="token punctuation">[</span>              <span class="token punctuation">{</span>                <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"docker"</span><span class="token punctuation">,</span>                <span class="token property">"readOnly"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>                <span class="token property">"mountPath"</span><span class="token operator">:</span> <span class="token string">"/data/docker/containers"</span>              <span class="token punctuation">}</span><span class="token punctuation">,</span>              <span class="token punctuation">{</span>                <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"pods"</span><span class="token punctuation">,</span>                <span class="token property">"readOnly"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>                <span class="token property">"mountPath"</span><span class="token operator">:</span> <span class="token string">"/var/log/pods"</span>              <span class="token punctuation">}</span>            <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面<code>volumes</code>和<code>volumeMounts</code>都要修改，因为<code>/var/log/pods</code>目录下的日志文件其实是个软链接，指向的是<code>docker/containers</code>目录下的日志文件。如果只修改了<code>volumes</code>，那么<code>promtail</code>容器内可以找到日志文件，但是打开确实空的，因为它只是个软连接。</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@node1 log<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ll /var/log/pods/monitoring_promtail-bs5cs_5bc5bc90-bac9-480d-b291-4caadeff2236/promtail/</span>total 4lrwxrwxrwx 1 root root 162 Dec 17 14:04 0.log -<span class="token operator">></span> /data/docker/containers/db45d5118e9508817e1a2efa3c9da68cfe969a2b0a3ed42619ff61a29cc64e5f/db45d5118e9508817e1a2efa3c9da68cfe969a2b0a3ed42619ff61a29cc64e5f-json.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> loki </tag>
            
            <tag> 日志 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s动态分配存储【创建新的StorageClass】</title>
      <link href="/2019/12/17/k8s-dong-tai-fen-pei-cun-chu-chuang-jian-xin-de-storageclass/"/>
      <url>/2019/12/17/k8s-dong-tai-fen-pei-cun-chu-chuang-jian-xin-de-storageclass/</url>
      
        <content type="html"><![CDATA[<pre class="line-numbers language-yml"><code class="language-yml">apiVersion: storage.k8s.io/v1kind: StorageClassmetadata:  annotations:    storageclass.kubernetes.io/is-default-class: "true"  labels:    app: nfs-client-provisioner    chart: nfs-client-provisioner-1.2.8    release: test-storageclass  name: nfs-clientparameters:  archiveOnDelete: "true"provisioner: cluster.local/test-storageclass-nfs-client-provisioner<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>注意事项</strong></p><ul><li><code>provisioner</code>：这个是安装<code>nfs-client-provisioner</code>是定义的<code>provisionerName</code>，如果配置中没有指明，会自动生成。</li><li>添加<code>storageclass.kubernetes.io/is-default-class: "true"</code>表面这是一个默认的<code>StorageClass</code> 资源对象</li><li><code>name</code>：它处使用这个<code>StorageClass</code>时要指定的名称。</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> StorageClass </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s中时区问题【使用PodPreset方法】</title>
      <link href="/2019/12/16/k8s-zhong-shi-qu-wen-ti-shi-yong-podpreset-fang-fa/"/>
      <url>/2019/12/16/k8s-zhong-shi-qu-wen-ti-shi-yong-podpreset-fang-fa/</url>
      
        <content type="html"><![CDATA[<blockquote><p>K8S启动的POD，默认时区与中国相差8小时，在排查问题或者查看日志时非常不方便。</p></blockquote><h3 id="增加容器环境变量，指定时区"><a href="#增加容器环境变量，指定时区" class="headerlink" title="增加容器环境变量，指定时区"></a>增加容器环境变量，指定时区</h3><pre class="line-numbers language-sh"><code class="language-sh">docker run -it --rm -e "TZ=Asia/Shanghai" centos<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>对应k8s中配置:</p><pre class="line-numbers language-yml"><code class="language-yml">apiVersion: v1kind: Podmetadata:  name: pod-env-tzspec:  containers:  - name: ngx    image: nginx:latest    imagePullPolicy: IfNotPresent    env:      - name: TZ        value: Asia/Shanghai<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="容器启动时，挂载到宿主机时区文件"><a href="#容器启动时，挂载到宿主机时区文件" class="headerlink" title="容器启动时，挂载到宿主机时区文件"></a>容器启动时，挂载到宿主机时区文件</h3><pre><code>docker run -it --rm -v /etc/localtime:/etc/localtime  centos</code></pre><p>对应k8s中配置</p><pre class="line-numbers language-yml"><code class="language-yml">apiVersion: v1kind: Podmetadata:  name: pod-vol-tzspec:  containers:  - name: ngx    image: nginx:latest    imagePullPolicy: IfNotPresent    volumeMounts:    - name: tz-config      mountPath: /etc/localtime      readOnly: true  volumes:  - name: tz-config    hostPath:      path: /etc/localtime<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上两种方法都可以解决问题，但是<strong>缺点明显</strong>，每次新建<code>POD</code>都需要指定。</p><h3 id="推荐使用PodPreset方式"><a href="#推荐使用PodPreset方式" class="headerlink" title="推荐使用PodPreset方式"></a>推荐使用PodPreset方式</h3><h4 id="PodPreset（参考中文文档）"><a href="#PodPreset（参考中文文档）" class="headerlink" title="PodPreset（参考中文文档）"></a>PodPreset（<a href="https://www.kubernetes.org.cn/podpreset" target="_blank" rel="noopener">参考中文文档</a>）</h4><p>PodPreset用来给指定标签的Pod注入额外的信息，如环境变量、存储卷等。这样，Pod模板就不需要为每个Pod都显式设置重复的信息。</p><h4 id="开启PodPreset"><a href="#开启PodPreset" class="headerlink" title="开启PodPreset"></a>开启PodPreset</h4><ul><li>开启<code>API</code> <code>settings.k8s.io/v1alpha1/podpreset</code></li><li>开启准入控制 <code>PodPreset</code></li></ul><h4 id="默认情况下PodPreset不可用"><a href="#默认情况下PodPreset不可用" class="headerlink" title="默认情况下PodPreset不可用"></a>默认情况下PodPreset不可用</h4><pre class="line-numbers language-sh"><code class="language-sh">[root@k8s-master ~]# kubectl get podpreseterror: the server doesn't have a resource type "podpreset"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="开启之后应该是"><a href="#开启之后应该是" class="headerlink" title="开启之后应该是"></a>开启之后应该是</h4><pre class="line-numbers language-sh"><code class="language-sh">[root@k8s-master ~]# kubectl get podpresetNo resources found.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="如何开启PodPreset？"><a href="#如何开启PodPreset？" class="headerlink" title="如何开启PodPreset？"></a>如何开启PodPreset？</h3><p>编辑<code>/etc/kubernetes/manifests/kube-apiserver.yaml</code></p><pre class="line-numbers language-yml"><code class="language-yml">spec:  containers:  - command:    - kube-apiserver    - --advertise-address=192.168.1.210    - --allow-privileged=true    - --authorization-mode=Node,RBAC    - --client-ca-file=/etc/kubernetes/pki/ca.crt    - --enable-admission-plugins=NodeRestriction,PodPreset    - --enable-bootstrap-token-auth=true    - --runtime-config=settings.k8s.io/v1alpha1=true    - --etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>添加一行配置<code>- --runtime-config=settings.k8s.io/v1alpha1=true，enable-admission-plugins后面增加PodPreset</code>。</p><p>等待<code>ApiServer</code><strong>自动重启</strong>完成。</p><h3 id="创建PodPreset"><a href="#创建PodPreset" class="headerlink" title="创建PodPreset"></a>创建PodPreset</h3><pre class="line-numbers language-yml"><code class="language-yml">apiVersion: settings.k8s.io/v1alpha1kind: PodPresetmetadata:  name: allow-tz-env  namespace: defaultspec:  selector:    matchLabels:  env:    - name: TZ      value: Asia/Shanghai<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-sh"><code class="language-sh">[root@k8s-master ~]# kubectl get podpresetsNAME           CREATED ATallow-tz-env   2019-12-16T07:57:54Z<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>现在创建一个新的POD，查看其环境变量。</p><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>我这边简单测试，删除一个已有的<code>consul容器</code>，等它重启之后，查看它的环境变量<br><img src="/images/k8s8.png" alt="consul"></p><p>可以看到，容器最后环境变量确实增加的时区配置。</p><h3 id="busybox通过时区设置时间不生效问题"><a href="#busybox通过时区设置时间不生效问题" class="headerlink" title="busybox通过时区设置时间不生效问题"></a>busybox通过时区设置时间不生效问题</h3><p>原因参考<a href="https://blog.csdn.net/vc66vcc/article/details/78747815" target="_blank" rel="noopener">这篇</a>。</p><p>解决办法，通过挂载磁盘<code>/etc/localtime</code>，也可以通过<code>PodPreset</code>方式，为每个创建的<code>POD自动添加挂载</code>。</p><pre class="line-numbers language-yml"><code class="language-yml">apiVersion: settings.k8s.io/v1alpha1kind: PodPresetmetadata:  name: allow-tz-envspec:  selector:    matchLabels:  volumeMounts:    - mountPath: /etc/localtime      name: tz-config      readOnly: true  volumes:    - name: tz-config      hostPath:         path: /etc/localtime<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样新增的<code>POD</code>会自动挂载宿主机上的时间文件。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> 时区 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s问题【flannel一直重启问题-CrashLoopBackOff】</title>
      <link href="/2019/12/16/k8s-wen-ti-flannel-yi-zhi-chong-qi-wen-ti-crashloopbackoff/"/>
      <url>/2019/12/16/k8s-wen-ti-flannel-yi-zhi-chong-qi-wen-ti-crashloopbackoff/</url>
      
        <content type="html"><![CDATA[<h3 id="kubectl-describe-命令查看"><a href="#kubectl-describe-命令查看" class="headerlink" title="kubectl describe 命令查看"></a>kubectl describe 命令查看</h3><pre class="line-numbers language-log"><code class="language-log">Events:  Type     Reason     Age                   From               Message  ----     ------     ----                  ----               -------  Normal   Scheduled  13m                   default-scheduler  Successfully assigned kube-system/kube-flannel-ds-amd64-vfhnj to node-d1  Normal   Pulled     13m                   kubelet, node-d1   Container image "quay.io/coreos/flannel:v0.11.0-amd64" already present on machine  Normal   Created    13m                   kubelet, node-d1   Created container install-cni  Normal   Started    13m                   kubelet, node-d1   Started container install-cni  Normal   Pulled     10m (x5 over 13m)     kubelet, node-d1   Container image "quay.io/coreos/flannel:v0.11.0-amd64" already present on machine  Normal   Created    10m (x5 over 13m)     kubelet, node-d1   Created container kube-flannel  Normal   Started    10m (x5 over 13m)     kubelet, node-d1   Started container kube-flannel  Warning  BackOff    3m39s (x30 over 12m)  kubelet, node-d1   Back-off restarting failed container<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="kubectl-logs命令查看"><a href="#kubectl-logs命令查看" class="headerlink" title="kubectl logs命令查看"></a>kubectl logs命令查看</h3><pre class="line-numbers language-log"><code class="language-log">[root@master ~]# kubectl logs  kube-flannel-ds-amd64-9w5nq -n kube-systemI1216 05:59:40.055608       1 main.go:527] Using interface with name eth0 and address 192.168.1.82I1216 05:59:40.055666       1 main.go:544] Defaulting external address to interface address (192.168.1.82)E1216 06:00:10.056546       1 main.go:241] Failed to create SubnetManager: error retrieving pod spec for 'kube-system/kube-flannel-ds-amd64-9w5nq': Get https://10.96.0.1:443/api/v1/namespaces/kube-system/pods/kube-flannel-ds-amd64-9w5nq: dial tcp 10.96.0.1:443: i/o timeout<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>问题排查<br>网络问题？<br>通过curl命令测试，网络没有问题。</p></blockquote><h3 id="测试kube-proxy"><a href="#测试kube-proxy" class="headerlink" title="测试kube-proxy"></a>测试kube-proxy</h3><p>重启该节点上的<code>kube-proxy</code>容器，并查看日志</p><pre><code>kubectl delete pod kube-proxy-vtd27 -n kube-system</code></pre><pre class="line-numbers language-log"><code class="language-log">[root@master ~]# kubectl logs kube-proxy-pljct -n kube-systemW1216 06:30:51.741835       1 proxier.go:513] Failed to load kernel module ip_vs_wrr with modprobe. You can ignore this message when kube-proxy is running inside container without mounting /lib/modulesW1216 06:30:51.742536       1 proxier.go:513] Failed to load kernel module ip_vs_sh with modprobe. You can ignore this message when kube-proxy is running inside container without mounting /lib/modulesW1216 06:30:51.748495       1 proxier.go:513] Failed to load kernel module ip_vs_wrr with modprobe. You can ignore this message when kube-proxy is running inside container without mounting /lib/modulesW1216 06:30:51.749223       1 proxier.go:513] Failed to load kernel module ip_vs_sh with modprobe. You can ignore this message when kube-proxy is running inside container without mounting /lib/modulesE1216 06:30:51.750805       1 server_others.go:259] can't determine whether to use ipvs proxy, error: IPVS proxier will not be used because the following required kernel modules are not loaded: [ip_vs_wrr ip_vs_sh]I1216 06:30:51.757054       1 server_others.go:143] Using iptables Proxier.W1216 06:30:51.757122       1 proxier.go:321] clusterCIDR not specified, unable to distinguish between internal and external trafficI1216 06:30:51.757338       1 server.go:534] Version: v1.15.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>这里明显有个问题。一些需要的内核模块加载失败，参考安装文档，已经配置过内核模块。重新尝试，问题依然存在。</p><pre class="line-numbers language-sh"><code class="language-sh">[root@master ~]# cat > /etc/sysconfig/modules/ipvs.modules <<EOF> #!/bin/bash> modprobe -- ip_vs> modprobe -- ip_vs_rr> modprobe -- ip_vs_wrr> modprobe -- ip_vs_sh> modprobe -- nf_conntrack_ipv4> EOF[root@master ~]# chmod 755 /etc/sysconfig/modules/ipvs.modules && bash /etc/sysconfig/modules/ipvs.modules && lsmod | grep -e ip_vs -e nf_conntrack_ipv4ip_vs_sh               12688  0 ip_vs_wrr              12697  0 ip_vs_rr               12600  150 ip_vs                 145497  156 ip_vs_rr,ip_vs_sh,ip_vs_wrrnf_conntrack_ipv4      15053  6 nf_defrag_ipv4         12729  1 nf_conntrack_ipv4nf_conntrack          139224  9 ip_vs,nf_nat,nf_nat_ipv4,nf_nat_ipv6,xt_conntrack,nf_nat_masquerade_ipv4,nf_conntrack_netlink,nf_conntrack_ipv4,nf_conntrack_ipv6libcrc32c              12644  3 ip_vs,nf_nat,nf_conntrack[root@master ~]# lsmod | grep -e ip_vs -e nf_conntrack_ipv4ip_vs_sh               12688  0 ip_vs_wrr              12697  0 ip_vs_rr               12600  150 ip_vs                 145497  156 ip_vs_rr,ip_vs_sh,ip_vs_wrrnf_conntrack_ipv4      15053  6 nf_defrag_ipv4         12729  1 nf_conntrack_ipv4nf_conntrack          139224  9 ip_vs,nf_nat,nf_nat_ipv4,nf_nat_ipv6,xt_conntrack,nf_nat_masquerade_ipv4,nf_conntrack_netlink,nf_conntrack_ipv4,nf_conntrack_ipv6libcrc32c              12644  3 ip_vs,nf_nat,nf_conntrack<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h4><p>由于<code>ipvs</code>已经加入到内核主干，所以需要内核模块支持，请确保内核已经加载了相应模块；如不确定，执行以下脚本，以确保内核加载相应模块，否则会出现<code>failed to load kernel modules: [ip_vs_rr ip_vs_sh ip_vs_wrr]</code>错误</p><pre class="line-numbers language-sh"><code class="language-sh">cat > /etc/sysconfig/modules/ipvs.modules <<EOF#!/bin/bashipvs_modules="ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_fo ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack_ipv4"for kernel_module in \${ipvs_modules}; do    /sbin/modinfo -F filename \${kernel_module} > /dev/null 2>&1    if [ $? -eq 0 ]; then        /sbin/modprobe \${kernel_module}    fidoneEOFchmod 755 /etc/sysconfig/modules/ipvs.modules && bash /etc/sysconfig/modules/ipvs.modules && lsmod | grep ip_vs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行后应该如下图所示，如果<code>lsmod | grep ip_vs</code>并未出现 <code>ip_vs_rr</code> 等模块；</p><pre class="line-numbers language-sh"><code class="language-sh">[root@node-d1 ~]# lsmod | grep ip_vsip_vs_ftp              13079  0 ip_vs_sed              12519  0 ip_vs_nq               12516  0 ip_vs_sh               12688  0 ip_vs_dh               12688  0 ip_vs_lblcr            12922  0 ip_vs_lblc             12819  0 ip_vs_wrr              12697  0 ip_vs_wlc              12519  0 ip_vs_lc               12516  0 nf_nat                 26583  5 ip_vs_ftp,nf_nat_ipv4,nf_nat_ipv6,xt_nat,nf_nat_masquerade_ipv4ip_vs_rr               12600  136 ip_vs                 145497  162 ip_vs_dh,ip_vs_lc,ip_vs_nq,ip_vs_rr,ip_vs_sh,ip_vs_ftp,ip_vs_sed,ip_vs_wlc,ip_vs_wrr,ip_vs_lblcr,ip_vs_lblcnf_conntrack          139224  9 ip_vs,nf_nat,nf_nat_ipv4,nf_nat_ipv6,xt_conntrack,nf_nat_masquerade_ipv4,nf_conntrack_netlink,nf_conntrack_ipv4,nf_conntrack_ipv6libcrc32c              12644  3 ip_vs,nf_nat,nf_conntrack<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后重启<code>Kube-proxy</code>和<code>flannel</code>容器，问题解决。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> flannel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>a标签href不跳转禁止跳转</title>
      <link href="/2019/12/10/a-biao-qian-href-bu-tiao-zhuan-jin-zhi-tiao-zhuan/"/>
      <url>/2019/12/10/a-biao-qian-href-bu-tiao-zhuan-jin-zhi-tiao-zhuan/</url>
      
        <content type="html"><![CDATA[<h3 id="a标签href不跳转-禁止跳转"><a href="#a标签href不跳转-禁止跳转" class="headerlink" title="a标签href不跳转 禁止跳转"></a>a标签href不跳转 禁止跳转</h3><p>当页面中a标签不需要任何跳转时，从原理上来讲，可分如下两种方法：</p><h4 id="标签属性href，使其指向空或不返回任何内容。如："><a href="#标签属性href，使其指向空或不返回任何内容。如：" class="headerlink" title="标签属性href，使其指向空或不返回任何内容。如："></a>标签属性href，使其指向空或不返回任何内容。如：</h4><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>javascript:void(0);<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>点此无反应javascript:void(0)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>javascript:;<span class="token punctuation">"</span></span> <span class="token punctuation">></span></span>点此无反应javascript:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="标签事件onclick，阻止其默认行为。如："><a href="#标签事件onclick，阻止其默认行为。如：" class="headerlink" title="标签事件onclick，阻止其默认行为。如："></a>标签事件onclick，阻止其默认行为。如：</h4><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">οnclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>return false;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>return false;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span> <span class="token attr-name">οnclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>return false;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>return false;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>注意：只有一个<code>href="#"</code>是不可以的。</p></blockquote><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> html </category>
          
      </categories>
      
      
        <tags>
            
            <tag> a标签 </tag>
            
            <tag> href </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql外键关联【一张表两个字段分别与另一张表主键关联】</title>
      <link href="/2019/12/05/mysql-wai-jian-guan-lian-yi-zhang-biao-liang-ge-zi-duan-fen-bie-yu-ling-yi-zhang-biao-zhu-jian-guan-lian/"/>
      <url>/2019/12/05/mysql-wai-jian-guan-lian-yi-zhang-biao-liang-ge-zi-duan-fen-bie-yu-ling-yi-zhang-biao-zhu-jian-guan-lian/</url>
      
        <content type="html"><![CDATA[<h3 id="用户表"><a href="#用户表" class="headerlink" title="用户表"></a>用户表</h3><table><thead><tr><th>user_id</th><th>user_name</th></tr></thead><tbody><tr><td>1</td><td>zhangsan</td></tr><tr><td>2</td><td>lisi</td></tr><tr><td>3</td><td>wangwu</td></tr><tr><td>4</td><td>zhaoliu</td></tr></tbody></table><h3 id="另一张money表，表示了借钱的关系"><a href="#另一张money表，表示了借钱的关系" class="headerlink" title="另一张money表，表示了借钱的关系"></a>另一张money表，表示了借钱的关系</h3><table><thead><tr><th>id</th><th>from</th><th>to</th><th>how</th></tr></thead><tbody><tr><td>1</td><td>1</td><td>2</td><td>100</td></tr><tr><td>2</td><td>3</td><td>4</td><td>100</td></tr></tbody></table><h3 id="关联查询"><a href="#关联查询" class="headerlink" title="关联查询"></a>关联查询</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">select</span> m<span class="token punctuation">.</span>id<span class="token punctuation">,</span>u1<span class="token punctuation">.</span>user_name<span class="token punctuation">,</span>u2<span class="token punctuation">.</span>user_name<span class="token punctuation">,</span>m<span class="token punctuation">.</span>how<span class="token keyword">from</span> money <span class="token keyword">as</span> m<span class="token keyword">left</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> <span class="token keyword">user</span> u1 <span class="token keyword">on</span> u2<span class="token punctuation">.</span>user_id<span class="token operator">=</span>m<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token keyword">left</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> <span class="token keyword">user</span> u3 <span class="token keyword">on</span> u3<span class="token punctuation">.</span>user_id<span class="token operator">=</span>m<span class="token punctuation">.</span><span class="token keyword">to</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="显示的结果"><a href="#显示的结果" class="headerlink" title="显示的结果"></a>显示的结果</h3><table><thead><tr><th>id</th><th>user_name</th><th>user_name</th><th>how</th></tr></thead><tbody><tr><td>1</td><td>zhangsan</td><td>lisi</td><td>100</td></tr><tr><td>2</td><td>wangwu</td><td>zhaoliu</td><td>100</td></tr></tbody></table><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>这里有个小问题，中间两列显示的名称一样，都是<code>user_name</code>，这样就不好辨别了，在<code>Mybatis</code>中如果想用</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@ResultType</span><span class="token punctuation">(</span>实体类名称<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>来定义返回的类型，因为两个字段名一样，定义的实体类肯定不能一样，就会导致返回没有结果，怎么处理呢？</p><p>关联查询时，指定结果字段别名</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">select</span> m<span class="token punctuation">.</span>id<span class="token punctuation">,</span>u1<span class="token punctuation">.</span>user_name <span class="token keyword">as</span> user_name1<span class="token punctuation">,</span>u2<span class="token punctuation">.</span>user_name <span class="token keyword">as</span> user_name2<span class="token punctuation">,</span>m<span class="token punctuation">.</span>how<span class="token keyword">from</span> money <span class="token keyword">as</span> m<span class="token keyword">left</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> <span class="token keyword">user</span> u1 <span class="token keyword">on</span> u2<span class="token punctuation">.</span>user_id<span class="token operator">=</span>m<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token keyword">left</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> <span class="token keyword">user</span> u3 <span class="token keyword">on</span> u3<span class="token punctuation">.</span>user_id<span class="token operator">=</span>m<span class="token punctuation">.</span><span class="token keyword">to</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>钉钉群机器人开发</title>
      <link href="/2019/12/03/ding-ding-qun-ji-qi-ren-kai-fa/"/>
      <url>/2019/12/03/ding-ding-qun-ji-qi-ren-kai-fa/</url>
      
        <content type="html"><![CDATA[<h3 id="钉钉群机器人定义"><a href="#钉钉群机器人定义" class="headerlink" title="钉钉群机器人定义"></a>钉钉群机器人定义</h3><p>群机器人是钉钉群的高级扩展功能。群机器人可以将第三方服务的信息聚合到群聊中，实现自动化的信息同步。目前，大部分机器人在添加后，还需要进行Webhook配置，才可正常使用(配置说明详见操作流程中的帮助链接)。</p><p>例如：</p><ul><li>通过聚合GitHub，GitLab等源码管理服务，实现源码更新同步。</li><li>通过聚合Trello，JIRA等项目协调服务，实现项目信息同步。</li><li>另外，群机器人支持Webhook协议的自定义接入，支持更多可能性，例如：你可将运维报警通过自定义机器人聚合到钉钉群实现提醒功能。</li></ul><h3 id="机器人发送消息频率限制"><a href="#机器人发送消息频率限制" class="headerlink" title="机器人发送消息频率限制"></a>机器人发送消息频率限制</h3><p>消息发送太频繁会严重影响群成员的使用体验，大量发消息的场景（譬如系统监控报警）可以将这些信息进行整合，通过<code>markdown</code>消息以摘要的形式发送到群里。</p><p>每个机器人每分钟最多发送<code>20</code>条。如果超过20条，会限流<code>10分钟</code>。</p><h3 id="添加群机器人"><a href="#添加群机器人" class="headerlink" title="添加群机器人"></a>添加群机器人</h3><p>参考官网：<code>https://ding-doc.dingtalk.com/doc#/serverapi3/iydd5h</code></p><h3 id="下载SDK简化开发"><a href="#下载SDK简化开发" class="headerlink" title="下载SDK简化开发"></a>下载SDK简化开发</h3><p>下载链接：<code>https://ding-doc.dingtalk.com/doc#/faquestions/vzbp02</code></p><h3 id="将SDK安装到本地maven仓库"><a href="#将SDK安装到本地maven仓库" class="headerlink" title="将SDK安装到本地maven仓库"></a>将SDK安装到本地maven仓库</h3><pre><code>mvn install:install-file -Dfile=D:/taobao-sdk-java-auto-20191203.jar -DgroupId=com.taobao -DartifactId=taobao-sdk-java-auto-20191203 -Dversion=1.0.0 -Dpackaging=jar</code></pre><h3 id="项目中引用"><a href="#项目中引用" class="headerlink" title="项目中引用"></a>项目中引用</h3><pre class="line-numbers language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.taobao<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>taobao-sdk-java-auto-20191203<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="开发样例"><a href="#开发样例" class="headerlink" title="开发样例"></a>开发样例</h3><pre class="line-numbers language-java"><code class="language-java">DingTalkClient client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultDingTalkClient</span><span class="token punctuation">(</span><span class="token string">"https://oapi.dingtalk.com/robot/send?access_token=566cc69da782ec33e42541b09b08551f09fbe864eb8008112e994b43887"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>OapiRobotSendRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OapiRobotSendRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//文本类型</span>request<span class="token punctuation">.</span><span class="token function">setMsgtype</span><span class="token punctuation">(</span><span class="token string">"text"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>OapiRobotSendRequest<span class="token punctuation">.</span>Text text <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OapiRobotSendRequest<span class="token punctuation">.</span>Text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>text<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span><span class="token string">"测试文本消息"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>request<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>OapiRobotSendRequest<span class="token punctuation">.</span>At at <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OapiRobotSendRequest<span class="token punctuation">.</span>At</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>at<span class="token punctuation">.</span><span class="token function">setAtMobiles</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"132xxxxxxxx"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>request<span class="token punctuation">.</span><span class="token function">setAt</span><span class="token punctuation">(</span>at<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//link类型</span>request<span class="token punctuation">.</span><span class="token function">setMsgtype</span><span class="token punctuation">(</span><span class="token string">"link"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>OapiRobotSendRequest<span class="token punctuation">.</span>Link link <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OapiRobotSendRequest<span class="token punctuation">.</span>Link</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>link<span class="token punctuation">.</span><span class="token function">setMessageUrl</span><span class="token punctuation">(</span><span class="token string">"https://www.dingtalk.com/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>link<span class="token punctuation">.</span><span class="token function">setPicUrl</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>link<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token string">"时代的火车向前开"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>link<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"这个即将发布的新版本，创始人xx称它为“红树林”。\n"</span> <span class="token operator">+</span>        <span class="token string">"而在此之前，每当面临重大升级，产品经理们都会取一个应景的代号，这一次，为什么是“红树林"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>request<span class="token punctuation">.</span><span class="token function">setLink</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//markdown类型</span>request<span class="token punctuation">.</span><span class="token function">setMsgtype</span><span class="token punctuation">(</span><span class="token string">"markdown"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>OapiRobotSendRequest<span class="token punctuation">.</span>Markdown markdown <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OapiRobotSendRequest<span class="token punctuation">.</span>Markdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>markdown<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token string">"杭州天气"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>markdown<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">"#### 杭州天气 @156xxxx8827\n"</span> <span class="token operator">+</span>        <span class="token string">"> 9度，西北风1级，空气良89，相对温度73%\n\n"</span> <span class="token operator">+</span>        <span class="token string">"> ![screenshot](https://gw.alicdn.com/tfs/TB1ut3xxbsrBKNjSZFpXXcXhFXa-846-786.png)\n"</span>  <span class="token operator">+</span>        <span class="token string">"> ###### 10点20分发布 [天气](http://www.thinkpage.cn/) \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>request<span class="token punctuation">.</span><span class="token function">setMarkdown</span><span class="token punctuation">(</span>markdown<span class="token punctuation">)</span><span class="token punctuation">;</span>OapiRobotSendResponse response <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>常用的三种类型如上所示，具体参考<a href="https://ding-doc.dingtalk.com/doc#/serverapi3/iydd5h" target="_blank" rel="noopener">官网类型</a>。</p><h3 id="应答机制"><a href="#应答机制" class="headerlink" title="应答机制"></a>应答机制</h3><p>自定义机器人尚不支持应答机制 (该机制指的是群里成员在聊天@机器人的时候，钉钉回调指定的服务地址，即Outgoing机器人)。</p><h3 id="错误码"><a href="#错误码" class="headerlink" title="错误码"></a>错误码</h3><p>开发者每次调用接口时，可能获得正确或错误的返回码，企业可以根据返回码信息调试接口，排查错误。</p><blockquote><p>注意：开发者的程序应该根据errcode来判断出错的情况，而不应该依赖errmsg来匹配，因为errmsg可能会调整。</p></blockquote><p>参考官网：<a href="https://ding-doc.dingtalk.com/doc#/faquestions/rftpfg" target="_blank" rel="noopener">错误码</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 钉钉 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>prometheus-operator使用【创建Alertmanager的Webhook】</title>
      <link href="/2019/12/03/prometheus-operator-shi-yong-chuang-jian-alertmanager-de-webhook/"/>
      <url>/2019/12/03/prometheus-operator-shi-yong-chuang-jian-alertmanager-de-webhook/</url>
      
        <content type="html"><![CDATA[<blockquote><p>上文介绍了<strong>Alertmanager集成钉钉</strong>，我们还可以自己写一个webhook，用于接收Alertmanager的通知服务。</p></blockquote><h3 id="获取Alertmanager的请求内容"><a href="#获取Alertmanager的请求内容" class="headerlink" title="获取Alertmanager的请求内容"></a>获取Alertmanager的请求内容</h3><p>参考前文，我们知道Alertmanager会向配置的webhook地址发送一个POST请求，这里我们先编写一个简单的controller，用于接收Alertmanager的请求，如下：</p><pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/test"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">watcher</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        BufferedReader reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String str <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>        String wholeStr <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>str <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            wholeStr <span class="token operator">+=</span> str<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"body:"</span> <span class="token operator">+</span> wholeStr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>写好上面的服务之后，修改Alertmanager中webhook地址，然后将上面打印的body分析分析。如下：</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"receiver"</span><span class="token operator">:</span><span class="token string">"webhook_alert"</span><span class="token punctuation">,</span>  <span class="token property">"status"</span><span class="token operator">:</span><span class="token string">"resolved"</span><span class="token punctuation">,</span>  <span class="token property">"alerts"</span><span class="token operator">:</span><span class="token punctuation">[</span>    <span class="token punctuation">{</span>      <span class="token property">"status"</span><span class="token operator">:</span><span class="token string">"resolved"</span><span class="token punctuation">,</span>      <span class="token property">"labels"</span><span class="token operator">:</span><span class="token punctuation">{</span>        <span class="token property">"alertname"</span><span class="token operator">:</span><span class="token string">"curl test"</span><span class="token punctuation">,</span>        <span class="token property">"severity"</span><span class="token operator">:</span><span class="token string">"warning"</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token property">"annotations"</span><span class="token operator">:</span><span class="token punctuation">{</span>        <span class="token property">"description"</span><span class="token operator">:</span><span class="token string">"this is a test alert from curl"</span><span class="token punctuation">,</span>        <span class="token property">"summary"</span><span class="token operator">:</span><span class="token string">"test alert from curl"</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token property">"startsAt"</span><span class="token operator">:</span><span class="token string">"2019-12-03T03:22:50.430372292Z"</span><span class="token punctuation">,</span>      <span class="token property">"endsAt"</span><span class="token operator">:</span><span class="token string">"2019-12-03T03:26:50.430372292Z"</span><span class="token punctuation">,</span>      <span class="token property">"generatorURL"</span><span class="token operator">:</span><span class="token string">""</span><span class="token punctuation">,</span>      <span class="token property">"fingerprint"</span><span class="token operator">:</span><span class="token string">"960077177807fca5"</span>    <span class="token punctuation">}</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token property">"groupLabels"</span><span class="token operator">:</span><span class="token punctuation">{</span>    <span class="token property">"alertname"</span><span class="token operator">:</span><span class="token string">"curl test"</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token property">"commonLabels"</span><span class="token operator">:</span><span class="token punctuation">{</span>    <span class="token property">"alertname"</span><span class="token operator">:</span><span class="token string">"curl test"</span><span class="token punctuation">,</span>    <span class="token property">"severity"</span><span class="token operator">:</span><span class="token string">"warning"</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token property">"commonAnnotations"</span><span class="token operator">:</span><span class="token punctuation">{</span>    <span class="token property">"description"</span><span class="token operator">:</span><span class="token string">"this is a test alert from curl"</span><span class="token punctuation">,</span>    <span class="token property">"summary"</span><span class="token operator">:</span><span class="token string">"test alert from curl"</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token property">"externalURL"</span><span class="token operator">:</span><span class="token string">"http://alertmanager-prometheus-operator-alertmanager-test-0:9093"</span><span class="token punctuation">,</span>  <span class="token property">"version"</span><span class="token operator">:</span><span class="token string">"4"</span><span class="token punctuation">,</span>  <span class="token property">"groupKey"</span><span class="token operator">:</span><span class="token string">"{}/{severity="</span>warning<span class="token string">"}:{alertname="</span>curl test<span class="token string">"}"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>所有接收到的请求内容格式基本不变，标准的<code>JSON格式</code>，我们编写一个<code>实体类</code>用于接收。</p><h3 id="编写实体类"><a href="#编写实体类" class="headerlink" title="编写实体类"></a>编写实体类</h3><p>编写内层实体类<code>Alert.java</code></p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * @ClassName: Alert * @Description: TODO * @Author: wuzhiyong * @Time: 2019/12/3 11:39 * @Version: v1.0 **/</span><span class="token annotation punctuation">@Data</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Alert</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * 状态：firing / resolved     */</span>    <span class="token keyword">private</span> String status<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 标签     */</span>    <span class="token keyword">private</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> labels<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 携带的其它信息     */</span>    <span class="token keyword">private</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> annotations<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 开始时间     */</span>    <span class="token keyword">private</span> String startsAt<span class="token punctuation">;</span>    <span class="token keyword">private</span> String endsAt<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * 产生的alertmanager信息     */</span>    <span class="token keyword">private</span> String generatorURL<span class="token punctuation">;</span>    <span class="token keyword">private</span> String fingerprint<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Alert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>编写外层实体类<code>Alerts.java</code></p><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** * @ClassName: Alerts * @Description: Alertmanager发出的告警格式 * @Author: wuzhiyong * @Time: 2019/12/3 11:49 * @Version: v1.0 **/</span><span class="token annotation punctuation">@Data</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Alerts</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String externalURL<span class="token punctuation">;</span>    <span class="token keyword">private</span> String version<span class="token punctuation">;</span>    <span class="token keyword">private</span> String groupKey<span class="token punctuation">;</span>    <span class="token keyword">private</span> String receiver<span class="token punctuation">;</span>    <span class="token keyword">private</span> String status<span class="token punctuation">;</span>    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>Alert<span class="token operator">></span> alerts<span class="token punctuation">;</span>    <span class="token keyword">private</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> groupLabels<span class="token punctuation">;</span>    <span class="token keyword">private</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> commonLabels<span class="token punctuation">;</span>    <span class="token keyword">private</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> commonAnnotations<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Alerts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="编写webhook"><a href="#编写webhook" class="headerlink" title="编写webhook"></a>编写webhook</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/receive"</span><span class="token punctuation">,</span> method <span class="token operator">=</span> RequestMethod<span class="token punctuation">.</span>POST<span class="token punctuation">)</span>    <span class="token keyword">void</span> <span class="token function">receive</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> Alerts alerts<span class="token punctuation">)</span> <span class="token punctuation">{</span>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"new alert: {}"</span><span class="token punctuation">,</span>alerts<span class="token punctuation">.</span><span class="token function">getCommonLabels</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"alertname"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>上面接收到<code>Alert manager</code>的请求，只是打印了<code>alert name</code>的日志，我们可以根据接收到告警，做更多的事。</p><p>可以根据自身业务自行发挥。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> prometheus </tag>
            
            <tag> alertmanager </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>prometheus-operator使用【prometheus配置说明】</title>
      <link href="/2019/11/29/prometheus-operator-shi-yong-prometheus-pei-zhi-shuo-ming/"/>
      <url>/2019/11/29/prometheus-operator-shi-yong-prometheus-pei-zhi-shuo-ming/</url>
      
        <content type="html"><![CDATA[<h2 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h2><p>参考官网：<code>https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config</code></p><pre class="line-numbers language-yml"><code class="language-yml">global:  # How frequently to scrape targets by default.  [ scrape_interval: <duration> | default = 1m ]  # How long until a scrape request times out.  [ scrape_timeout: <duration> | default = 10s ]  # How frequently to evaluate rules.  [ evaluation_interval: <duration> | default = 1m ]  # The labels to add to any time series or alerts when communicating with  # external systems (federation, remote storage, Alertmanager).  external_labels:    [ <labelname>: <labelvalue> ... ]# Rule files specifies a list of globs. Rules and alerts are read from# all matching files.rule_files:  [ - <filepath_glob> ... ]# A list of scrape configurations.scrape_configs:  [ - <scrape_config> ... ]# Alerting specifies settings related to the Alertmanager.alerting:  alert_relabel_configs:    [ - <relabel_config> ... ]  alertmanagers:    [ - <alertmanager_config> ... ]# Settings related to the remote write feature.remote_write:  [ - <remote_write> ... ]# Settings related to the remote read feature.remote_read:  [ - <remote_read> ... ]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="更改指标标签"><a href="#更改指标标签" class="headerlink" title="更改指标标签"></a>更改指标标签</h2><p>更改标签的时机：抓取前修改、抓取后修改、告警时修改</p><ul><li>采集数据之前，通过<code>relabel_config</code>；</li><li>采集数据之后，写入存储之前，通过<code>metric_relabel_configs</code></li><li>在告警前修改标签，通过<code>alert_relabel_configs</code></li></ul><h2 id="JOB配置"><a href="#JOB配置" class="headerlink" title="JOB配置"></a>JOB配置</h2><pre class="line-numbers language-yml"><code class="language-yml">- job_name: prometheus  honor_labels: false  kubernetes_sd_configs:  - role: endpoints    namespaces:      names:      - monitoring  scrape_interval: 30s  relabel_configs:  - action: keep    source_labels:    - __meta_kubernetes_service_label_prometheus    regex: k8s  - source_labels:    - __meta_kubernetes_endpoint_address_target_kind    - __meta_kubernetes_endpoint_address_target_name    separator: ;    regex: Pod;(.*)    replacement: ${1}    target_label: pod  - source_labels:    - __meta_kubernetes_namespace    target_label: namespace<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>kubernetes_sd_configs</code>：使用这个配置可以自动发现 k8s 中 node、service、pod、endpoint、ingress，并为其添加监控，更多的内容可以直接查看官方文档。__meta_kubernetes_xxxxx具体什么意思都可以在官网找到。</li><li><code>endpoints</code>:采用endpoints方式采集，每创建一个 service 就会创建一个对应的 endpoint，通过endpoint方式可以将service下所有的pod都采集到。</li><li>下面配置的意思是只有 service 的标签包含 prometheus=k8s，k8s 才会对其对应的 endpoint 进行采集。所以我们后面要为 Prometheus 创建一个 service，并且要为这个 service 加上 prometheus: k8s 这样的标签。<pre class="line-numbers language-yml"><code class="language-yml">- action: keep  source_labels:  - __meta_kubernetes_service_label_prometheus  regex: k8s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li><li>下面配置意识是如果 <strong>meta_kubernetes_endpoint_address_target_kind 的值为 Pod，</strong>meta_kubernetes_endpoint_address_target_name 的值为 prometheus-0，在它们之间加上一个 ; 之后，它们合起来就是 Pod;prometheus-0。使用正则表达式 Pod;(.*) 对其进行匹配，那么 ${1} 就是取第一个分组，它值就是 prometheus-0，最后将这个值交给 pod 这个标签。因此这一段配置就是为所有采集到的监控指标增加一个 pod=prometheus-0 的标签。如果 __meta_kubernetes_endpoint_address_target_kind 的值不是 Pod，那么不会添加任何标签。<br>```yml</li><li>source_labels:<ul><li>__meta_kubernetes_endpoint_address_target_kind</li><li>__meta_kubernetes_endpoint_address_target_name<br>separator: ;<br>regex: Pod;(.*)<br>replacement: ${1}<br>target_label: pod<br>```</li></ul></li><li>没有指定 url，Prometheus 会采集默认的 url <code>/metrics</code>。</li></ul><h2 id="定义告警规则"><a href="#定义告警规则" class="headerlink" title="定义告警规则"></a>定义告警规则</h2><pre class="line-numbers language-yml"><code class="language-yml">groups:- name: example  rules:  - alert: HighRequestLatency    expr: job:request_latency_seconds:mean5m{job="myjob"} > 0.5    for: 10m    labels:      severity: page    annotations:      summary: High request latency<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>参考官网： <code>https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/</code></p><ul><li><code>for</code>：Prometheus将在每次发出警报之前检查警报在10分钟内是否继续处于活动状态</li><li><code>labels</code>：允许指定一组附加标签来附加到警报。任何现有的冲突标签都将被覆盖。标签值可以模板化。</li><li><code>annotations</code>：指定了一组信息标签，可用于存储更长的附加信息，例如警报说明或运行手册链接。注释值可以模板化。</li></ul><h2 id="模板化"><a href="#模板化" class="headerlink" title="模板化"></a>模板化</h2><p>标签和注释值可以使用<a href="https://prometheus.io/docs/visualization/consoles/" target="_blank" rel="noopener">控制台模板进行模板化</a>。该<code>$labels</code> 变量保存警报实例的标签键/值对。可以通过<code>$externalLabels</code>变量访问已组态的外部标签。该 <code>$value</code>变量保存警报实例的评估值。</p><pre class="line-numbers language-yml"><code class="language-yml"># To insert a firing element's label values:{{ $labels.<labelname> }}# To insert the numeric expression value of the firing element:{{ $value }}</labelname><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>例子：</p><pre class="line-numbers language-yml"><code class="language-yml">groups:- name: example  rules:  # Alert for any instance that is unreachable for >5 minutes.  - alert: InstanceDown    expr: up == 0    for: 5m    labels:      severity: page    annotations:      summary: "Instance {{ $labels.instance }} down"      description: "{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 5 minutes."  # Alert for any instance that has a median request latency >1s.  - alert: APIHighRequestLatency    expr: api_http_request_latencies_second{quantile="0.5"} > 1    for: 10m    annotations:      summary: "High request latency on {{ $labels.instance }}"      description: "{{ $labels.instance }} has a median request latency above 1s (current value: {{ $value }}s)"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> prometheus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>prometheus-operator使用【创建新的Alertmanager】</title>
      <link href="/2019/11/29/prometheus-operator-shi-yong-chuang-jian-xin-de-alertmanager/"/>
      <url>/2019/11/29/prometheus-operator-shi-yong-chuang-jian-xin-de-alertmanager/</url>
      
        <content type="html"><![CDATA[<blockquote><p><code>Alertmanager</code>是安装<code>prometheus-operator</code>时默认新增的自定义资源类型（<code>CRD</code>），我们可以直接在K8s中创建这样的资源。</p></blockquote><h3 id="创建alert-test-yaml"><a href="#创建alert-test-yaml" class="headerlink" title="创建alert-test.yaml"></a>创建alert-test.yaml</h3><pre class="line-numbers language-yml"><code class="language-yml">apiVersion: monitoring.coreos.com/v1kind: Alertmanagermetadata:  generation: 1  labels:    app: prometheus-operator-alertmanager    chart: prometheus-operator-8.2.4    heritage: Tiller    release: prometheus-operator  name: prometheus-operator-alertmanager-test  namespace: monitoringspec:  baseImage: quay.io/prometheus/alertmanager  version: v0.19.0  portName: web  replicas: 1  retention: 120h  routePrefix: /  serviceAccountName: prometheus-operator-alertmanager  affinity:    podAntiAffinity:      requiredDuringSchedulingIgnoredDuringExecution:      - topologyKey: kubernetes.io/hostname        labelSelector:          matchLabels:            app: alertmanager            alertmanager: prometheus-operator-alertmanager-test    podAntiAffinity:      preferredDuringSchedulingIgnoredDuringExecution:      - weight: 100        podAffinityTerm:          topologyKey: kubernetes.io/hostname          labelSelector:            matchLabels:              app: alertmanager              alertmanager: prometheus-operator-alertmanager-test  storage:    volumeClaimTemplate:      selector: {}      spec:        accessModes:        - ReadWriteOnce        resources:          requests:            storage: 1Gi        storageClassName: nfs-client<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="针对以上配置文件简要说明："><a href="#针对以上配置文件简要说明：" class="headerlink" title="针对以上配置文件简要说明："></a>针对以上配置文件简要说明：</h4><ul><li>所有配置项可以从<code>stable/prometheus-operator/templates/alertmanager/alertmanager.yaml</code>获取，参考前文，<code>prometheus-operator</code>环境是使用<code>helm</code>安装的，可以通过命令<code>helm fetch stable/prometheus-operator</code>将所有配置下载到本地，然后参考。helm安装会默认安装一个<code>Alertmanager</code>服务，也是通过<code>alertmanager.yaml</code>安装的。</li><li><code>kind</code>类型写Alertmanager，无需多言。</li><li><code>metadata.name</code>指定你这个Alertmanager名称，可以通过命令查询<pre><code>kubectl get alertmanager -n monitoring</code></pre></li><li><code>spec.baseImage/version</code>需要指定，不然默认使用的镜像版本可能跟helm安装时使用的版本不一致，导致你需要重新下载，部署就非常慢。</li><li><code>spec.storage</code>指定你新部署的Alertmanager存储，建议指定。</li><li><code>spec.affinity</code>需要指定一些label，Alertmanager对象本质还是一个StatefulSet对象，后面你为Alertmanager对象创建Service时需要通过Label选择。</li><li><code>spec.portName</code>指定你端口的名称，这个后面配置和Prometheus关联的时候需要。建议保持默认。</li><li><code>metadata.namespace</code>指定命名空间，这个后面配置和Prometheus关联的时候需要。建议保持默认。</li><li><code>spec.routePrefix</code>指定路径前缀，这个后面配置和Prometheus关联的时候需要。建议保持默认。</li></ul><h3 id="过命令或者dashborad创建Alertmanager"><a href="#过命令或者dashborad创建Alertmanager" class="headerlink" title="过命令或者dashborad创建Alertmanager"></a>过命令或者dashborad创建Alertmanager</h3><pre><code>kubectl create -f alert-test.yaml</code></pre><h4 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h4><p>现在创建这个，肯定会报错，类似<code>MountVolume.SetUp failed for volume "config-volume" : secrets "alertmanager-XXXX-xX" not found</code></p><p>原因：（参考：<code>https://yunlzheng.gitbook.io/prometheus-book/part-iii-prometheus-shi-zhan/operator/use-operator-manage-monitor</code>）</p><p>这是由于<code>Prometheus Operator</code>通过<code>Statefulset</code>的方式创建的<code>Alertmanager</code>实例，在默认情况下，会通过<code>alertmanager-{ALERTMANAGER_NAME}</code>的命名规则去查找<code>Secret</code>配置并以文件挂载的方式，将<code>Secret</code>的内容作为配置文件挂载到<code>Alertmanager</code>实例当中。因此，需要提前为<code>Alertmanager</code>创建相应的配置内容。</p><h3 id="参考前文Alertmanager配置"><a href="#参考前文Alertmanager配置" class="headerlink" title="参考前文Alertmanager配置"></a>参考前文Alertmanager配置</h3><p>我们创建<code>alertmanager.yaml</code>，<code>template_1.tmpl</code></p><p>然后用命令创建<code>secret</code>，<code>secret</code>名称格式：<code>alertmanager-{ALERTMANAGER_NAME}</code>,例如我们前文指定的<code>Alertmanager</code>名称为<code>prometheus-operator-alertmanager-test</code>，那么这里<code>secret</code>名称为<code>alertmanager-prometheus-operator-alertmanager-test</code>。</p><pre><code>kubectl create secret generic alertmanager-prometheus-operator-alertmanager-test -n monitoring --from-file=alertmanager.yaml --from-file=template_1.tmpl</code></pre><h3 id="最后创建Alertmanager"><a href="#最后创建Alertmanager" class="headerlink" title="最后创建Alertmanager"></a>最后创建Alertmanager</h3><h3 id="创建Alertmanager的service"><a href="#创建Alertmanager的service" class="headerlink" title="创建Alertmanager的service"></a>创建Alertmanager的service</h3><blockquote><p>这里直接指定Service类型是NodePort，便于我们访问，实际应通过Ingress来做。</p></blockquote><pre class="line-numbers language-yml"><code class="language-yml">apiVersion: v1kind: Servicemetadata:  labels:    app: prometheus-operator-alertmanager    chart: prometheus-operator-8.2.4    heritage: Tiller    release: prometheus-operator  name: prometheus-operator-alertmanager-test  namespace: monitoringspec:  ports:  - name: web    port: 9093    protocol: TCP    targetPort: 9093  selector:    alertmanager: prometheus-operator-alertmanager-test    app: alertmanager  sessionAffinity: None  type: NodePort<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>注意：这里通过<code>selector</code>来选择，和创建<code>Alertmanager</code>配置中保持一致。</p></blockquote><h3 id="通过命令查询Service的映射端口"><a href="#通过命令查询Service的映射端口" class="headerlink" title="通过命令查询Service的映射端口"></a>通过命令查询Service的映射端口</h3><pre><code>kubectl get svc -n monitoring</code></pre><p>通过命令查询Service的映射端口，即可访问我们刚刚创建的Alertmanager.</p><p>现在Alertmanager上应该还没有任何通知，原因是还没有将我们创建的Alertmanager和Prometheus关联。</p><h3 id="关联Prometheus"><a href="#关联Prometheus" class="headerlink" title="关联Prometheus"></a>关联Prometheus</h3><p>如何关联Prometheus呢？首先查看下prometheus-operator创建的Prometheus的配置，prometheus-operator也是通过自定义资源类型（CRD）prometheus来创建prometheus server的，直接通过命令查看。</p><pre class="line-numbers language-yml"><code class="language-yml">kubectl get Prometheus prometheus-operator-prometheus  -n monitoring -o yamlapiVersion: monitoring.coreos.com/v1kind: Prometheusmetadata:  creationTimestamp: "2019-11-28T02:42:48Z"  generation: 1  labels:    app: prometheus-operator-prometheus    chart: prometheus-operator-8.2.4    heritage: Tiller    release: prometheus-operator  name: prometheus-operator-prometheus  namespace: monitoring  resourceVersion: "6316434"  selfLink: /apis/monitoring.coreos.com/v1/namespaces/monitoring/prometheuses/prometheus-operator-prometheus  uid: de60d68f-6818-484d-ba30-4f381e7cb016spec:  alerting:    alertmanagers:    - name: prometheus-operator-alertmanager      namespace: monitoring      pathPrefix: /      port: web  baseImage: quay.io/prometheus/prometheus  enableAdminAPI: false  externalUrl: http://prom.deri.com/  listenLocal: false  logFormat: logfmt  logLevel: info  paused: false  podMonitorNamespaceSelector: {}  podMonitorSelector:    matchLabels:      release: prometheus-operator  portName: web  replicas: 1  retention: 10d  routePrefix: /  ruleNamespaceSelector: {}  ruleSelector:    matchLabels:      app: prometheus-operator      release: prometheus-operator  securityContext:    fsGroup: 2000    runAsNonRoot: true    runAsUser: 1000  serviceAccountName: prometheus-operator-prometheus  serviceMonitorNamespaceSelector: {}  serviceMonitorSelector:    matchLabels:      release: prometheus-operator  storage:    volumeClaimTemplate:      selector: {}      spec:        accessModes:        - ReadWriteOnce        resources:          requests:            storage: 2Gi        storageClassName: nfs-client  version: v2.13.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Prometheus配置"><a href="#Prometheus配置" class="headerlink" title="Prometheus配置"></a>Prometheus配置</h4><ul><li><code>spec.alerting.alertmanagers</code>就是指定Prometheus将告警发给哪些alertmanagers。</li><li><code>spec.ruleSelector.matchLabels</code>通过标签关联用户创建的自定义PrometheusRule。</li><li><code>spec.serviceMonitorSelector.matchLabels</code>通过标签关联用户创建的自定义ServiceMonitor</li></ul><p>使用命令编辑已有的Prometheus服务配置</p><pre><code>kubectl edit Prometheus prometheus-operator-prometheus  -n monitoring</code></pre><p>增加一个<code>Alertmanager</code>的<code>Endpoint</code>，其中<code>name</code>、<code>namespace</code>、<code>pathPrefix</code>、<code>port</code>和创建<code>Alertmanager</code>配置保持一致。</p><pre class="line-numbers language-yml"><code class="language-yml">spec:  alerting:    alertmanagers:    - name: prometheus-operator-alertmanager      namespace: monitoring      pathPrefix: /      port: web    - name: prometheus-operator-alertmanager-test      namespace: monitoring      pathPrefix: /      port: web<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> prometheus </tag>
            
            <tag> Alertmanager </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>prometheus-operator使用【了解Alertmanager通知机制】</title>
      <link href="/2019/11/28/prometheus-operator-shi-yong-liao-jie-alertmanager-tong-zhi-ji-zhi/"/>
      <url>/2019/11/28/prometheus-operator-shi-yong-liao-jie-alertmanager-tong-zhi-ji-zhi/</url>
      
        <content type="html"><![CDATA[<h2 id="Alertmanager简介及机制"><a href="#Alertmanager简介及机制" class="headerlink" title="Alertmanager简介及机制"></a>Alertmanager简介及机制</h2><p>Alertmanager处理由例如Prometheus服务器等客户端发来的警报。它负责删除重复数据、分组，并将警报通过路由发送到正确的接收器，比如电子邮件、Slack等。Alertmanager还支持groups,silencing和警报抑制的机制。</p><h3 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h3><p>分组是指将同一类型的警报分类为单个通知。当许多系统同时宕机时，很有可能成百上千的警报会同时生成，这种机制特别有用。</p><h3 id="抑制-Inhibition"><a href="#抑制-Inhibition" class="headerlink" title="抑制(Inhibition)"></a>抑制(Inhibition)</h3><p>抑制是指当警报发出后，停止重复发送由此警报引发其他错误的警报的机制。(比如网络不可达，导致其他服务连接相关警报)</p><h3 id="沉默-Silences"><a href="#沉默-Silences" class="headerlink" title="沉默(Silences)"></a>沉默(Silences)</h3><p>Silences是一种简单的特定时间不告警的机制。</p><h3 id="默认配置"><a href="#默认配置" class="headerlink" title="默认配置"></a>默认配置</h3><p>打开Alertmanager的页面，选择status页面，可以查看到当前的Config。这是使用Helm安装prometheus-operator时默认的配置，如何修改呢？</p><pre class="line-numbers language-yml"><code class="language-yml">global:  resolve_timeout: 4m  http_config: {}  smtp_hello: localhost  smtp_require_tls: true  pagerduty_url: https://events.pagerduty.com/v2/enqueue  hipchat_api_url: https://api.hipchat.com/  opsgenie_api_url: https://api.opsgenie.com/  wechat_api_url: https://qyapi.weixin.qq.com/cgi-bin/  victorops_api_url: https://alert.victorops.com/integrations/generic/20131114/alert/route:  receiver: "null"  group_by:  - job  routes:  - receiver: "null"    match:      severity: info  group_wait: 30s  group_interval: 5m  repeat_interval: 12hreceivers:- name: "null"templates: []<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Alertmanager配置说明"><a href="#Alertmanager配置说明" class="headerlink" title="Alertmanager配置说明"></a>Alertmanager配置说明</h2><p>参考<code>https://www.jianshu.com/p/239b145e2acc</code></p><h2 id="修改默认配置"><a href="#修改默认配置" class="headerlink" title="修改默认配置"></a>修改默认配置</h2><p>默认配置由同命名空间下<code>Secret</code>挂载到<code>POD</code>中，所以只要修改了这个<code>Secret</code>就可以修改默认配置了。</p><p><code>alertmanager-prometheus-operator-alertmanager</code>内容主要是<code>alertmanager.yaml</code> 经过<code>Base64加密</code>的。可以通过命令查看</p><pre><code>kubectl edit  secret alertmanager-prometheus-operator-alertmanager -n monitoring</code></pre><p>复制其中的<code>alertmanager.yaml</code>后面的字符串，然后使用命令查看原始值。</p><pre class="line-numbers language-log"><code class="language-log">echo "Imdsb2JhbCI6IAogICJyZXNvbHZlX3RpbWVvdXQiOiAiNW0iCiJyZWNlaXZlcnMiOiAKLSAibmFtZSI6ICJudWxsIgoicm91dGUiOiAKICAiZ3JvdXBfYnkiOiAKICAtICJqb2IiCiAgImdyb3VwX2ludGVydmFsIjogIjVtIgogICJncm91cF93YWl0IjogIjMwcyIKICAicmVjZWl2ZXIiOiAibnVsbCIKICAicmVwZWF0X2ludGVydmFsIjogIjEyaCIKICAicm91dGVzIjogCiAgLSAibWF0Y2giOiAKICAgICAgImFsZXJ0bmFtZSI6ICJEZWFkTWFuc1N3aXRjaCIKICAgICJyZWNlaXZlciI6ICJudWxsIg==" | base64 -d"global":  "resolve_timeout": "5m""receivers":- "name": "null""route":  "group_by":  - "job"  "group_interval": "5m"  "group_wait": "30s"  "receiver": "null"  "repeat_interval": "12h"  "routes":  - "match":      "alertname": "DeadMansSwitch"    "receiver": "null"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建一个新的<code>alertmanager.yaml</code>文件，内容</p><pre class="line-numbers language-yml"><code class="language-yml">global:  resolve_timeout: 4mreceivers:- name: webhook_alert  webhook_configs:  - send_resolved: true    url: http://dingtalkservice:8060/dingtalk/webhook1/send route:  group_by:  - job  - alertname  - cluster  - service  group_interval: 5m  group_wait: 30s  receiver: webhook_alert  repeat_interval: 12h  routes:  - match:      severity: info    receiver: webhook_alert  - match:      severity: warning    receiver: webhook_alerttemplates:- '*.tmpl'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中我们增加了<code>webhook</code>方式报警，配置最后增加了模板，所以我们还需要创建一个模板，如<code>template_1.tmpl</code></p><pre class="line-numbers language-go"><code class="language-go"><span class="token punctuation">{</span><span class="token punctuation">{</span> define <span class="token string">"cluster"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>    <span class="token punctuation">[</span>错误订阅信息<span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token builtin">len</span> <span class="token punctuation">.</span>Alerts <span class="token punctuation">}</span><span class="token punctuation">}</span>条 <span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">.</span>GroupLabels<span class="token punctuation">.</span>appid<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">-</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">.</span>GroupLabels<span class="token punctuation">.</span>service<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span> 时间    <span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token keyword">range</span> $i<span class="token punctuation">,</span> $alert <span class="token operator">:=</span> <span class="token punctuation">.</span>Alerts <span class="token punctuation">}</span><span class="token punctuation">}</span>        <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token keyword">if</span> eq $i <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">}</span>             <span class="token punctuation">{</span><span class="token punctuation">{</span> $alert<span class="token punctuation">.</span>StartsAt <span class="token punctuation">}</span><span class="token punctuation">}</span>        <span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>    <span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span> define <span class="token string">"alertemp.html"</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>    <span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token keyword">range</span> $i<span class="token punctuation">,</span> $alert <span class="token operator">:=</span> <span class="token punctuation">.</span>Alerts <span class="token punctuation">}</span><span class="token punctuation">}</span>        <span class="token operator">*</span>报警名称<span class="token punctuation">:</span><span class="token operator">*</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> $alert<span class="token punctuation">.</span>Labels<span class="token punctuation">.</span>alertname <span class="token punctuation">}</span><span class="token punctuation">}</span>        <span class="token operator">*</span>开始时间<span class="token punctuation">:</span><span class="token operator">*</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> $alert<span class="token punctuation">.</span>StartsAt <span class="token punctuation">}</span><span class="token punctuation">}</span>        <span class="token operator">*</span>错误信息<span class="token punctuation">:</span><span class="token operator">*</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> $alert<span class="token punctuation">.</span>Annotations<span class="token punctuation">.</span>errormessage <span class="token punctuation">}</span><span class="token punctuation">}</span>    <span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上述模板参考：<code>http://blog.microservice4.net/2018/12/05/alertmanager/</code></p><p>先删除原来的Secret</p><pre><code>kubectl delete secret alertmanager-prometheus-operator-alertmanager -n monitoring</code></pre><p>从刚刚文件创建新的Secret</p><pre><code>kubectl create secret generic alertmanager-prometheus-operator-alertmanager -n monitoring --from-file=alertmanager.yaml --from-file=template_1.tmpl</code></pre><p>创建完之后可以通过log命令查看后台有没有报错。</p><pre><code>kubectl log alertmanager-prometheus-operator-alertmanager-0 alertmanager -n monitoring</code></pre><p>也可以在Dashboard中查看日志。还可以在Alertmanager容器中查看<br><img src="/images/k8s6.png" alt="altermanager"></p><p>最后在Alertmanager页面中查看Config是否更新。<br><img src="/images/k8s7.png" alt="altermanager"></p><p>到此，已经完成Alertmanager默认配置的更新。</p><p>以上参考<code>https://www.qikqiak.com/post/prometheus-operator-custom-alert/</code>.</p><h2 id="上述配置Webhook使用的钉钉来做通知"><a href="#上述配置Webhook使用的钉钉来做通知" class="headerlink" title="上述配置Webhook使用的钉钉来做通知"></a>上述配置Webhook使用的钉钉来做通知</h2><h3 id="webhook通知机制"><a href="#webhook通知机制" class="headerlink" title="webhook通知机制"></a>webhook通知机制</h3><p>在Alertmanager中可以使用如下配置定义基于webhook的告警接收器receiver。一个receiver可以对应一组webhook配置。</p><pre class="line-numbers language-yml"><code class="language-yml">name: <string>webhook_configs:  [ - <webhook_config>, ... ]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>每一项webhook_config的具体配置格式如下：</p><pre class="line-numbers language-yml"><code class="language-yml"># Whether or not to notify about resolved alerts.[ send_resolved: <boolean> | default = true ]# The endpoint to send HTTP POST requests to.url: <string># The HTTP client's configuration.[ http_config: <http_config> | default = global.http_config ]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>send_resolved用于指定是否在告警消除时发送回执消息。url则是用于接收webhook请求的地址。http_configs则是在需要对请求进行SSL配置时使用。</p><p>当用户定义webhook用于接收告警信息后，当告警被触发时，Alertmanager会按照以下格式向这些url地址发送HTTP Post请求，请求内容如下：</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"4"</span><span class="token punctuation">,</span>  <span class="token property">"groupKey"</span><span class="token operator">:</span> &lt;string><span class="token punctuation">,</span>    // key identifying the group of alerts (e.g. to deduplicate<span class="token punctuation">)</span>  <span class="token property">"status"</span><span class="token operator">:</span> "&lt;resolved|firing>"<span class="token punctuation">,</span>  <span class="token property">"receiver"</span><span class="token operator">:</span> &lt;string><span class="token punctuation">,</span>  <span class="token property">"groupLabels"</span><span class="token operator">:</span> &lt;object><span class="token punctuation">,</span>  <span class="token property">"commonLabels"</span><span class="token operator">:</span> &lt;object><span class="token punctuation">,</span>  <span class="token property">"commonAnnotations"</span><span class="token operator">:</span> &lt;object><span class="token punctuation">,</span>  <span class="token property">"externalURL"</span><span class="token operator">:</span> &lt;string><span class="token punctuation">,</span>  // backlink to the Alertmanager.  <span class="token property">"alerts"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">{</span>      <span class="token property">"labels"</span><span class="token operator">:</span> &lt;object><span class="token punctuation">,</span>      <span class="token property">"annotations"</span><span class="token operator">:</span> &lt;object><span class="token punctuation">,</span>      <span class="token property">"startsAt"</span><span class="token operator">:</span> <span class="token string">"&lt;rfc3339>"</span><span class="token punctuation">,</span>      <span class="token property">"endsAt"</span><span class="token operator">:</span> <span class="token string">"&lt;rfc3339>"</span>    <span class="token punctuation">}</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="钉钉机器人"><a href="#钉钉机器人" class="headerlink" title="钉钉机器人"></a>钉钉机器人</h3><p>webhook机器人创建成功后，用户就可以使用任何方式向该地址发起HTTP POST请求，即可实现向该群主发送消息。目前自定义机器人支持文本(text)，连接(link)，markdown三种消息类型。</p><p>例如，可以向webhook地址以POST形式发送以下</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>     <span class="token property">"msgtype"</span><span class="token operator">:</span> <span class="token string">"markdown"</span><span class="token punctuation">,</span>     <span class="token property">"markdown"</span><span class="token operator">:</span> <span class="token punctuation">{</span>         <span class="token property">"title"</span><span class="token operator">:</span><span class="token string">"Prometheus告警信息"</span><span class="token punctuation">,</span>         <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"#### 监控指标\n"</span> +                 <span class="token string">"> 监控描述信息\n\n"</span> +                 <span class="token string">"> ###### 告警时间 \n"</span>     <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"at"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"atMobiles"</span><span class="token operator">:</span> <span class="token punctuation">[</span>            <span class="token string">"156xxxx8827"</span><span class="token punctuation">,</span>            <span class="token string">"189xxxx8325"</span>        <span class="token punctuation">]</span><span class="token punctuation">,</span>         <span class="token property">"isAtAll"</span><span class="token operator">:</span> <span class="token boolean">false</span>    <span class="token punctuation">}</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以使用curl验证钉钉webhook是否能够成功调用：</p><pre class="line-numbers language-sh"><code class="language-sh">$ curl -l -H "Content-type: application/json" -X POST -d '{"msgtype": "markdown","markdown": {"title":"Prometheus告警信息","text": "#### 监控指标\n> 监控描述信息\n\n> ###### 告警时间 \n"},"at": {"isAtAll": false}}' https://oapi.dingtalk.com/robot/send?access_token=xxxx{"errcode":0,"errmsg":"ok"}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>如果想把Alertmanager信息转到钉钉上去，需要做一个转换器。<br>转化器部署：可以在k8s中部署一个Deployment，然后创建一个Service给Alert manager使用。</p></blockquote><h2 id="整个报警链路"><a href="#整个报警链路" class="headerlink" title="整个报警链路"></a>整个报警链路</h2><ol><li>首先是Prometheus根据告警规则告警，如果增删改规则参考PrometheusRule</li><li>Prometheus的告警经过Alertmanager静默、抑制、分组等配置到达Alertmanager</li><li>AlterManager通过配置webhook，地址填钉钉转换器的地址。</li><li>钉钉转换器中webhook地址填写钉钉机器人webhook的地址。</li></ol><h2 id="Prometheus-Alert-告警状态"><a href="#Prometheus-Alert-告警状态" class="headerlink" title="Prometheus Alert 告警状态"></a>Prometheus Alert 告警状态</h2><p>这里说明一下 Prometheus Alert 告警状态有三种状态：<code>Inactive</code>、<code>Pending</code>、<code>Firing</code>。</p><ul><li><strong>Inactive</strong>：非活动状态，表示正在监控，但是还未有任何警报触发。</li><li><strong>Pending</strong>：表示这个警报必须被触发。由于警报可以被分组、压抑/抑制或静默/静音，所以等待验证，一旦所有的验证都通过，则将转到 Firing 状态。</li><li><strong>Firing</strong>：将警报发送到 AlertManager，它将按照配置将警报的发送给所有接收者。一旦警报解除，则将状态转到 Inactive，如此循环。</li></ul><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="https://yunlzheng.gitbook.io/prometheus-book/parti-prometheus-ji-chu/alert/alert-manager-use-receiver/alert-manager-extension-with-webhook#shi-yong-golang-chuang-jian-webhook-fu-wu" target="_blank" rel="noopener">Alert manager集成钉钉</a></li><li><a href="https://developer.aliyun.com/article/705415" target="_blank" rel="noopener">创建一个转化器镜像</a></li><li><a href="https://theo.im/blog/2017/10/16/release-prometheus-alertmanager-webhook-for-dingtalk/" target="_blank" rel="noopener">转化器如何使用</a></li><li><a href="https://mp.weixin.qq.com/s/2yKB3aqeYgna2GupM6SiGA" target="_blank" rel="noopener">Alertmanager何时报警</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> prometheus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>prometheus-operator使用【自定义PrometheusRule】</title>
      <link href="/2019/11/28/prometheus-operator-shi-yong-zi-ding-yi-prometheusrule/"/>
      <url>/2019/11/28/prometheus-operator-shi-yong-zi-ding-yi-prometheusrule/</url>
      
        <content type="html"><![CDATA[<h3 id="PrometheusRule介绍"><a href="#PrometheusRule介绍" class="headerlink" title="PrometheusRule介绍"></a>PrometheusRule介绍</h3><blockquote><p><code>PrometheusRule</code>是安装<code>prometheus-operator</code>时默认安装的自定义资源对象（<code>CRD</code>），用来管理<code>Prometheus</code>上的<code>告警规则</code>，后面增删改查规则都可以通过这个资源对象查询。</p></blockquote><p>例如查询默认加入的规则，通过下面的命令可以查询。</p><pre class="line-numbers language-sh"><code class="language-sh">[root@k8s-master prometheus-operator]# kubectl get PrometheusRule -n monitoringNAME                                                       AGEprometheus-operator-alertmanager.rules                     28mprometheus-operator-etcd                                   28mprometheus-operator-general.rules                          28mprometheus-operator-k8s.rules                              28mprometheus-operator-kube-apiserver.rules                   28mprometheus-operator-kube-prometheus-node-recording.rules   28mprometheus-operator-kube-scheduler.rules                   28mprometheus-operator-kubernetes-absent                      28mprometheus-operator-kubernetes-apps                        28mprometheus-operator-kubernetes-resources                   28mprometheus-operator-kubernetes-storage                     28mprometheus-operator-kubernetes-system                      28mprometheus-operator-kubernetes-system-apiserver            28mprometheus-operator-kubernetes-system-controller-manager   28mprometheus-operator-kubernetes-system-kubelet              28mprometheus-operator-kubernetes-system-scheduler            28mprometheus-operator-node-exporter                          28mprometheus-operator-node-exporter.rules                    28mprometheus-operator-node-network                           28mprometheus-operator-node-time                              28mprometheus-operator-node.rules                             28mprometheus-operator-prometheus                             28mprometheus-operator-prometheus-operator                    28m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>也可以在<code>Prometheus -&gt; Dashboard -&gt; Status -&gt; Rules</code>中查看<br><img src="/images/k8s4.png" alt="prometheusRules"></p><h3 id="Prometheus怎么识别这个资源对象"><a href="#Prometheus怎么识别这个资源对象" class="headerlink" title="Prometheus怎么识别这个资源对象"></a>Prometheus怎么识别这个资源对象</h3><p>简单来说，类似标签选择器，定义的<code>PrometheusRule</code>资源对象，需要带有一些<code>Labels</code>，具体哪些可以参考默认生成的<code>PrometheusRule</code>，然后新建的也给加上。</p><p><img src="/images/k8s5.png" alt="prometheusRules"></p><p>参考链接：<code>https://www.qikqiak.com/post/prometheus-operator-custom-alert/</code>。</p><p>所有的Rules都有对应的文件，默认生成在<code>prometheus容器内</code>的</p><pre><code>/etc/prometheus/rules/prometheus-prometheus-operator-prometheus-rulefiles-0/</code></pre><p>目录下，新增一个<code>PrometheusRule资源</code>，也会在该目录下自动生成一个<code>YAML文件</code>。</p><p>因此我们可以不用管理配置文件，只需要管理<code>PrometheusRule</code>，<code>prometheus-operator</code>使得<code>prometheus</code>监控更加<code>K8s</code>.</p><h3 id="创建新的PrometheusRule资源"><a href="#创建新的PrometheusRule资源" class="headerlink" title="创建新的PrometheusRule资源"></a>创建新的PrometheusRule资源</h3><p><code>myrule.yaml</code></p><pre class="line-numbers language-yml"><code class="language-yml">apiVersion: monitoring.coreos.com/v1kind: PrometheusRulemetadata:  name: myrule  labels:    app: prometheus-operator    chart: prometheus-operator-8.2.4    heritage: Tiller    release: prometheus-operatorspec:  groups:  - name: my-node-time    rules:    - alert: myClockSkewDetected      annotations:        message: myClock skew detected on node-exporter {{`{{ $labels.namespace }}`}}/{{`{{ $labels.pod }}`}}. Ensure NTP is configured correctly on this host.      expr: abs(node_timex_offset_seconds{job="node-exporter"}) > 0.03      for: 2m      labels:        severity: warning<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>注意：上面配置中具体的规则只是拷贝了一个默认规则中的内容。</p></blockquote><h3 id="使用命令或者在dashboard中贴上以上YAML，即可创建。"><a href="#使用命令或者在dashboard中贴上以上YAML，即可创建。" class="headerlink" title="使用命令或者在dashboard中贴上以上YAML，即可创建。"></a>使用命令或者在dashboard中贴上以上YAML，即可创建。</h3><pre><code>kubectl create -f myrule.yaml</code></pre><p>创建完之后，可以通过命令查看</p><pre><code>kubectl get PrometheusRule -n monitoring</code></pre><p>也可以在<code>Prometheus</code> -&gt; <code>Dashboard</code>中查看，最后在<code>Prometheus</code>容器<code>Rule</code>目录下确认是否新生成一个<code>myrule.yaml</code>的配置文件。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> prometheus </tag>
            
            <tag> PrometheusRule </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s集群监控【使用Helm一键安装Prometheus Operator】</title>
      <link href="/2019/11/22/k8s-ji-qun-jian-kong-shi-yong-helm-yi-jian-an-zhuang-prometheusoperator/"/>
      <url>/2019/11/22/k8s-ji-qun-jian-kong-shi-yong-helm-yi-jian-an-zhuang-prometheusoperator/</url>
      
        <content type="html"><![CDATA[<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>首先我们先来了解下 <code>Prometheus-Operator</code>的架构图：<br><img src="/images/k8s3.jpg" alt="Prometheus-Operator"></p><p>上图是<code>Prometheus-Operator</code>官方提供的架构图，其中<code>Operator</code>是最核心的部分，作为一个控制器，他会去创建<code>Prometheus</code>、<code>ServiceMonitor</code>、<code>AlertManager</code>以及<code>PrometheusRule</code>4个<code>CRD</code>资源对象，然后会一直监控并维持这4个资源对象的状态。</p><p>其中创建的<code>prometheus</code>这种资源对象就是作为<code>Prometheus Server</code>存在，而<code>ServiceMonitor</code>就是<code>exporter</code>的各种抽象，<code>exporter</code>前面我们已经学习了，是用来提供专门提供<code>metrics</code>数据接口的工具，<code>Prometheus</code>就是通过<code>ServiceMonitor</code>提供的<code>metrics</code>数据接口去 <code>pull</code> 数据的，当然<code>alertmanager</code>这种资源对象就是对应的<code>AlertManager</code>的抽象，而<code>PrometheusRule</code>是用来被<code>Prometheus</code>实例使用的报警规则文件。</p><p>这样我们要在集群中监控什么数据，就变成了直接去操作 <code>Kubernetes</code> 集群的资源对象了，是不是方便很多了。上图中的 <code>Service</code>和 <code>ServiceMonitor</code> 都是 <code>Kubernetes</code> 的资源，一个 <code>ServiceMonitor</code>可以通过 <code>labelSelector</code> 的方式去匹配一类<code>Service</code>，<code>Prometheus</code> 也可以通过 <code>labelSelector</code> 去匹配多个<code>ServiceMonitor</code>。</p><h3 id="查看stable-prometheus-operator的默认值"><a href="#查看stable-prometheus-operator的默认值" class="headerlink" title="查看stable/prometheus-operator的默认值"></a>查看stable/prometheus-operator的默认值</h3><pre><code>helm inspect values stable/prometheus-operator</code></pre><h3 id="将默认配置导出，备用"><a href="#将默认配置导出，备用" class="headerlink" title="将默认配置导出，备用"></a>将默认配置导出，备用</h3><pre><code>helm inspect values stable/prometheus-operator &gt; prometheus-operator.yaml</code></pre><h3 id="提前将配置中涉及到的镜像下载好"><a href="#提前将配置中涉及到的镜像下载好" class="headerlink" title="提前将配置中涉及到的镜像下载好"></a>提前将配置中涉及到的镜像下载好</h3><pre class="line-numbers language-sh"><code class="language-sh">#!/bin/shdocker pull hub.deri.org.cn/k8s_monitor/alertmanager:v0.19.0docker tag hub.deri.org.cn/k8s_monitor/alertmanager:v0.19.0 quay.io/prometheus/alertmanager:v0.19.0docker rmi hub.deri.org.cn/k8s_monitor/alertmanager:v0.19.0docker pull hub.deri.org.cn/k8s_monitor/ghostunnel:v1.4.1 docker tag hub.deri.org.cn/k8s_monitor/ghostunnel:v1.4.1 squareup/ghostunnel:v1.4.1docker rmi hub.deri.org.cn/k8s_monitor/ghostunnel:v1.4.1 docker pull hub.deri.org.cn/k8s_monitor/kube-webhook-certgen:v1.0.0 docker tag hub.deri.org.cn/k8s_monitor/kube-webhook-certgen:v1.0.0  jettech/kube-webhook-certgen:v1.0.0docker rmi hub.deri.org.cn/k8s_monitor/kube-webhook-certgen:v1.0.0 docker pull hub.deri.org.cn/k8s_monitor/prometheus-operator:v0.34.0docker tag hub.deri.org.cn/k8s_monitor/prometheus-operator:v0.34.0 quay.io/coreos/prometheus-operator:v0.34.0docker rmi hub.deri.org.cn/k8s_monitor/prometheus-operator:v0.34.0docker pull hub.deri.org.cn/k8s_monitor/configmap-reload:v0.0.1docker tag hub.deri.org.cn/k8s_monitor/configmap-reload:v0.0.1 quay.io/coreos/configmap-reload:v0.0.1docker rmi pull hub.deri.org.cn/k8s_monitor/configmap-reload:v0.0.1docker pull hub.deri.org.cn/k8s_monitor/prometheus-config-reloader:v0.34.0docker tag hub.deri.org.cn/k8s_monitor/prometheus-config-reloader:v0.34.0 quay.io/coreos/prometheus-config-reloader:v0.34.0docker rmi hub.deri.org.cn/k8s_monitor/prometheus-config-reloader:v0.34.0docker pull hub.deri.org.cn/k8s_monitor/hyperkube:v1.12.1docker tag hub.deri.org.cn/k8s_monitor/hyperkube:v1.12.1 k8s.gcr.io/hyperkube:v1.12.1docker rmi  hub.deri.org.cn/k8s_monitor/hyperkube:v1.12.1docker pull hub.deri.org.cn/k8s_monitor/prometheus:v2.13.1docker tag hub.deri.org.cn/k8s_monitor/prometheus:v2.13.1 quay.io/prometheus/prometheus:v2.13.1docker rmi hub.deri.org.cn/k8s_monitor/prometheus:v2.13.1docker pull hub.deri.org.cn/k8s_monitor/kube-state-metrics:v1.8.0docker tag hub.deri.org.cn/k8s_monitor/kube-state-metrics:v1.8.0 quay.io/coreos/kube-state-metrics:v1.8.0docker rmi hub.deri.org.cn/k8s_monitor/kube-state-metrics:v1.8.0docker pull hub.deri.org.cn/k8s_monitor/node-exporter:v0.18.1docker tag hub.deri.org.cn/k8s_monitor/node-exporter:v0.18.1 quay.io/prometheus/node-exporter:v0.18.1docker rmi hub.deri.org.cn/k8s_monitor/node-exporter:v0.18.1docker pull hub.deri.org.cn/k8s_monitor/k8s-sidecar:0.1.20docker tag hub.deri.org.cn/k8s_monitor/k8s-sidecar:0.1.20 kiwigrid/k8s-sidecar:0.1.20docker rmi hub.deri.org.cn/k8s_monitor/k8s-sidecar:0.1.20docker pull hub.deri.org.cn/k8s_monitor/grafana:6.4.2docker tag hub.deri.org.cn/k8s_monitor/grafana:6.4.2 grafana/grafana:6.4.2docker rmi hub.deri.org.cn/k8s_monitor/grafana:6.4.2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="用默认配置安装，指定了name、namespace等信息"><a href="#用默认配置安装，指定了name、namespace等信息" class="headerlink" title="用默认配置安装，指定了name、namespace等信息"></a>用默认配置安装，指定了name、namespace等信息</h3><pre><code>helm install stable/prometheus-operator  --name prometheus-operator --namespace monitoring -f prometheus-operator.yaml --set grafana.adminPassword=admin</code></pre><h3 id="查看pod运行情况"><a href="#查看pod运行情况" class="headerlink" title="查看pod运行情况"></a>查看pod运行情况</h3><pre><code>kubectl get pod -n monitoring</code></pre><h3 id="修改Grafana的service类型为NodePort，便于访问测试"><a href="#修改Grafana的service类型为NodePort，便于访问测试" class="headerlink" title="修改Grafana的service类型为NodePort，便于访问测试"></a>修改Grafana的service类型为NodePort，便于访问测试</h3><pre><code>kubectl edit svc prometheus-operator-grafana -n monitoring</code></pre><p>通过下面命令，查看绑定宿主机的端口 ，访问测试密码安装时指定了<code>admin/admin</code></p><pre><code>kubectl get svc -n monitoring</code></pre><h3 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h3><pre><code>helm delete prometheus-operator</code></pre><pre><code>helm delete --purge prometheus-operator</code></pre><p><code>Prometheus-Operator</code>安装时会去创建<code>Prometheus</code>、<code>ServiceMonitor</code>、<code>AlertManager</code>以及<code>PrometheusRule</code>4个<code>CRD</code>资源对象，卸载时一并删掉</p><pre><code>kubectl delete crd prometheuses.monitoring.coreos.comkubectl delete crd prometheusrules.monitoring.coreos.comkubectl delete crd servicemonitors.monitoring.coreos.comkubectl delete crd podmonitors.monitoring.coreos.comkubectl delete crd alertmanagers.monitoring.coreos.com</code></pre><h3 id="修改prometheus-operator-yaml，配置ingress"><a href="#修改prometheus-operator-yaml，配置ingress" class="headerlink" title="修改prometheus-operator.yaml，配置ingress"></a>修改prometheus-operator.yaml，配置ingress</h3><pre class="line-numbers language-yml"><code class="language-yml"># 例如AlterManager配置，默认情况enabled: false修改成true，hosts: []填入alterManager的域名alertmanager:  ingress:    enabled: true    hosts: ["alert.deri.com"]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="修改prometheus-operator-yaml，配置数据持久化"><a href="#修改prometheus-operator-yaml，配置数据持久化" class="headerlink" title="修改prometheus-operator.yaml，配置数据持久化"></a>修改prometheus-operator.yaml，配置数据持久化</h3><pre class="line-numbers language-yml"><code class="language-yml"># 例如AlterManager，默认如下，是被注释掉的，取消注释，并填入你的storageClassName    storage: {}    # volumeClaimTemplate:    #   spec:    #     storageClassName: gluster    #     accessModes: ["ReadWriteOnce"]    #     resources:    #       requests:    #         storage: 50Gi    #   selector: {}alertmanager:  alertmanagerSpec:    storage:       volumeClaimTemplate:        spec:          storageClassName: nfs-client          accessModes: ["ReadWriteOnce"]          resources:            requests:              storage: 5Gi        selector: {}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其它配置可以在默认配置<code>prometheus-operator.yaml</code>中查看并修改。</p><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><h4 id="问题一"><a href="#问题一" class="headerlink" title="问题一:"></a>问题一:</h4><p>【摘自<code>https://github.com/helm/charts/tree/master/stable/prometheus-operator</code>】</p><p>KubeProxy【改完重启kubelet、docker服务】</p><pre class="line-numbers language-log"><code class="language-log">The metrics bind address of kube-proxy is default to 127.0.0.1:10249 that prometheus instances cannot access to. You should expose metrics by changing metricsBindAddress field value to 0.0.0.0:10249 if you want to collect them.Depending on the cluster, the relevant part config.conf will be in ConfigMap kube-system/kube-proxy or kube-system/kube-proxy-config. For example:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre><code>kubectl -n kube-system edit cm kube-proxy</code></pre><pre class="line-numbers language-yml"><code class="language-yml">apiVersion: v1data:  config.conf: |-    apiVersion: kubeproxy.config.k8s.io/v1alpha1    kind: KubeProxyConfiguration    # ...    # metricsBindAddress: 127.0.0.1:10249    metricsBindAddress: 0.0.0.0:10249    # ...  kubeconfig.conf: |-    # ...kind: ConfigMapmetadata:  labels:    app: kube-proxy  name: kube-proxy  namespace: kube-system<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="问题二："><a href="#问题二：" class="headerlink" title="问题二："></a>问题二：</h4><p>在不同环境安装时发现结果不一样，所有配置都一样，可能原因：</p><p>由于上述是通过<code>helm</code>安装的，首先通过命令<code>helm repo list</code>检查源是否一致；</p><p>通过<code>helm search | grep prometheus</code>查看<code>CHART VERSION    APP VERSION</code>是否一致；</p><p>如果不一致通过<code>helm repo update</code>更新一下就可以了。</p><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul><li><a href="https://github.com/helm/charts/tree/master/stable/prometheus-operator" target="_blank" rel="noopener">https://github.com/helm/charts/tree/master/stable/prometheus-operator</a> </li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> Prometheus </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> Prometheus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ingress-nginx自带认证功能</title>
      <link href="/2019/11/19/ingress-nginx-zi-dai-ren-zheng-gong-neng/"/>
      <url>/2019/11/19/ingress-nginx-zi-dai-ren-zheng-gong-neng/</url>
      
        <content type="html"><![CDATA[<h3 id="安装htpasswd"><a href="#安装htpasswd" class="headerlink" title="安装htpasswd"></a>安装htpasswd</h3><p><code>htpasswd</code>不是<code>centos7</code>自带的命令，需要使用<code>yum</code>安装。</p><pre><code>yum install httpd-tools</code></pre><p>选项</p><ul><li>-c: 创建一个新的密码文件</li><li>-b: 在命令行中一并输入用户名和密码而不是根据提示输入密码</li><li>-D: 删除指定的用户</li><li>-n: 不更新密码文件,只将加密后的用户名密码输出到屏幕上</li><li>-p: 不对密码进行加密,采用明文的方式</li><li>-m: 采用MD5算法对密码进行加密(默认的加密方式)</li><li>-d: 采用CRYPT算法对密码进行加密</li><li>-s: 采用SHA算法对密码进行加密</li><li>-B: 采用bcrypt算法对密码进行加密(非常安全)</li></ul><p>参数</p><ul><li>用户名: 要创建或者更新的用户名</li><li>密码: 用户的新密码</li></ul><h3 id="创建用户，设置密码"><a href="#创建用户，设置密码" class="headerlink" title="创建用户，设置密码"></a>创建用户，设置密码</h3><p>用下面的三个操作，创建 <code>basic-auth</code> 用户 <code>foo</code>，密码 <code>123456</code>，将用户信息提交到 <code>kubernetes</code>：</p><pre class="line-numbers language-sh"><code class="language-sh">$ htpasswd -c auth foo$ kubectl -n demo-echo create secret generic basic-auth --from-file=auth<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>注意其中命名空间<code>demo-echo</code>，<code>secret</code> 与目标服务<code>echo</code>在同一个 <code>namespace</code> 中。</p></blockquote><h3 id="为目标服务设置-ingress"><a href="#为目标服务设置-ingress" class="headerlink" title="为目标服务设置 ingress"></a>为目标服务设置 ingress</h3><blockquote><p>注意其中的<code>basic-auth</code>改成你的</p></blockquote><pre class="line-numbers language-yml"><code class="language-yml">apiVersion: extensions/v1beta1kind: Ingressmetadata:  name: ingress-echo-with-auth-basic  annotations:    # type of authentication    nginx.ingress.kubernetes.io/auth-type: basic    # name of the secret that contains the user/password definitions    nginx.ingress.kubernetes.io/auth-secret: basic-auth    # message to display with an appropriate context why the authentication is required    nginx.ingress.kubernetes.io/auth-realm: 'Authentication Required - foo'spec:  rules:  - host: auth-basic.echo.example    http:      paths:      - path: /        backend:          serviceName: echo          servicePort: 80<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="访问测试"><a href="#访问测试" class="headerlink" title="访问测试"></a>访问测试</h3><p><img src="/images/k8s2.png" alt="ingress-nginx"></p><h3 id="原文链接"><a href="#原文链接" class="headerlink" title="原文链接"></a>原文链接</h3><ul><li><a href="https://www.lijiaocn.com/soft/k8s/ingress-nginx/auth.html" target="_blank" rel="noopener">https://www.lijiaocn.com/soft/k8s/ingress-nginx/auth.html</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> ingress-nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ingress-nginx设置https证书</title>
      <link href="/2019/11/19/ingress-nginx-she-zhi-https-zheng-shu/"/>
      <url>/2019/11/19/ingress-nginx-she-zhi-https-zheng-shu/</url>
      
        <content type="html"><![CDATA[<h3 id="创建自签署证书"><a href="#创建自签署证书" class="headerlink" title="创建自签署证书"></a>创建自签署证书</h3><blockquote><p>注意证书中的<code>CN=tls.echo.example</code>改成自己的域名地址。</p></blockquote><pre><code>echo "生成自签署的 ca 证书"openssl req -x509 -sha256 -newkey rsa:4096 -keyout ca.key -out ca.crt -days 3560 -nodes -subj '/CN=My Cert Authority'echo "生成用上述 ca 签署的 server 证书"openssl req -new -newkey rsa:4096 -keyout server.key -out server.csr -nodes -subj '/CN=tls.echo.example'openssl x509 -req -sha256 -days 3650 -in server.csr -CA ca.crt -CAkey ca.key -set_serial 01 -out server.crt</code></pre><h3 id="将-server-证书上传到-kubernetes"><a href="#将-server-证书上传到-kubernetes" class="headerlink" title="将 server 证书上传到 kubernetes"></a>将 server 证书上传到 kubernetes</h3><blockquote><p>注意其中的命名空间<code>demo-echo和secret</code>名称<code>tls-echo-exmaple-secret</code>，改成自己的。</p></blockquote><pre><code>kubectl -n demo-echo create secret generic tls-echo-exmaple-secret --from-file=tls.crt=server.crt --from-file=tls.key=server.key</code></pre><h3 id="配置ingress"><a href="#配置ingress" class="headerlink" title="配置ingress"></a>配置ingress</h3><blockquote><p><code>ignress</code> 中的 <code>host</code> 一定要与证书的 <code>CN</code> 相同，在 <code>tls</code> 配置中引用前面创建的 <code>secret</code></p></blockquote><pre class="line-numbers language-yml"><code class="language-yml">apiVersion: extensions/v1beta1kind: Ingressmetadata:  name: ingress-echo-with-tlsspec:  rules:  - host: tls.echo.example    http:      paths:      - path: /        backend:          serviceName: echo          servicePort: 80  tls:  - hosts:    - tls.echo.example    secretName: tls-echo-exmaple-secret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="为多个域名配置证书"><a href="#为多个域名配置证书" class="headerlink" title="为多个域名配置证书"></a>为多个域名配置证书</h3><pre class="line-numbers language-yml"><code class="language-yml">apiVersion: extensions/v1beta1kind: Ingressmetadata:  name: foo-tls  namespace: defaultspec:  tls:  - hosts:    - foo.bar.com    # This secret must exist beforehand    # The cert must also contain the subj-name foo.bar.com    # https://github.com/kubernetes/ingress-nginx/blob/master/docs/examples/PREREQUISITES.md#tls-certificates    secretName: foobar  - hosts:    - bar.baz.com    # This secret must exist beforehand    # The cert must also contain the subj-name bar.baz.com    # https://github.com/kubernetes/ingress-nginx/blob/master/docs/examples/PREREQUISITES.md#tls-certificates    secretName: barbaz  rules:  - host: foo.bar.com    http:      paths:      - backend:          serviceName: http-svc          servicePort: 80        path: /  - host: bar.baz.com    http:      paths:      - backend:          serviceName: nginx          servicePort: 80        path: /<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul><li><a href="https://www.lijiaocn.com/soft/k8s/ingress-nginx/tls.html" target="_blank" rel="noopener">https://www.lijiaocn.com/soft/k8s/ingress-nginx/tls.html</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> ingress-nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s动态分配存储【helm安装nfs-client】</title>
      <link href="/2019/11/18/k8s-dong-tai-fen-pei-cun-chu-helm-an-zhuang-nfs-client/"/>
      <url>/2019/11/18/k8s-dong-tai-fen-pei-cun-chu-helm-an-zhuang-nfs-client/</url>
      
        <content type="html"><![CDATA[<blockquote><p>前文：在所有节点安装nfs-utils并启动相关服务。</p></blockquote><h3 id="NFS服务端新建一个挂载目录"><a href="#NFS服务端新建一个挂载目录" class="headerlink" title="NFS服务端新建一个挂载目录"></a>NFS服务端新建一个挂载目录</h3><pre><code>echo "/home/nfs *(rw,async,no_root_squash)" &gt;&gt; /etc/exportsexportfs -rshowmount -e localhost</code></pre><h3 id="安装nfs-client"><a href="#安装nfs-client" class="headerlink" title="安装nfs-client"></a>安装nfs-client</h3><pre><code>helm install stable/nfs-client-provisioner --name test-storageclass --set nfs.server=192.168.1.210 --set nfs.path=/home/nfs</code></pre><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>可以先用命令<code>helm inspect values stable/nfs-client-provisioner</code>查看所有配置项，并提前下载好镜像。</p><pre class="line-numbers language-yml"><code class="language-yml">replicaCount: 1strategyType: Recreateimage:  repository: quay.io/external_storage/nfs-client-provisioner  tag: v3.1.0-k8s1.11  pullPolicy: IfNotPresentnfs:  server:  path: /ifs/kubernetes  mountOptions:# For creating the StorageClass automatically:storageClass:  create: true  # Set a provisioner name. If unset, a name will be generated.  # provisionerName:  # Set StorageClass as the default StorageClass  # Ignored if storageClass.create is false  defaultClass: false  # Set a StorageClass name  # Ignored if storageClass.create is false  name: nfs-client  # Allow volume to be expanded dynamically  allowVolumeExpansion: true  # Method used to reclaim an obsoleted volume  reclaimPolicy: Delete  # When set to false your PVs will not be archived by the provisioner upon deletion of the PVC.  archiveOnDelete: true## For RBAC support:rbac:  # Specifies whether RBAC resources should be created  create: true# If true, create & use Pod Security Policy resources# https://kubernetes.io/docs/concepts/policy/pod-security-policy/podSecurityPolicy:  enabled: false## Set pod priorityClassName# priorityClassName: ""serviceAccount:  # Specifies whether a ServiceAccount should be created  create: true  # The name of the ServiceAccount to use.  # If not set and create is true, a name is generated using the fullname template  name:resources: {}  # limits:  #  cpu: 100m  #  memory: 128Mi  # requests:  #  cpu: 100m  #  memory: 128Mi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>也可以修改下上面的yaml，直接通过<code>nfs-client.yaml</code>创建：</p><pre class="line-numbers language-yml"><code class="language-yml">replicaCount: 1strategyType: Recreateimage:  repository: quay.io/external_storage/nfs-client-provisioner  tag: v3.1.0-k8s1.11  pullPolicy: IfNotPresentnfs:  server: 192.168.1.210  path: /home/nfs  mountOptions:storageClass:  create: true  defaultClass: false  name: nfs-client  allowVolumeExpansion: true  reclaimPolicy: Delete  archiveOnDelete: truerbac:  create: truepodSecurityPolicy:  enabled: false<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行安装命令：</p><pre><code>helm install stable/nfs-client-provisioner -n test-storageclass -f nfs-client.yaml</code></pre><h3 id="创建PVC测试"><a href="#创建PVC测试" class="headerlink" title="创建PVC测试"></a>创建PVC测试</h3><p>创建<code>test-pvc.yaml</code></p><pre class="line-numbers language-yml"><code class="language-yml">apiVersion: v1kind: PersistentVolumeClaimmetadata:  name: testclaimspec:  storageClassName: "nfs-client"  accessModes:    - ReadWriteMany  resources:    requests:      storage: 10Mi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre><code>kubectl apply -f test-pvc.yaml</code></pre><h3 id="查看结果"><a href="#查看结果" class="headerlink" title="查看结果"></a>查看结果</h3><pre class="line-numbers language-log"><code class="language-log">[root@k8s-master home]# kubectl get scNAME         PROVISIONER                                              AGEnfs-client   cluster.local/test-storageclass-nfs-client-provisioner   36m[root@k8s-master home]# kubectl get pv,pvcNAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS        CLAIM                 STORAGECLASS    REASON   AGEpersistentvolume/pvc-d9bdfa45-6417-4ad9-bbf0-02301f928342   10Mi       RWX            Delete           Bound         default/testclaim     nfs-client               33mNAME                              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGEpersistentvolumeclaim/testclaim   Bound    pvc-d9bdfa45-6417-4ad9-bbf0-02301f928342   10Mi       RWX            nfs-client     34m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> nfs-client </tag>
            
            <tag> storageclass </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysql查询</title>
      <link href="/2019/11/17/mysql-cha-xun/"/>
      <url>/2019/11/17/mysql-cha-xun/</url>
      
        <content type="html"><![CDATA[<h3 id="多条件模糊查询"><a href="#多条件模糊查询" class="headerlink" title="多条件模糊查询"></a>多条件模糊查询</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_log <span class="token keyword">where</span> <span class="token punctuation">(</span>LOCATE<span class="token punctuation">(</span><span class="token string">'wu'</span><span class="token punctuation">,</span> user_name<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">or</span>  LOCATE<span class="token punctuation">(</span><span class="token string">'wu'</span><span class="token punctuation">,</span> params <span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">and</span>  <span class="token punctuation">(</span>method<span class="token operator">=</span><span class="token string">'POST'</span> <span class="token operator">or</span> method<span class="token operator">=</span><span class="token string">'GET'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="查询id在列表中的所有结果"><a href="#查询id在列表中的所有结果" class="headerlink" title="查询id在列表中的所有结果"></a>查询id在列表中的所有结果</h3><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t_user <span class="token keyword">where</span> tenant_id <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> sql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>K8s持久化存储【使用NFS】</title>
      <link href="/2019/11/15/k8s-chi-jiu-hua-cun-chu-shi-yong-nfs/"/>
      <url>/2019/11/15/k8s-chi-jiu-hua-cun-chu-shi-yong-nfs/</url>
      
        <content type="html"><![CDATA[<h3 id="k8s所有节点安装NFS"><a href="#k8s所有节点安装NFS" class="headerlink" title="k8s所有节点安装NFS"></a>k8s所有节点安装NFS</h3><pre><code>yum install nfs-utils#所有节点，不论NFS服务端还是客户端systemctl enable rpcbindsystemctl start rpcbind#NFS服务端systemctl enable nfssystemctl start nfs</code></pre><h3 id="在NFS服务端配置挂载磁盘"><a href="#在NFS服务端配置挂载磁盘" class="headerlink" title="在NFS服务端配置挂载磁盘"></a>在NFS服务端配置挂载磁盘</h3><ul><li>创建目录：<code>mkdir /data</code></li><li>修改权限：<code>chmod 755 /data</code></li><li>编辑NFS配置：<code>vi /etc/exports</code></li><li>添加：<code>/data/ 192.168.0.0/24(rw,sync,no_root_squash,no_all_squash)</code></li><li>重启：<code>systemctl restart nfs</code></li><li>或者执行<code>exportfs -r</code>生效</li><li>检查：<code>showmount -e localhost</code></li></ul><h3 id="K8s中创建PersistentVolume"><a href="#K8s中创建PersistentVolume" class="headerlink" title="K8s中创建PersistentVolume"></a>K8s中创建PersistentVolume</h3><pre class="line-numbers language-yml"><code class="language-yml">apiVersion: v1kind: PersistentVolumemetadata:  name: pv0003spec:  capacity: #容量     storage:5Gi  volumeMode: Filesystem #存储卷模式  accessModes: #访问模式  - ReadWriteOnce  persistentVolumeReclaimPolicy: Recycle #持久化卷回收策略  storageClassName: slow #存储类  mountOptions: #挂接选项   - hard   - nfsvers=4.1  nfs:     path: /data     server: 172.17.0.2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="访问模式（Access-Modes）"><a href="#访问模式（Access-Modes）" class="headerlink" title="访问模式（Access Modes）"></a>访问模式（Access Modes）</h4><p>只要资源提供者支持，持久卷能够通过任何方式加载到主机上。每种存储都会有不同的能力，每个PV的访问模式也会被设置成为该卷所支持的特定模式。例如NFS能够支持多个读写客户端，但某个NFS PV可能会在服务器上以只读方式使用。每个PV都有自己的一系列的访问模式，这些访问模式取决于PV的能力。</p><p>访问模式的可选范围如下：</p><ul><li>ReadWriteOnce：该卷能够以读写模式被加载到一个节点上。</li><li>ReadOnlyMany：该卷能够以只读模式加载到多个节点上。</li><li>ReadWriteMany：该卷能够以读写模式被多个节点同时加载。</li></ul><h4 id="类（Class）"><a href="#类（Class）" class="headerlink" title="类（Class）"></a>类（Class）</h4><p>在PV中可以指定存储类，通过设置<code>storageClassName</code>字段进行设置。如果设置了存储类，则此PV只能被绑定到也指定了此存储类的PVC。</p><h4 id="回收策略"><a href="#回收策略" class="headerlink" title="回收策略"></a>回收策略</h4><p>当前的回收策略可选值包括：</p><ul><li>Retain-持久化卷被释放后，需要手工进行回收操作。</li><li>Recycle-基础擦除（<code>rm-rf /thevolume/*</code>）</li><li>Delete-相关的存储资产，例如AWSEBS或GCE PD卷一并删除。<br>目前，只有<code>NFS</code>和<code>HostPath</code>支持<code>Recycle</code>策略，AWSEBS、GCE PD支持Delete策略。</li></ul><h3 id="K8s中创建PersistentVolumeClaim"><a href="#K8s中创建PersistentVolumeClaim" class="headerlink" title="K8s中创建PersistentVolumeClaim"></a>K8s中创建PersistentVolumeClaim</h3><pre class="line-numbers language-yml"><code class="language-yml">kind: PersistentVolumeClaimapiVersion: v1metadata:  name: myclaimspec:  accessModes: #访问模式    - ReadWriteOnce  volumeMode: Filesystem #存储卷模式  resources: #资源    requests:      storage: 8Gi  storageClassName: slow #存储类  selector: #选择器    matchLabels:      release: "stable"    matchExpressions: #匹配表达式      - {key: environment, operator: In, values: [dev]}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="选择器"><a href="#选择器" class="headerlink" title="选择器"></a>选择器</h4><p>在PVC中，可以通过标签选择器来进一步的过滤PV。仅仅与选择器匹配的PV才会被绑定到PVC中。选择器的组成如下：</p><ul><li><code>matchLabels</code>： 只有存在与此处的标签一样的PV才会被PVC选中；</li><li><code>matchExpressions</code> ：匹配表达式由键、值和操作符组成，操作符包括<code>In</code>, <code>NotIn</code>, <code>Exists</code>和<code>DoesNotExist</code>，只有符合表达式的PV才能被选择。<br>如果同时设置了<code>matchLabels</code>和<code>matchExpressions</code>，则会进行求与，即只有同时满足上述匹配要求的PV才会被选择。</li></ul><h4 id="存储类"><a href="#存储类" class="headerlink" title="存储类"></a>存储类</h4><p>如果PVC使用storageClassName字段指定一个存储类，那么只有指定了同样的存储类的PV才能被绑定到PVC上。对于PVC来说，存储类并不是必须的。依赖于安装方法，可以在安装过程中使用add-on管理器将默认的StorageClass部署至Kubernetes集群中。当PVC指定了选择器，并且指定了StorageClass，则在匹配PV时，取两者之间的与：即仅仅同时满足存储类和带有要求标签值的PV才能被匹配上。</p><h3 id="Pod使用刚刚创建的持久化存储"><a href="#Pod使用刚刚创建的持久化存储" class="headerlink" title="Pod使用刚刚创建的持久化存储"></a>Pod使用刚刚创建的持久化存储</h3><pre class="line-numbers language-yml"><code class="language-yml">kind: PodapiVersion: v1metadata:  name: mypodspec:  containers:  - name: myfrontend    image: dockerfile/nginx     volumeMounts: #挂接存储卷     - mountPath: "/var/www/html" #POD内挂接的路径       name: mypd #所要挂接的存储卷的名称 volumes: #定义存储卷 - name: mypd   persistentVolumeClaim: #所使用的持久化存储卷声明     claimName: myclaim<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> nfs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CentOS 7 安装使用NFS</title>
      <link href="/2019/11/15/an-zhuang-shi-yong-nfs/"/>
      <url>/2019/11/15/an-zhuang-shi-yong-nfs/</url>
      
        <content type="html"><![CDATA[<h3 id="yum-安装"><a href="#yum-安装" class="headerlink" title="yum 安装"></a>yum 安装</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> yum <span class="token function">install</span> nfs-utils<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="设置-NFS-服务开机启动"><a href="#设置-NFS-服务开机启动" class="headerlink" title="设置 NFS 服务开机启动"></a>设置 NFS 服务开机启动</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> systemctl <span class="token function">enable</span> rpcbind<span class="token function">sudo</span> systemctl <span class="token function">enable</span> nfs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="启动-NFS-服务"><a href="#启动-NFS-服务" class="headerlink" title="启动 NFS 服务"></a>启动 NFS 服务</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> systemctl start rpcbind<span class="token function">sudo</span> systemctl start nfs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="服务启动之后，我们在服务端配置一个共享目录"><a href="#服务启动之后，我们在服务端配置一个共享目录" class="headerlink" title="服务启动之后，我们在服务端配置一个共享目录"></a>服务启动之后，我们在服务端配置一个共享目录</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">mkdir</span> /data<span class="token function">sudo</span> <span class="token function">chmod</span> 755 /data<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="根据这个目录，相应配置导出目录"><a href="#根据这个目录，相应配置导出目录" class="headerlink" title="根据这个目录，相应配置导出目录"></a>根据这个目录，相应配置导出目录</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vi</span> /etc/exports<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="添加如下配置"><a href="#添加如下配置" class="headerlink" title="添加如下配置"></a>添加如下配置</h3><pre><code>/data/     192.168.0.0/24(rw,sync,no_root_squash,no_all_squash)</code></pre><blockquote><ol><li><code>/data</code>: 共享目录位置。</li><li><code>192.168.0.0/24</code>: 客户端 <code>IP</code> 范围，<code>*</code> 代表所有，即没有限制。</li><li><code>rw</code>: 权限设置，可读可写。</li><li><code>sync</code>: 同步共享目录。</li><li><code>no_root_squash</code>: 可以使用 <code>root</code> 授权。</li><li><code>no_all_squash</code>: 可以使用普通用户授权。</li></ol></blockquote><h3 id="wq保存设置之后，重启-NFS-服务"><a href="#wq保存设置之后，重启-NFS-服务" class="headerlink" title=":wq保存设置之后，重启 NFS 服务"></a><code>:wq</code>保存设置之后，重启 <code>NFS</code> 服务</h3><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> systemctl restart nfs<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="可以检查一下本地的共享目录"><a href="#可以检查一下本地的共享目录" class="headerlink" title="可以检查一下本地的共享目录"></a>可以检查一下本地的共享目录</h3><pre class="line-numbers language-bash"><code class="language-bash">showmount -e localhostExport list <span class="token keyword">for</span> localhost:/data 192.168.0.0/24<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://qizhanming.com/blog/2018/08/08/how-to-install-nfs-on-centos-7" target="_blank" rel="noopener">参考</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nfs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s监控【metrics-server部署使用】</title>
      <link href="/2019/11/10/k8s-jian-kong-metrics-server-bu-shu-shi-yong/"/>
      <url>/2019/11/10/k8s-jian-kong-metrics-server-bu-shu-shi-yong/</url>
      
        <content type="html"><![CDATA[<p>从<code>Heapster</code>的<a href="https://github.com/kubernetes/heapster" target="_blank" rel="noopener">github</a> 中可以看到已经，<code>heapster</code>已经<code>DEPRECATED</code>。 这里是<code>heapster</code>的<a href="https://github.com/kubernetes-retired/heapster/blob/master/docs/deprecation.md" target="_blank" rel="noopener">deprecation timeline</a>。 可以看出<code>heapster</code>从<code>Kubernetes 1.12</code>开始从<code>Kubernetes</code>各种安装脚本中移除。</p><p><code>Kubernetes</code>推荐使用<code>metrics-server</code>。我们这里也使用<code>helm</code>来部署<code>metrics-server</code>。</p><h3 id="创建配置metrics-server-yaml"><a href="#创建配置metrics-server-yaml" class="headerlink" title="创建配置metrics-server.yaml"></a>创建配置<code>metrics-server.yaml</code></h3><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">replicaCount</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token key atrule">image</span><span class="token punctuation">:</span>    <span class="token key atrule">repository</span><span class="token punctuation">:</span> hub.deri.org.cn/k8s/metrics<span class="token punctuation">-</span>server<span class="token punctuation">-</span>amd64    <span class="token key atrule">tag</span><span class="token punctuation">:</span> v0.3.5    <span class="token key atrule">pullPolicy</span><span class="token punctuation">:</span> IfNotPresent<span class="token key atrule">args</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>logtostderr<span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>kubelet<span class="token punctuation">-</span>insecure<span class="token punctuation">-</span>tls<span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>kubelet<span class="token punctuation">-</span>preferred<span class="token punctuation">-</span>address<span class="token punctuation">-</span>types=InternalIP<span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>    <span class="token key atrule">node-role.kubernetes.io/edge</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token key atrule">tolerations</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master      <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists      <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule    <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master      <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists      <span class="token key atrule">effect</span><span class="token punctuation">:</span> PreferNoSchedule<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><pre class="line-numbers language-bash"><code class="language-bash">helm <span class="token function">install</span> stable/metrics-server \-n metrics-server \--namespace kube-system \-f metrics-server.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><pre class="line-numbers language-bash"><code class="language-bash">kubectl <span class="token function">top</span> nodeNAME    CPU<span class="token punctuation">(</span>cores<span class="token punctuation">)</span>   CPU%   MEMORY<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>   MEMORY%node1   650m         32%    1276Mi          73%node2   73m          3%     527Mi           30%<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash"><code class="language-bash">kubectl <span class="token function">top</span> pod -n kube-systemNAME                                    CPU<span class="token punctuation">(</span>cores<span class="token punctuation">)</span>   MEMORY<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>   coredns-5c98db65d4-dr8lf                8m           7Mi             coredns-5c98db65d4-lp8dg                6m           8Mi             etcd-node1                              44m          46Mi            kube-apiserver-node1                    74m          295Mi           kube-controller-manager-node1           35m          50Mi            kube-flannel-ds-amd64-7lwm9             2m           8Mi             kube-flannel-ds-amd64-mm296             5m           9Mi             kube-proxy-7fsrg                        1m           11Mi            kube-proxy-k8vhm                        3m           11Mi            kube-scheduler-node1                    8m           15Mi            kubernetes-dashboard-848b8dd798-c4sc2   2m           14Mi            metrics-server-8456fb6676-fwh2t         10m          19Mi            tiller-deploy-7bf78cdbf7-9q94c          1m           16Mi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>遗憾的是，当前<code>Kubernetes Dashboard</code>还不支持<code>metrics-server</code>。因此如果使用<code>metrics-server</code>替代了<code>heapster</code>，将无法在<code>dashboard</code>中以图形展示<code>Pod</code>的内存和<code>CPU</code>情况。计划在<a href="https://github.com/kubernetes/dashboard" target="_blank" rel="noopener">dashboard 2.0</a>版本以后才会支持，尽情期待~</p></blockquote><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> metrics-server </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>spring boot自定义配置Boolean属性不能生效问题</title>
      <link href="/2019/11/08/spring-boot-zi-ding-yi-pei-zhi-boolean-shu-xing-bu-neng-sheng-xiao-wen-ti/"/>
      <url>/2019/11/08/spring-boot-zi-ding-yi-pei-zhi-boolean-shu-xing-bu-neng-sheng-xiao-wen-ti/</url>
      
        <content type="html"><![CDATA[<p>有时候我们需要在 <code>application.yaml</code>文件中自定义配置，在程序中通过属性名映射过去，但是有时候定义错误的属性名会导致配置不生效。<br>属性名<font color="red"><strong>不能</strong>是<code>is</code>开头</font>，例如属性名为<code>isLog</code>，你在配置文件中不管怎么给这个属性设值都不会生效，需要改成log即可。</p><p>我使用<code>spring boot</code>版本：</p><pre><code>&lt;parent&gt;    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;    &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;    &lt;version&gt;2.0.6.RELEASE&lt;/version&gt;    &lt;relativePath/&gt;&lt;/parent&gt;</code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> spring boot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring boot </tag>
            
            <tag> config </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s与harbor联合使用【k8s拉取harbor中镜像】</title>
      <link href="/2019/11/08/k8s-yu-harbor-lian-he-shi-yong-k8s-la-qu-harbor-zhong-jing-xiang/"/>
      <url>/2019/11/08/k8s-yu-harbor-lian-he-shi-yong-k8s-la-qu-harbor-zhong-jing-xiang/</url>
      
        <content type="html"><![CDATA[<blockquote><p><strong>概要</strong>：要想<code>k8s</code>从<code>harbor</code>中拉取镜像，需要有<code>harbor</code>的用户、密码、服务器信息，然后在<code>k8s</code>指定<code>namespace</code>中创建<code>docker-registry</code>类型。</p></blockquote><blockquote><p><strong>前提</strong>：已经搭建<code>K8s</code>集群、<code>harbor</code>服务，且已经在机器上配置可以从<code>harbor</code>中拉取上传镜像。</p></blockquote><h3 id="创建docker-registry"><a href="#创建docker-registry" class="headerlink" title="创建docker-registry"></a>创建<code>docker-registry</code></h3><p>创建<code>docker-registry</code>，有两种方式，命令行和<code>YAML</code>.</p><h4 id="第一种方式：命令行"><a href="#第一种方式：命令行" class="headerlink" title="第一种方式：命令行"></a>第一种方式：命令行</h4><pre class="line-numbers language-bash"><code class="language-bash">kubectl create secret docker-registry test-deri-registry-secret --namespace<span class="token operator">=</span>test-namespace \ --docker-server<span class="token operator">=</span>hub.test.org.cn --docker-username<span class="token operator">=</span>test2019 \ --docker-password<span class="token operator">=</span>tests12019 --docker-email<span class="token operator">=</span>admin@harbor.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="第二种方式：YAML"><a href="#第二种方式：YAML" class="headerlink" title="第二种方式：YAML"></a>第二种方式：YAML</h4><p>需要有一台已经成功登录过<code>harbor</code>服务器的机器，使用命令<code>cat ~/.docker/config.json</code>，确认是否有<code>harbor</code>服务器的认证信息，例如:</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"auths"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"hub.test.org.cn:443"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"auth"</span><span class="token operator">:</span> <span class="token string">"YWRtaW46RGVxasdXXnsada"</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"HttpHeaders"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"User-Agent"</span><span class="token operator">:</span> <span class="token string">"Docker-Client/19.03.4 (linux)"</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来k8s也可以直接使用该认证信息，使用命令<code>cat ~/.docker/config.json |base64 -w 0</code>将该认证信息<code>BASE64</code>编码<font color="red"><strong>【以下示例结果都是瞎写的，请使用自己返回的结果】</strong></font>。</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat .docker/config.json |base64 -w 0</span>ewoJImF1dGhzIjogewoJCSJodWIuZGVyaS5vcmcuY246NDQzIjogewoJCQkiYXV0aCI6ICJZV1J0YVc0NlJHVnlhU015TURFNSIKCHIUASDGUGDUGAUDUIAGDJIIGIUDZWFkZXJzIjogewoJCSJVc2VyLUFnZW50IjogIkRvY2tlci1DbGllbnQvMTkSDISDhi7asd56523gHGSGH<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>编写<code>test-registry-secret.yaml</code></p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>registry<span class="token punctuation">-</span>secret  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>deri<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">.dockerconfigjson</span><span class="token punctuation">:</span> wraJImF1dGhzIjogeraJCSIxOTIuMTY4LjEzMC4yMyI6IHsKCQkJImF1dGgiOiAiYW5OaVpHVjJaV3h2Y0dWeU9rcHpZakV5TXpRMSIKCQl9Cgl9LAoJIkh0dHBIZWFkZXJzIjogewoJCSJVc2VyLUFnZW50IjogIkRvY2tlci1DbGllbnQvMTguMDkuMiAobGludXgpIgoJfQp9<span class="token key atrule">type</span><span class="token punctuation">:</span> kubernetes.io/dockerconfigjson<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用命令<code>kubectl create -f test-registry-secret.yaml</code>或者在<code>dashboard</code>中用上述<code>YAML</code>即可创建<code>docker-registry</code>。</p><p>使用命令查看结果</p><pre class="line-numbers language-bash"><code class="language-bash">kubectl get secret -n test-namespace<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash"><code class="language-bash">kubectl describe secret test-registry-secret -n test-namespace<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="使用刚刚创建的docker-registry"><a href="#使用刚刚创建的docker-registry" class="headerlink" title="使用刚刚创建的docker-registry"></a>使用刚刚创建的<code>docker-registry</code></h3><p>如何使用刚刚创建的<code>docker-registry</code>呢？两种方式:</p><ul><li>一种是每次在创建<code>pod</code>或者<code>deployment</code>时指定<code>imagePullSecrets</code>，</li><li>一种是在该<code>namespace</code>的<code>serviceaccount</code>【默认<code>default</code>，如果是别的<code>serviceaccount</code>，需要在创建<code>pod</code>时指定<code>spec.serviceAccount</code>】中指定<code>imagePullSecrets</code>，这样用该<code>serviceaccount</code>创建的<code>pod</code>会自动加上。</li></ul><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">imagePullSecrets</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>registry<span class="token punctuation">-</span>secret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="第一种"><a href="#第一种" class="headerlink" title="第一种"></a>第一种</h4><p>每次创建<code>pod</code>时指定<code>secret</code>，例如</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>baresystem  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>namespace<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>baresystem      <span class="token key atrule">image</span><span class="token punctuation">:</span> hub.test.org.cn/dev<span class="token punctuation">-</span>project/centos6<span class="token punctuation">-</span>bare<span class="token punctuation">-</span>system<span class="token punctuation">:</span>v0      <span class="token key atrule">ports</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>        <span class="token key atrule">hostPort</span><span class="token punctuation">:</span> <span class="token number">30001</span>  <span class="token key atrule">imagePullSecrets</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>registry<span class="token punctuation">-</span>secret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="第二种"><a href="#第二种" class="headerlink" title="第二种"></a>第二种</h4><p>以创建<code>namespace</code>时自动创建的<code>serviceaccount default</code>为例，首先查看<code>default</code>的详细情况:</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl describe sa test-deri -n test-namespace</span>Name:                test-deriNamespace:           test-namespaceLabels:              <span class="token operator">&lt;</span>none<span class="token operator">></span>Annotations:         <span class="token operator">&lt;</span>none<span class="token operator">></span>Image pull secrets:  <span class="token operator">&lt;</span>none<span class="token operator">></span>Mountable secrets:   test-deri-token-rmxbnTokens:              test-deri-token-rmxbnEvents:              <span class="token operator">&lt;</span>none<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到当前的<code>Image pull secrets:  &lt;none&gt;</code>，需要为它指定成刚刚我们创建的<code>secret</code>。使用命令:</p><pre class="line-numbers language-bash"><code class="language-bash">kubectl patch serviceaccount default -p <span class="token string">'{"imagePullSecrets": [{"name": "test-registry-secret"}]}'</span> -n test-namespace<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>或者使用命令:</p><pre class="line-numbers language-bash"><code class="language-bash">kubectl edit sa default -n test-namespace<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>在打开的<code>YAML</code>文件中添加两行，保存退出。</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">imagePullSecrets</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>registry<span class="token punctuation">-</span>secret<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>最后再次查看<code>default</code>的详细情况，可以看到<code>Image pull secrets:  test-registry-secret</code>.</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># kubectl describe sa default -n test-namespace</span>Name:                defaultNamespace:           test-namespaceLabels:              <span class="token operator">&lt;</span>none<span class="token operator">></span>Annotations:         <span class="token operator">&lt;</span>none<span class="token operator">></span>Image pull secrets:  test-registry-secretMountable secrets:   default-token-5fcn5Tokens:              default-token-5fcn5Events:              <span class="token operator">&lt;</span>none<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来在<code>test-namespace</code>命名空间下用<code>default</code>这个<code>serviceaccount</code>创建的任何<code>pods</code>容器，都会自动在<code>pod</code>定义中附加上下面这样的密钥认证信息了。</p><p>最后测试一下吧。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> harbor </tag>
            
            <tag> docker-registry </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s资源限制【针对namespace、pod、Container】</title>
      <link href="/2019/11/07/k8s-zi-yuan-xian-zhi-zhen-dui-namespace-pod-container/"/>
      <url>/2019/11/07/k8s-zi-yuan-xian-zhi-zhen-dui-namespace-pod-container/</url>
      
        <content type="html"><![CDATA[<h3 id="综述"><a href="#综述" class="headerlink" title="综述"></a>综述</h3><p>K8s中对资源的限制分以下情况：</p><ul><li>对<code>namespace</code>中容器、<code>pod</code>等使用<font color="green"><strong>总和</strong></font>限制<pre><code>ResourceQuota</code></pre></li><li>对<code>namespace</code>中容器、<code>pod</code>等使用<font color="yellow"><strong>单独</strong></font>限制：<pre><code>LimitRange</code></pre></li></ul><h3 id="创建一个namespace用于测试"><a href="#创建一个namespace用于测试" class="headerlink" title="创建一个namespace用于测试"></a>创建一个<code>namespace</code>用于测试</h3><pre><code>kubectl create namespace quota-mem-cpu-example</code></pre><h3 id="创建一个ResourceQuota"><a href="#创建一个ResourceQuota" class="headerlink" title="创建一个ResourceQuota"></a>创建一个<code>ResourceQuota</code></h3><p>创建一个<code>ResourceQuota</code>对<code>namespace</code>中资源使用总和做限制，创建<code>quota-mem-cpu.yaml</code></p><blockquote><h4 id="资源配额的类型"><a href="#资源配额的类型" class="headerlink" title="资源配额的类型"></a>资源配额的类型</h4><ol><li>计算资源，包括<code>cpu</code>和<code>memory</code><blockquote><ul><li><code>cpu</code>, <code>limits.cpu</code>, <code>requests.cpu</code></li><li><code>memory</code>, <code>limits.memory</code>, <code>requests.memory</code></li></ul></blockquote></li><li>存储资源，包括存储资源的总量以及指定<code>storage class</code>的总量<blockquote><ul><li><code>requests.storage</code>：存储资源总量，如<code>500Gi</code></li><li><code>persistentvolumeclaims</code>：<code>pvc</code>的个数</li><li><code>storageclass.storage.k8s.io/requests.storage</code></li><li><code>storageclass.storage.k8s.io/persistentvolumeclaims</code></li></ul></blockquote></li><li>对象数，即可创建的对象的个数<blockquote><ul><li><code>pods</code>, <code>replicationcontrollers</code>, <code>configmaps</code>, <code>secrets</code></li><li><code>resourcequotas</code>, <code>persistentvolumeclaims</code></li><li><code>services</code>, <code>services.loadbalancers</code>, <code>services.nodeports</code></li></ul></blockquote></li></ol></blockquote><h4 id="示例1："><a href="#示例1：" class="headerlink" title="示例1："></a>示例1：</h4><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ResourceQuota<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> object<span class="token punctuation">-</span>counts<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hard</span><span class="token punctuation">:</span>    <span class="token key atrule">pods</span><span class="token punctuation">:</span> <span class="token string">"4"</span>    <span class="token key atrule">configmaps</span><span class="token punctuation">:</span> <span class="token string">"10"</span>    <span class="token key atrule">persistentvolumeclaims</span><span class="token punctuation">:</span> <span class="token string">"4"</span>    <span class="token key atrule">replicationcontrollers</span><span class="token punctuation">:</span> <span class="token string">"20"</span>    <span class="token key atrule">secrets</span><span class="token punctuation">:</span> <span class="token string">"10"</span>    <span class="token key atrule">services</span><span class="token punctuation">:</span> <span class="token string">"10"</span>    <span class="token key atrule">services.loadbalancers</span><span class="token punctuation">:</span> <span class="token string">"2"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="示例2："><a href="#示例2：" class="headerlink" title="示例2："></a>示例2：</h4><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ResourceQuota<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mem<span class="token punctuation">-</span>cpu<span class="token punctuation">-</span>demo<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">hard</span><span class="token punctuation">:</span>    <span class="token key atrule">requests.cpu</span><span class="token punctuation">:</span> <span class="token string">"1"</span>    <span class="token key atrule">requests.memory</span><span class="token punctuation">:</span> 1Gi    <span class="token key atrule">limits.cpu</span><span class="token punctuation">:</span> <span class="token string">"2"</span>    <span class="token key atrule">limits.memory</span><span class="token punctuation">:</span> 2Gi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash"><code class="language-bash">kubectl create -f quota-mem-cpu.yaml --namespace<span class="token operator">=</span>quota-mem-cpu-example<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="查看-ResourceQuota-详情："><a href="#查看-ResourceQuota-详情：" class="headerlink" title="查看 ResourceQuota 详情："></a>查看 <code>ResourceQuota</code> 详情：</h4><pre class="line-numbers language-bash"><code class="language-bash">kubectl get resourcequota mem-cpu-demo --namespace<span class="token operator">=</span>quota-mem-cpu-example --output<span class="token operator">=</span>yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p><code>ResourceQuota</code> 在 <code>quota-mem-cpu-example</code> 命名空间中设置了如下要求：</p><ul><li>每个容器必须有内存请求和限制，以及 <code>CPU</code> 请求和限制。</li><li>所有容器的内存请求总和不能超过<code>1 GiB</code>。</li><li>所有容器的内存限制总和不能超过<code>2 GiB</code>。</li><li>所有容器的 <code>CPU</code> 请求总和不能超过<code>1 cpu</code>。</li><li>所有容器的 <code>CPU</code> 限制总和不能超过<code>2 cpu</code>。</li></ul></blockquote><h3 id="创建一个LimitRange"><a href="#创建一个LimitRange" class="headerlink" title="创建一个LimitRange"></a>创建一个<code>LimitRange</code></h3><p>创建一个<code>LimitRange</code>，对<code>namespace</code>中<code>pod</code>、容器设置单独的默认限制  </p><p>创建<code>limits.yaml</code></p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> LimitRange<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mem<span class="token punctuation">-</span>limit<span class="token punctuation">-</span>range<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">limits</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">default</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># default limit</span>      <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512Mi      <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token number">2</span>    <span class="token key atrule">defaultRequest</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># default request</span>      <span class="token key atrule">memory</span><span class="token punctuation">:</span> 256Mi      <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token number">0.5</span>    <span class="token key atrule">max</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># max limit</span>      <span class="token key atrule">memory</span><span class="token punctuation">:</span> 800Mi      <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token number">3</span>    <span class="token key atrule">min</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># min request</span>      <span class="token key atrule">memory</span><span class="token punctuation">:</span> 100Mi      <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token number">0.3</span>    <span class="token key atrule">maxLimitRequestRatio</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># max value for limit / request</span>      <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token number">2</span>      <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token number">2</span>    <span class="token key atrule">type</span><span class="token punctuation">:</span> Container <span class="token comment" spellcheck="true"># limit type, support: Container / Pod / PersistentVolumeClaim</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash"><code class="language-bash">kubectl create -f limits.yaml --namespace<span class="token operator">=</span>limit-example<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>查看一下在该  <code>Namespace</code> 中被强加的限制 </p><pre class="line-numbers language-bash"><code class="language-bash">kubectl describe limits mylimits --namespace<span class="token operator">=</span>limit-example<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><h4 id="CPU和内存的单位"><a href="#CPU和内存的单位" class="headerlink" title="CPU和内存的单位"></a><code>CPU</code>和内存的单位</h4><ul><li><code>CPU</code>的测量单位是<code>cpus</code>，允许分数值。你可以使用前缀<code>m</code>来表示<code>mili</code>（千分之一）。例如<code>100mcpu</code>就是<code>100 milicpu</code>，等价于<code>0.1CPU</code>。</li><li>内存的测量单位是字节。你可以使用纯整数来表示内存，也可以使用一些前缀：<code>E</code>, <code>P</code>, <code>T</code>, <code>G</code>, <code>M</code>, <code>K</code>, <code>Ei</code>, <code>Pi</code>, <code>Ti</code>, <code>Gi</code>, <code>Mi</code>, <code>Ki</code>.</li></ul></blockquote><h3 id="创建pod时，指定资源限制"><a href="#创建pod时，指定资源限制" class="headerlink" title="创建pod时，指定资源限制"></a>创建<code>pod</code>时，指定资源限制</h3><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> quota<span class="token punctuation">-</span>mem<span class="token punctuation">-</span>cpu<span class="token punctuation">-</span>demo<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> quota<span class="token punctuation">-</span>mem<span class="token punctuation">-</span>cpu<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>ctr    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">resources</span><span class="token punctuation">:</span>      <span class="token key atrule">limits</span><span class="token punctuation">:</span>        <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"800Mi"</span>        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"800m"</span>       <span class="token key atrule">requests</span><span class="token punctuation">:</span>        <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"600Mi"</span>        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> <span class="token string">"400m"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> pod </tag>
            
            <tag> namespace </tag>
            
            <tag> 资源限制 </tag>
            
            <tag> Container </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s权限使用【ServiceAccount、Role、RoleBinding使用】</title>
      <link href="/2019/11/07/k8s-quan-xian-shi-yong-serviceaccount-role-rolebinding-shi-yong/"/>
      <url>/2019/11/07/k8s-quan-xian-shi-yong-serviceaccount-role-rolebinding-shi-yong/</url>
      
        <content type="html"><![CDATA[<blockquote><p><font color="red"><strong>需求</strong></font>：需要为每个项目组在K8s集群中创建不同的<code>namespace</code>，然后为这个<code>namespace</code>创建单独的<code>ServiceAccount</code>，这个<code>ServiceAccount</code>需要拥有这个<code>namespace</code>的完全控制权。以下均通过<code>YAML</code>文件的方式创建。</p></blockquote><h3 id="创建namespace"><a href="#创建namespace" class="headerlink" title="创建namespace"></a>创建<code>namespace</code></h3><p>打个标签，代表是测试用的</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>deri  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="创建ServiceAccount"><a href="#创建ServiceAccount" class="headerlink" title="创建ServiceAccount"></a>创建<code>ServiceAccount</code></h3><p>注意指定<code>namespace</code></p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>deri  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>deri<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="创建role"><a href="#创建role" class="headerlink" title="创建role"></a>创建<code>role</code></h3><p>创建<code>role</code>，两种方式:</p><ul><li>第一种，需要依次指定<code>apiGroups</code>、<code>resources</code>和<code>verbs</code>，便于权限的细粒度控制，</li><li>第二种通过通用符 <code>*</code> 设置所有权限，非常方便。</li></ul><h4 id="第一种"><a href="#第一种" class="headerlink" title="第一种"></a>第一种</h4><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Role<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>deri  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>reader<span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># The API group "" indicates the core API Group.</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> configmaps    <span class="token punctuation">-</span> secrets    <span class="token punctuation">-</span> nodes    <span class="token punctuation">-</span> nodes/metrics    <span class="token punctuation">-</span> nodes/stats    <span class="token punctuation">-</span> nodes/log    <span class="token punctuation">-</span> nodes/spec    <span class="token punctuation">-</span> nodes/proxy    <span class="token punctuation">-</span> pods    <span class="token punctuation">-</span> services    <span class="token punctuation">-</span> resourcequotas    <span class="token punctuation">-</span> replicationcontrollers    <span class="token punctuation">-</span> limitranges    <span class="token punctuation">-</span> persistentvolumeclaims    <span class="token punctuation">-</span> persistentvolumes    <span class="token punctuation">-</span> namespaces    <span class="token punctuation">-</span> endpoints    <span class="token punctuation">-</span> proxy    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> list    <span class="token punctuation">-</span> watch    <span class="token punctuation">-</span> get  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> extensions    <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> daemonsets    <span class="token punctuation">-</span> deployments    <span class="token punctuation">-</span> replicasets    <span class="token punctuation">-</span> ingresses    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> list    <span class="token punctuation">-</span> watch  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> apps    <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> statefulsets    <span class="token punctuation">-</span> daemonsets    <span class="token punctuation">-</span> deployments    <span class="token punctuation">-</span> replicasets    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> list    <span class="token punctuation">-</span> watch  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> batch    <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> cronjobs    <span class="token punctuation">-</span> jobs    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> list    <span class="token punctuation">-</span> watch  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> autoscaling    <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> horizontalpodautoscalers    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> list    <span class="token punctuation">-</span> watch  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> authentication.k8s.io    <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> tokenreviews    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> create  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> authorization.k8s.io    <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> subjectaccessreviews    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> create    <span class="token key atrule">nonResourceURLs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="第二种"><a href="#第二种" class="headerlink" title="第二种"></a>第二种</h4><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Role<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>deri  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>reader<span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token string">'*'</span>    <span class="token key atrule">resources</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token string">'*'</span>    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token string">'*'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="创建RoleBinding"><a href="#创建RoleBinding" class="headerlink" title="创建RoleBinding"></a>创建<code>RoleBinding</code></h3><p>将创建的<code>role</code>和<code>serviceaccount</code>绑定</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true"># This role binding allows "test-deri" to read pods in the namespace "test-deri"</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1beta1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> read<span class="token punctuation">-</span>pods  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>deri<span class="token key atrule">subjects</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount <span class="token comment" spellcheck="true"># May be "User", "Group" or "ServiceAccount"</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>deri<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>reader  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="查看token"><a href="#查看token" class="headerlink" title="查看token"></a>查看<code>token</code></h3><p>查看创建<code>ServiceAccount</code>时自动创建的<code>Secret Token</code>，查看<code>ServiceAccount</code>名称开头的<code>token</code></p><pre class="line-numbers language-bash"><code class="language-bash">kubectl get secret -n test-deri<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash"><code class="language-bash">kubectl describe secret test-deri-token-xxxxx -n test-deri<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>使用该<code>token</code>登录<code>dashboard</code>，可以查看、使用刚刚创建的<code>namespace</code>,但是没有权限访问别的<code>namespace</code>,这样就做到了权限控制。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> 权限 </tag>
            
            <tag> ServiceAccount </tag>
            
            <tag> Role </tag>
            
            <tag> RoleBinding </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>keepalived+haproxy实现双机热备</title>
      <link href="/2019/10/29/keepalived-haproxy-shi-xian-shuang-ji-re-bei/"/>
      <url>/2019/10/29/keepalived-haproxy-shi-xian-shuang-ji-re-bei/</url>
      
        <content type="html"><![CDATA[<h3 id="安装haproxy"><a href="#安装haproxy" class="headerlink" title="安装haproxy"></a>安装<code>haproxy</code></h3><p>参考<a href="">Haproxy安装使用</a></p><h3 id="安装keepalived"><a href="#安装keepalived" class="headerlink" title="安装keepalived"></a>安装<code>keepalived</code></h3><pre class="line-numbers language-bash"><code class="language-bash">yum <span class="token function">install</span> keepalived -y<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="修改keepalived配置文件"><a href="#修改keepalived配置文件" class="headerlink" title="修改keepalived配置文件"></a>修改<code>keepalived</code>配置文件</h3><p>默认配置文件目录：<code>/etc/keepalived/keepalived.conf</code></p><pre><code>global_defs {   router_id consul1    #虚拟路由名称}vrrp_script chk_haproxy {    script "killall -0 haproxy"     #使用killall -0检查haproxy实例是否存在，性能高于ps命令    interval 2    #脚本运行周期    timeout 2    #每次检查的加权权重值    fall 3}vrrp_instance haproxy {    state MASTER     #本机实例状态，MASTER/BACKUP，备机配置文件中请写BACKUP    interface ens33    #本机网卡名称，使用ifconfig命令查看    virtual_router_id 51    #虚拟路由编号，主备机保持一致    priority 100    #本机初始权重，备机请填写小于主机的值（例如100）    advert_int 1        #争抢虚地址的周期，秒    authentication {        auth_type PASS        auth_pass 1111    }    virtual_ipaddress {        192.168.41.150    #虚地址IP，主备机保持一致    }    track_script {        chk_haproxy        #对应的健康检查配置    }}</code></pre><h3 id="启动keepalived服务"><a href="#启动keepalived服务" class="headerlink" title="启动keepalived服务"></a>启动<code>keepalived</code>服务</h3><p>主备机配置完成后，均启动<code>keepalived</code>服务</p><pre><code>systemctl  start keepalived.service</code></pre><h3 id="检查主备机网卡上是否有VIP"><a href="#检查主备机网卡上是否有VIP" class="headerlink" title="检查主备机网卡上是否有VIP"></a>检查主备机网卡上是否有<code>VIP</code></h3><p>执行命令：<code>ip addr sh ens33</code></p><pre><code>2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000    link/ether 00:0c:29:e8:3f:ba brd ff:ff:ff:ff:ff:ff    inet 192.168.41.129/24 brd 192.168.41.255 scope global noprefixroute ens33       valid_lft forever preferred_lft forever    inet 192.168.41.150/32 scope global ens33       valid_lft forever preferred_lft forever    inet6 fe80::999f:e60:1951:9d4d/64 scope link tentative noprefixroute dadfailed        valid_lft forever preferred_lft forever    inet6 fe80::d5e3:a2fa:a42:31d3/64 scope link noprefixroute        valid_lft forever preferred_lft forever</code></pre><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><ul><li><p>停止<code>haproxy</code>服务，查看<code>VIP</code>是否转移</p><pre><code>systemctl  stop haproxy.service</code></pre></li><li><p>停止<code>keepalived</code>服务，查看<code>VIP</code>是否转移</p><pre><code>systemctl  stop keepalived.service</code></pre></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> haproxy </tag>
            
            <tag> keepalived </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Haproxy安装使用</title>
      <link href="/2019/10/29/haproxy-an-zhuang-shi-yong/"/>
      <url>/2019/10/29/haproxy-an-zhuang-shi-yong/</url>
      
        <content type="html"><![CDATA[<h3 id="yum安装"><a href="#yum安装" class="headerlink" title="yum安装"></a>yum安装</h3><pre class="line-numbers language-bash"><code class="language-bash">yum update<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash"><code class="language-bash">yum <span class="token function">install</span> haproxy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="修改haproxy配置文件"><a href="#修改haproxy配置文件" class="headerlink" title="修改haproxy配置文件"></a>修改haproxy配置文件</h3><p>默认目录：<code>/etc/haproxy/haproxy.cfg</code>，下面是一些参考配置</p><pre><code>#---------------------------------------------------------------------# Global settings    #---------------------------------------------------------------------global    #全局配置文件    log         127.0.0.1 local2        #日志配置，所有的日志都记录本地，通过local2输出    maxconn         20000    ulimit-n    16384    #chroot      /var/lib/haproxy        #改变haproxy的工作目录    #pidfile     /var/run/haproxy.pid    #指定pid文件的路径    maxconn     4000                    #最大连接数的设定    #user        haproxy                 #指定运行服务的用户    #group       haproxy                 #指定运行服务的用户组    daemon#---------------------------------------------------------------------# common defaults that all the 'listen' and 'backend' sections will# use if not designated in their block#---------------------------------------------------------------------defaults    mode                    http                  #默认使用协议,可以为{http|tcp|health} http:是七层协议 tcp:是四层 health：只返回OK    log                     global                #全局日志记录    option                  httplog               #详细记录http日志    option                  dontlognull           #不记录空日志    option http-server-close                      #启用http-server-close    option forwardfor       except 127.0.0.0/8    #来自这些信息的都不forwardfor    option                  redispatch            #重新分发，ServerID对应的服务器宕机后，强制定向到其他运行正常的服务器    retries                 3                      #3次连接失败则认为服务不可用    timeout http-request    10s                    #默认http请求超时时间    timeout queue           1m                     #默认队列超时时间    timeout connect         10s                    #默认连接超时时间    timeout client          1m                     #默认客户端超时时间    timeout server          1m                     #默认服务器超时时间    timeout http-keep-alive 10s                    #默认持久连接超时时间    timeout check           10s                    #默认检查时间间隔    maxconn                 3000                   #最大连接数######## 监控界面配置 #################listen admin_status        # 监控界面访问信息        bind 0.0.0.0:8888        mode http        #自动刷新时间        stats refresh 30s        # URI相对地址        stats uri /        # 统计报告格式        # stats realm Global\ statistics        stats realm welcome login\ Haproxy        # 登录账户信息        stats auth admin:123456        #用来隐藏统计页面上HAProxy 的版本信息        stats hide-version        #通过设置此选项，可以在监控页面上手工启用或禁用后端真实服务器        stats admin if TRUE        ########frontend配置###################### mysql负载均衡配置 ###############listen mysql        bind 0.0.0.0:3306        mode tcp        # 负载均衡算法        # static-rr 权重, leastconn 最少连接, source 请求IP, 轮询 roundrobin        balance roundrobin        # 日志格式        # option tcplog        # 在 mysql 创建一个没有权限的haproxy用户，密码为空。 haproxy用户        # create user 'haproxy'@'%' identified by ''; FLUSH PRIVILEGES;        # option mysql-check user haproxy         # 这里是容器中的IP地址，由于配置的是轮询roundrobin，weight 权重其实没有生效        server mysql_1 192.168.41.129:3306 check weight 1 maxconn 2000        server mysql_2 192.168.41.130:3306 check weight 1 maxconn 2000        server mysql_3 192.168.41.131:3306 check weight 1 maxconn 2000        # 使用keepalive检测死链        # option tcpka#################################################test1配置################## listen test1#         bind 0.0.0.0:8008#         mode tcp#         balance roundrobin#         server s1 127.0.0.1:8010 weight 1 maxconn 10000 check inter 10s#         server s2 127.0.0.1:8011 weight 1 maxconn 10000 check inter 10s#         server s3 127.0.0.1:8012 weight 1 maxconn 10000 check inter 10s########test2配置################## listen test2#         bind 0.0.0.0:8007#         mode tcp#         balance roundrobin#         server s1 192.168.1.88:8010 weight 1 maxconn 10000 check inter 10s</code></pre><h3 id="修改ulimit配置"><a href="#修改ulimit配置" class="headerlink" title="修改ulimit配置"></a>修改ulimit配置</h3><p><code>haproxy</code>要求<code>ulimit</code><font color="red">大于（<code>maxconn</code>*2 + 15 ）</font></p><pre><code>#临时修改ulimit -n 65536#永久修改，需要修改/etc/security/limits.conf配置文件，文末增加以下内容，然后重新登录就可以生效* soft nofile 65536* hard nofile 65536* soft nproc 65565* hard nproc 65565</code></pre><h3 id="启动服务并配置自启动"><a href="#启动服务并配置自启动" class="headerlink" title="启动服务并配置自启动"></a>启动服务并配置自启动</h3><p>启动后访问<code>8888</code>端口，使用<code>admin/123456</code>登录就可以看到<code>UI</code>界面了。</p><pre class="line-numbers language-bash"><code class="language-bash">systemctl start haproxysystemctl <span class="token function">enable</span> haproxy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> haproxy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Boot通过注解实现Restful接口权限控制</title>
      <link href="/2019/10/29/spring-boot-tong-guo-zhu-jie-shi-xian-restful-jie-kou-quan-xian-kong-zhi/"/>
      <url>/2019/10/29/spring-boot-tong-guo-zhu-jie-shi-xian-restful-jie-kou-quan-xian-kong-zhi/</url>
      
        <content type="html"><![CDATA[<h3 id="创建一个注解AuthToken"><a href="#创建一个注解AuthToken" class="headerlink" title="创建一个注解AuthToken"></a>创建一个注解<code>AuthToken</code></h3><p>所有使用这个注解的方法，均要通过权限验证才能访问。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span>ElementType<span class="token punctuation">.</span>METHOD<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span>RetentionPolicy<span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span><span class="token annotation punctuation">@Documented</span><span class="token keyword">public</span> @<span class="token keyword">interface</span> <span class="token class-name">AuthToken</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * 是否只能管理员权限才能访问,默认所有用户都可以访问     */</span>    <span class="token keyword">boolean</span> <span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="创建一个拦截器AuthInterceptor"><a href="#创建一个拦截器AuthInterceptor" class="headerlink" title="创建一个拦截器AuthInterceptor"></a>创建一个拦截器<code>AuthInterceptor</code></h3><p>所有请求都通过拦截器</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthInterceptor</span> <span class="token keyword">extends</span> <span class="token class-name">HandlerInterceptorAdapter</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> Object handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>handler <span class="token keyword">instanceof</span> <span class="token class-name">HandlerMethod</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        HandlerMethod handlerMethod <span class="token operator">=</span> <span class="token punctuation">(</span>HandlerMethod<span class="token punctuation">)</span> handler<span class="token punctuation">;</span>        Method method <span class="token operator">=</span> handlerMethod<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        AuthToken authToken <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span>AuthToken<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//需要验证的Method</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>authToken <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">boolean</span> isAdmin <span class="token operator">=</span> authToken<span class="token punctuation">.</span><span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//todo</span>            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//无需验证</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="注册拦截器"><a href="#注册拦截器" class="headerlink" title="注册拦截器"></a>注册拦截器</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthConfigurer</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptors</span><span class="token punctuation">(</span>InterceptorRegistry registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>        registry<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token function">AuthInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPathPatterns</span><span class="token punctuation">(</span><span class="token string">"/**"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> AuthInterceptor <span class="token function">AuthInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AuthInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="在controller方法上添加注解"><a href="#在controller方法上添加注解" class="headerlink" title="在controller方法上添加注解"></a>在<code>controller</code>方法上添加注解</h3><pre class="line-numbers language-java"><code class="language-java">#需要管理员权限才能访问的<span class="token annotation punctuation">@AuthToken</span><span class="token punctuation">(</span>admin <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>#普通用户和管理员都能访问的<span class="token annotation punctuation">@AuthToken</span>#不加注解是所有人都可以访问的，不安全<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> spring boot </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring boot </tag>
            
            <tag> 注解 </tag>
            
            <tag> 接口权限 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>私有镜像仓库Harbor-v1.5.0搭建与使用</title>
      <link href="/2019/10/25/si-you-jing-xiang-cang-ku-harbor-v1-5-0-da-jian-yu-shi-yong/"/>
      <url>/2019/10/25/si-you-jing-xiang-cang-ku-harbor-v1-5-0-da-jian-yu-shi-yong/</url>
      
        <content type="html"><![CDATA[<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><ol><li>安装<code>docker-ce</code>（过程省略）</li><li>安装<code>docker-compose</code>（过程省略）</li><li>安装<code>harbor</code></li></ol><h3 id="下载Harbor离线安装包"><a href="#下载Harbor离线安装包" class="headerlink" title="下载Harbor离线安装包"></a>下载Harbor离线安装包</h3><ol><li>下载地址：<code>http://harbor.orientsoft.cn/</code>，找个最新的，本文使用<code>v1.5.0</code>版本</li><li>使用 <code>tar xvf harbor-offline-installer-v1.5.0.tgz</code></li><li>进入到解压后的目录，<code>harbor/</code></li></ol><h3 id="配置harbor-cfg【关键配置】"><a href="#配置harbor-cfg【关键配置】" class="headerlink" title="配置harbor.cfg【关键配置】"></a>配置<code>harbor.cfg</code><font color="red">【关键配置】</font></h3><pre><code>#hostname设置访问地址，可以使用ip、域名，不可以设置为127.0.0.1或localhosthostname = harbor.deri.com# 访问协议，默认是http，也可以设置https，如果设置https，则nginx ssl需要设置onui_url_protocol = http#配置admin用户的密码，默认Harbor12345harbor_admin_password = Harbor12345#是否只允许admin用户创建项目，everyone是所有人都可以project_creation_restriction = adminonly# 是否开启自注册self_registration = on# Token有效时间，默认30分钟token_expiration = 30</code></pre><h3 id="配置docker-compose-yml"><a href="#配置docker-compose-yml" class="headerlink" title="配置docker-compose.yml"></a>配置<code>docker-compose.yml</code></h3><p>如果需要修改访问端口，默认<code>80</code>，<code>443</code>，也可以不修改.</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token comment" spellcheck="true">##此处粘贴部分配置  </span>  <span class="token key atrule">proxy</span><span class="token punctuation">:</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> vmware/nginx<span class="token punctuation">-</span>photon<span class="token punctuation">:</span>v1.5.0    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> ./common/config/nginx<span class="token punctuation">:</span>/etc/nginx<span class="token punctuation">:</span>z    <span class="token key atrule">networks</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> harbor    <span class="token key atrule">ports</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token datetime number">80:80</span>      <span class="token punctuation">-</span> 443<span class="token punctuation">:</span><span class="token number">443</span>      <span class="token punctuation">-</span> 4443<span class="token punctuation">:</span><span class="token number">4443</span>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> mysql      <span class="token punctuation">-</span> registry      <span class="token punctuation">-</span> ui      <span class="token punctuation">-</span> log    <span class="token key atrule">logging</span><span class="token punctuation">:</span>      <span class="token key atrule">driver</span><span class="token punctuation">:</span> <span class="token string">"syslog"</span>      <span class="token key atrule">options</span><span class="token punctuation">:</span>          <span class="token key atrule">syslog-address</span><span class="token punctuation">:</span> <span class="token string">"tcp://127.0.0.1:1514"</span>        <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"proxy"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="启动harbor"><a href="#启动harbor" class="headerlink" title="启动harbor"></a>启动<code>harbor</code></h3><p>到<code>harbor/</code>目录下，执行<code>./install.sh</code>，<code>harbor</code>会根据当前目录下<code>docker-compose.yml</code>配置，下载相关镜像，并启动。</p><h3 id="配置本地hosts文件"><a href="#配置本地hosts文件" class="headerlink" title="配置本地hosts文件"></a>配置本地<code>hosts</code>文件</h3><p>配置<code>hosts</code>文件，增加部署机器的 <code>IP</code> 和 域名【域名是<code>harbor.cfg</code>中的<code>hostname</code>】</p><pre><code>Windows: C:\Windows\System32\drivers\etc\hosts Linux: /etc/hosts</code></pre><h3 id="访问Harbor"><a href="#访问Harbor" class="headerlink" title="访问Harbor"></a>访问<code>Harbor</code></h3><p>浏览器输入<code>hostname</code>，用户名密码：<code>admin/Harbor12345</code></p><p><img src="/images/harbor1.jpg" alt="Harbor首页"></p><h3 id="上传镜像"><a href="#上传镜像" class="headerlink" title="上传镜像"></a>上传镜像</h3><h4 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h4><p><em>注意选择访问级别</em><br><img src="/images/harbor2.jpg" alt="Harbor创建项目"></p><h4 id="使用docker-login登录到私有仓库"><a href="#使用docker-login登录到私有仓库" class="headerlink" title="使用docker login登录到私有仓库"></a>使用<code>docker login</code>登录到私有仓库</h4><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@node4 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># docker login harbor.deri.com</span>Username: adminPassword: WARNING<span class="token operator">!</span> Your password will be stored unencrypted <span class="token keyword">in</span> /root/.docker/config.json.Configure a credential helper to remove this warning. Seehttps://docs.docker.com/engine/reference/commandline/login/<span class="token comment" spellcheck="true">#credentials-store</span>Login Succeeded<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p><font color="red"><strong>这里有个问题</strong></font></p><p>执行上面的一步肯定会报错：<code>Error response from daemon: Get https://harbor.deri.com/v2/users/: dial tcp 192.168.41.139:443: getsockopt: connection refused</code>，原因是<code>docker</code>认为这个仓库不可信，需要在<code>/etc/docker/daemon.json</code>（<font color="red">不存在就新建</font>）增加<code>insecure-registries</code>配置，注意是标准的json格式！</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"insecure-registries"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"harbor.deri.com"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>然后重启docker服务</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token function">sudo</span> systemctl daemon-reload<span class="token function">sudo</span> systemctl restart docker<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>重启harbor服务</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#到harbor/目录下执行</span>docker-compose down -vdocker-compose up -d<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><hr><h4 id="本地随便找个镜像"><a href="#本地随便找个镜像" class="headerlink" title="本地随便找个镜像"></a>本地随便找个镜像</h4><p>修改其<code>tag</code>，如</p><pre class="line-numbers language-bash"><code class="language-bash">docker tag hub.c.163.com/library/mysql:5.7 harbor.deri.com/deri/mysql:5.7<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><font color="red"><strong>注意<code>tag</code>格式：<code>域名</code>/<code>项目名</code>/<code>镜像名</code>:<code>版本</code></strong></font></p><h4 id="上传镜像-1"><a href="#上传镜像-1" class="headerlink" title="上传镜像"></a>上传镜像</h4><pre class="line-numbers language-bash"><code class="language-bash">docker push harbor.deri.com/deri/mysql:5.7<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="登录UI查看"><a href="#登录UI查看" class="headerlink" title="登录UI查看"></a>登录<code>UI</code>查看</h4><p><img src="/images/harbor3.jpg" alt="harbor镜像仓库"></p><h4 id="从私有镜像仓库拉取镜像"><a href="#从私有镜像仓库拉取镜像" class="headerlink" title="从私有镜像仓库拉取镜像"></a>从私有镜像仓库拉取镜像</h4><pre class="line-numbers language-bash"><code class="language-bash">docker pull harbor.deri.com/deri/mysql:5.7<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="退出登录"><a href="#退出登录" class="headerlink" title="退出登录"></a>退出登录</h4><pre class="line-numbers language-bash"><code class="language-bash">docker <span class="token function">logout</span> harbor.deri.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>使用结束！接下来创建项目、用户了。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> harbor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kubernetes集群发布外部服务【mysql、redis并测试】</title>
      <link href="/2019/10/21/kubernetes-ji-qun-fa-bu-wai-bu-fu-wu-mysql-redis-bing-ce-shi/"/>
      <url>/2019/10/21/kubernetes-ji-qun-fa-bu-wai-bu-fu-wu-mysql-redis-bing-ce-shi/</url>
      
        <content type="html"><![CDATA[<p>有时候我们需要将<code>k8s</code>集群外的服务引入到集群内部来，便于集群内部服务调用，我可以使用<code>Endpoints</code>.</p><h3 id="引入外部myql"><a href="#引入外部myql" class="headerlink" title="引入外部myql"></a>引入外部<code>myql</code></h3><h4 id="编写k8s-mysql-endpoints-yaml"><a href="#编写k8s-mysql-endpoints-yaml" class="headerlink" title="编写k8s-mysql-endpoints.yaml"></a>编写<code>k8s-mysql-endpoints.yaml</code></h4><p>为外部<code>Mysql</code>创建<code>Endpoints</code></p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Endpoints<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">subsets</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">addresses</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> 192.168.1.11    <span class="token key atrule">ports</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">20030</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>可以使用命令<code>kubectl get endpoints</code>查看是否创建完成</li><li><code>kubectl describe  endpoints mysql</code> 查看具体描述</li></ol><h4 id="编写k8s-mysql-service-yaml"><a href="#编写k8s-mysql-service-yaml" class="headerlink" title="编写k8s-mysql-service.yaml"></a>编写<code>k8s-mysql-service.yaml</code></h4><p>编写<code>k8s-mysql-service.yaml</code>，为<code>endpoints</code>发布成内部<code>pod</code>可以调用的服务</p><blockquote><p>注意<code>metadata.name</code>与<code>k8s-mysql-endpoints.yaml</code>中<code>metadata.name</code>保持一致，此处均为<code>mysql</code>.</p></blockquote><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">ports</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">20030</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>可以使用命令 <code>kubectl get svc</code> 查看是否服务创建完成</li><li><code>kubectl describe  svc mysql</code> 查看具体服务描述</li></ol><h4 id="测试endpoints是否生效"><a href="#测试endpoints是否生效" class="headerlink" title="测试endpoints是否生效"></a>测试endpoints是否生效</h4><p>为了方便测试<code>endpoints</code>是否生效，我们修改上述的<code>k8s-mysql-service.yaml</code>配置 </p><blockquote><ol><li>我们将<code>type</code>类型改为<code>NodePort</code>，这样可以设定宿主机上的映射端口号<code>nodePort：30030</code>，这样直接通过宿主机<code>IP:30030</code>就可以调用到<code>mysql</code>服务。</li><li>注意删除了创建好的<code>service</code>，对应的<code>endpoints</code>也会删除掉，需要重新创建！测试的时候注意！</li></ol></blockquote><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">20030</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">20030</span>    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30030</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="使用Navicat测试"><a href="#使用Navicat测试" class="headerlink" title="使用Navicat测试"></a>使用<code>Navicat</code>测试</h4><p>使用<code>Navicat</code>测试，输入宿主机<code>IP</code>和端口<code>30030</code>（用户名密码还是外部数据库原本的用户名密码），测试连接！成功！证明了通过<code>Endpoints</code>机制可以将外部服务发布成<code>k8s</code>内部的服务！</p><blockquote><p><strong>发布外部的<code>redis</code>服务也是同理，只需要修改<code>name</code>、<code>port</code>、<code>ip</code>等参数即可！</strong></p></blockquote><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
            <tag> endpoints </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>consul【在kubernetes集群中部署】</title>
      <link href="/2019/10/18/consul-zai-kubernetes-ji-qun-zhong-bu-shu/"/>
      <url>/2019/10/18/consul-zai-kubernetes-ji-qun-zhong-bu-shu/</url>
      
        <content type="html"><![CDATA[<blockquote><p>consul具体配置、ACL配置可以参考Consul系列文章</p></blockquote><h3 id="首先创建k8s-consul-config-json文件"><a href="#首先创建k8s-consul-config-json文件" class="headerlink" title="首先创建k8s-consul-config.json文件"></a>首先创建k8s-consul-config.json文件</h3><p>注意token需要自己创建一个，这里加密处理了</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"datacenter"</span><span class="token operator">:</span><span class="token string">"dc8"</span><span class="token punctuation">,</span>    <span class="token property">"primary_datacenter"</span><span class="token operator">:</span><span class="token string">"dc8"</span><span class="token punctuation">,</span>    <span class="token property">"acl"</span><span class="token operator">:</span><span class="token punctuation">{</span>        <span class="token property">"enabled"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token property">"default_policy"</span><span class="token operator">:</span><span class="token string">"deny"</span><span class="token punctuation">,</span>        <span class="token property">"enable_token_persistence"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token property">"enable_key_list_policy"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token property">"tokens"</span><span class="token operator">:</span><span class="token punctuation">{</span>            <span class="token property">"master"</span><span class="token operator">:</span><span class="token string">"14d54c5e-24ca-****-*******-*********"</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="创建configmap"><a href="#创建configmap" class="headerlink" title="创建configmap"></a>创建configmap</h3><pre><code>kubectl  create configmap consul --from-file=k8s-consul-config.json</code></pre><p>上述命令创建一个名称为consul，内容为一个文件，文件名为<code>k8s-consul-config.json</code>，<code>configmap</code>可以挂载在<code>volume</code>下.</p><h3 id="修改-k8s-consul-statefulset-yaml文件"><a href="#修改-k8s-consul-statefulset-yaml文件" class="headerlink" title="修改 k8s-consul-statefulset.yaml文件"></a>修改 k8s-consul-statefulset.yaml文件</h3><blockquote><p>注意内容：</p><ol><li>在配置最后挂载了volumes-configmap，就是我们刚刚创建的consul</li><li><ul><li>“-config-file=/etc/consul/config/k8s-consul-config.json” 配置了我们保存的consul ACL相关配置</li></ul></li><li>requiredDuringSchedulingIgnoredDuringExecution，我们增加了这个配置，保证了consul的pod不会在同一台机器上运行【反亲和特性】，因为我们将consul/data挂载的是hostPath，如果一台机器启动多个会有冲突导致consul启动卡住。</li></ol></blockquote><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> consul<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> consul  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> consul        <span class="token key atrule">component</span><span class="token punctuation">:</span> server    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> consul      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>                <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>                  <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app                    <span class="token key atrule">operator</span><span class="token punctuation">:</span> In                    <span class="token key atrule">values</span><span class="token punctuation">:</span>                      <span class="token punctuation">-</span> consul              <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> consul        <span class="token key atrule">image</span><span class="token punctuation">:</span> consul<span class="token punctuation">:</span>1.6.0        <span class="token key atrule">args</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token string">"agent"</span>          <span class="token punctuation">-</span> <span class="token string">"-server"</span>          <span class="token punctuation">-</span> <span class="token string">"-bootstrap-expect=3"</span>          <span class="token punctuation">-</span> <span class="token string">"-ui"</span>          <span class="token punctuation">-</span> <span class="token string">"-data-dir=/consul/data"</span>          <span class="token punctuation">-</span> <span class="token string">"-config-file=/etc/consul/config/k8s-consul-config.json"</span>          <span class="token punctuation">-</span> <span class="token string">"-bind=0.0.0.0"</span>          <span class="token punctuation">-</span> <span class="token string">"-client=0.0.0.0"</span>          <span class="token punctuation">-</span> <span class="token string">"-advertise=$(PODIP)"</span>          <span class="token punctuation">-</span> <span class="token string">"-retry-join=consul-0.consul.$(NAMESPACE).svc.cluster.local"</span>          <span class="token punctuation">-</span> <span class="token string">"-retry-join=consul-1.consul.$(NAMESPACE).svc.cluster.local"</span>          <span class="token punctuation">-</span> <span class="token string">"-retry-join=consul-2.consul.$(NAMESPACE).svc.cluster.local"</span>          <span class="token punctuation">-</span> <span class="token string">"-domain=cluster.local"</span>          <span class="token punctuation">-</span> <span class="token string">"-disable-host-node-id"</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> data            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /consul/data          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/consul/config        <span class="token key atrule">env</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PODIP            <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>              <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>                <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> status.podIP          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NAMESPACE            <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>              <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>                <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.namespace        <span class="token key atrule">ports</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8500</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> ui<span class="token punctuation">-</span>port          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8400</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> alt<span class="token punctuation">-</span>port          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">53</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> udp<span class="token punctuation">-</span>port          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8443</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>port          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> http<span class="token punctuation">-</span>port          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8301</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> serflan          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8302</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> serfwan          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8600</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> consuldns          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8300</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> server      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> data          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>            <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/consul/data        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config          <span class="token key atrule">configMap</span><span class="token punctuation">:</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> consul<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>最后根据上面的配置重新创建consul的StatefulSet，启动完成后根据之前consul的知识，我们需要使用master token登录到ui，<strong>创建Agent token</strong>，然后修改configmap中acl配置，增加agent token，具体可以参考之前的文章。然后删除consul的pod，让k8s重新创建新的pod，使我们新的configmap生效即可。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> consul </category>
          
      </categories>
      
      
        <tags>
            
            <tag> consul </tag>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s常用命令整理</title>
      <link href="/2019/10/14/k8s-chang-yong-ming-ling-zheng-li/"/>
      <url>/2019/10/14/k8s-chang-yong-ming-ling-zheng-li/</url>
      
        <content type="html"><![CDATA[<table><thead><tr><th>用途</th><th>命令</th></tr></thead><tbody><tr><td>查看节点</td><td><code>kubectl get nodes</code></td></tr><tr><td>查看节点更多信息</td><td><code>kubectl get nodes -o wide</code></td></tr><tr><td>标志一个节点不可调度</td><td><code>kubectl cordon -nodeName</code></td></tr><tr><td>标志一个节点可调度</td><td><code>kubectl uncordon -nodeName</code></td></tr><tr><td>查看token列表</td><td><code>kubeadm token list</code></td></tr><tr><td>创建token</td><td><code>kubeadm token create</code></td></tr><tr><td>删除节点</td><td><code>kubectl drain &lt;node name&gt; --delete-local-data --force --ignore-daemonsets</code>/<code>kubectl delete node &lt;node name&gt;</code></td></tr><tr><td>创建一个deployment</td><td><code>kubectl create deployment nginx --image=nginx</code></td></tr><tr><td>查看deployments</td><td><code>kubectl get deployment(deployments)</code></td></tr><tr><td>创建一个service</td><td><code>kubectl create service nodeport nginx --tcp 80:80</code></td></tr><tr><td>查看services</td><td><code>kubectl get svc(service/services)</code></td></tr><tr><td>删除一个deployment</td><td><code>kubectl delete deployments/nginx</code></td></tr><tr><td>删除一个service</td><td><code>kubectl delete services/nginx</code></td></tr><tr><td>同时删除deployment和service</td><td><code>kubectl delete deployments/nginx services/nginx</code></td></tr><tr><td>从yaml文件创建deployment</td><td><code>kubectl create -f deployment.yaml</code></td></tr><tr><td>查看pods</td><td><code>kubectl get pods(pod)</code></td></tr><tr><td>查看pod更多信息</td><td><code>kubectl get pods -o wide</code></td></tr><tr><td>查看具体pod信息</td><td><code>kubectl describe pods/kube-node-59bf664cbf-2qzgd</code></td></tr><tr><td>修改deployment</td><td><code>kubectl edit deployments/test</code></td></tr><tr><td>从yaml创建service</td><td><code>kubectl create -f service.yaml</code></td></tr><tr><td>快捷创建service(expose)</td><td><code>kubectl expose deployment kube-node --type=NodePort</code></td></tr><tr><td>查看service具体信息</td><td><code>kubectl describe services/kube-node</code></td></tr><tr><td>查看namespace</td><td><code>kubectl get namespace</code></td></tr><tr><td>创建namespace</td><td><code>kubectl create namespace -name</code></td></tr><tr><td>删除namespace</td><td><code>kubectl delete namespace -name</code></td></tr><tr><td>根据配置文件创建configmap</td><td><code>kubectl create configmap my-config --from-file=path/to/bar</code>/<code>kubectl create configmap my-config --from-file=key1=/path/file1.txt --from-file=key2=/path/to/bar/file2.txt</code></td></tr><tr><td>从字符串创建configmap</td><td><code>kubectl create configmap my-config --from-literal=key1=config1 --from-literal=key2=config2</code></td></tr><tr><td>从env文件创建configmap</td><td><code>kubectl create configmap my-config --from-env-file=path/to/bar.env</code></td></tr><tr><td>扩容</td><td><code>kubectl scale deployment nginx-deployment --replicas 10</code></td></tr><tr><td>自动扩容</td><td><code>kubectl autoscale deployment nginx-deployment --min=10 --max=15 --cpu-percent=80</code></td></tr><tr><td>更新镜像</td><td><code>kubectl set image deployment/nginx-deployment nginx=nginx:1.9.1</code></td></tr><tr><td>回滚</td><td><code>kubectl rollout undo deployment/nginx-deployment</code></td></tr><tr><td>查看默认配置项，如pod.spec    kubectl</td><td><code>explain pod.spec</code></td></tr></tbody></table><p>以上都是亲自用过的，没用过的自己查表，附上<a href="http://docs.kubernetes.org.cn/683.html" target="_blank" rel="noopener">kubectl命令表</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>consul【多台机器docker部署】</title>
      <link href="/2019/10/11/consul-duo-tai-ji-qi-docker-bu-shu/"/>
      <url>/2019/10/11/consul-duo-tai-ji-qi-docker-bu-shu/</url>
      
        <content type="html"><![CDATA[<h3 id="问题1：ip问题"><a href="#问题1：ip问题" class="headerlink" title="问题1：ip问题"></a>问题1：ip问题</h3><p><img src="/images/consul22.png" alt="consul"><br>使用容器方式在主机上部署后，consul节点的ip为容器IP，如上图所示，主机外不能访问到该服务，需要配置内网或公网IP。</p><h4 id="使用docker"><a href="#使用docker" class="headerlink" title="使用docker"></a>使用docker</h4><p>使用docker run命令启动consul只需要在run后增加 <code>--net = "host"</code> ，这相当于使用主机上的IP。</p><pre class="line-numbers language-sh"><code class="language-sh">#注意1是要指定net为host，2是网卡为主机上的网卡，该网卡主机外服务能访问到，可以使用ifconfig看看网卡具体的名字docker run --net = "host" --name ** -e CONSUL_BIND_INTERFACE='eth0' ....(省略)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="使用docker-compose"><a href="#使用docker-compose" class="headerlink" title="使用docker-compose"></a>使用docker-compose</h4><p>使用<code>docker-compose</code>启动docker，需要指定<code>network_mode</code>为<code>host</code></p><pre class="line-numbers language-yml"><code class="language-yml">#原本配置，eth0为容器内网卡  consul_server_2:    container_name: consul_server_2    image: consul:1.6.0    networks:       consul:        ipv4_address: 172.20.0.3    volumes:      - /docker/consul/server2/config:/consul/config      - /docker/consul/server2/data:/consul/data    environment:      - CONSUL_BIND_INTERFACE=eth0      - TZ=Asia/Shanghai      - CONSUL_HTTP_TOKEN=db98c304-4d38-8660-fafe-6a4be56a40d0    restart: always    command: [      'agent'    ]#优化后，映射端口不需要了，因为是直接使用主机ens33网卡了  consul_server_1:    container_name: consul_server_1    image: consul:1.6.0    network_mode: host    volumes:      - /docker/consul/server1/config:/consul/config      - /docker/consul/server1/data:/consul/data    environment:      - CONSUL_BIND_INTERFACE=ens33      - TZ=Asia/Shanghai      - CONSUL_HTTP_TOKEN=db98c304-4d38-8660-fafe-6a4be56a40d0    restart: always    command: [      'agent'    ]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这样启动后consul服务的ip会变成主机的ip，外面的服务可以访问，跨机器部署consul集群通信也不会有问题了<br><img src="/images/consul23.png" alt="consul"></p><p>但是以上办法一台机器只能启动一个consul容器，多了会有端口占用的问题，如果想要单机部署多个consul节点，可以考虑修改consul端口。</p><pre class="line-numbers language-json"><code class="language-json">//新增ports.json放到consul的配置目录下即可。配置目录下所有.json配置都会加载//默认端口参考官网：https<span class="token operator">:</span>//www.consul.io/docs/agent/options.html#ports<span class="token punctuation">{</span>  <span class="token property">"ports"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"dns"</span><span class="token operator">:</span><span class="token number">9600</span><span class="token punctuation">,</span>    <span class="token property">"http"</span><span class="token operator">:</span><span class="token number">9500</span><span class="token punctuation">,</span>    <span class="token property">"serf_lan"</span><span class="token operator">:</span><span class="token number">9301</span><span class="token punctuation">,</span>    <span class="token property">"serf_wan"</span><span class="token operator">:</span><span class="token number">9302</span><span class="token punctuation">,</span>    <span class="token property">"server"</span><span class="token operator">:</span><span class="token number">9300</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>启动后同一台机器上两个consul都启动了，占用不同端口，类似可以继续增加consul节点数量，他们的IP都是一样的</p><p><img src="/images/consul24.png" alt="consul"><br><img src="/images/consul25.png" alt="consul"></p><h3 id="问题2：跨机器加入集群报错"><a href="#问题2：跨机器加入集群报错" class="headerlink" title="问题2：跨机器加入集群报错"></a>问题2：跨机器加入集群报错</h3><pre class="line-numbers language-log"><code class="language-log">#client2019/10/11 03:48:01 [INFO] agent: (LAN) joining: [192.168.41.128]consul_client_2    | ==> 1 error occurred:consul_client_2    |     * Failed to join 192.168.41.128: No installed keys could decrypt the message#server端consul_server_1    |     2019/10/11 03:48:18 [ERR] memberlist: failed to receive: No installed keys could decrypt the message from=192.168.41.129:48362consul_server_1    |     2019/10/11 03:48:18 [ERR] memberlist: failed to receive: No installed keys could decrypt the message from=192.168.41.129:48364consul_server_1    |     2019/10/11 03:48:31 [ERR] memberlist: failed to receive: No installed keys could decrypt the message from=192.168.41.129:48438consul_server_1    |     2019/10/11 03:48:31 [ERR] memberlist: failed to receive: No installed keys could decrypt the message from=192.168.41.129:48440consul_server_1    |     2019/10/11 03:48:57 [ERR] memberlist: failed to receive: No installed keys could decrypt the message from=192.168.41.129:48598consul_server_1    |     2019/10/11 03:48:57 [ERR] memberlist: failed to receive: No installed keys could decrypt the message from=192.168.41.129:48600<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre><code>所有consul节点加入配置"encrypt":"Cwqvm4elg0SIaF6xanFxZ3OFYadEiQtZ71xY1mJTUbk="此encrypt官方解释是用与集群通信加密的，生成方式 consul keygen依然报错不能解决</code></pre><pre class="line-numbers language-json"><code class="language-json">//所有节点加入以下配置，删除encrypt，下面的配置字面意思，出入的通信都不在验证，问题解决，不在报错    <span class="token property">"encrypt_verify_incoming"</span><span class="token operator">:</span><span class="token boolean">false</span>    <span class="token property">"encrypt_verify_outgoing"</span><span class="token operator">:</span><span class="token boolean">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>上面的配置是把验证功能关掉了，有安全隐患，官网还有另一个配置<code>disable_keyring_file</code>，（<code>https://github.com/hashicorp/consul/issues/4163</code>）有人可以解决，但是我尝试没有成功，后面继续研究有没有两全其美的办法。。</p><h3 id="start-join、retry-join的格式"><a href="#start-join、retry-join的格式" class="headerlink" title="start_join、retry_join的格式"></a>start_join、retry_join的格式</h3><pre class="line-numbers language-sh"><code class="language-sh">-join-启动时要加入的另一个代理的地址。可以多次指定，以指定要加入的多个代理。如果Consul无法加入任何指定地址，则代理启动将失败。默认情况下，代理在启动时不会加入任何节点。请注意，retry_join在Consul群集部署自动化时，使用 更为合适的方法有助于减轻节点启动竞争条件。-retry-join-与类似，-join但如果第一次尝试失败，则允许重试连接。在您知道该地址最终可用的情况下，这很有用。该列表可以包含IPv4，IPv6或DNS地址。在Consul 1.1.0及更高版本中，可以将其设置为 go-sockaddr 模板。如果Consul在非默认的Serf LAN端口上运行，则也必须指定此端口。IPv6必须使用“括弧式”语法。如果给出了多个值，则按照列出的顺序尝试并重试它们，直到第一个成功。这里有些例子：# Using a DNS entry$ consul agent -retry-join "consul.domain.internal"# Using IPv4，只有IP$ consul agent -retry-join "10.0.4.67"# Using IPv6,带端口$ consul agent -retry-join "[::1]:8301"#配置文件中格式    "start_join":[        "192.168.41.128:8301"    ],    "retry_join":[        "192.168.41.128:8301"    ],<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="问题：No-installed-keys-could-decrypt-the-message-报错解决"><a href="#问题：No-installed-keys-could-decrypt-the-message-报错解决" class="headerlink" title="问题：No installed keys could decrypt the message 报错解决"></a>问题：No installed keys could decrypt the message 报错解决</h3><p>新加入的consul节点需要配置<code>encrypt</code>，这个值是需要跟server端一样的，值保存在<code>/consul/data/serf/local.keyring</code>文件中，如果文件中已存在内容，是不是会更新的，需要删掉，或者手动填入，然后重启服务。如果文件中已经有了，那么启动配置中encrypt参数就可以删了，不会产生影响。<code>-disable-keyring-file</code>这个参数作用是是否持久化这个<code>encrypt</code>，默认持久化，可以选择不持久化，缺点是就要在启动配置里显式填写，优点是更好的排查所有节点是否一样。例如文件中和你启动参数中不一样，问题就出来了。</p><p>可以先在原有的集群中找到<code>local.keyring</code>文件中找到该<code>encrypt</code>，所有节点保持一致即可。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> consul </category>
          
      </categories>
      
      
        <tags>
            
            <tag> consul </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>consul【结合spring cloud使用consul配置中心并自动刷新】</title>
      <link href="/2019/10/10/consul-jie-he-spring-cloud-shi-yong-consul-pei-zhi-zhong-xin-bing-zi-dong-shua-xin/"/>
      <url>/2019/10/10/consul-jie-he-spring-cloud-shi-yong-consul-pei-zhi-zhong-xin-bing-zi-dong-shua-xin/</url>
      
        <content type="html"><![CDATA[<h3 id="重点"><a href="#重点" class="headerlink" title="重点:"></a><strong>重点:</strong></h3><blockquote><p><code>consul</code>的配置需要全部写在<code>resource</code>目录下<code>bootstrap.yml</code>文件中，写在<code>application.yml</code>中不能生效！</p></blockquote><h3 id="consul-config配置"><a href="#consul-config配置" class="headerlink" title="consul config配置"></a>consul config配置</h3><pre class="line-numbers language-yml"><code class="language-yml">#bootstrap.yml配置spring:  cloud:    consul:      host: 192.168.1.11      port: 8500      config:        enabled: true        format: KEY_VALUE        data-key: data        watch:          enabled: true        prefix: deriii        acl-token: bd63ce16-ccd0-22e1-d37d-fb948232cbf5      discovery:        healthCheckPath: /actuator/health        healthCheckInterval: 15s        acl-token: bd63ce16-ccd0-22e1-d37d-fb948232cbf5        prefer-ip-address: true        ip-address: 192.168.1.113<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="获取配置"><a href="#获取配置" class="headerlink" title="获取配置"></a>获取配置</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token comment" spellcheck="true">//data在consul中完整的目录是prefix + application name + data  </span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${data}"</span><span class="token punctuation">)</span>    String test<span class="token punctuation">;</span>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/test"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> String <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> test<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="实时刷新，需要在类上加注解"><a href="#实时刷新，需要在类上加注解" class="headerlink" title="实时刷新，需要在类上加注解"></a>实时刷新，需要在类上加注解</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@RefreshScope</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="另一种实现配置刷新"><a href="#另一种实现配置刷新" class="headerlink" title="另一种实现配置刷新"></a>另一种实现配置刷新</h3><pre class="line-numbers language-yml"><code class="language-yml">#bootstrap.yml配置，主要是修改了format为YAML，配合spring boot Configuration使用spring:  cloud:    consul:      host: 192.168.1.11      port: 8500      config:        enabled: true        format: YAML        data-key: data        watch:          enabled: true        prefix: deriiiii        acl-token: bd63ce16-ccd0-22e1-d37d-fb948232cbf5      discovery:        healthCheckPath: /actuator/health        healthCheckInterval: 15s        acl-token: bd63ce16-ccd0-22e1-d37d-fb948232cbf5        prefer-ip-address: true        ip-address: 192.168.1.113<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="spring-boot-配置类"><a href="#spring-boot-配置类" class="headerlink" title="spring boot 配置类"></a>spring boot 配置类</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"ttt"</span><span class="token punctuation">)</span><span class="token annotation punctuation">@Configuration</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HiConfig</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String test<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//getter setter ...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="consul中key为prefix-application-Name-data，value为yaml类型，且前缀是ttt，属性名为test"><a href="#consul中key为prefix-application-Name-data，value为yaml类型，且前缀是ttt，属性名为test" class="headerlink" title="consul中key为prefix + application Name + data，value为yaml类型，且前缀是ttt，属性名为test"></a>consul中key为prefix + application Name + data，value为yaml类型，且前缀是ttt，属性名为test</h3><pre class="line-numbers language-yml"><code class="language-yml">#key = deriiii/service-hello/datattt: test: asdas<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="启动类加上"><a href="#启动类加上" class="headerlink" title="启动类加上"></a>启动类加上</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token punctuation">{</span>HiConfig<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> consul </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring cloud </tag>
            
            <tag> consul </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>consul【K/V-HTTP接口】</title>
      <link href="/2019/10/10/consul-k-v-http-jie-kou/"/>
      <url>/2019/10/10/consul-k-v-http-jie-kou/</url>
      
        <content type="html"><![CDATA[<h3 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h3><blockquote><p>http头部加入<code>X-Consul-Token</code>，值为有权限的<code>token</code></p></blockquote><h3 id="查询一个key值"><a href="#查询一个key值" class="headerlink" title="查询一个key值"></a>查询一个key值</h3><pre><code>#key=/datahttp://192.168.1.11:8500/v1/kv/data#key=/test/datahttp://192.168.1.11:8500/v1/kv/test/data</code></pre><h3 id="查询一个folder下所有key值"><a href="#查询一个folder下所有key值" class="headerlink" title="查询一个folder下所有key值"></a>查询一个folder下所有key值</h3><pre><code>#folder是test，注意test后面有/不能少！http://192.168.1.11:8500/v1/kv/test/?recurse=true</code></pre><h3 id="查询folder下有哪些key"><a href="#查询folder下有哪些key" class="headerlink" title="查询folder下有哪些key"></a>查询folder下有哪些key</h3><pre><code>#test后面有/http://192.168.1.11:8500/v1/kv/test/?keys</code></pre><h3 id="修改key值"><a href="#修改key值" class="headerlink" title="修改key值"></a>修改key值</h3><blockquote><p>注意：KV存储中的值不能大于<font style="color:red"><strong>512kb</strong></font>。</p></blockquote><pre><code>#使用PUT请求，key为/test/datahttp://192.168.1.11:8500/v1/kv/test/data#body可以是{  "data":"sasasaasas1231313131"}#或者是{  "data-binary":"sasasaasas6666666"}#修改成功则回复true</code></pre><h3 id="删除key"><a href="#删除key" class="headerlink" title="删除key"></a>删除key</h3><pre><code>#使用DELETE请求，key为/test/datahttp://192.168.1.11:8500/v1/kv/test/data#成功则返回true</code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> consul </category>
          
      </categories>
      
      
        <tags>
            
            <tag> consul </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>consul【ACL使用】</title>
      <link href="/2019/10/09/consul-acl-shi-yong/"/>
      <url>/2019/10/09/consul-acl-shi-yong/</url>
      
        <content type="html"><![CDATA[<h3 id="开启ACL"><a href="#开启ACL" class="headerlink" title="开启ACL"></a>开启ACL</h3><p>接前文，需要开启<code>consul ACL</code>配置，如下</p><pre class="line-numbers language-json"><code class="language-json">// enable_key_list_policy开启<span class="token boolean">true</span>，为kv配置acl控制<span class="token property">"acl"</span><span class="token operator">:</span><span class="token punctuation">{</span>    <span class="token property">"enabled"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token property">"default_policy"</span><span class="token operator">:</span><span class="token string">"deny"</span><span class="token punctuation">,</span>    <span class="token property">"enable_token_persistence"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token property">"enable_key_list_policy"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token property">"tokens"</span><span class="token operator">:</span><span class="token punctuation">{</span>        <span class="token property">"master"</span><span class="token operator">:</span><span class="token string">"14d54c5e-24ca-41cc-8c9e-987ba7a96ffb"</span><span class="token punctuation">,</span>        <span class="token property">"agent"</span><span class="token operator">:</span><span class="token string">"db98c304-4d38-8660-fafe-6a4be56a40d0"</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="策略级别"><a href="#策略级别" class="headerlink" title="策略级别"></a>策略级别</h3><p>策略可以具有多个控制级别：</p><ul><li>read：允许读取但不修改资源。</li><li>write：允许读取和修改资源。</li><li>deny：不允许读取或修改资源。</li><li>list：允许访问领事KV中某个网段下的所有键。注意，此策略只能与key_prefix资源一起使用，并且acl.enable_key_list_policy必须设置为true。</li></ul><h3 id="k-v创建token示例"><a href="#k-v创建token示例" class="headerlink" title="k-v创建token示例"></a>k-v创建token示例</h3><pre class="line-numbers language-json"><code class="language-json"># These control access to the key/value store.key_prefix <span class="token string">""</span> <span class="token punctuation">{</span>  policy = <span class="token string">"read"</span><span class="token punctuation">}</span>key_prefix <span class="token string">"foo/"</span> <span class="token punctuation">{</span>  policy = <span class="token string">"write"</span><span class="token punctuation">}</span>key_prefix <span class="token string">"foo/private/"</span> <span class="token punctuation">{</span>  policy = <span class="token string">"deny"</span><span class="token punctuation">}</span># Or for exact key matcheskey <span class="token string">"foo/bar/secret"</span> <span class="token punctuation">{</span>  policy = <span class="token string">"deny"</span><span class="token punctuation">}</span># This controls access to cluster-wide Consul operator information.operator = <span class="token string">"read"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>等同于</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"key_prefix"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">""</span><span class="token operator">:</span> <span class="token punctuation">{</span>      <span class="token property">"policy"</span><span class="token operator">:</span> <span class="token string">"read"</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"foo/"</span><span class="token operator">:</span> <span class="token punctuation">{</span>      <span class="token property">"policy"</span><span class="token operator">:</span> <span class="token string">"write"</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"foo/private/"</span><span class="token operator">:</span> <span class="token punctuation">{</span>      <span class="token property">"policy"</span><span class="token operator">:</span> <span class="token string">"deny"</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token property">"key"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"foo/bar/secret"</span> <span class="token operator">:</span> <span class="token punctuation">{</span>      <span class="token property">"policy"</span> <span class="token operator">:</span> <span class="token string">"deny"</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token property">"operator"</span><span class="token operator">:</span> <span class="token string">"read"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-json"><code class="language-json">key_prefix <span class="token string">""</span> <span class="token punctuation">{</span>  policy = <span class="token string">"read"</span><span class="token punctuation">}</span>key <span class="token string">"foo"</span> <span class="token punctuation">{</span>  policy = <span class="token string">"write"</span><span class="token punctuation">}</span>key <span class="token string">"bar"</span> <span class="token punctuation">{</span>  policy = <span class="token string">"deny"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-json"><code class="language-json">key_prefix <span class="token string">""</span> <span class="token punctuation">{</span> policy = <span class="token string">"deny"</span><span class="token punctuation">}</span>key_prefix <span class="token string">"bar"</span> <span class="token punctuation">{</span> policy = <span class="token string">"list"</span><span class="token punctuation">}</span>key_prefix <span class="token string">"baz"</span> <span class="token punctuation">{</span> policy = <span class="token string">"read"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-json"><code class="language-json">node_prefix <span class="token string">""</span> <span class="token punctuation">{</span>  policy = <span class="token string">"read"</span><span class="token punctuation">}</span>node <span class="token string">"app"</span> <span class="token punctuation">{</span>  policy = <span class="token string">"write"</span><span class="token punctuation">}</span>node <span class="token string">"admin"</span> <span class="token punctuation">{</span>  policy = <span class="token string">"deny"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-json"><code class="language-json">agent_prefix <span class="token string">""</span> <span class="token punctuation">{</span>  policy = <span class="token string">"read"</span><span class="token punctuation">}</span>agent <span class="token string">"foo"</span> <span class="token punctuation">{</span>  policy = <span class="token string">"write"</span><span class="token punctuation">}</span>agent_prefix <span class="token string">"bar"</span> <span class="token punctuation">{</span>  policy = <span class="token string">"deny"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-json"><code class="language-json">event_prefix <span class="token string">""</span> <span class="token punctuation">{</span>  policy = <span class="token string">"read"</span><span class="token punctuation">}</span>event <span class="token string">"deploy"</span> <span class="token punctuation">{</span>  policy = <span class="token string">"write"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-json"><code class="language-json">node_prefix <span class="token string">""</span> <span class="token punctuation">{</span>  policy = <span class="token string">"read"</span><span class="token punctuation">}</span>node <span class="token string">"app"</span> <span class="token punctuation">{</span>  policy = <span class="token string">"write"</span><span class="token punctuation">}</span>node <span class="token string">"admin"</span> <span class="token punctuation">{</span>  policy = <span class="token string">"deny"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-json"><code class="language-json">query_prefix <span class="token string">""</span> <span class="token punctuation">{</span>  policy = <span class="token string">"read"</span><span class="token punctuation">}</span>query <span class="token string">"foo"</span> <span class="token punctuation">{</span>  policy = <span class="token string">"write"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-json"><code class="language-json">service_prefix <span class="token string">""</span> <span class="token punctuation">{</span>  policy = <span class="token string">"read"</span><span class="token punctuation">}</span>service <span class="token string">"app"</span> <span class="token punctuation">{</span>  policy = <span class="token string">"write"</span><span class="token punctuation">}</span>service <span class="token string">"admin"</span> <span class="token punctuation">{</span>  policy = <span class="token string">"deny"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-json"><code class="language-json">session_prefix <span class="token string">""</span> <span class="token punctuation">{</span>  policy = <span class="token string">"read"</span><span class="token punctuation">}</span>session <span class="token string">"app"</span> <span class="token punctuation">{</span>  policy = <span class="token string">"write"</span><span class="token punctuation">}</span>session <span class="token string">"admin"</span> <span class="token punctuation">{</span>  policy = <span class="token string">"deny"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="遇到的坑！"><a href="#遇到的坑！" class="headerlink" title="遇到的坑！"></a>遇到的坑！</h3><p>当我创建一个<code>token</code>，分配了<code>policy</code>，如<code>service_prefix....</code>用这个<code>token</code>登录<code>ui</code>，在<code>Services</code>中可以看到权限内的<code>service</code>！同理<code>node</code>也是一样，但是针对<code>key/values</code>不行，会直接跳转到<code>ACL</code>登录页面!<br><img src="/images/consul18.png" alt="consul"><br><img src="/images/consul19.png" alt="consul"><br><img src="/images/consul20.png" alt="consul"><br><img src="/images/consul21.png" alt="consul"></p><p>这时候并不是<code>acl</code>没有权限，需要在浏览器中直接输入<code>http://ip:8500/ui/dc1/kv/foo/</code>，<code>dc1</code>是<code>datacenter</code>的名字，<code>foo</code>为<code>policy</code>赋予的<code>kv前缀</code>，这样就可以在<code>ui</code>中修改<code>key/values</code>了.</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> consul </category>
          
      </categories>
      
      
        <tags>
            
            <tag> consul </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>consul【watcher handle使用】</title>
      <link href="/2019/10/08/consul-watcher-handle-shi-yong/"/>
      <url>/2019/10/08/consul-watcher-handle-shi-yong/</url>
      
        <content type="html"><![CDATA[<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>创建<code>watcher.json</code>文件，放在<code>consul</code>配置目录下，启动consul时指定<code>-config-dir</code>:</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"watches"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">{</span>      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"key"</span><span class="token punctuation">,</span>      <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"foo/data"</span><span class="token punctuation">,</span>      <span class="token property">"handler_type"</span><span class="token operator">:</span> <span class="token string">"http"</span><span class="token punctuation">,</span>      <span class="token property">"http_handler_config"</span><span class="token operator">:</span> <span class="token punctuation">{</span>         <span class="token property">"path"</span><span class="token operator">:</span><span class="token string">"http://127.0.0.1:8763/watch"</span><span class="token punctuation">,</span>         <span class="token property">"method"</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>         <span class="token property">"header"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"x-foo"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"bar"</span><span class="token punctuation">,</span> <span class="token string">"baz"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>         <span class="token property">"timeout"</span><span class="token operator">:</span> <span class="token string">"10s"</span><span class="token punctuation">,</span>         <span class="token property">"tls_skip_verify"</span><span class="token operator">:</span> <span class="token boolean">false</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="创建handle"><a href="#创建handle" class="headerlink" title="创建handle"></a>创建handle</h3><p>创建一个<code>http服务</code>用于接收变更的<code>key</code>，<code>http://127.0.0.1:8763/watch</code></p><pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"/watch"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">watcher</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        BufferedReader reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String str <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>        String wholeStr <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>str <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            wholeStr <span class="token operator">+=</span> str<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"body:"</span> <span class="token operator">+</span> wholeStr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>在<code>consul ui</code>中新增 或者修改<code>foo/data</code>这个key值，<code>watcher</code>就会收到这个更新后的值</p><pre class="line-numbers language-log"><code class="language-log">POSTbody:{"Key":"foo/data","CreateIndex":12,"ModifyIndex":12,"LockIndex":0,"Flags":0,"Value":"YWFhYWFhYQ==","Session":""}POSTbody:{"Key":"foo/data","CreateIndex":12,"ModifyIndex":17,"LockIndex":0,"Flags":0,"Value":"YWFhYWFhYXNzc3NkZHNkZHNk","Session":""}POSTbody:{"Key":"foo/data","CreateIndex":12,"ModifyIndex":25,"LockIndex":0,"Flags":0,"Value":"ewogICJ0ZXN0IjoidGVzdCIsCiAgInRlc3QyIjoidDMzM2VzdCIKfQ==","Session":""}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>value为<code>base64编码</code>，解码后得到需要的值。</p><h3 id="sh脚本"><a href="#sh脚本" class="headerlink" title="sh脚本"></a>sh脚本</h3><p><code>handle</code>除了是<code>http</code>，还可以是<code>sh脚本</code>，如</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"key"</span><span class="token punctuation">,</span>  <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"foo/bar/baz"</span><span class="token punctuation">,</span>  <span class="token property">"handler_type"</span><span class="token operator">:</span> <span class="token string">"script"</span><span class="token punctuation">,</span>  <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"/usr/bin/my-service-handler.sh"</span><span class="token punctuation">,</span> <span class="token string">"-redis"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="官网说明"><a href="#官网说明" class="headerlink" title="官网说明"></a>官网说明</h3><p>以下摘自官网：<code>https://www.consul.io/docs/agent/watches.html#key</code></p><p>Watch Types/支持的类型<br>The following types are supported. Detailed documentation on each is below:</p><ul><li>key - Watch a specific KV pair</li><li>keyprefix - Watch a prefix in the KV store</li><li>services - Watch the list of available services</li><li>nodes - Watch the list of nodes</li><li>service- Watch the instances of a service</li><li>checks - Watch the value of health checks</li><li>event - Watch for custom user events</li></ul><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"key"</span><span class="token punctuation">,</span>  <span class="token property">"key"</span><span class="token operator">:</span> <span class="token string">"foo/bar/baz"</span><span class="token punctuation">,</span>  <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"/usr/bin/my-service-handler.sh"</span><span class="token punctuation">,</span> <span class="token string">"-redis"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyprefix"</span><span class="token punctuation">,</span>  <span class="token property">"prefix"</span><span class="token operator">:</span> <span class="token string">"foo/"</span><span class="token punctuation">,</span>  <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"/usr/bin/my-service-handler.sh"</span><span class="token punctuation">,</span> <span class="token string">"-redis"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"service"</span><span class="token punctuation">,</span>  <span class="token property">"service"</span><span class="token operator">:</span> <span class="token string">"redis"</span><span class="token punctuation">,</span>  <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"/usr/bin/my-service-handler.sh"</span><span class="token punctuation">,</span> <span class="token string">"-redis"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token property">"tag"</span><span class="token operator">:</span> <span class="token string">"bar"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> consul </category>
          
      </categories>
      
      
        <tags>
            
            <tag> consul </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kubernetes-v1.15.0安装【使用kubeadm部署】</title>
      <link href="/2019/09/06/kubernetes-v1-15-0-an-zhuang-shi-yong-kubeadm-bu-shu/"/>
      <url>/2019/09/06/kubernetes-v1-15-0-an-zhuang-shi-yong-kubeadm-bu-shu/</url>
      
        <content type="html"><![CDATA[<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><table><thead><tr><th>节点名</th><th>IP</th><th>角色</th></tr></thead><tbody><tr><td>node2</td><td>192.168.41.129</td><td>master</td></tr><tr><td>node3</td><td>192.168.41.130</td><td>slave</td></tr><tr><td>node4</td><td>192.168.41.131</td><td>slave</td></tr></tbody></table><h3 id="系统配置"><a href="#系统配置" class="headerlink" title="系统配置"></a>系统配置</h3><p>在安装之前，需要先做如下准备,修改hosts：</p><pre class="line-numbers language-sh"><code class="language-sh">cat /etc/hosts192.168.41.129 node2192.168.41.130 node3192.168.41.131 node4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>禁用防火墙：</p><pre class="line-numbers language-sh"><code class="language-sh">systemctl stop firewalldsystemctl disable firewalldsystemctl stop iptablessystemctl disable iptables<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>禁用SELINUX：</p><pre><code>setenforce 0</code></pre><pre><code>vi /etc/selinux/configSELINUX=disabled</code></pre><pre class="line-numbers language-sh"><code class="language-sh">#检查SELINUX状态/usr/sbin/sestatus -vSELinux status: disabled<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>创建/etc/sysctl.d/k8s.conf文件，添加如下内容：（vm.swappiness=0是swap相关配置，后面需要配置，这里统一加上）</p><pre><code>net.bridge.bridge-nf-call-ip6tables = 1net.bridge.bridge-nf-call-iptables = 1net.ipv4.ip_forward = 1vm.swappiness=0</code></pre><p>执行命令使修改生效。</p><pre><code>modprobe br_netfiltersysctl -p /etc/sysctl.d/k8s.conf</code></pre><h3 id="kube-proxy开启ipvs的前置条件"><a href="#kube-proxy开启ipvs的前置条件" class="headerlink" title="kube-proxy开启ipvs的前置条件"></a>kube-proxy开启ipvs的前置条件</h3><p>由于ipvs已经加入到了内核的主干，所以为kube-proxy开启ipvs的前提需要加载以下的内核模块：</p><pre class="line-numbers language-s"><code class="language-s">ip_vsip_vs_rrip_vs_wrrip_vs_shnf_conntrack_ipv4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在所有的Kubernetes节点node1和node2上执行以下脚本:</p><pre class="line-numbers language-sh"><code class="language-sh">cat > /etc/sysconfig/modules/ipvs.modules <<EOF#!/bin/bashmodprobe -- ip_vsmodprobe -- ip_vs_rrmodprobe -- ip_vs_wrrmodprobe -- ip_vs_shmodprobe -- nf_conntrack_ipv4EOFchmod 755 /etc/sysconfig/modules/ipvs.modules && bash /etc/sysconfig/modules/ipvs.modules && lsmod | grep -e ip_vs -e nf_conntrack_ipv4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面脚本创建了的<code>/etc/sysconfig/modules/ipvs.modules</code>文件，保证在节点重启后能自动加载所需模块。 使用</p><pre><code>lsmod | grep -e ip_vs -e nf_conntrack_ipv4</code></pre><p>命令查看是否已经正确加载所需的内核模块。</p><p>接下来还需要确保各个节点上已经安装了<code>ipset</code>软件包</p><pre><code>yum install ipset</code></pre><p>为了便于查看ipvs的代理规则，最好安装一下管理工具<code>ipvsadm</code> 。</p><pre><code>yum install ipvsadm</code></pre><p>如果以上前提条件如果不满足，则即使<code>kube-proxy</code>的配置开启了<code>ipvs</code>模式，也会退回到<code>iptables</code>模式。</p><h3 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h3><blockquote><p>Kubernetes从1.6开始使用<code>CRI</code>(<code>Container Runtime Interface</code>)容器运行时接口。默认的容器运行时仍然是<code>Docker</code>，使用的是<code>kubelet</code>中内置<code>dockershim CRI</code>实现。</p></blockquote><p>安装<code>docker</code>的<code>yum</code>源:</p><pre class="line-numbers language-sh"><code class="language-sh">yum install -y yum-utils device-mapper-persistent-data lvm2yum-config-manager \    --add-repo \    https://download.docker.com/linux/centos/docker-ce.repo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>查看最新的Docker版本：</p><pre class="line-numbers language-log"><code class="language-log">yum list docker-ce.x86_64  --showduplicates |sort -rdocker-ce.x86_64            3:18.09.7-3.el7                     docker-ce-stabledocker-ce.x86_64            3:18.09.6-3.el7                     docker-ce-stabledocker-ce.x86_64            3:18.09.5-3.el7                     docker-ce-stabledocker-ce.x86_64            3:18.09.4-3.el7                     docker-ce-stabledocker-ce.x86_64            3:18.09.3-3.el7                     docker-ce-stabledocker-ce.x86_64            3:18.09.2-3.el7                     docker-ce-stabledocker-ce.x86_64            3:18.09.1-3.el7                     docker-ce-stabledocker-ce.x86_64            3:18.09.0-3.el7                     docker-ce-stabledocker-ce.x86_64            18.06.3.ce-3.el7                    docker-ce-stabledocker-ce.x86_64            18.06.2.ce-3.el7                    docker-ce-stabledocker-ce.x86_64            18.06.1.ce-3.el7                    docker-ce-stabledocker-ce.x86_64            18.06.0.ce-3.el7                    docker-ce-stabledocker-ce.x86_64            18.03.1.ce-1.el7.centos             docker-ce-stabledocker-ce.x86_64            18.03.0.ce-1.el7.centos             docker-ce-stable<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>Kubernetes 1.15</code>当前支持的docker版本列表是<code>1.13.1</code>, <code>17.03</code>, <code>17.06</code>, <code>17.09</code>, <code>18.06</code>, <code>18.09</code>。 这里在各节点安装docker的<code>18.09.7</code>版本。</p><pre class="line-numbers language-sh"><code class="language-sh">yum makecache fastyum install -y --setopt=obsoletes=0 \  docker-ce-18.09.7-3.el7 systemctl start dockersystemctl enable docker<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>确认一下<code>iptables filter</code>表中<code>FOWARD</code>链的默认策略(<code>pllicy</code>)为<code>ACCEPT</code>:</p><pre class="line-numbers language-sh"><code class="language-sh">iptables -nvLChain INPUT (policy ACCEPT 263 packets, 19209 bytes) pkts bytes target     prot opt in     out     source               destinationChain FORWARD (policy ACCEPT 0 packets, 0 bytes) pkts bytes target     prot opt in     out     source               destination    0     0 DOCKER-USER  all  --  *      *       0.0.0.0/0            0.0.0.0/0    0     0 DOCKER-ISOLATION-STAGE-1  all  --  *      *       0.0.0.0/0            0.0.0.0/0    0     0 ACCEPT     all  --  *      docker0  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED    0     0 DOCKER     all  --  *      docker0  0.0.0.0/0            0.0.0.0/0    0     0 ACCEPT     all  --  docker0 !docker0  0.0.0.0/0            0.0.0.0/0    0     0 ACCEPT     all  --  docker0 docker0  0.0.0.0/0            0.0.0.0/0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="修改docker-cgroup-driver为systemd"><a href="#修改docker-cgroup-driver为systemd" class="headerlink" title="修改docker cgroup driver为systemd"></a>修改docker cgroup driver为systemd</h3><p>根据文档<code>CRI installation</code>中的内容，对于使用<code>systemd</code>作为<code>init system</code>的Linux的发行版，使用systemd作为docker的<code>cgroup driver</code>可以确保服务器节点在资源紧张的情况更加稳定，因此这里修改各个节点上docker的cgroup driver为systemd。</p><p>创建或修改<code>/etc/docker/daemon.json</code>：</p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"exec-opts"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"native.cgroupdriver=systemd"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>重启docker：</p><pre class="line-numbers language-sh"><code class="language-sh">systemctl restart dockerdocker info | grep CgroupCgroup Driver: systemd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="使用kubeadm部署Kubernetes"><a href="#使用kubeadm部署Kubernetes" class="headerlink" title="使用kubeadm部署Kubernetes"></a>使用kubeadm部署Kubernetes</h2><h3 id="安装kubeadm和kubelet"><a href="#安装kubeadm和kubelet" class="headerlink" title="安装kubeadm和kubelet"></a>安装kubeadm和kubelet</h3><p>下面在各节点安装<code>kubeadm</code>和<code>kubelet</code>：</p><pre class="line-numbers language-sh"><code class="language-sh">cat <<EOF > /etc/yum.repos.d/kubernetes.repo[kubernetes]name=Kubernetesbaseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64enabled=1gpgcheck=1repo_gpgcheck=1gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg        https://packages.cloud.google.com/yum/doc/rpm-package-key.gpgEOF#由于国内网络不通问题，推荐使用以下阿里云镜像cat <<EOF > /etc/yum.repos.d/kubernetes.repo[kubernetes]name=Kubernetesbaseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64enabled=1gpgcheck=1repo_gpgcheck=1gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg        http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpgEOF<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-sh"><code class="language-sh">yum makecache fast#默认可能安装的版本不一样yum install -y kubelet kubeadm kubectl#建议指定版本yum install -y kubelet-1.15.0 kubeadm-1.15.0 kubectl-1.15.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>Kubernetes 1.8</code>开始要求关闭系统的<code>Swap</code>，如果不关闭，默认配置下kubelet将无法启动。 关闭系统的Swap方法如下:</p><pre><code>swapoff -a</code></pre><p>永久关闭swap：</p><p>修改 <code>/etc/fstab</code> 文件，注释掉 SWAP 的自动挂载，使用<code>free -m</code>确认swap已经关闭。</p><p><code>swappiness</code>参数调整，修改<code>/etc/sysctl.d/k8s.conf</code>添加下面一行,<strong>前面已经统一加过了</strong>：</p><pre><code>vm.swappiness=0</code></pre><p>执行<code>sysctl -p /etc/sysctl.d/k8s.conf</code>使修改生效。</p><blockquote><p>关闭swap可能会对其他服务产生影响，所以这里修改kubelet的配置去掉这个限制。<br>使用kubelet的启动参数<code>–fail-swap-on=false</code>去掉必须关闭Swap的限制，修改<code>/etc/sysconfig/kubelet</code>，加入：<br><code>KUBELET_EXTRA_ARGS=--fail-swap-on=false</code></p></blockquote><h3 id="使用kubeadm-init初始化集群"><a href="#使用kubeadm-init初始化集群" class="headerlink" title="使用kubeadm init初始化集群"></a>使用kubeadm init初始化集群</h3><p>在各节点开机启动<code>kubelet</code>服务：</p><pre><code>systemctl enable kubelet.service</code></pre><p>使用<code>kubeadm config print init-defaults</code>可以打印集群初始化默认的使用的配置：</p><pre class="line-numbers language-yml"><code class="language-yml">apiVersion: kubeadm.k8s.io/v1beta2bootstrapTokens:- groups:  - system:bootstrappers:kubeadm:default-node-token  token: abcdef.0123456789abcdef  ttl: 24h0m0s  usages:  - signing  - authenticationkind: InitConfigurationlocalAPIEndpoint:  advertiseAddress: 1.2.3.4  bindPort: 6443nodeRegistration:  criSocket: /var/run/dockershim.sock  name: node1  taints:  - effect: NoSchedule    key: node-role.kubernetes.io/master---apiServer:  timeoutForControlPlane: 4m0sapiVersion: kubeadm.k8s.io/v1beta2certificatesDir: /etc/kubernetes/pkiclusterName: kubernetescontrollerManager: {}dns:  type: CoreDNSetcd:  local:    dataDir: /var/lib/etcdimageRepository: k8s.gcr.iokind: ClusterConfigurationkubernetesVersion: v1.14.0networking:  dnsDomain: cluster.local  serviceSubnet: 10.96.0.0/12scheduler: {}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>从默认的配置中可以看到，可以使用<code>imageRepository</code>定制在集群初始化时拉取k8s所需镜像的地址。基于默认配置定制出本次使用kubeadm初始化集群所需的配置文件<code>kubeadm.yaml</code>：</p><pre class="line-numbers language-yml"><code class="language-yml">apiVersion: kubeadm.k8s.io/v1beta2kind: InitConfigurationlocalAPIEndpoint:  advertiseAddress: 192.168.41.129  bindPort: 6443nodeRegistration:  taints:  - effect: PreferNoSchedule    key: node-role.kubernetes.io/master---apiVersion: kubeadm.k8s.io/v1beta2kind: ClusterConfigurationkubernetesVersion: v1.15.0networking:  podSubnet: 10.244.0.0/16<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在开始初始化集群之前可以使用</p><pre><code>kubeadm config images pull</code></pre><p>预先在各个节点上拉取所k8s需要的docker镜像。</p><blockquote><p>由于国内网络问题，k8s.gcr.io 资源获取不了,使用以下方法</p></blockquote><pre class="line-numbers language-sh"><code class="language-sh">#!/bin/bashMY_REGISTRY=gcr.azk8s.cn/google-containers## 拉取镜像docker pull ${MY_REGISTRY}/kube-apiserver:v1.15.0docker pull ${MY_REGISTRY}/kube-controller-manager:v1.15.0docker pull ${MY_REGISTRY}/kube-scheduler:v1.15.0docker pull ${MY_REGISTRY}/kube-proxy:v1.15.0docker pull ${MY_REGISTRY}/pause:3.1docker pull ${MY_REGISTRY}/etcd:3.3.10docker pull ${MY_REGISTRY}/coredns:1.3.1## 添加Tagdocker tag ${MY_REGISTRY}/kube-apiserver:v1.15.0 k8s.gcr.io/kube-apiserver:v1.15.0docker tag ${MY_REGISTRY}/kube-controller-manager:v1.15.0 k8s.gcr.io/kube-controller-manager:v1.15.0docker tag ${MY_REGISTRY}/kube-scheduler:v1.15.0 k8s.gcr.io/kube-scheduler:v1.15.0docker tag ${MY_REGISTRY}/kube-proxy:v1.15.0 k8s.gcr.io/kube-proxy:v1.15.0docker tag ${MY_REGISTRY}/pause:3.1 k8s.gcr.io/pause:3.1docker tag ${MY_REGISTRY}/etcd:3.3.10 k8s.gcr.io/etcd:3.3.10docker tag ${MY_REGISTRY}/coredns:1.3.1 k8s.gcr.io/coredns:1.3.1#删除无用的镜像docker images | grep ${MY_REGISTRY} | awk '{print "docker rmi "  $1":"$2}' | sh -xecho "end"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的所有操作可以在一个节点上面完成，然后对进行复制即可。</p><p>其它因为网络原因pull的镜像都可以同理先下载下来:</p><pre class="line-numbers language-sh"><code class="language-sh">#1.先使用docker search命令查找#2.选择一个下载快的镜像使用docker pull下载下来#3.使用docker tag命令修改成程序需要的镜像#4.使用docker rmi删除之前的镜像#下载flannel网络镜像docker pull xmlgrg/flannel:v0.11.0-amd64docker tag docker.io/xmlgrg/flannel:v0.11.0-amd64 quay.io/coreos/flannel:v0.11.0-amd64docker rmi docker.io/xmlgrg/flannel:v0.11.0-amd64#下载tillerdocker pull junolu/tiller:v2.14.3docker tag docker.io/junolu/tiller:v2.14.3 gcr.io/kubernetes-helm/tiller:v2.14.3docker rmi docker.io/junolu/tiller:v2.14.3#下载ingress-nginx/defaultbackend-amd64docker pull fungitive/defaultbackend-amd64docker tag docker.io/fungitive/defaultbackend-amd64:latest k8s.gcr.io/defaultbackend-amd64:1.5docker rmi docker.io/fungitive/defaultbackend-amd64:latest#下载dashboarddocker.io/loveone/kubernetes-dashboard-amd64:v1.10.1docker tag docker.io/loveone/kubernetes-dashboard-amd64:v1.10.1 k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1docker  rmi docker.io/loveone/kubernetes-dashboard-amd64:v1.10.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接下来使用<code>kubeadm</code>初始化集群，选择<code>node2</code>作为<code>Master Node</code>，在<code>node2</code>上执行下面的命令：</p><pre class="line-numbers language-log"><code class="language-log">kubeadm init --config kubeadm.yaml --ignore-preflight-errors=Swap[init] Using Kubernetes version: v1.15.0[preflight] Running pre-flight checks    [WARNING Swap]: running with swap on is not supported. Please disable swap[preflight] Pulling images required for setting up a Kubernetes cluster[preflight] This might take a minute or two, depending on the speed of your internet connection[preflight] You can also perform this action in beforehand using 'kubeadm config images pull'[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"[kubelet-start] Activating the kubelet service[certs] Using certificateDir folder "/etc/kubernetes/pki"[certs] Generating "etcd/ca" certificate and key[certs] Generating "apiserver-etcd-client" certificate and key[certs] Generating "etcd/server" certificate and key[certs] etcd/server serving cert is signed for DNS names [node1 localhost] and IPs [192.168.99.11 127.0.0.1 ::1][certs] Generating "etcd/peer" certificate and key[certs] etcd/peer serving cert is signed for DNS names [node1 localhost] and IPs [192.168.99.11 127.0.0.1 ::1][certs] Generating "etcd/healthcheck-client" certificate and key[certs] Generating "ca" certificate and key[certs] Generating "apiserver" certificate and key[certs] apiserver serving cert is signed for DNS names [node1 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 192.168.99.11][certs] Generating "apiserver-kubelet-client" certificate and key[certs] Generating "front-proxy-ca" certificate and key[certs] Generating "front-proxy-client" certificate and key[certs] Generating "sa" key and public key[kubeconfig] Using kubeconfig folder "/etc/kubernetes"[kubeconfig] Writing "admin.conf" kubeconfig file[kubeconfig] Writing "kubelet.conf" kubeconfig file[kubeconfig] Writing "controller-manager.conf" kubeconfig file[kubeconfig] Writing "scheduler.conf" kubeconfig file[control-plane] Using manifest folder "/etc/kubernetes/manifests"[control-plane] Creating static Pod manifest for "kube-apiserver"[control-plane] Creating static Pod manifest for "kube-controller-manager"[control-plane] Creating static Pod manifest for "kube-scheduler"[etcd] Creating static Pod manifest for local etcd in "/etc/kubernetes/manifests"[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory "/etc/kubernetes/manifests". This can take up to 4m0s[apiclient] All control plane components are healthy after 26.004907 seconds[upload-config] Storing the configuration used in ConfigMap "kubeadm-config" in the "kube-system" Namespace[kubelet] Creating a ConfigMap "kubelet-config-1.15" in namespace kube-system with the configuration for the kubelets in the cluster[upload-certs] Skipping phase. Please see --upload-certs[mark-control-plane] Marking the node node1 as control-plane by adding the label "node-role.kubernetes.io/master=''"[mark-control-plane] Marking the node node1 as control-plane by adding the taints [node-role.kubernetes.io/master:PreferNoSchedule][bootstrap-token] Using token: 4qcl2f.gtl3h8e5kjltuo0r[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster[bootstrap-token] Creating the "cluster-info" ConfigMap in the "kube-public" namespace[addons] Applied essential addon: CoreDNS[addons] Applied essential addon: kube-proxyYour Kubernetes control-plane has initialized successfully!To start using your cluster, you need to run the following as a regular user:  mkdir -p $HOME/.kube  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config  sudo chown $(id -u):$(id -g) $HOME/.kube/configYou should now deploy a pod network to the cluster.Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:  https://kubernetes.io/docs/concepts/cluster-administration/addons/Then you can join any number of worker nodes by running the following on each as root:kubeadm join 192.168.99.11:6443 --token 4qcl2f.gtl3h8e5kjltuo0r \    --discovery-token-ca-cert-hash sha256:7ed5404175cc0bf18dbfe53f19d4a35b1e3d40c19b10924275868ebf2a3bbe6e<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面记录了完成的初始化输出的内容，根据输出的内容基本上可以看出手动初始化安装一个Kubernetes集群所需要的关键步骤。 其中有以下关键内容：</p><ul><li>[kubelet-start] 生成kubelet的配置文件”/var/lib/kubelet/config.yaml”</li><li>[certs]生成相关的各种证书</li><li>[kubeconfig]生成相关的kubeconfig文件</li><li>[control-plane]使用/etc/kubernetes/manifests目录中的yaml文件创建apiserver、controller-manager、scheduler的静态pod</li><li>[bootstraptoken]生成token记录下来，后边使用kubeadm join往集群中添加节点时会用到</li><li>最后给出了将节点加入集群的命令<code>kubeadm join 18.16.202.163:6443 --token jrts59.18pe12atfafgcxca \ --discovery-token-ca-cert-hash sha256:56d6c7d7b63a9109444ece68a1b155d8a9ac049ba57febab2c72d40d8ab7d426</code></li></ul><p><strong><font style="color:red">下面的命令是配置常规用户如何使用kubectl访问集群：务必配上，不然无法使用kubectl命令！</font></strong></p><pre class="line-numbers language-sh"><code class="language-sh">mkdir -p $HOME/.kubesudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/configsudo chown $(id -u):$(id -g) $HOME/.kube/config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>集群初始化如果遇到问题，可以使用下面的命令进行清理：</p><pre><code>kubeadm reset</code></pre><blockquote><p>遇到的问题：<code>The connection to the server localhost:8080 was refused - did you specify the right host or port?</code><br>初始化的集群，kube-apiserver没有监听默认的http 8080端口。</p></blockquote><p>查看kube-apiserver的监听端口可以看到只监听了https的6443端口:</p><pre class="line-numbers language-log"><code class="language-log">netstat -nltp | grep apiservertcp6       0      0 :::6443                 :::*                    LISTEN      9831/kube-apiserver<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>为了使用kubectl访问apiserver，在~/.bash_profile中追加下面的环境变量：</p><pre class="line-numbers language-log"><code class="language-log">export KUBECONFIG=/etc/kubernetes/admin.confsource ~/.bash_profile<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>此时kubectl命令在master node上就好用了.</p><h3 id="安装Pod-Network"><a href="#安装Pod-Network" class="headerlink" title="安装Pod Network"></a>安装Pod Network</h3><h4 id="使用flannel网络"><a href="#使用flannel网络" class="headerlink" title="使用flannel网络"></a>使用flannel网络</h4><p>接下来安装<code>flannel network add-on</code>：</p><pre class="line-numbers language-log"><code class="language-log">mkdir -p ~/k8s/cd ~/k8scurl -O https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.ymlkubectl apply -f  kube-flannel.ymlclusterrole.rbac.authorization.k8s.io/flannel createdclusterrolebinding.rbac.authorization.k8s.io/flannel createdserviceaccount/flannel createdconfigmap/kube-flannel-cfg createddaemonset.extensions/kube-flannel-ds-amd64 createddaemonset.extensions/kube-flannel-ds-arm64 createddaemonset.extensions/kube-flannel-ds-arm createddaemonset.extensions/kube-flannel-ds-ppc64le createddaemonset.extensions/kube-flannel-ds-s390x created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>这里注意kube-flannel.yml这个文件里的flannel的镜像是0.11.0，quay.io/coreos/flannel:v0.11.0-amd64.<br>由于网络问题，flannel镜像可能pull失败，建议参考之前拉取镜像的方法，提前再各个节点拉好镜像！</p></blockquote><blockquote><p>如果Node有多个网卡的话，参考<a href="https://github.com/kubernetes/kubernetes/issues/39701" target="_blank" rel="noopener">flannel issues 39701</a>，目前需要在kube-flannel.yml中使用–iface参数指定集群主机内网网卡的名称，否则可能会出现dns无法解析。需要将<code>kube-flannel.yml</code>下载到本地，flanneld启动参数加上<code>–iface=&lt;iface-name&gt;</code></p></blockquote><pre class="line-numbers language-yml"><code class="language-yml">containers:      - name: kube-flannel        image: quay.io/coreos/flannel:v0.11.0-amd64        command:        - /opt/bin/flanneld        args:        - --ip-masq        - --kube-subnet-mgr        - --iface=eth1# ......<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用kubectl get pod –all-namespaces -o wide确保所有的Pod都处于Running状态。</p><pre class="line-numbers language-log"><code class="language-log">kubectl get pod -n kube-systemNAME                            READY   STATUS    RESTARTS   AGEcoredns-5c98db65d4-dr8lf        1/1     Running   0          52mcoredns-5c98db65d4-lp8dg        1/1     Running   0          52metcd-node1                      1/1     Running   0          51mkube-apiserver-node1            1/1     Running   0          51mkube-controller-manager-node1   1/1     Running   0          51mkube-flannel-ds-amd64-mm296     1/1     Running   0          44skube-proxy-kchkf                1/1     Running   0          52mkube-scheduler-node1            1/1     Running   0          51m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="问题，flannel一直在CrashLoopBackOff，日志如下"><a href="#问题，flannel一直在CrashLoopBackOff，日志如下" class="headerlink" title="问题，flannel一直在CrashLoopBackOff，日志如下"></a>问题，flannel一直在CrashLoopBackOff，日志如下</h4><pre class="line-numbers language-sh"><code class="language-sh">[root@master ~]# kubectl get pods --all-namespacesNAMESPACE     NAME                             READY   STATUS              RESTARTS   AGEkube-system   coredns-5c98db65d4-57zm5         0/1     ContainerCreating   0          7m46skube-system   coredns-5c98db65d4-g8kqh         0/1     ContainerCreating   0          7m46skube-system   etcd-master                      1/1     Running             0          6m51skube-system   kube-apiserver-master            1/1     Running             0          6m31skube-system   kube-controller-manager-master   1/1     Running             0          6m29skube-system   kube-flannel-ds-amd64-jthsp      0/1     CrashLoopBackOff    3          104s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-log"><code class="language-log">[root@master ~]# kubectl logs kube-flannel-ds-amd64-jthsp -n kube-systemI1105 08:37:34.863407       1 main.go:527] Using interface with name eth0 and address 192.168.1.209I1105 08:37:34.863461       1 main.go:544] Defaulting external address to interface address (192.168.1.209)I1105 08:37:35.061919       1 kube.go:126] Waiting 10m0s for node controller to syncI1105 08:37:35.166015       1 kube.go:309] Starting kube subnet managerI1105 08:37:36.065963       1 kube.go:133] Node controller sync successfulI1105 08:37:36.065985       1 main.go:244] Created subnet manager: Kubernetes Subnet Manager - masterI1105 08:37:36.065989       1 main.go:247] Installing signal handlersI1105 08:37:36.066082       1 main.go:386] Found network config - Backend type: vxlanI1105 08:37:36.066143       1 vxlan.go:120] VXLAN config: VNI=1 Port=0 GBP=false DirectRouting=falseE1105 08:37:36.066314       1 main.go:289] Error registering network: failed to acquire lease: node "master" pod cidr not assignedI1105 08:37:36.066356       1 main.go:366] Stopping shutdownHandler...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>解决办法:</p><pre class="line-numbers language-sh"><code class="language-sh"># 修改 /etc/kubernetes/manifests/kube-controller-manager.yaml# 增加参数--allocate-node-cidrs=true--cluster-cidr=10.244.0.0/16# 然后重启kubelet<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="使用weave网络"><a href="#使用weave网络" class="headerlink" title="使用weave网络"></a>使用weave网络</h4><p>虽然系统显示安装成功，但是master节点显示状态还是 NotReady，原因是需要安装网络插件，这边kubernetes官方提供了<a href="https://kubernetes.io/docs/concepts/cluster-administration/addons/#networking-and-network-policy" target="_blank" rel="noopener">几款网络插件</a>。。</p><pre><code>kubectl apply -f https://git.io/weave-kube-1.6NAME                      STATUS    ROLES     AGE       VERSIONizj6c3vsekthy7xn94b5s6z   Ready     master    1h        v1.10.3</code></pre><p>大概过一会master节点就显示ready了，说明master已经准备就绪了.</p><h3 id="测试集群DNS是否可用"><a href="#测试集群DNS是否可用" class="headerlink" title="测试集群DNS是否可用"></a>测试集群DNS是否可用</h3><pre class="line-numbers language-sh"><code class="language-sh">kubectl run curl --image=radial/busyboxplus:curl -itkubectl run --generator=deployment/apps.v1beta1 is DEPRECATED and will be removed in a future version. Use kubectl create instead.If you don't see a command prompt, try pressing enter.[ root@curl-5cc7b478b6-r997p:/ ]$<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>进入后执行<code>nslookup kubernetes.default</code>确认解析正常:</p><pre class="line-numbers language-log"><code class="language-log">nslookup kubernetes.defaultServer:    10.96.0.10Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.localName:      kubernetes.defaultAddress 1: 10.96.0.1 kubernetes.default.svc.cluster.local<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="向Kubernetes集群中添加Node节点"><a href="#向Kubernetes集群中添加Node节点" class="headerlink" title="向Kubernetes集群中添加Node节点"></a>向Kubernetes集群中添加Node节点</h3><p>下面将node3这个主机添加到Kubernetes集群中，在node3上执行:</p><pre class="line-numbers language-log"><code class="language-log">kubeadm join 192.168.99.11:6443 --token 4qcl2f.gtl3h8e5kjltuo0r \    --discovery-token-ca-cert-hash sha256:7ed5404175cc0bf18dbfe53f19d4a35b1e3d40c19b10924275868ebf2a3bbe6e \ --ignore-preflight-errors=Swap[preflight] Running pre-flight checks    [WARNING Swap]: running with swap on is not supported. Please disable swap    [WARNING Service-Kubelet]: kubelet service is not enabled, please run 'systemctl enable kubelet.service'[preflight] Reading configuration from the cluster...[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'[kubelet-start] Downloading configuration for the kubelet from the "kubelet-config-1.15" ConfigMap in the kube-system namespace[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"[kubelet-start] Activating the kubelet service[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...This node has joined the cluster:* Certificate signing request was sent to apiserver and a response was received.* The Kubelet was informed of the new secure connection details.Run 'kubectl get nodes' on the control-plane to see this node join the cluster.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>node3加入集群后，下面在master节点上执行命令查看集群中的节点：</p><pre class="line-numbers language-log"><code class="language-log">kubectl get nodeNAME    STATUS   ROLES    AGE   VERSIONnode2   Ready    master   57m   v1.15.0node3   Ready    <none>   11s   v1.15.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h4><p>执行上述命令一直卡在了<br><code>[preflight] Running pre-flight checks</code></p><ul><li>问题可能的原因是master防火墙没有关掉，检查firewalld和iptables</li><li>加上 –v=2 命令具体看看</li></ul><h3 id="从集群中移除Node"><a href="#从集群中移除Node" class="headerlink" title="从集群中移除Node"></a>从集群中移除Node</h3><p>在master节点上执行：</p><pre class="line-numbers language-sh"><code class="language-sh">kubectl drain node2 --delete-local-data --force --ignore-daemonsetskubectl delete node node2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>在<code>Node</code>上执行：</p><pre class="line-numbers language-sh"><code class="language-sh">kubeadm resetifconfig cni0 downip link delete cni0ifconfig flannel.1 downip link delete flannel.1rm -rf /var/lib/cni/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="kube-proxy开启ipvs"><a href="#kube-proxy开启ipvs" class="headerlink" title="kube-proxy开启ipvs"></a>kube-proxy开启ipvs</h3><p>修改<code>ConfigMap</code>的<code>kube-system/kube-proxy</code>中的<code>config.conf</code>，<code>mode: "ipvs"</code></p><pre><code>kubectl edit cm kube-proxy -n kube-system</code></pre><p>之后重启各个节点上的<code>kube-proxy pod</code>：</p><pre class="line-numbers language-sh"><code class="language-sh">kubectl get pod -n kube-system | grep kube-proxy | awk '{system("kubectl delete pod "$1" -n kube-system")}'<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-log"><code class="language-log">kubectl get pod -n kube-system | grep kube-proxykube-proxy-7fsrg                1/1     Running   0          3skube-proxy-k8vhm                1/1     Running   0          9skubectl logs kube-proxy-7fsrg  -n kube-systemI0703 04:42:33.308289       1 server_others.go:170] Using ipvs Proxier.W0703 04:42:33.309074       1 proxier.go:401] IPVS scheduler not specified, use rr by defaultI0703 04:42:33.309831       1 server.go:534] Version: v1.15.0I0703 04:42:33.320088       1 conntrack.go:52] Setting nf_conntrack_max to 131072I0703 04:42:33.320365       1 config.go:96] Starting endpoints config controllerI0703 04:42:33.320393       1 controller_utils.go:1029] Waiting for caches to sync for endpoints config controllerI0703 04:42:33.320455       1 config.go:187] Starting service config controllerI0703 04:42:33.320470       1 controller_utils.go:1029] Waiting for caches to sync for service config controllerI0703 04:42:33.420899       1 controller_utils.go:1036] Caches are synced for endpoints config controllerI0703 04:42:33.420969       1 controller_utils.go:1036] Caches are synced for service config controller<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>日志中打印出了Using ipvs Proxier，说明ipvs模式已经开启。</p><h2 id="Kubernetes常用组件部署"><a href="#Kubernetes常用组件部署" class="headerlink" title="Kubernetes常用组件部署"></a>Kubernetes常用组件部署</h2><p>越来越多的公司和团队开始使用Helm这个Kubernetes的包管理器，这里也将使用Helm安装Kubernetes的常用组件。</p><h3 id="Helm的安装"><a href="#Helm的安装" class="headerlink" title="Helm的安装"></a>Helm的安装</h3><p>Helm由客户端命helm令行工具和服务端tiller组成，Helm的安装十分简单。 下载helm命令行工具到master节点node1的<code>/usr/local/bin</code>下，这里下载的<code>2.14.1</code>版本.</p><p><strong>网络问题下载不了，可以直接在网上搜个压缩包拷进去即可！</strong></p><pre class="line-numbers language-sh"><code class="language-sh">curl -O https://get.helm.sh/helm-v2.14.1-linux-amd64.tar.gztar -zxvf helm-v2.14.1-linux-amd64.tar.gzcd linux-amd64/cp helm /usr/local/bin/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>为了安装服务端tiller，还需要在这台机器上配置好kubectl工具和kubeconfig文件，确保kubectl工具可以在这台机器上访问apiserver且正常使用。</p></blockquote><p>因为Kubernetes APIServer开启了RBAC访问控制，所以需要创建tiller使用的service account: tiller并分配合适的角色给它。 详细内容可以查看helm文档中的<a href="https://helm.sh/docs/intro/" target="_blank" rel="noopener">Role-based Access Control</a>。 这里简单起见直接分配<code>cluster-admin</code>这个集群内置的<code>ClusterRole</code>给它。创建<code>helm-rbac.yaml</code>文件：</p><pre class="line-numbers language-yml"><code class="language-yml">apiVersion: v1kind: ServiceAccountmetadata:  name: tiller  namespace: kube-system---apiVersion: rbac.authorization.k8s.io/v1beta1kind: ClusterRoleBindingmetadata:  name: tillerroleRef:  apiGroup: rbac.authorization.k8s.io  kind: ClusterRole  name: cluster-adminsubjects:  - kind: ServiceAccount    name: tiller    namespace: kube-system<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-sh"><code class="language-sh">kubectl create -f helm-rbac.yamlserviceaccount/tiller createdclusterrolebinding.rbac.authorization.k8s.io/tiller created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>接下来使用helm部署<code>tiller</code>:</p><pre class="line-numbers language-log"><code class="language-log">helm init --service-account tiller --skip-refreshCreating /root/.helmCreating /root/.helm/repositoryCreating /root/.helm/repository/cacheCreating /root/.helm/repository/localCreating /root/.helm/pluginsCreating /root/.helm/startersCreating /root/.helm/cache/archiveCreating /root/.helm/repository/repositories.yamlAdding stable repo with URL: https://kubernetes-charts.storage.googleapis.comAdding local repo with URL: http://127.0.0.1:8879/charts$HELM_HOME has been configured at /root/.helm.Tiller (the Helm server-side component) has been installed into your Kubernetes Cluster.Please note: by default, Tiller is deployed with an insecure 'allow unauthenticated users' policy.To prevent this, run `helm init` with the --tiller-tls-verify flag.For more information on securing your installation see: https://docs.helm.sh/using_helm/#securing-your-helm-installationHappy Helming!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>tiller</code>默认被部署在k8s集群中的<code>kube-system</code>这个<code>namespace</code>下：</p><pre class="line-numbers language-log"><code class="language-log">kubectl get pod -n kube-system -l app=helmNAME                            READY   STATUS    RESTARTS   AGEtiller-deploy-c4fd4cd68-dwkhv   1/1     Running   0          83s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-log"><code class="language-log">helm versionClient: &version.Version{SemVer:"v2.14.1", GitCommit:"5270352a09c7e8b6e8c9593002a73535276507c0", GitTreeState:"clean"}Server: &version.Version{SemVer:"v2.14.1", GitCommit:"5270352a09c7e8b6e8c9593002a73535276507c0", GitTreeState:"clean"}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="遇到的问题-1"><a href="#遇到的问题-1" class="headerlink" title="遇到的问题!!!!"></a>遇到的问题!!!!</h4><p>tiller可能因为网络问题安装失败，可以使用以下命令重置</p><pre><code>helm reset --force</code></pre><p>然后安装tiller的时候指定image和stable url，这里用的阿里云的</p><pre class="line-numbers language-log"><code class="language-log">helm init --service-account tiller --skip-refresh -i registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.14.3 --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>最后在node1上修改helm chart仓库的地址为azure提供的镜像地址：</p><pre class="line-numbers language-log"><code class="language-log">helm repo add stable http://mirror.azure.cn/kubernetes/charts"stable" has been added to your repositorieshelm repo listNAME    URL                                     stable  http://mirror.azure.cn/kubernetes/chartslocal   http://127.0.0.1:8879/charts<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="使用Helm部署Nginx-Ingress"><a href="#使用Helm部署Nginx-Ingress" class="headerlink" title="使用Helm部署Nginx Ingress"></a>使用Helm部署Nginx Ingress</h3><p>为了便于将集群中的服务暴露到集群外部，需要使用Ingress。接下来使用Helm将Nginx Ingress部署到Kubernetes上。</p><blockquote><p>Nginx Ingress Controller被部署在Kubernetes的边缘节点上</p></blockquote><p>我们将<code>node1(192.168.99.11)</code>做为边缘节点，打上<code>Label</code>：</p><pre class="line-numbers language-log"><code class="language-log">kubectl label node node1 node-role.kubernetes.io/edge=node/node1 labeledkubectl get nodeNAME    STATUS   ROLES         AGE    VERSIONnode1   Ready    edge,master   138m   v1.15.0node2   Ready    <none>        82m    v1.15.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>stable/nginx-ingress</code> <code>chart</code>的值文件<code>ingress-nginx.yaml</code>如下：</p><pre class="line-numbers language-yml"><code class="language-yml">controller:  replicaCount: 1  hostNetwork: true  nodeSelector:    node-role.kubernetes.io/edge: ''  affinity:    podAntiAffinity:        requiredDuringSchedulingIgnoredDuringExecution:        - labelSelector:            matchExpressions:            - key: app              operator: In              values:              - nginx-ingress            - key: component              operator: In              values:              - controller          topologyKey: kubernetes.io/hostname  tolerations:      - key: node-role.kubernetes.io/master        operator: Exists        effect: NoSchedule      - key: node-role.kubernetes.io/master        operator: Exists        effect: PreferNoScheduledefaultBackend:  nodeSelector:    node-role.kubernetes.io/edge: ''  tolerations:      - key: node-role.kubernetes.io/master        operator: Exists        effect: NoSchedule      - key: node-role.kubernetes.io/master        operator: Exists        effect: PreferNoSchedule<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>nginx ingress controller</code>的副本数<code>replicaCount</code>为<code>1</code>，将被调度到node1这个边缘节点上。</p><p>这里并没有指定nginx ingress controller service的<code>externalIPs</code>，而是通过<code>hostNetwork: true</code>设置nginx ingress controller使用宿主机网络。</p><pre class="line-numbers language-sh"><code class="language-sh">helm repo updatehelm install stable/nginx-ingress \-n nginx-ingress \--namespace ingress-nginx  \-f ingress-nginx.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-log"><code class="language-log">kubectl get pod -n ingress-nginx -o wideNAME                                            READY   STATUS    RESTARTS   AGE   IP              NODE    NOMINATED NODE   READINESS GATESnginx-ingress-controller-cc9b6d55b-pr8vr        1/1     Running   0          10m   192.168.99.11   node1   <none>           <none>nginx-ingress-default-backend-cc888fd56-bf4h2   1/1     Running   0          10m   10.244.0.14     node1   <none>           <none><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>如果访问<code>http://192.168.99.11</code>返回<code>default backend</code>，则部署完成。</p><h4 id="遇到的问题-2"><a href="#遇到的问题-2" class="headerlink" title="遇到的问题!!!!"></a>遇到的问题!!!!</h4><blockquote><p>这里可能因为网络原因安装失败需要清理之前的<code>nginx-ingress</code>，建议提前下载好相关镜像。<br>使用<code>kubectl describe pod [name] -n [namespace]</code>看看默认拉取的是哪个版本的镜像，参考之前方法提前下载！</p></blockquote><pre><code>kubectl delete namespace/ingress-nginxhelm delete nginx-ingresshelm del --purge nginx-ingress</code></pre><h3 id="使用Helm部署dashboard"><a href="#使用Helm部署dashboard" class="headerlink" title="使用Helm部署dashboard"></a>使用Helm部署dashboard</h3><h4 id="创建tls-secret："><a href="#创建tls-secret：" class="headerlink" title="创建tls secret："></a>创建<code>tls secret</code>：</h4><p>通过https进行访问必需要使用证书和密钥，在Kubernetes中可以通过配置一个加密凭证（TLS secret）来提供。创建一个自己签名的证书:</p><pre><code>openssl req -x509 -nodes -days 3650 -newkey rsa:2048 -keyout ./tls.key -out ./tls.crt -subj "/CN=192.168.1.210"</code></pre><p>将会产生两个文件tls.key和tls.crt，你可以改成自己的文件名或放在特定的目录下。<strong>后面的192.168.1.210是我的服务器IP地址，你需要改成自己的。</strong></p><h4 id="安装tls-secret"><a href="#安装tls-secret" class="headerlink" title="安装tls secret:"></a>安装<code>tls secret</code>:</h4><p>将这两个文件的信息创建为一个Kubernetes的secret访问凭证，我将名称指定为<code>test-com-tls-secret</code>，这在后面的Ingress配置时将会用到。</p><blockquote><p>如果你修改了这个名字，注意后面的配置yaml文件也需要同步修改。</p></blockquote><pre><code>kubectl -n kube-system create secret tls test-com-tls-secret --key ./tls.key --cert ./tls.crt</code></pre><h4 id="查看"><a href="#查看" class="headerlink" title="查看:"></a>查看:</h4><pre><code>kubectl get secret -n kube-system |grep test</code></pre><h4 id="kubernetes-dashboard-yaml"><a href="#kubernetes-dashboard-yaml" class="headerlink" title="kubernetes-dashboard.yaml:"></a><code>kubernetes-dashboard.yaml</code>:</h4><blockquote><p>注意修改里面的<code>secretName</code>和<code>hosts</code></p></blockquote><pre class="line-numbers language-yml"><code class="language-yml">image:  repository: k8s.gcr.io/kubernetes-dashboard-amd64  tag: v1.10.1ingress:  enabled: true  hosts:     - k8s.test.com  annotations:    nginx.ingress.kubernetes.io/ssl-redirect: "true"    nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"  tls:    - secretName: test-com-tls-secret      hosts:      - k8s.test.comnodeSelector:    node-role.kubernetes.io/edge: ''tolerations:    - key: node-role.kubernetes.io/master      operator: Exists      effect: NoSchedule    - key: node-role.kubernetes.io/master      operator: Exists      effect: PreferNoSchedulerbac:  clusterAdminRole: true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="安装："><a href="#安装：" class="headerlink" title="安装："></a>安装：</h4><pre><code>helm install stable/kubernetes-dashboard \-n kubernetes-dashboard \--namespace kube-system  \-f kubernetes-dashboard.yaml</code></pre><h4 id="查看："><a href="#查看：" class="headerlink" title="查看："></a>查看：</h4><pre class="line-numbers language-log"><code class="language-log">kubectl -n kube-system get secret | grep kubernetes-dashboard-tokenkubernetes-dashboard-token-pkm2s                 kubernetes.io/service-account-token   3      3m7skubectl describe -n kube-system secret/kubernetes-dashboard-token-pkm2sName:         kubernetes-dashboard-token-pkm2sNamespace:    kube-systemLabels:       <none>Annotations:  kubernetes.io/service-account.name: kubernetes-dashboard              kubernetes.io/service-account.uid: 2f0781dd-156a-11e9-b0f0-080027bb7c43Type:  kubernetes.io/service-account-tokenData====ca.crt:     1025 bytesnamespace:  11 bytestoken:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC10b2tlbi1wa20ycyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjJmMDc4MWRkLTE1NmEtMTFlOS1iMGYwLTA4MDAyN2JiN2M0MyIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTprdWJlcm5ldGVzLWRhc2hib2FyZCJ9.24ad6ZgZMxdydpwlmYAiMxZ9VSIN7dDR7Q6-RLW0qC81ajXoQKHAyrEGpIonfld3gqbE0xO8nisskpmlkQra72-9X6sBPoByqIKyTsO83BQlME2sfOJemWD0HqzwSCjvSQa0x-bUlq9HgH2vEXzpFuSS6Svi7RbfzLXlEuggNoC4MfA4E2hF1OX_ml8iAKx-49y1BQQe5FGWyCyBSi1TD_-ZpVs44H5gIvsGK2kcvi0JT4oHXtWjjQBKLIWL7xxyRCSE4HmUZT2StIHnOwlX7IEIB0oBX4mPg2_xNGnqwcu-8OERU9IoqAAE2cZa0v3b5O2LMcJPrcxrVOukvRIumA<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="测试："><a href="#测试：" class="headerlink" title="测试："></a>测试：</h4><p>在dashboard的登录窗口使用上面的<code>token</code>登录，访问刚刚填写的hosts，如果是内网域名，需要在访问的那台机器上，在hosts文件中加入刚刚的域名和IP。<br><img src="/images/k8s1.png" alt="k8s"></p><h3 id="使用Helm部署metrics-server"><a href="#使用Helm部署metrics-server" class="headerlink" title="使用Helm部署metrics-server"></a>使用Helm部署metrics-server</h3><blockquote><p><code>heapster</code>从<code>Kubernetes 1.12</code>开始从Kubernetes各种安装脚本中移除。</p></blockquote><p>Kubernetes推荐使用<code>metrics-server</code>。我们这里也使用helm来部署<code>metrics-server</code>。</p><p><code>metrics-server.yaml</code>:</p><pre class="line-numbers language-yml"><code class="language-yml">replicaCount: 1image:    repository: hub.deri.org.cn/k8s/metrics-server-amd64    tag: v0.3.5    pullPolicy: IfNotPresentargs:- --logtostderr- --kubelet-insecure-tls- --kubelet-preferred-address-types=InternalIPnodeSelector:    node-role.kubernetes.io/edge: ''tolerations:    - key: node-role.kubernetes.io/master      operator: Exists      effect: NoSchedule    - key: node-role.kubernetes.io/master      operator: Exists      effect: PreferNoSchedule<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre><code>helm install stable/metrics-server \-n metrics-server \--namespace kube-system \-f metrics-server.yaml</code></pre><p>使用下面的命令可以获取到关于集群节点基本的指标信息：</p><pre class="line-numbers language-log"><code class="language-log">kubectl top nodeNAME    CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%node1   650m         32%    1276Mi          73%node2   73m          3%     527Mi           30%<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-log"><code class="language-log">kubectl top pod -n kube-systemNAME                                    CPU(cores)   MEMORY(bytes)   coredns-5c98db65d4-dr8lf                8m           7Mi             coredns-5c98db65d4-lp8dg                6m           8Mi             etcd-node1                              44m          46Mi            kube-apiserver-node1                    74m          295Mi           kube-controller-manager-node1           35m          50Mi            kube-flannel-ds-amd64-7lwm9             2m           8Mi             kube-flannel-ds-amd64-mm296             5m           9Mi             kube-proxy-7fsrg                        1m           11Mi            kube-proxy-k8vhm                        3m           11Mi            kube-scheduler-node1                    8m           15Mi            kubernetes-dashboard-848b8dd798-c4sc2   2m           14Mi            metrics-server-8456fb6676-fwh2t         10m          19Mi            tiller-deploy-7bf78cdbf7-9q94c          1m           16Mi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="https://www.kubernetes.org.cn/5551.html" target="_blank" rel="noopener">https://www.kubernetes.org.cn/5551.html</a></li><li><a href="https://www.cnblogs.com/hongdada/p/11250293.html" target="_blank" rel="noopener">https://www.cnblogs.com/hongdada/p/11250293.html</a></li><li><a href="https://www.jianshu.com/p/03eba1513c17" target="_blank" rel="noopener">https://www.jianshu.com/p/03eba1513c17</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>consul【开启ACL】</title>
      <link href="/2019/09/05/consul-kai-qi-acl/"/>
      <url>/2019/09/05/consul-kai-qi-acl/</url>
      
        <content type="html"><![CDATA[<h3 id="开启acl"><a href="#开启acl" class="headerlink" title="开启acl"></a>开启acl</h3><pre class="line-numbers language-json"><code class="language-json">// 这里的master token是用UUID生成的，保证三个server的acl配置一样<span class="token property">"acl"</span><span class="token operator">:</span><span class="token punctuation">{</span>    <span class="token property">"enabled"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token property">"default_policy"</span><span class="token operator">:</span><span class="token string">"deny"</span><span class="token punctuation">,</span>    <span class="token property">"enable_token_persistence"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token property">"tokens"</span><span class="token operator">:</span><span class="token punctuation">{</span>        <span class="token property">"master"</span><span class="token operator">:</span><span class="token string">"14d54c5e-24ca-41cc-8c9e-987ba7a96ffb"</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="启动docker-compose-up"><a href="#启动docker-compose-up" class="headerlink" title="启动docker-compose up"></a>启动docker-compose up</h3><p>后台报大量错误</p><pre><code>agent: Coordinate update blocked by ACLs</code></pre><p>解决办法:<code>创建一个token</code></p><pre><code>#使用POSTMAN，请求方法PUT#请求路径http://192.168.41.128:8500/v1/acl/create#请求JSON参数{  "Name": "Agent Token",  "Type": "client",  "Rules": "node \"\" { policy = \"write\" } service \"\" { policy = \"read\" }"}#Headers加上X-Consul-Token，值为master的值14d54c5e-24ca-41cc-8c9e-987ba7a96ffb#返回结果{    "ID": "db98c304-4d38-8660-fafe-6a4be56a40d0"}</code></pre><p>将返回的ID贴到consul节点配置中</p><pre class="line-numbers language-json"><code class="language-json"><span class="token property">"acl"</span><span class="token operator">:</span><span class="token punctuation">{</span>    <span class="token property">"enabled"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token property">"default_policy"</span><span class="token operator">:</span><span class="token string">"deny"</span><span class="token punctuation">,</span>    <span class="token property">"enable_token_persistence"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token property">"tokens"</span><span class="token operator">:</span><span class="token punctuation">{</span>        <span class="token property">"master"</span><span class="token operator">:</span><span class="token string">"14d54c5e-24ca-41cc-8c9e-987ba7a96ffb"</span><span class="token punctuation">,</span>        <span class="token property">"agent"</span><span class="token operator">:</span><span class="token string">"db98c304-4d38-8660-fafe-6a4be56a40d0"</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重新启动，问题解决。</p><h3 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h3><pre><code>docker exec consul_server_1 consul members</code></pre><p>执行上面命令查看members的时候，发现返回为空<br><img src="/images/consul15.png" alt="consul"></p><p>配置<code>CONSUL_HTTP_TOKEN</code>环境变量，值为刚刚PUT请求获取的token即可。</p><p>修改<code>docker-compose.yml</code>配置，所有节点增加环境变量</p><pre class="line-numbers language-yaml"><code class="language-yaml">    <span class="token key atrule">environment</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> CONSUL_BIND_INTERFACE=eth0      <span class="token punctuation">-</span> TZ=Asia/Shanghai      <span class="token punctuation">-</span> CONSUL_HTTP_TOKEN=db98c304<span class="token punctuation">-</span>4d38<span class="token punctuation">-</span>8660<span class="token punctuation">-</span>fafe<span class="token punctuation">-</span>6a4be56a40d0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>重新启动docker-compose up，再次查看members<br><img src="/images/consul16.png" alt="consul"></p><p>问题解决。</p><h3 id="登录web-ui"><a href="#登录web-ui" class="headerlink" title="登录web ui"></a>登录web ui</h3><p>打开后发现啥都没有，需要点击ACL，输入<code>master</code>中的值</p><p><img src="/images/consul17.png" alt="consul"></p><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul><li><a href="https://blog.csdn.net/YellowStar5/article/details/90728468" target="_blank" rel="noopener">https://blog.csdn.net/YellowStar5/article/details/90728468</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> consul </category>
          
      </categories>
      
      
        <tags>
            
            <tag> consul </tag>
            
            <tag> acl </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>consul【docker-compose部署】</title>
      <link href="/2019/09/04/consul-docker-compose-bu-shu/"/>
      <url>/2019/09/04/consul-docker-compose-bu-shu/</url>
      
        <content type="html"><![CDATA[<h3 id="前章回顾"><a href="#前章回顾" class="headerlink" title="前章回顾"></a>前章回顾</h3><p>上一章使用了<code>docker</code>命令部署<code>consul</code>集群，但是每次都敲命令太麻烦了，可以使用<code>docker-compose</code>简化。</p><h3 id="docker-compose简介"><a href="#docker-compose简介" class="headerlink" title="docker-compose简介"></a>docker-compose简介</h3><p>本章内容参考官网：<code>https://docs.docker.com/compose/</code></p><p>Compose是一个用于定义和运行多容器Docker应用程序的工具。使用Compose，您可以使用YAML文件来配置应用程序的服务。然后，使用单个命令，您可以从配置中创建并启动所有服务。</p><h3 id="docker-compose安装"><a href="#docker-compose安装" class="headerlink" title="docker-compose安装"></a>docker-compose安装</h3><p>进入官网，<code>https://docs.docker.com/compose/install/</code>，选择<code>linux</code>，可以找到安装命令</p><pre class="line-numbers language-sh"><code class="language-sh">#运行此命令以下载Docker Compose的当前稳定版本：sudo curl -L "https://github.com/docker/compose/releases/download/1.24.1/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose#对二进制文件应用可执行权限：sudo chmod +x /usr/local/bin/docker-compose#可以移到到你需要的目录下，也可以不移动，如果移动，例如mv /usr/local/bin/docker-compose /docker/docker-compose#可以再创建一个链接就行sudo ln -s /docker/docker-compose /usr/bin/docker-compose#测试安装$ docker-compose --versiondocker-compose version 1.24.1, build 1110ad01<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="编写docker-compose-yml"><a href="#编写docker-compose-yml" class="headerlink" title="编写docker-compose.yml"></a>编写docker-compose.yml</h3><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span><span class="token key atrule">services</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true">#服务名</span>  <span class="token key atrule">consul_server_1</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true">#容器名</span>    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> consul_server_1    <span class="token comment" spellcheck="true">#使用的镜像</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> consul<span class="token punctuation">:</span>1.6.0    <span class="token comment" spellcheck="true">#映射的端口</span>    <span class="token key atrule">ports</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"8500:8500"</span>    <span class="token comment" spellcheck="true">#使用的网络</span>    <span class="token key atrule">networks</span><span class="token punctuation">:</span>       <span class="token punctuation">-</span> consul    <span class="token comment" spellcheck="true">#映射的目录</span>    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> /docker/consul/server1/config<span class="token punctuation">:</span>/consul/config      <span class="token punctuation">-</span> /docker/consul/server1/data<span class="token punctuation">:</span>/consul/data    <span class="token comment" spellcheck="true">#需要导入的环境变量</span>    <span class="token key atrule">environment</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> CONSUL_BIND_INTERFACE=eth0      <span class="token punctuation">-</span> TZ=Asia/Shanghai    <span class="token comment" spellcheck="true">#是否伴随docker重启</span>    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always    <span class="token comment" spellcheck="true">#执行的命令</span>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>      <span class="token string">'agent'</span>    <span class="token punctuation">]</span><span class="token comment" spellcheck="true">#使用自定义网络，这样每次启动就不会创建新的网络了，ip相对固定</span><span class="token key atrule">networks</span><span class="token punctuation">:</span>  consul<span class="token punctuation">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="docker-compose启动"><a href="#docker-compose启动" class="headerlink" title="docker-compose启动"></a>docker-compose启动</h3><pre class="line-numbers language-sh"><code class="language-sh">#启动/停止都需要进入到docker-compose.yml目录下#启动命令-前台运行docker-compose up#启动命令-后台运行docker-compose up -d#停止命令docker-compose stop#更多命令进入官网学习：https://docs.docker.com/compose/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="注意网络问题"><a href="#注意网络问题" class="headerlink" title="注意网络问题"></a>注意网络问题</h3><p><code>docker-compose</code>使用的是<code>docker网络</code></p><pre class="line-numbers language-sh"><code class="language-sh">#查看现有docker网络docker network ls#删除一个网络docker network rm +name#查看一个网络的详情docker network inspect +name#docker-compose网络设置#自定义网络networks:  frontend:  backend:  #使用默认网络networks:  default:    # Use a custom driver    driver: custom-driver-1#使用现有网络networks:  default:    external:      name: my-pre-existing-network#更多参考官网：https://docs.docker.com/compose/networking/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="修改consul另外节点的join-IP"><a href="#修改consul另外节点的join-IP" class="headerlink" title="修改consul另外节点的join IP"></a>修改consul另外节点的join IP</h3><p>获取<code>consul_server_1</code>的<code>ip</code>，可以根据启动日志，或者运行完之后执行<code>docker exec consul_server_1 consul members</code>查看<code>IP</code><br><img src="/images/consul9.png" alt="consul"><br>或<br><img src="/images/consul10.png" alt="consul"></p><p>修改其余<code>consul</code>配置的<code>join ip</code><br><img src="/images/consul11.png" alt="consul"></p><p>在<code>docker-compose.yml</code>中增加其他节点服务，完整配置如下：</p><pre class="line-numbers language-yml"><code class="language-yml">version: '3'services:  consul_server_1:    container_name: consul_server_1    image: consul:1.6.0    ports:      - "8500:8500"    networks:       - consul    volumes:      - /docker/consul/server1/config:/consul/config      - /docker/consul/server1/data:/consul/data    environment:      - CONSUL_BIND_INTERFACE=eth0      - TZ=Asia/Shanghai    restart: always    command: [      'agent'    ]  consul_server_2:    container_name: consul_server_2    image: consul:1.6.0    networks:       - consul    volumes:      - /docker/consul/server2/config:/consul/config      - /docker/consul/server2/data:/consul/data    environment:      - CONSUL_BIND_INTERFACE=eth0      - TZ=Asia/Shanghai    restart: always    command: [      'agent'    ]  consul_server_3:    container_name: consul_server_3    image: consul:1.6.0    networks:       - consul    volumes:      - /docker/consul/server3/config:/consul/config      - /docker/consul/server3/data:/consul/data    environment:      - CONSUL_BIND_INTERFACE=eth0      - TZ=Asia/Shanghai    restart: always    command: [      'agent'    ]  consul_client_1:    container_name: consul_client_1    image: consul:1.6.0    networks:       - consul    volumes:      - /docker/consul/client1/config:/consul/config      - /docker/consul/client1/data:/consul/data    environment:      - CONSUL_BIND_INTERFACE=eth0      - TZ=Asia/Shanghai    restart: always    command: [      'agent'    ]networks:  consul:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="启动，查看"><a href="#启动，查看" class="headerlink" title="启动，查看"></a>启动，查看</h3><p><img src="/images/consul12.png" alt="consul"><br><img src="/images/consul13.png" alt="consul"><br><img src="/images/consul14.png" alt="consul"></p><p>服务均正常，以后启动只需要<code>docker-compose up -d</code> 和 <code>docker-compose stop</code>即可，大大方便！</p><h3 id="增加固定IP部署配置"><a href="#增加固定IP部署配置" class="headerlink" title="增加固定IP部署配置"></a>增加固定IP部署配置</h3><pre class="line-numbers language-yml"><code class="language-yml">version: '3'services:  consul_server_1:    container_name: consul_server_1    image: consul:1.6.0    ports:      - "8500:8500"    networks:       consul:        ipv4_address: 172.20.0.2    volumes:      - /docker/consul/server1/config:/consul/config      - /docker/consul/server1/data:/consul/data    environment:      - CONSUL_BIND_INTERFACE=eth0      - TZ=Asia/Shanghai    restart: always    command: [      'agent'    ]  consul_server_2:    container_name: consul_server_2    image: consul:1.6.0    networks:       consul:        ipv4_address: 172.20.0.3    volumes:      - /docker/consul/server2/config:/consul/config      - /docker/consul/server2/data:/consul/data    environment:      - CONSUL_BIND_INTERFACE=eth0      - TZ=Asia/Shanghai    restart: always    command: [      'agent'    ]  consul_server_3:    container_name: consul_server_3    image: consul:1.6.0    networks:       consul:        ipv4_address: 172.20.0.4    volumes:      - /docker/consul/server3/config:/consul/config      - /docker/consul/server3/data:/consul/data    environment:      - CONSUL_BIND_INTERFACE=eth0      - TZ=Asia/Shanghai    restart: always    command: [      'agent'    ]  consul_client_1:    container_name: consul_client_1    image: consul:1.6.0    networks:       consul:        ipv4_address: 172.20.0.5    volumes:      - /docker/consul/client1/config:/consul/config      - /docker/consul/client1/data:/consul/data    environment:      - CONSUL_BIND_INTERFACE=eth0      - TZ=Asia/Shanghai    restart: always    command: [      'agent'    ]networks:  consul:    ipam:      config:        - subnet: 172.20.0.0/16<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> consul </category>
          
      </categories>
      
      
        <tags>
            
            <tag> consul </tag>
            
            <tag> docker-compose </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux虚拟机设置固定IP并且可以访问外网配置</title>
      <link href="/2019/09/04/linux-xu-ni-ji-she-zhi-gu-ding-ip-bing-qie-ke-yi-fang-wen-wai-wang-pei-zhi/"/>
      <url>/2019/09/04/linux-xu-ni-ji-she-zhi-gu-ding-ip-bing-qie-ke-yi-fang-wen-wai-wang-pei-zhi/</url>
      
        <content type="html"><![CDATA[<h3 id="设置网络模式"><a href="#设置网络模式" class="headerlink" title="设置网络模式"></a>设置网络模式</h3><p><img src="/images/nat.jpg" alt="NAT模式"></p><h3 id="设置固定ip"><a href="#设置固定ip" class="headerlink" title="设置固定ip"></a>设置固定ip</h3><pre><code>#编辑以下文件vi /etc/sysconfig/network-scripts/ifcfg-ens33#修改以下内容,注意属性BOOTPROTO,ONBOOT,IPADDR,NETMASK,GATEWAYTYPE=EthernetPROXY_METHOD=noneBROWSER_ONLY=noBOOTPROTO=staticDEFROUTE=yesIPV4_FAILURE_FATAL=noIPV6INIT=yesIPV6_AUTOCONF=yesIPV6_DEFROUTE=yesIPV6_FAILURE_FATAL=noIPV6_ADDR_GEN_MODE=stable-privacyNAME=ens33UUID=e27ede3e-740b-4241-adf1-e979fd2788e9DEVICE=ens33ONBOOT=yesIPADDR=192.168.41.128NETMASK=255.255.255.0GATEWAY=192.168.41.2#重启网络service network restart</code></pre><h3 id="设置nameserver"><a href="#设置nameserver" class="headerlink" title="设置nameserver"></a>设置nameserver</h3><pre><code>#编辑/etc/resolv.conf,随便增加一些国内DNS服务器IP，例如：nameserver 114.114.114.114nameserver 119.29.29.29nameserver 114.114.114.114nameserver 223.5.5.5nameserver 8.8.8.8#重启网络服务，注意和上一步重启网络要分开执行，不然本文件内容会因为上一步重启而清空service network restart</code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> 虚拟机 </tag>
            
            <tag> 网络 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>consul【集群容器化部署】</title>
      <link href="/2019/09/03/consul-ji-qun-rong-qi-hua-bu-shu/"/>
      <url>/2019/09/03/consul-ji-qun-rong-qi-hua-bu-shu/</url>
      
        <content type="html"><![CDATA[<h3 id="拉取consul镜像"><a href="#拉取consul镜像" class="headerlink" title="拉取consul镜像"></a>拉取consul镜像</h3><pre class="line-numbers language-sh"><code class="language-sh">docker pull consul:1.6.0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="本地创建映射目录及配置文件"><a href="#本地创建映射目录及配置文件" class="headerlink" title="本地创建映射目录及配置文件"></a>本地创建映射目录及配置文件</h3><pre class="line-numbers language-sh"><code class="language-sh">#创建server1对应的目录mkdir /docker/consul/server1mkdir /docker/consul/server1/datamkdir /docker/consul/server1/config#创建server2对应的目录mkdir /docker/consul/server2mkdir /docker/consul/server2/datamkdir /docker/consul/server2/config#创建server3对应的目录mkdir /docker/consul/server3mkdir /docker/consul/server3/datamkdir /docker/consul/server3/config#consul容器默认config路径在/consul/config,data路径在/consul/data#使用docker -v映射，启动可以使用本地config，data也可以持久化到本地<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-json"><code class="language-json">// 创建server1配置文件config.json// 注意配置ui集群页面，client_addr对应-client，bootstrap<span class="token punctuation">{</span>    <span class="token property">"datacenter"</span><span class="token operator">:</span><span class="token string">"dc1"</span><span class="token punctuation">,</span>    <span class="token property">"primary_datacenter"</span><span class="token operator">:</span><span class="token string">"dc1"</span><span class="token punctuation">,</span>    <span class="token property">"server"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token property">"ui"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token property">"client_addr"</span><span class="token operator">:</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span>    <span class="token property">"bootstrap"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token property">"enable_script_checks"</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>    <span class="token property">"node_name"</span><span class="token operator">:</span><span class="token string">"consul-server-1"</span><span class="token punctuation">,</span>    <span class="token property">"enable_local_script_checks"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span>// 拷贝同样的配置到/docker/consul/server2，/docker/consul/server3目录下，注意去掉ui和bootstrap属性，注意修改节点名node_name，不能冲突// client_addr不写的话，外面服务访问不了容器里的consul服务<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="启动容器"><a href="#启动容器" class="headerlink" title="启动容器"></a>启动容器</h3><pre class="line-numbers language-sh"><code class="language-sh">#docker启动命令docker run -d -e CONSUL_BIND_INTERFACE=eth0 -v /docker/consul/server1/config:/consul/config -v /docker/consul/server1/data:/consul/data  -p 8500:8500  --name=consul consul:1.6.0 agent#前面的不解释了，-v是将本地目录映射到容器内，容器内的路径是刚刚config.json配置中指定的，启动consul时指定配置文件，实际这个配置文件在本地/docker/consul/server1/config/config.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="访问本地8500端口，可以看到页面"><a href="#访问本地8500端口，可以看到页面" class="headerlink" title="访问本地8500端口，可以看到页面"></a>访问本地8500端口，可以看到页面</h3><p><img src="/images/consul2.png" alt="consul"></p><h3 id="启动第二、第三个server加入到集群"><a href="#启动第二、第三个server加入到集群" class="headerlink" title="启动第二、第三个server加入到集群"></a>启动第二、第三个server加入到集群</h3><pre class="line-numbers language-sh"><code class="language-sh">#第一步：通过consul命令查看现有server信息docker exec consul_server_1 consul members<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><img src="/images/consul3.png" alt="consul"></p><pre class="line-numbers language-json"><code class="language-json">//第二步：修改server2和server3的配置文件，增加以下内容    <span class="token property">"start_join"</span><span class="token operator">:</span><span class="token punctuation">[</span>        <span class="token string">"172.17.0.4"</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token property">"retry_join"</span><span class="token operator">:</span><span class="token punctuation">[</span>        <span class="token string">"172.17.0.4"</span>    <span class="token punctuation">]</span>//注意保持json格式正确//也可以在docker启动命令后加 -join=<span class="token number">172.17</span>.<span class="token number">0.4</span> -retry-join=<span class="token number">172.17</span>.<span class="token number">0.4</span>，结果一样<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-sh"><code class="language-sh">#第三步：使用docker命令启动server2和server3#启动第2个server节点docker run -d -e CONSUL_BIND_INTERFACE=eth0 -v /docker/consul/server2/config:/consul/config -v /docker/consul/server2/data:/consul/data --name=consul_server_2 consul:1.6.0 agent#启动第3个server节点docker run -d -e CONSUL_BIND_INTERFACE=eth0 -v /docker/consul/server3/config:/consul/config -v /docker/consul/server3/data:/consul/data --name=consul_server_3 consul:1.6.0 agent<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="查看ui"><a href="#查看ui" class="headerlink" title="查看ui"></a>查看ui</h3><p><img src="/images/consul4.png" alt="consul"></p><h3 id="增加client类型consul"><a href="#增加client类型consul" class="headerlink" title="增加client类型consul"></a>增加client类型consul</h3><pre class="line-numbers language-json"><code class="language-json">// 复制一个config.json到/docker/consul/client1目录下// 修改client1的配置文件，具体如下<span class="token punctuation">{</span>    <span class="token property">"datacenter"</span><span class="token operator">:</span><span class="token string">"dc1"</span><span class="token punctuation">,</span>    <span class="token property">"primary_datacenter"</span><span class="token operator">:</span><span class="token string">"dc1"</span><span class="token punctuation">,</span>    <span class="token property">"server"</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>    <span class="token property">"client_addr"</span><span class="token operator">:</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span>    <span class="token property">"enable_script_checks"</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>    <span class="token property">"node_name"</span><span class="token operator">:</span><span class="token string">"consul-client-1"</span><span class="token punctuation">,</span>    <span class="token property">"enable_local_script_checks"</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token property">"start_join"</span><span class="token operator">:</span><span class="token punctuation">[</span>        <span class="token string">"172.17.0.4"</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token property">"retry_join"</span><span class="token operator">:</span><span class="token punctuation">[</span>        <span class="token string">"172.17.0.4"</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span>// 注意点：指明了server为<span class="token boolean">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-sh"><code class="language-sh"># docker启动docker run -d -e CONSUL_BIND_INTERFACE=eth0 -v /docker/consul/client1/config:/consul/config -v /docker/consul/client1/data:/consul/data --name=consul_client_1 consul:1.6.0 agent<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>client</code>加入之后可以通过命令<code>consul members</code>查看<br><img src="/images/consul5.png" alt="consul"></p><p>可以看到我们刚刚启动的<code>consul_client_1</code>这个节点。</p><p><code>UI</code>中在<code>service</code>中看不到<code>client</code><br><img src="/images/consul6.png" alt="consul"></p><p>但是可以在<code>node</code>中看到<br><img src="/images/consul7.png" alt="consul"></p><h3 id="查看容器中运行的数据是否保存在本地"><a href="#查看容器中运行的数据是否保存在本地" class="headerlink" title="查看容器中运行的数据是否保存在本地"></a>查看容器中运行的数据是否保存在本地</h3><p><img src="/images/consul8.png" alt="consul"><br>成功部署完成！</p><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul><li><a href="https://www.consul.io/docs/agent/options.html" target="_blank" rel="noopener">https://www.consul.io/docs/agent/options.html</a></li><li><a href="https://docs.docker.com/samples/library/consul/" target="_blank" rel="noopener">https://docs.docker.com/samples/library/consul/</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> consul </category>
          
      </categories>
      
      
        <tags>
            
            <tag> consul </tag>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>consul【单机版windows部署及使用】</title>
      <link href="/2019/08/30/consul-dan-ji-ban-windows-bu-shu-ji-shi-yong/"/>
      <url>/2019/08/30/consul-dan-ji-ban-windows-bu-shu-ji-shi-yong/</url>
      
        <content type="html"><![CDATA[<h3 id="启动及常用配置项"><a href="#启动及常用配置项" class="headerlink" title="启动及常用配置项"></a>启动及常用配置项</h3><p>解压后，在目录下打开<code>cmd</code>窗口，运行</p><pre class="line-numbers language-sh"><code class="language-sh">consul agent -dev -ui -node=nodeName<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="data-dir"><a href="#data-dir" class="headerlink" title="-data-dir"></a>-data-dir</h4><ul><li>作用：指定agent储存状态的数据目录</li><li>这是所有agent都必须的</li><li>对于server尤其重要，因为他们必须持久化集群的状态</li></ul><h4 id="config-dir"><a href="#config-dir" class="headerlink" title="-config-dir"></a>-config-dir</h4><ul><li>作用：指定service的配置文件和检查定义所在的位置</li><li>通常会指定为”某一个路径/consul.d”（通常情况下，.d表示一系列配置文件存放的目录）</li></ul><h4 id="config-file"><a href="#config-file" class="headerlink" title="-config-file"></a>-config-file</h4><ul><li>作用：指定一个要装载的配置文件</li><li>该选项可以配置多次，进而配置多个配置文件（后边的会合并前边的，相同的值覆盖）</li></ul><h4 id="dev"><a href="#dev" class="headerlink" title="-dev"></a>-dev</h4><ul><li>作用：创建一个开发环境下的server节点</li><li>该参数配置下，不会有任何持久化操作，即不会有任何数据写入到磁盘</li><li>这种模式不能用于生产环境（因为第二条）</li></ul><h4 id="node"><a href="#node" class="headerlink" title="-node"></a>-node</h4><ul><li>作用：指定节点在集群中的名称</li><li>该名称在集群中必须是唯一的（默认采用机器的<code>host</code>）</li><li>推荐：直接采用机器的IP</li></ul><h4 id="bind"><a href="#bind" class="headerlink" title="-bind"></a>-bind</h4><ul><li>作用：指明节点的IP地址</li><li>有时候不指定绑定IP，会报<code>Failed to get advertise address: Multiple private IPs found. Please configure one.</code>的异常</li></ul><h4 id="server"><a href="#server" class="headerlink" title="-server"></a>-server</h4><ul><li>作用：指定节点为<code>server</code></li><li>每个数据中心（<code>DC</code>）的server数推荐至少为1，至多为5</li><li>所有的server都采用raft一致性算法来确保事务的一致性和线性化，事务修改了集群的状态，且集群的状态保存在每一台server上保证可用性</li><li>server也是与其他DC交互的门面（gateway）</li></ul><h4 id="bootstrap-expect"><a href="#bootstrap-expect" class="headerlink" title="-bootstrap-expect"></a>-bootstrap-expect</h4><ul><li>作用：该命令通知consul server我们现在准备加入的server节点个数，该参数是为了延迟日志复制的启动直到我们指定数量的server节点成功的加入后启动。</li></ul><h4 id="join"><a href="#join" class="headerlink" title="-join"></a>-join</h4><ul><li>作用：将节点加入到集群</li></ul><h4 id="datacenter（老版本叫-dc，-dc已经失效）"><a href="#datacenter（老版本叫-dc，-dc已经失效）" class="headerlink" title="-datacenter（老版本叫-dc，-dc已经失效）"></a>-datacenter（老版本叫-dc，-dc已经失效）</h4><ul><li>作用：指定机器加入到哪一个数据中心中</li></ul><h4 id="client"><a href="#client" class="headerlink" title="-client"></a>-client</h4><ul><li>作用：指定节点为<code>client</code>，指定客户端接口的绑定地址，包括：<code>HTTP、DNS、RPC</code></li><li>默认是<code>127.0.0.1</code>，只允许回环接口访问</li><li>若不指定为<code>-server</code>，其实就是<code>-client</code></li></ul><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>浏览器访问<a href="http://127.0.0.1:8500" target="_blank" rel="noopener">http://127.0.0.1:8500</a><br><img src="/images/consul1.png" alt="consul"></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> consul </category>
          
      </categories>
      
      
        <tags>
            
            <tag> consul </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>docker常用命令</title>
      <link href="/2019/08/30/docker-chang-yong-ming-ling/"/>
      <url>/2019/08/30/docker-chang-yong-ming-ling/</url>
      
        <content type="html"><![CDATA[<h3 id="启动命令"><a href="#启动命令" class="headerlink" title="启动命令"></a>启动命令</h3><pre class="line-numbers language-sh"><code class="language-sh">docker run "image"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><table><thead><tr><th>参数</th><th>用途</th></tr></thead><tbody><tr><td><code>-it</code></td><td>交互式启动</td></tr><tr><td><code>-d</code></td><td>后台启动</td></tr><tr><td><code>-p80:80</code></td><td>端口映射</td></tr><tr><td><code>--name</code></td><td>容器名称</td></tr><tr><td><code>--cpus</code></td><td>限制cpu使用个数</td></tr><tr><td><code>--cpuset-cpus</code></td><td>限制cpu使用的核，例如0-3，限制使用0-3核CPU</td></tr><tr><td><code>-m</code></td><td>限制内存使用，例如2048M</td></tr><tr><td><code>--restart</code></td><td>自动重启策略</td></tr></tbody></table><h3 id="对指定容器执行bash"><a href="#对指定容器执行bash" class="headerlink" title="对指定容器执行bash"></a>对指定容器执行bash</h3><pre class="line-numbers language-sh"><code class="language-sh">docker exec -it 9df70f9a0714 /bin/bash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="删除镜像"><a href="#删除镜像" class="headerlink" title="删除镜像"></a>删除镜像</h3><pre class="line-numbers language-sh"><code class="language-sh">docker rmi 镜像名/镜像ID<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="构建镜像"><a href="#构建镜像" class="headerlink" title="构建镜像"></a>构建镜像</h3><pre class="line-numbers language-Dockerfile"><code class="language-Dockerfile">FROM myjdk1.8MAINTAINER authorADD haolin.jar /rootADD start.sh /rootRUN chmod +x /root/start.shEXPOSE 80ENV LANG C.UTF-8CMD /root/start.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-sh"><code class="language-sh">#! /bin/bashecho "building docker image..."docker build -f /docker/bbs/Dockerfile -t author/bbs .echo "stop and remove old docker container"if [ `docker ps -a|grep bbs|awk '{print $1}'` != '' ]; then        docker stop bbs        docker rm bbsfiecho "start..."docker run -d -p 80:80 --name bbs --restart=always author/bbs:latestecho "buid success"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何在Spring cloud gateway全局filter中获取本次请求命中的路由id</title>
      <link href="/2019/08/23/spring-cloud-gateway-quan-ju-filter/"/>
      <url>/2019/08/23/spring-cloud-gateway-quan-ju-filter/</url>
      
        <content type="html"><![CDATA[<p>首先开启<code>gateway debug</code>日志，可以看到:</p><p><img src="/images/gateway1.png" alt="debug"></p><p><code>debug</code>日志中是可以打印请求所命中的路由id的，<code>Route matched: hello-route</code></p><p>然后我在想怎么在程序中获取到这个id呢？因为如果在程序中可以获取到这个id，我就可以按统计每个路由所被访问的次数。网上找了一些博客，都没有提到这个问题，所以只能自己想了。</p><p>首先我从打印日志的类开始搜，打开源码<code>RoutePredicateHandlerMapping</code>,找到打印日志的代码。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">protected</span> Mono<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> <span class="token function">getHandlerInternal</span><span class="token punctuation">(</span>ServerWebExchange exchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>managmentPort <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>managmentPort<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> Mono<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        exchange<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ServerWebExchangeUtils<span class="token punctuation">.</span>GATEWAY_HANDLER_MAPPER_ATTR<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">lookupRoute</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            exchange<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ServerWebExchangeUtils<span class="token punctuation">.</span>GATEWAY_PREDICATE_ROUTE_ATTR<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 可以看到这里对应的r就是我们要获取的路由。因为从打印的日志中可以看出</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Mapping ["</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getExchangeDesc</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"] to "</span> <span class="token operator">+</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            exchange<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ServerWebExchangeUtils<span class="token punctuation">.</span>GATEWAY_ROUTE_ATTR<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> Mono<span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>webHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">switchIfEmpty</span><span class="token punctuation">(</span>Mono<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>Mono<span class="token punctuation">.</span><span class="token function">fromRunnable</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            exchange<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ServerWebExchangeUtils<span class="token punctuation">.</span>GATEWAY_PREDICATE_ROUTE_ATTR<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"No RouteDefinition found for ["</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getExchangeDesc</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-log"><code class="language-log">Route{id='hello-route', uri=http://127.0.0.1:8763, order=0, predicate=org.springframework........<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>我们只要获取到这个<code>Route</code>对象就可以了。那么源码中这个对象放哪儿了呢？</p><pre class="line-numbers language-java"><code class="language-java">exchange<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ServerWebExchangeUtils<span class="token punctuation">.</span>GATEWAY_ROUTE_ATTR<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>所以我们只需要在exchange中根据<code>ServerWebExchangeUtils.GATEWAY_ROUTE_ATTR</code>,这个<code>key</code>从<code>Attributes</code>获取就可以了。</p><p>下面编写一个Global Filter试试吧。</p><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayLogFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> Ordered <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Mono<span class="token operator">&lt;</span>Void<span class="token operator">></span> <span class="token function">filter</span><span class="token punctuation">(</span>ServerWebExchange exchange<span class="token punctuation">,</span> GatewayFilterChain chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Route route <span class="token operator">=</span> <span class="token punctuation">(</span>Route<span class="token punctuation">)</span> exchange<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ServerWebExchangeUtils<span class="token punctuation">.</span>GATEWAY_ROUTE_ATTR<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> spring cloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring cloud gateway </tag>
            
            <tag> filter </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo博客安装步骤</title>
      <link href="/2019/07/31/hexo-bo-ke-an-zhuang-bu-zou/"/>
      <url>/2019/07/31/hexo-bo-ke-an-zhuang-bu-zou/</url>
      
        <content type="html"><![CDATA[<h3 id="安装git"><a href="#安装git" class="headerlink" title="安装git"></a>安装git</h3><pre><code>git -v</code></pre><h3 id="安装nodejs"><a href="#安装nodejs" class="headerlink" title="安装nodejs"></a>安装nodejs</h3><pre><code>node -vnpm -v</code></pre><pre><code>npm config set registry https://registry.npm.taobao.org</code></pre><h3 id="安装hexo"><a href="#安装hexo" class="headerlink" title="安装hexo"></a>安装hexo</h3><pre><code>npm install -g hexo-cli</code></pre><pre><code>hexo init MyBlog</code></pre><pre><code>cd MyBlog      //进入这个MyBlog文件夹npm install</code></pre><h3 id="生成SSH添加到GitHub"><a href="#生成SSH添加到GitHub" class="headerlink" title="生成SSH添加到GitHub"></a>生成SSH添加到GitHub</h3><p>详细的百度~</p><pre><code>git config --global user.name "yourname"git config --global user.email "youremail"</code></pre><h3 id="安装一些插件"><a href="#安装一些插件" class="headerlink" title="安装一些插件"></a>安装一些插件</h3><p>上传到GitHub上需要的插件</p><pre><code>npm install hexo-deployer-git --save</code></pre><p><a href="https://github.com/blinkfox/hexo-theme-matery/blob/develop/README_CN.md" target="_blank" rel="noopener">matery主题需要的插件</a></p><pre><code>npm i -S hexo-prism-plugin</code></pre><pre><code>npm install hexo-generator-search --save</code></pre><pre><code>npm i hexo-permalink-pinyin --save</code></pre><pre><code>npm i --save hexo-wordcount</code></pre><pre><code>npm install hexo-filter-github-emojis --save</code></pre><pre><code>npm install hexo-generator-feed --save</code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCloud config 配置文件手动刷新遇到的坑，解决没有/refresh路径问题</title>
      <link href="/2019/07/26/spring-cloud-config-pei-zhi-wen-jian-shou-dong-shua-xin-yu-dao-de-keng/"/>
      <url>/2019/07/26/spring-cloud-config-pei-zhi-wen-jian-shou-dong-shua-xin-yu-dao-de-keng/</url>
      
        <content type="html"><![CDATA[<p>在<code>SpringCloud 2.0.0</code>版本以前，只要加入下面依赖:</p><pre><code>&lt;dependency&gt;    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;&lt;/dependency&gt;</code></pre><p>并且在类上,变量上打上<code>@RefreshScope</code>的注解,在启动的时候,都会看到</p><pre><code>RequestMappingHandlerMapping : Mapped "{/refresh,methods=[post]}" </code></pre><p>也就是<code>SpringCloud</code>暴露了一个接口 <code>/refresh</code> 来给我们去刷新配置,但是<code>SpringCloud 2.0.0</code>以后,有了改变.<br>我们需要在<code>bootstrap.yml</code>里面加上需要暴露出来的地址  </p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">management</span><span class="token punctuation">:</span>  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>    <span class="token key atrule">web</span><span class="token punctuation">:</span>      <span class="token key atrule">exposure</span><span class="token punctuation">:</span>        <span class="token key atrule">include</span><span class="token punctuation">:</span> refresh<span class="token punctuation">,</span>health<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在的地址也不是<code>/refresh</code>了,而是<code>/actuator/refresh</code></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> spring cloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring cloud </tag>
            
            <tag> spring cloud config </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2019/07/01/hello-world/"/>
      <url>/2019/07/01/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><pre class="line-numbers language-bash"><code class="language-bash">$ hexo new <span class="token string">"My New Post"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><pre class="line-numbers language-bash"><code class="language-bash">$ hexo server<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><pre class="line-numbers language-bash"><code class="language-bash">$ hexo generate<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><pre class="line-numbers language-bash"><code class="language-bash">$ hexo deploy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> test </category>
          
      </categories>
      
      
        <tags>
            
            <tag> test </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IDEA列操作（windows版-实测）</title>
      <link href="/2019/04/14/idea-lie-cao-zuo-windows-ban-shi-ce/"/>
      <url>/2019/04/14/idea-lie-cao-zuo-windows-ban-shi-ce/</url>
      
        <content type="html"><![CDATA[<table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td><code>CTRL +SHIFT + A</code></td><td>查找快捷键 –&gt;HELP–&gt;FIND ACTION move caret to,move caret to next world 快速到单词的末尾，ctrl+ →， 同时按住shift 就是选中这个单词</td></tr><tr><td><code>CTRL +SHIFT+ALT +J</code></td><td>选中一样的 –&gt;EDIT –&gt;FIND SELECT ALL OCCURRENCES</td></tr><tr><td><code>SHIFT + ALT + 鼠标左键</code></td><td>选中多行</td></tr><tr><td><code>END键</code></td><td>快速移到行尾</td></tr><tr><td><code>HOME键</code></td><td>快速移到行首</td></tr><tr><td><code>CTRL+ALT + L</code></td><td>格式化 –&gt;code –&gt;reformat code</td></tr><tr><td><code>Ctrl+alt+I</code></td><td>自动缩进</td></tr><tr><td><code>ctrl+ shift +U</code></td><td>字母大小写切换</td></tr><tr><td><code>ctrl+alt+t</code></td><td>surround with ,if else, try catch,…</td></tr><tr><td><code>ctrl +shift + t</code></td><td>创建新的测试</td></tr><tr><td><code>alt + insert</code></td><td>generate 生成getter and setter,constructor,toString…</td></tr><tr><td><code>ctrl+y / x</code></td><td>删除行</td></tr><tr><td><code>ctrl + D</code></td><td>复制行</td></tr><tr><td><code>ctrl + H</code></td><td>显示类结构图</td></tr><tr><td><code>ctrl+ shift + h</code></td><td>显示方法调用结构</td></tr><tr><td><code>Alt+7</code></td><td>显示类所有方法，快速定位</td></tr><tr><td><code>ctrl + E</code></td><td>显示最近打开的文件</td></tr><tr><td><code>ctrl +j</code></td><td>自动补全代码 fori psvm sout …</td></tr><tr><td><code>ctrl + w</code></td><td>选中代码，多次按，逐渐扩大选中范围</td></tr><tr><td><code>alt+f3 / ctrl+shift + f7</code></td><td>高亮显示文本</td></tr><tr><td><code>ctrl+/ / ctrl+shift+/</code></td><td>注释// 或者注释/*</td></tr><tr><td><code>ctrl + Alt + o</code></td><td>优化导入的包</td></tr><tr><td><code>ctrl + p</code></td><td>显示方法参数提醒</td></tr></tbody></table><blockquote><p>注意有时候快捷键不生效，是不是和<code>QQ</code>、<code>钉钉</code>等常用软件冲突导致。</p></blockquote><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> idea </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
